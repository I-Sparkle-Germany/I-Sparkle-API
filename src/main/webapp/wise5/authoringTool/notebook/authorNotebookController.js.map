{"version":3,"sources":["authorNotebookController.es6"],"names":["AuthorNotebookController","$filter","$mdDialog","$state","$stateParams","$scope","ConfigService","ProjectService","UtilService","$translate","projectId","project","notebook","projectTemplate","getNewProjectTemplate","notes","itemTypes","report","note","reportId","summernoteId","noteContent","replaceAssetPaths","content","replaceWISELinks","summernoteHTML","insertAssetString","insertAssetButton","createInsertAssetButton","summernoteOptions","toolbar","height","disableDragAndDrop","buttons","$on","event","args","assetItem","fileName","assetsDirectoryPath","getProjectAssetsDirectoryPath","fullAssetPath","target","isImage","$","summernote","isVideo","videoElement","document","createElement","controls","innerHTML","hide","push","n","length","commitMessage","saveProject","go","html","removeAbsoluteAssetPaths","insertWISELinks","$inject"],"mappings":"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","file":"authorNotebookController.js","sourcesContent":["'use strict';\n\nclass AuthorNotebookController {\n\n  constructor($filter,\n        $mdDialog,\n        $state,\n        $stateParams,\n        $scope,\n        ConfigService,\n        ProjectService,\n        UtilService) {\n\n    this.$filter = $filter;\n    this.$mdDialog = $mdDialog;\n    this.$state = $state;\n    this.$stateParams = $stateParams;\n    this.$scope = $scope;\n    this.ConfigService = ConfigService;\n    this.ProjectService = ProjectService;\n    this.UtilService = UtilService;\n    this.$translate = this.$filter('translate');\n    this.projectId = this.$stateParams.projectId;\n    this.project = this.ProjectService.project;\n\n    if (this.project.notebook == null) {\n      // some old projects may not have the notebook settings,\n      // so copy default settings from template project.\n      let projectTemplate = this.ProjectService.getNewProjectTemplate();\n      this.project.notebook = projectTemplate.notebook;\n    }\n    var notes = this.project.notebook.itemTypes.report.notes;\n    if (notes != null) {\n      for (const note of notes) {\n        if (note != null) {\n          const reportId = note.reportId;\n          note.summernoteId = 'summernoteNotebook_' + reportId;\n          let noteContent = this.ProjectService.replaceAssetPaths(note.content);\n          noteContent = this.UtilService.replaceWISELinks(noteContent);\n          note.summernoteHTML = noteContent;\n\n          // the tooltip text for the insert WISE asset button\n          const insertAssetString = this.$translate('INSERT_ASSET');\n\n          /*\n           * create the custom button for inserting WISE assets into\n           * summernote\n           */\n          const insertAssetButton =\n              this.UtilService.createInsertAssetButton(\n                  this, this.projectId, null, null, reportId, insertAssetString);\n\n          /*\n           * the options that specifies the tools to display in the\n           * summernote prompt\n           */\n          note.summernoteOptions = {\n            toolbar: [\n              ['style', ['style']],\n              ['font', ['bold', 'underline', 'clear']],\n              ['fontname', ['fontname']],\n              ['fontsize', ['fontsize']],\n              ['color', ['color']],\n              ['para', ['ul', 'ol', 'paragraph']],\n              ['table', ['table']],\n              ['insert', ['link', 'video']],\n              ['view', ['fullscreen', 'codeview', 'help']],\n              ['customButton', ['insertAssetButton']]\n            ],\n            height: 300,\n            disableDragAndDrop: true,\n            buttons: {\n              insertAssetButton: insertAssetButton\n            }\n          };\n        }\n      }\n    }\n\n    /*\n     * Listen for the assetSelected event which occurs when the user\n     * selects an asset from the choose asset popup\n     */\n    this.$scope.$on('assetSelected', (event, args) => {\n      if (args != null) {\n        // make sure the event was fired for this component\n        if (args.projectId == this.projectId) {\n          // the asset was selected for this component\n          var assetItem = args.assetItem;\n          if (assetItem != null) {\n            var fileName = assetItem.fileName;\n\n            if (fileName != null) {\n              /*\n               * get the assets directory path\n               * e.g.\n               * /wise/curriculum/3/\n               */\n              var assetsDirectoryPath = this.ConfigService.getProjectAssetsDirectoryPath();\n              var fullAssetPath = assetsDirectoryPath + '/' + fileName;\n\n              var summernoteId = '';\n              var reportId = args.target;\n\n              if (reportId != null) {\n                // the target is the summernote prompt element\n                summernoteId = 'summernoteNotebook_' + reportId;\n              }\n\n              if (summernoteId != '') {\n                if (this.UtilService.isImage(fileName)) {\n                  /*\n                   * move the cursor back to its position when the asset chooser\n                   * popup was clicked\n                   */\n                  $('#' + summernoteId).summernote('editor.restoreRange');\n                  $('#' + summernoteId).summernote('editor.focus');\n\n                  // add the image html\n                  $('#' + summernoteId).summernote('insertImage', fullAssetPath, fileName);\n                } else if (this.UtilService.isVideo(fileName)) {\n                  /*\n                   * move the cursor back to its position when the asset chooser\n                   * popup was clicked\n                   */\n                  $('#' + summernoteId).summernote('editor.restoreRange');\n                  $('#' + summernoteId).summernote('editor.focus');\n\n                  // insert the video element\n                  var videoElement = document.createElement('video');\n                  videoElement.controls = 'true';\n                  videoElement.innerHTML = '<source ng-src=\"' + fullAssetPath + '\" type=\"video/mp4\">';\n                  $('#' + summernoteId).summernote('insertNode', videoElement);\n                }\n              }\n            }\n          }\n        }\n      }\n      this.$mdDialog.hide();\n    });\n  }\n\n  /**\n   * Adds a new report note item to this project's notebook. Currently we limit 1 report note per project.\n   */\n  addReportNote() {\n    // some old projects may not have the notebook settings, so copy default settings from template project.\n    let projectTemplate = this.ProjectService.getNewProjectTemplate();\n\n    if (this.project.notebook.itemTypes.report.notes == null) {\n      this.project.notebook.itemTypes.report.notes = [];\n    }\n    if (this.project.notebook.itemTypes.report.notes < 1) {\n      this.project.notebook.itemTypes.report.notes.push(projectTemplate.notebook.itemTypes.report.notes[0]);\n    }\n  }\n\n  exit() {\n    var notes = this.project.notebook.itemTypes.report.notes;\n    if (notes != null) {\n      for (var n = 0; n < notes.length; n++) {\n        var note = notes[n];\n        if (note != null) {\n          // remove the temporary fields that were used for bookkeeping\n          delete note['summernoteId'];\n          delete note['summernoteHTML'];\n          delete note['summernoteOptions'];\n        }\n      }\n    }\n\n    let commitMessage = this.$translate('madeChangesToNotebook');\n    this.ProjectService.saveProject(commitMessage);\n    this.$state.go('root.project', {projectId: this.projectId});\n  }\n\n  /**\n   * A note was changed\n   * @param note the note that was changed\n   */\n  summernoteHTMLChanged(note) {\n\n    if (note != null) {\n\n      // get the summernote html\n      var html = note.summernoteHTML;\n\n      /*\n       * remove the absolute asset paths\n       * e.g.\n       * <img src='https://wise.berkeley.edu/curriculum/3/assets/sun.png'/>\n       * will be changed to\n       * <img src='sun.png'/>\n       */\n      html = this.ConfigService.removeAbsoluteAssetPaths(html);\n\n      /*\n       * replace <a> and <button> elements with <wiselink> elements when\n       * applicable\n       */\n      html = this.UtilService.insertWISELinks(html);\n\n      note.content = html;\n    }\n  }\n}\n\nAuthorNotebookController.$inject = [\n  '$filter',\n  '$mdDialog',\n  '$state',\n  '$stateParams',\n  '$scope',\n  'ConfigService',\n  'ProjectService',\n  'UtilService'];\n\nexport default AuthorNotebookController;\n"]}