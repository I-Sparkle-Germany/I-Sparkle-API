{"version":3,"sources":["authorNotebookController.es6"],"names":["AuthorNotebookController","$filter","$mdDialog","$state","$stateParams","$scope","ConfigService","ProjectService","SpaceService","UtilService","$translate","projectId","project","reportIdToAuthoringNote","notebook","projectTemplate","getNewProjectTemplate","initializeNotesAuthoring","$on","event","args","assetItem","fileName","target","assetsDirectoryPath","getProjectAssetsDirectoryPath","fullAssetPath","reportId","summernoteId","isImage","restoreSummernoteCursorPosition","insertImageIntoSummernote","isVideo","insertVideoIntoSummernote","hide","isPublicNotebookEnabled","isSpaceExists","notes","itemTypes","report","note","initializeNoteAuthoring","authoringReportNote","noteContent","replaceAssetPaths","content","replaceWISELinks","summernoteHTML","insertAssetButton","createInsertAssetButton","summernoteOptions","toolbar","height","disableDragAndDrop","buttons","setReportIdToAuthoringNote","id","push","getReportNote","authoringNote","getAuthoringReportNote","removeAbsoluteAssetPaths","insertWISELinks","save","addSpace","removeSpace","saveProject","$inject"],"mappings":"AAAA;;;;;;;;;;IAEMA,wB;AAEJ,oCACIC,OADJ,EAEIC,SAFJ,EAGIC,MAHJ,EAIIC,YAJJ,EAKIC,MALJ,EAMIC,aANJ,EAOIC,cAPJ,EAQIC,YARJ,EASIC,WATJ,EASiB;AAAA;;AAAA;;AACf,SAAKR,OAAL,GAAeA,OAAf;AACA,SAAKC,SAAL,GAAiBA,SAAjB;AACA,SAAKC,MAAL,GAAcA,MAAd;AACA,SAAKC,YAAL,GAAoBA,YAApB;AACA,SAAKC,MAAL,GAAcA,MAAd;AACA,SAAKC,aAAL,GAAqBA,aAArB;AACA,SAAKC,cAAL,GAAsBA,cAAtB;AACA,SAAKC,YAAL,GAAoBA,YAApB;AACA,SAAKC,WAAL,GAAmBA,WAAnB;AACA,SAAKC,UAAL,GAAkB,KAAKT,OAAL,CAAa,WAAb,CAAlB;AACA,SAAKU,SAAL,GAAiB,KAAKP,YAAL,CAAkBO,SAAnC;AACA,SAAKC,OAAL,GAAe,KAAKL,cAAL,CAAoBK,OAAnC;AACA,SAAKC,uBAAL,GAA+B,EAA/B;;AAEA,QAAI,KAAKD,OAAL,CAAaE,QAAb,IAAyB,IAA7B,EAAmC;AACjC,UAAMC,kBAAkB,KAAKR,cAAL,CAAoBS,qBAApB,EAAxB;AACA,WAAKJ,OAAL,CAAaE,QAAb,GAAwBC,gBAAgBD,QAAxC;AACD;;AAED,SAAKG,wBAAL;;AAEA,SAAKZ,MAAL,CAAYa,GAAZ,CAAgB,eAAhB,EAAiC,UAACC,KAAD,EAAQC,IAAR,EAAiB;AAChD,UAAIA,KAAKT,SAAL,IAAkB,MAAKA,SAAvB,IAAoCS,KAAKC,SAAL,IAAkB,IAAtD,IACAD,KAAKC,SAAL,CAAeC,QAAf,IAA2B,IAD3B,IACmCF,KAAKG,MAAL,IAAe,IADtD,EAC4D;AAC1D,YAAMC,sBAAsB,MAAKlB,aAAL,CAAmBmB,6BAAnB,EAA5B;AACA,YAAMH,WAAWF,KAAKC,SAAL,CAAeC,QAAhC;AACA,YAAMI,gBAAgBF,sBAAsB,GAAtB,GAA4BF,QAAlD;AACA,YAAMK,WAAWP,KAAKG,MAAtB;AACA,YAAMK,eAAe,wBAAwBD,QAA7C;AACA,YAAI,MAAKlB,WAAL,CAAiBoB,OAAjB,CAAyBP,QAAzB,CAAJ,EAAwC;AACtC,gBAAKb,WAAL,CAAiBqB,+BAAjB,CAAiDF,YAAjD;AACA,gBAAKnB,WAAL,CAAiBsB,yBAAjB,CAA2CH,YAA3C,EAAyDF,aAAzD,EAAwEJ,QAAxE;AACD,SAHD,MAGO,IAAI,MAAKb,WAAL,CAAiBuB,OAAjB,CAAyBV,QAAzB,CAAJ,EAAwC;AAC7C,gBAAKb,WAAL,CAAiBqB,+BAAjB,CAAiDF,YAAjD;AACA,gBAAKnB,WAAL,CAAiBwB,yBAAjB,CAA2CL,YAA3C,EAAyDF,aAAzD;AACD;AACF;AACD,YAAKxB,SAAL,CAAegC,IAAf;AACD,KAjBD;;AAmBA,SAAKC,uBAAL,GAA+B,KAAK5B,cAAL,CAAoB6B,aAApB,CAAkC,QAAlC,CAA/B;AACD;;;;+CAE0B;AACzB,UAAMC,QAAQ,KAAKzB,OAAL,CAAaE,QAAb,CAAsBwB,SAAtB,CAAgCC,MAAhC,CAAuCF,KAArD;AACA,UAAIA,SAAS,IAAb,EAAmB;AAAA;AAAA;AAAA;;AAAA;AACjB,+BAAmBA,KAAnB,8HAA0B;AAAA,gBAAfG,IAAe;;AACxB,iBAAKC,uBAAL,CAA6BD,IAA7B;AACD;AAHgB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAIlB;AACF;;;4CAEuBA,I,EAAM;AAC5B,UAAME,sBAAsB,EAA5B;AACA,UAAMf,WAAWa,KAAKb,QAAtB;AACAe,0BAAoBd,YAApB,GAAmC,wBAAwBD,QAA3D;AACA,UAAIgB,cAAc,KAAKpC,cAAL,CAAoBqC,iBAApB,CAAsCJ,KAAKK,OAA3C,CAAlB;AACAF,oBAAc,KAAKlC,WAAL,CAAiBqC,gBAAjB,CAAkCH,WAAlC,CAAd;AACAD,0BAAoBK,cAApB,GAAqCJ,WAArC;;AAEA;AACA,UAAMK,oBAAoB,KAAKvC,WAAL,CAAiBwC,uBAAjB,CACtB,IADsB,EAChB,KAAKtC,SADW,EACA,IADA,EACM,IADN,EACYgB,QADZ,EAEtB,KAAKjB,UAAL,CAAgB,cAAhB,CAFsB,CAA1B;;AAIA;AACAgC,0BAAoBQ,iBAApB,GAAwC;AACtCC,iBAAS,CACP,CAAC,OAAD,EAAU,CAAC,OAAD,CAAV,CADO,EAEP,CAAC,MAAD,EAAS,CAAC,MAAD,EAAS,WAAT,EAAsB,OAAtB,CAAT,CAFO,EAGP,CAAC,UAAD,EAAa,CAAC,UAAD,CAAb,CAHO,EAIP,CAAC,UAAD,EAAa,CAAC,UAAD,CAAb,CAJO,EAKP,CAAC,OAAD,EAAU,CAAC,OAAD,CAAV,CALO,EAMP,CAAC,MAAD,EAAS,CAAC,IAAD,EAAO,IAAP,EAAa,WAAb,CAAT,CANO,EAOP,CAAC,OAAD,EAAU,CAAC,OAAD,CAAV,CAPO,EAQP,CAAC,QAAD,EAAW,CAAC,MAAD,EAAS,OAAT,CAAX,CARO,EASP,CAAC,MAAD,EAAS,CAAC,YAAD,EAAe,UAAf,EAA2B,MAA3B,CAAT,CATO,EAUP,CAAC,cAAD,EAAiB,CAAC,mBAAD,CAAjB,CAVO,CAD6B;AAatCC,gBAAQ,GAb8B;AActCC,4BAAoB,IAdkB;AAetCC,iBAAS;AACPN,6BAAmBA;AADZ;AAf6B,OAAxC;;AAoBA,WAAKO,0BAAL,CAAgC5B,QAAhC,EAA0Ce,mBAA1C;AACD;;;+CAE0Bf,Q,EAAUe,mB,EAAqB;AACxD,WAAK7B,uBAAL,CAA6Bc,QAA7B,IAAyCe,mBAAzC;AACD;;;2CAEsBc,E,EAAI;AACzB,aAAO,KAAK3C,uBAAL,CAA6B2C,EAA7B,CAAP;AACD;;;kCAEaA,E,EAAI;AAChB,UAAMnB,QAAQ,KAAKzB,OAAL,CAAaE,QAAb,CAAsBwB,SAAtB,CAAgCC,MAAhC,CAAuCF,KAArD;AADgB;AAAA;AAAA;;AAAA;AAEhB,8BAAiBA,KAAjB,mIAAwB;AAAA,cAAfG,IAAe;;AACtB,cAAIA,KAAKb,QAAL,KAAkB6B,EAAtB,EAA0B;AACxB,mBAAOhB,IAAP;AACD;AACF;AANe;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAOhB,aAAO,IAAP;AACD;;AAED;;;;;;;oCAIgB;AACd,UAAMzB,kBAAkB,KAAKR,cAAL,CAAoBS,qBAApB,EAAxB;AACA,UAAI,KAAKJ,OAAL,CAAaE,QAAb,CAAsBwB,SAAtB,CAAgCC,MAAhC,CAAuCF,KAAvC,IAAgD,IAApD,EAA0D;AACxD,aAAKzB,OAAL,CAAaE,QAAb,CAAsBwB,SAAtB,CAAgCC,MAAhC,CAAuCF,KAAvC,GAA+C,EAA/C;AACD;AACD,UAAI,KAAKzB,OAAL,CAAaE,QAAb,CAAsBwB,SAAtB,CAAgCC,MAAhC,CAAuCF,KAAvC,GAA+C,CAAnD,EAAsD;AACpD,aAAKzB,OAAL,CAAaE,QAAb,CAAsBwB,SAAtB,CAAgCC,MAAhC,CAAuCF,KAAvC,CACKoB,IADL,CACU1C,gBAAgBD,QAAhB,CAAyBwB,SAAzB,CAAmCC,MAAnC,CAA0CF,KAA1C,CAAgD,CAAhD,CADV;AAED;AACF;;AAED;;;;;;;0CAIsBV,Q,EAAU;AAC9B,UAAMa,OAAO,KAAKkB,aAAL,CAAmB/B,QAAnB,CAAb;AACA,UAAMgC,gBAAgB,KAAKC,sBAAL,CAA4BjC,QAA5B,CAAtB;AACA,UAAIoB,iBAAiBY,cAAcZ,cAAnC;;AAEA;;;;;;;AAOAA,uBAAiB,KAAKzC,aAAL,CAAmBuD,wBAAnB,CAA4Cd,cAA5C,CAAjB;;AAEA;;;;AAIAA,uBAAiB,KAAKtC,WAAL,CAAiBqD,eAAjB,CAAiCf,cAAjC,CAAjB;AACAP,WAAKK,OAAL,GAAeE,cAAf;AACA,WAAKgB,IAAL;AACD;;;2CAEsB;AACrB,UAAI,KAAK5B,uBAAT,EAAkC;AAChC,aAAK3B,YAAL,CAAkBwD,QAAlB,CAA2B,QAA3B,EAAqC,QAArC;AACD,OAFD,MAEO;AACL,aAAKxD,YAAL,CAAkByD,WAAlB,CAA8B,QAA9B;AACD;AACF;;;yCAEoB;AACnB,WAAKzD,YAAL,CAAkByD,WAAlB,CAA8B,QAA9B;AACD;;;oDAE+B;AAC9B,WAAKF,IAAL;AACD;;;2BAEM;AACL,WAAKxD,cAAL,CAAoB2D,WAApB;AACD;;;;;;AAGHlE,yBAAyBmE,OAAzB,GAAmC,CAC/B,SAD+B,EAE/B,WAF+B,EAG/B,QAH+B,EAI/B,cAJ+B,EAK/B,QAL+B,EAM/B,eAN+B,EAO/B,gBAP+B,EAQ/B,cAR+B,EAS/B,aAT+B,CAAnC;;kBAYenE,wB","file":"authorNotebookController.js","sourcesContent":["'use strict';\n\nclass AuthorNotebookController {\n\n  constructor(\n      $filter,\n      $mdDialog,\n      $state,\n      $stateParams,\n      $scope,\n      ConfigService,\n      ProjectService,\n      SpaceService,\n      UtilService) {\n    this.$filter = $filter;\n    this.$mdDialog = $mdDialog;\n    this.$state = $state;\n    this.$stateParams = $stateParams;\n    this.$scope = $scope;\n    this.ConfigService = ConfigService;\n    this.ProjectService = ProjectService;\n    this.SpaceService = SpaceService;\n    this.UtilService = UtilService;\n    this.$translate = this.$filter('translate');\n    this.projectId = this.$stateParams.projectId;\n    this.project = this.ProjectService.project;\n    this.reportIdToAuthoringNote = {};\n\n    if (this.project.notebook == null) {\n      const projectTemplate = this.ProjectService.getNewProjectTemplate();\n      this.project.notebook = projectTemplate.notebook;\n    }\n\n    this.initializeNotesAuthoring();\n\n    this.$scope.$on('assetSelected', (event, args) => {\n      if (args.projectId == this.projectId && args.assetItem != null &&\n          args.assetItem.fileName != null && args.target != null) {\n        const assetsDirectoryPath = this.ConfigService.getProjectAssetsDirectoryPath();\n        const fileName = args.assetItem.fileName;\n        const fullAssetPath = assetsDirectoryPath + '/' + fileName;\n        const reportId = args.target;\n        const summernoteId = 'summernoteNotebook_' + reportId;\n        if (this.UtilService.isImage(fileName)) {\n          this.UtilService.restoreSummernoteCursorPosition(summernoteId);\n          this.UtilService.insertImageIntoSummernote(summernoteId, fullAssetPath, fileName);\n        } else if (this.UtilService.isVideo(fileName)) {\n          this.UtilService.restoreSummernoteCursorPosition(summernoteId);\n          this.UtilService.insertVideoIntoSummernote(summernoteId, fullAssetPath);\n        }\n      }\n      this.$mdDialog.hide();\n    });\n\n    this.isPublicNotebookEnabled = this.ProjectService.isSpaceExists('public');\n  }\n\n  initializeNotesAuthoring() {\n    const notes = this.project.notebook.itemTypes.report.notes;\n    if (notes != null) {\n      for (const note of notes) {\n        this.initializeNoteAuthoring(note);\n      }\n    }\n  }\n\n  initializeNoteAuthoring(note) {\n    const authoringReportNote = {};\n    const reportId = note.reportId;\n    authoringReportNote.summernoteId = 'summernoteNotebook_' + reportId;\n    let noteContent = this.ProjectService.replaceAssetPaths(note.content);\n    noteContent = this.UtilService.replaceWISELinks(noteContent);\n    authoringReportNote.summernoteHTML = noteContent;\n\n    //create the custom button for inserting WISE assets into summernote\n    const insertAssetButton = this.UtilService.createInsertAssetButton(\n        this, this.projectId, null, null, reportId,\n        this.$translate('INSERT_ASSET'));\n\n    //the options that specifies the tools to display in the summernote prompt\n    authoringReportNote.summernoteOptions = {\n      toolbar: [\n        ['style', ['style']],\n        ['font', ['bold', 'underline', 'clear']],\n        ['fontname', ['fontname']],\n        ['fontsize', ['fontsize']],\n        ['color', ['color']],\n        ['para', ['ul', 'ol', 'paragraph']],\n        ['table', ['table']],\n        ['insert', ['link', 'video']],\n        ['view', ['fullscreen', 'codeview', 'help']],\n        ['customButton', ['insertAssetButton']]\n      ],\n      height: 300,\n      disableDragAndDrop: true,\n      buttons: {\n        insertAssetButton: insertAssetButton\n      }\n    };\n\n    this.setReportIdToAuthoringNote(reportId, authoringReportNote);\n  }\n\n  setReportIdToAuthoringNote(reportId, authoringReportNote) {\n    this.reportIdToAuthoringNote[reportId] = authoringReportNote;\n  }\n\n  getAuthoringReportNote(id) {\n    return this.reportIdToAuthoringNote[id];\n  }\n\n  getReportNote(id) {\n    const notes = this.project.notebook.itemTypes.report.notes;\n    for (let note of notes) {\n      if (note.reportId === id) {\n        return note;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Adds a new report note item to this project's notebook.\n   * Currently we limit 1 report note per project.\n   */\n  addReportNote() {\n    const projectTemplate = this.ProjectService.getNewProjectTemplate();\n    if (this.project.notebook.itemTypes.report.notes == null) {\n      this.project.notebook.itemTypes.report.notes = [];\n    }\n    if (this.project.notebook.itemTypes.report.notes < 1) {\n      this.project.notebook.itemTypes.report.notes\n          .push(projectTemplate.notebook.itemTypes.report.notes[0]);\n    }\n  }\n\n  /**\n   * A note was changed\n   * @param note the note that was changed\n   */\n  summernoteHTMLChanged(reportId) {\n    const note = this.getReportNote(reportId);\n    const authoringNote = this.getAuthoringReportNote(reportId);\n    let summernoteHTML = authoringNote.summernoteHTML;\n\n    /*\n     * remove the absolute asset paths\n     * e.g.\n     * <img src='https://wise.berkeley.edu/curriculum/3/assets/sun.png'/>\n     * will be changed to\n     * <img src='sun.png'/>\n     */\n    summernoteHTML = this.ConfigService.removeAbsoluteAssetPaths(summernoteHTML);\n\n    /*\n     * replace <a> and <button> elements with <wiselink> elements when\n     * applicable\n     */\n    summernoteHTML = this.UtilService.insertWISELinks(summernoteHTML);\n    note.content = summernoteHTML;\n    this.save();\n  }\n\n  togglePublicNotebook() {\n    if (this.isPublicNotebookEnabled) {\n      this.SpaceService.addSpace('public', 'Public');\n    } else {\n      this.SpaceService.removeSpace('public');\n    }\n  }\n\n  disablePublicSpace() {\n    this.SpaceService.removeSpace('public');\n  }\n\n  authoringViewComponentChanged() {\n    this.save();\n  }\n\n  save() {\n    this.ProjectService.saveProject();\n  }\n}\n\nAuthorNotebookController.$inject = [\n    '$filter',\n    '$mdDialog',\n    '$state',\n    '$stateParams',\n    '$scope',\n    'ConfigService',\n    'ProjectService',\n    'SpaceService',\n    'UtilService'\n];\n\nexport default AuthorNotebookController;\n"]}