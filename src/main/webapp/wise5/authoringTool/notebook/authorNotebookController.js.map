{"version":3,"sources":["authorNotebookController.es6"],"names":["AuthorNotebookController","$filter","$mdDialog","$state","$stateParams","$scope","ConfigService","ProjectService","SpaceService","UtilService","$translate","projectId","project","reportIdToAuthoringNote","notebook","projectTemplate","getNewProjectTemplate","teacherNotebook","enabled","initializeStudentNotesAuthoring","initializeTeacherNotesAuthoring","$on","event","args","assetItem","fileName","target","assetsDirectoryPath","getProjectAssetsDirectoryPath","fullAssetPath","reportId","summernoteId","isImage","restoreSummernoteCursorPosition","insertImageIntoSummernote","isVideo","insertVideoIntoSummernote","hide","isPublicNotebookEnabled","isSpaceExists","initializeNotesAuthoring","itemTypes","report","notes","note","initializeNoteAuthoring","authoringReportNote","noteContent","replaceAssetPaths","content","replaceWISELinks","summernoteHTML","insertAssetButton","createInsertAssetButton","summernoteOptions","toolbar","height","disableDragAndDrop","buttons","setReportIdToAuthoringNote","id","studentNotes","teacherNotes","push","getReportNote","authoringNote","getAuthoringReportNote","removeAbsoluteAssetPaths","insertWISELinks","save","addSpace","removeSpace","saveProject","$inject"],"mappings":"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","file":"authorNotebookController.js","sourcesContent":["'use strict';\n\nclass AuthorNotebookController {\n\n  constructor(\n      $filter,\n      $mdDialog,\n      $state,\n      $stateParams,\n      $scope,\n      ConfigService,\n      ProjectService,\n      SpaceService,\n      UtilService) {\n    this.$filter = $filter;\n    this.$mdDialog = $mdDialog;\n    this.$state = $state;\n    this.$stateParams = $stateParams;\n    this.$scope = $scope;\n    this.ConfigService = ConfigService;\n    this.ProjectService = ProjectService;\n    this.SpaceService = SpaceService;\n    this.UtilService = UtilService;\n    this.$translate = this.$filter('translate');\n    this.projectId = this.$stateParams.projectId;\n    this.project = this.ProjectService.project;\n    this.reportIdToAuthoringNote = {};\n\n    if (this.project.notebook == null) {\n      const projectTemplate = this.ProjectService.getNewProjectTemplate();\n      this.project.notebook = projectTemplate.notebook;\n    }\n\n    if (this.project.teacherNotebook == null) {\n      const projectTemplate = this.ProjectService.getNewProjectTemplate();\n      projectTemplate.teacherNotebook.enabled = false;\n      this.project.teacherNotebook = projectTemplate.teacherNotebook;\n    }\n\n    this.initializeStudentNotesAuthoring();\n    this.initializeTeacherNotesAuthoring();\n\n    this.$scope.$on('assetSelected', (event, args) => {\n      if (args.projectId == this.projectId && args.assetItem != null &&\n          args.assetItem.fileName != null && args.target != null) {\n        const assetsDirectoryPath = this.ConfigService.getProjectAssetsDirectoryPath();\n        const fileName = args.assetItem.fileName;\n        const fullAssetPath = assetsDirectoryPath + '/' + fileName;\n        const reportId = args.target;\n        const summernoteId = 'summernoteNotebook_' + reportId;\n        if (this.UtilService.isImage(fileName)) {\n          this.UtilService.restoreSummernoteCursorPosition(summernoteId);\n          this.UtilService.insertImageIntoSummernote(summernoteId, fullAssetPath, fileName);\n        } else if (this.UtilService.isVideo(fileName)) {\n          this.UtilService.restoreSummernoteCursorPosition(summernoteId);\n          this.UtilService.insertVideoIntoSummernote(summernoteId, fullAssetPath);\n        }\n      }\n      this.$mdDialog.hide();\n    });\n\n    this.isPublicNotebookEnabled = this.ProjectService.isSpaceExists('public');\n  }\n\n  initializeStudentNotesAuthoring() {\n    this.initializeNotesAuthoring(this.project.notebook.itemTypes.report.notes);\n  }\n\n  initializeTeacherNotesAuthoring() {\n    this.initializeNotesAuthoring(this.project.teacherNotebook.itemTypes.report.notes);\n  }\n\n  initializeNotesAuthoring(notes) {\n    for (const note of notes) {\n      this.initializeNoteAuthoring(note);\n    }\n  }\n\n  initializeNoteAuthoring(note) {\n    const authoringReportNote = {};\n    const reportId = note.reportId;\n    authoringReportNote.summernoteId = 'summernoteNotebook_' + reportId;\n    let noteContent = this.ProjectService.replaceAssetPaths(note.content);\n    noteContent = this.UtilService.replaceWISELinks(noteContent);\n    authoringReportNote.summernoteHTML = noteContent;\n\n    //create the custom button for inserting WISE assets into summernote\n    const insertAssetButton = this.UtilService.createInsertAssetButton(\n        this, this.projectId, null, null, reportId,\n        this.$translate('INSERT_ASSET'));\n\n    //the options that specifies the tools to display in the summernote prompt\n    authoringReportNote.summernoteOptions = {\n      toolbar: [\n        ['style', ['style']],\n        ['font', ['bold', 'underline', 'clear']],\n        ['fontname', ['fontname']],\n        ['fontsize', ['fontsize']],\n        ['color', ['color']],\n        ['para', ['ul', 'ol', 'paragraph']],\n        ['table', ['table']],\n        ['insert', ['link', 'video']],\n        ['view', ['fullscreen', 'codeview', 'help']],\n        ['customButton', ['insertAssetButton']]\n      ],\n      height: 300,\n      disableDragAndDrop: true,\n      buttons: {\n        insertAssetButton: insertAssetButton\n      }\n    };\n\n    this.setReportIdToAuthoringNote(reportId, authoringReportNote);\n  }\n\n  setReportIdToAuthoringNote(reportId, authoringReportNote) {\n    this.reportIdToAuthoringNote[reportId] = authoringReportNote;\n  }\n\n  getAuthoringReportNote(id) {\n    return this.reportIdToAuthoringNote[id];\n  }\n\n  getReportNote(id) {\n    const studentNotes = this.project.notebook.itemTypes.report.notes;\n    for (let note of studentNotes) {\n      if (note.reportId === id) {\n        return note;\n      }\n    }\n    const teacherNotes = this.project.teacherNotebook.itemTypes.report.notes;\n    for (let note of teacherNotes) {\n      if (note.reportId === id) {\n        return note;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Adds a new report note item to this project's notebook.\n   * Currently we limit 1 report note per project.\n   */\n  addReportNote() {\n    const projectTemplate = this.ProjectService.getNewProjectTemplate();\n    if (this.project.notebook.itemTypes.report.notes == null) {\n      this.project.notebook.itemTypes.report.notes = [];\n    }\n    if (this.project.notebook.itemTypes.report.notes < 1) {\n      this.project.notebook.itemTypes.report.notes\n          .push(projectTemplate.notebook.itemTypes.report.notes[0]);\n    }\n  }\n\n  reportStarterTextChanged(reportId) {\n    const note = this.getReportNote(reportId);\n    const authoringNote = this.getAuthoringReportNote(reportId);\n    let summernoteHTML = authoringNote.summernoteHTML;\n\n    /*\n     * remove the absolute asset paths\n     * e.g.\n     * <img src='https://wise.berkeley.edu/curriculum/3/assets/sun.png'/>\n     * will be changed to\n     * <img src='sun.png'/>\n     */\n    summernoteHTML = this.ConfigService.removeAbsoluteAssetPaths(summernoteHTML);\n\n    /*\n     * replace <a> and <button> elements with <wiselink> elements when\n     * applicable\n     */\n    summernoteHTML = this.UtilService.insertWISELinks(summernoteHTML);\n    note.content = summernoteHTML;\n    this.save();\n  }\n\n  togglePublicNotebook() {\n    if (this.isPublicNotebookEnabled) {\n      this.SpaceService.addSpace('public', 'Public');\n    } else {\n      this.SpaceService.removeSpace('public');\n    }\n  }\n\n  disablePublicSpace() {\n    this.SpaceService.removeSpace('public');\n  }\n\n  authoringViewComponentChanged() {\n    this.save();\n  }\n\n  save() {\n    this.ProjectService.saveProject();\n  }\n}\n\nAuthorNotebookController.$inject = [\n    '$filter',\n    '$mdDialog',\n    '$state',\n    '$stateParams',\n    '$scope',\n    'ConfigService',\n    'ProjectService',\n    'SpaceService',\n    'UtilService'\n];\n\nexport default AuthorNotebookController;\n"]}