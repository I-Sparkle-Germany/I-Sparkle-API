{"version":3,"sources":["authorNotebookController.es6"],"names":["AuthorNotebookController","$filter","$mdDialog","$state","$stateParams","$scope","ConfigService","ProjectService","UtilService","$translate","projectId","project","notebook","projectTemplate","getNewProjectTemplate","notes","itemTypes","report","note","reportId","summernoteId","noteContent","replaceAssetPaths","content","replaceWISELinks","summernoteHTML","insertAssetString","insertAssetButton","createInsertAssetButton","summernoteOptions","toolbar","height","disableDragAndDrop","buttons","$on","event","args","assetItem","fileName","target","assetsDirectoryPath","getProjectAssetsDirectoryPath","fullAssetPath","isImage","$","summernote","isVideo","videoElement","document","createElement","controls","innerHTML","hide","push","commitMessage","saveProject","go","removeAbsoluteAssetPaths","insertWISELinks","$inject"],"mappings":"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","file":"authorNotebookController.js","sourcesContent":["'use strict';\n\nclass AuthorNotebookController {\n\n  constructor(\n      $filter,\n      $mdDialog,\n      $state,\n      $stateParams,\n      $scope,\n      ConfigService,\n      ProjectService,\n      UtilService) {\n    this.$filter = $filter;\n    this.$mdDialog = $mdDialog;\n    this.$state = $state;\n    this.$stateParams = $stateParams;\n    this.$scope = $scope;\n    this.ConfigService = ConfigService;\n    this.ProjectService = ProjectService;\n    this.UtilService = UtilService;\n    this.$translate = this.$filter('translate');\n    this.projectId = this.$stateParams.projectId;\n    this.project = this.ProjectService.project;\n\n    if (this.project.notebook == null) {\n      // some old projects may not have the notebook settings,\n      // so copy default settings from template project.\n      let projectTemplate = this.ProjectService.getNewProjectTemplate();\n      this.project.notebook = projectTemplate.notebook;\n    }\n    let notes = this.project.notebook.itemTypes.report.notes;\n    if (notes != null) {\n      for (const note of notes) {\n        if (note != null) {\n          const reportId = note.reportId;\n          note.summernoteId = 'summernoteNotebook_' + reportId;\n          let noteContent = this.ProjectService.replaceAssetPaths(note.content);\n          noteContent = this.UtilService.replaceWISELinks(noteContent);\n          note.summernoteHTML = noteContent;\n\n          // the tooltip text for the insert WISE asset button\n          const insertAssetString = this.$translate('INSERT_ASSET');\n\n          /*\n           * create the custom button for inserting WISE assets into\n           * summernote\n           */\n          const insertAssetButton =\n              this.UtilService.createInsertAssetButton(\n                  this, this.projectId, null, null, reportId, insertAssetString);\n\n          /*\n           * the options that specifies the tools to display in the\n           * summernote prompt\n           */\n          note.summernoteOptions = {\n            toolbar: [\n              ['style', ['style']],\n              ['font', ['bold', 'underline', 'clear']],\n              ['fontname', ['fontname']],\n              ['fontsize', ['fontsize']],\n              ['color', ['color']],\n              ['para', ['ul', 'ol', 'paragraph']],\n              ['table', ['table']],\n              ['insert', ['link', 'video']],\n              ['view', ['fullscreen', 'codeview', 'help']],\n              ['customButton', ['insertAssetButton']]\n            ],\n            height: 300,\n            disableDragAndDrop: true,\n            buttons: {\n              insertAssetButton: insertAssetButton\n            }\n          };\n        }\n      }\n    }\n\n    /*\n     * Listen for the assetSelected event which occurs when the user\n     * selects an asset from the choose asset popup\n     */\n    this.$scope.$on('assetSelected', (event, args) => {\n      // make sure the event was fired for this component\n      if (args != null && args.projectId == this.projectId &&\n          args.assetItem != null && args.assetItem.fileName != null &&\n          args.target != null) {\n        /*\n         * get the assets directory path\n         * e.g.\n         * /wise/curriculum/3/\n         */\n        let assetsDirectoryPath =\n            this.ConfigService.getProjectAssetsDirectoryPath();\n        let fileName = args.assetItem.fileName;\n        let fullAssetPath = assetsDirectoryPath + '/' + fileName;\n\n        // the target is the summernote prompt element\n        let reportId = args.target;\n        let summernoteId = 'summernoteNotebook_' + reportId;\n        if (this.UtilService.isImage(fileName)) {\n          /*\n           * move the cursor back to its position when the asset chooser\n           * popup was clicked\n           */\n          $('#' + summernoteId).summernote('editor.restoreRange');\n          $('#' + summernoteId).summernote('editor.focus');\n\n          // add the image html\n          $('#' + summernoteId)\n              .summernote('insertImage', fullAssetPath, fileName);\n        } else if (this.UtilService.isVideo(fileName)) {\n          /*\n           * move the cursor back to its position when the asset chooser\n           * popup was clicked\n           */\n          $('#' + summernoteId).summernote('editor.restoreRange');\n          $('#' + summernoteId).summernote('editor.focus');\n\n          // insert the video element\n          let videoElement = document.createElement('video');\n          videoElement.controls = 'true';\n          videoElement.innerHTML =\n              '<source ng-src=\"' + fullAssetPath + '\" type=\"video/mp4\">';\n          $('#' + summernoteId).summernote('insertNode', videoElement);\n        }\n      }\n      this.$mdDialog.hide();\n    });\n  }\n\n  /**\n   * Adds a new report note item to this project's notebook.\n   * Currently we limit 1 report note per project.\n   */\n  addReportNote() {\n    // some old projects may not have the notebook settings,\n    // so copy default settings from template project.\n    let projectTemplate = this.ProjectService.getNewProjectTemplate();\n    if (this.project.notebook.itemTypes.report.notes == null) {\n      this.project.notebook.itemTypes.report.notes = [];\n    }\n    if (this.project.notebook.itemTypes.report.notes < 1) {\n      this.project.notebook.itemTypes.report.notes\n          .push(projectTemplate.notebook.itemTypes.report.notes[0]);\n    }\n  }\n\n  exit() {\n    let notes = this.project.notebook.itemTypes.report.notes;\n    if (notes != null) {\n      for (let note of notes) {\n        if (note != null) {\n          // remove the temporary fields that were used for bookkeeping\n          delete note['summernoteId'];\n          delete note['summernoteHTML'];\n          delete note['summernoteOptions'];\n        }\n      }\n    }\n    let commitMessage = this.$translate('madeChangesToNotebook');\n    this.ProjectService.saveProject(commitMessage);\n    this.$state.go('root.project', {projectId: this.projectId});\n  }\n\n  /**\n   * A note was changed\n   * @param note the note that was changed\n   */\n  summernoteHTMLChanged(note) {\n    if (note != null) {\n      let summernoteHTML = note.summernoteHTML;\n      /*\n       * remove the absolute asset paths\n       * e.g.\n       * <img src='https://wise.berkeley.edu/curriculum/3/assets/sun.png'/>\n       * will be changed to\n       * <img src='sun.png'/>\n       */\n      summernoteHTML =\n          this.ConfigService.removeAbsoluteAssetPaths(summernoteHTML);\n\n      /*\n       * replace <a> and <button> elements with <wiselink> elements when\n       * applicable\n       */\n      summernoteHTML = this.UtilService.insertWISELinks(summernoteHTML);\n      note.content = summernoteHTML;\n    }\n  }\n}\n\nAuthorNotebookController.$inject = [\n    '$filter',\n    '$mdDialog',\n    '$state',\n    '$stateParams',\n    '$scope',\n    'ConfigService',\n    'ProjectService',\n    'UtilService'\n];\n\nexport default AuthorNotebookController;\n"]}