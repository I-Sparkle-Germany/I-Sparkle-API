{"version":3,"sources":["authorNotebookController.es6"],"names":["AuthorNotebookController","$filter","$mdDialog","$state","$stateParams","$scope","$timeout","ConfigService","ProjectService","SpaceService","UtilService","$translate","projectId","project","reportIdToAuthoringNote","notebook","projectTemplate","getNewProjectTemplate","initializeNotesAuthoring","$on","event","args","assetItem","fileName","target","assetsDirectoryPath","getProjectAssetsDirectoryPath","fullAssetPath","reportId","summernoteId","isImage","$","summernote","isVideo","videoElement","document","createElement","controls","innerHTML","hide","isPublicNotebookEnabled","isSpaceExists","notes","itemTypes","report","note","initializeNoteAuthoring","authoringReportNote","noteContent","replaceAssetPaths","content","replaceWISELinks","summernoteHTML","insertAssetString","insertAssetButton","createInsertAssetButton","summernoteOptions","toolbar","height","disableDragAndDrop","buttons","setReportIdToAuthoringNote","id","push","getReportNote","authoringNote","getAuthoringReportNote","removeAbsoluteAssetPaths","insertWISELinks","save","addSpace","removeSpace","saveProject","$inject"],"mappings":"AAAA;;;;;;;;;;IAEMA,wB;AAEJ,oCACIC,OADJ,EAEIC,SAFJ,EAGIC,MAHJ,EAIIC,YAJJ,EAKIC,MALJ,EAMIC,QANJ,EAOIC,aAPJ,EAQIC,cARJ,EASIC,YATJ,EAUIC,WAVJ,EAUiB;AAAA;;AAAA;;AACf,SAAKT,OAAL,GAAeA,OAAf;AACA,SAAKC,SAAL,GAAiBA,SAAjB;AACA,SAAKC,MAAL,GAAcA,MAAd;AACA,SAAKC,YAAL,GAAoBA,YAApB;AACA,SAAKC,MAAL,GAAcA,MAAd;AACA,SAAKC,QAAL,GAAgBA,QAAhB;AACA,SAAKC,aAAL,GAAqBA,aAArB;AACA,SAAKC,cAAL,GAAsBA,cAAtB;AACA,SAAKC,YAAL,GAAoBA,YAApB;AACA,SAAKC,WAAL,GAAmBA,WAAnB;AACA,SAAKC,UAAL,GAAkB,KAAKV,OAAL,CAAa,WAAb,CAAlB;AACA,SAAKW,SAAL,GAAiB,KAAKR,YAAL,CAAkBQ,SAAnC;AACA,SAAKC,OAAL,GAAe,KAAKL,cAAL,CAAoBK,OAAnC;AACA,SAAKC,uBAAL,GAA+B,EAA/B;;AAEA,QAAI,KAAKD,OAAL,CAAaE,QAAb,IAAyB,IAA7B,EAAmC;AACjC;AACA;AACA,UAAIC,kBAAkB,KAAKR,cAAL,CAAoBS,qBAApB,EAAtB;AACA,WAAKJ,OAAL,CAAaE,QAAb,GAAwBC,gBAAgBD,QAAxC;AACD;AACD,SAAKG,wBAAL;;AAEA;;;;AAIA,SAAKb,MAAL,CAAYc,GAAZ,CAAgB,eAAhB,EAAiC,UAACC,KAAD,EAAQC,IAAR,EAAiB;AAChD;AACA,UAAIA,QAAQ,IAAR,IAAgBA,KAAKT,SAAL,IAAkB,MAAKA,SAAvC,IACAS,KAAKC,SAAL,IAAkB,IADlB,IAC0BD,KAAKC,SAAL,CAAeC,QAAf,IAA2B,IADrD,IAEAF,KAAKG,MAAL,IAAe,IAFnB,EAEyB;AACvB;;;;;AAKA,YAAIC,sBACA,MAAKlB,aAAL,CAAmBmB,6BAAnB,EADJ;AAEA,YAAIH,WAAWF,KAAKC,SAAL,CAAeC,QAA9B;AACA,YAAII,gBAAgBF,sBAAsB,GAAtB,GAA4BF,QAAhD;;AAEA;AACA,YAAIK,WAAWP,KAAKG,MAApB;AACA,YAAIK,eAAe,wBAAwBD,QAA3C;AACA,YAAI,MAAKlB,WAAL,CAAiBoB,OAAjB,CAAyBP,QAAzB,CAAJ,EAAwC;AACtC;;;;AAIAQ,YAAE,MAAMF,YAAR,EAAsBG,UAAtB,CAAiC,qBAAjC;AACAD,YAAE,MAAMF,YAAR,EAAsBG,UAAtB,CAAiC,cAAjC;;AAEA;AACAD,YAAE,MAAMF,YAAR,EACKG,UADL,CACgB,aADhB,EAC+BL,aAD/B,EAC8CJ,QAD9C;AAED,SAXD,MAWO,IAAI,MAAKb,WAAL,CAAiBuB,OAAjB,CAAyBV,QAAzB,CAAJ,EAAwC;AAC7C;;;;AAIAQ,YAAE,MAAMF,YAAR,EAAsBG,UAAtB,CAAiC,qBAAjC;AACAD,YAAE,MAAMF,YAAR,EAAsBG,UAAtB,CAAiC,cAAjC;;AAEA;AACA,cAAIE,eAAeC,SAASC,aAAT,CAAuB,OAAvB,CAAnB;AACAF,uBAAaG,QAAb,GAAwB,MAAxB;AACAH,uBAAaI,SAAb,GACI,qBAAqBX,aAArB,GAAqC,qBADzC;AAEAI,YAAE,MAAMF,YAAR,EAAsBG,UAAtB,CAAiC,YAAjC,EAA+CE,YAA/C;AACD;AACF;AACD,YAAKhC,SAAL,CAAeqC,IAAf;AACD,KA9CD;;AAgDA,SAAKC,uBAAL,GAA+B,KAAKhC,cAAL,CAAoBiC,aAApB,CAAkC,QAAlC,CAA/B;AACD;;;;+CAE0B;AACzB,UAAIC,QAAQ,KAAK7B,OAAL,CAAaE,QAAb,CAAsB4B,SAAtB,CAAgCC,MAAhC,CAAuCF,KAAnD;AACA,UAAIA,SAAS,IAAb,EAAmB;AAAA;AAAA;AAAA;;AAAA;AACjB,+BAAmBA,KAAnB,8HAA0B;AAAA,gBAAfG,IAAe;;AACxB,iBAAKC,uBAAL,CAA6BD,IAA7B;AACD;AAHgB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAIlB;AACF;;;4CAEuBA,I,EAAM;AAC5B,UAAME,sBAAsB,EAA5B;AACA,UAAMnB,WAAWiB,KAAKjB,QAAtB;AACAmB,0BAAoBlB,YAApB,GAAmC,wBAAwBD,QAA3D;AACA,UAAIoB,cAAc,KAAKxC,cAAL,CAAoByC,iBAApB,CAAsCJ,KAAKK,OAA3C,CAAlB;AACAF,oBAAc,KAAKtC,WAAL,CAAiByC,gBAAjB,CAAkCH,WAAlC,CAAd;AACAD,0BAAoBK,cAApB,GAAqCJ,WAArC;;AAEA;AACA,UAAMK,oBAAoB,KAAK1C,UAAL,CAAgB,cAAhB,CAA1B;;AAEA;;;;AAIA,UAAM2C,oBACJ,KAAK5C,WAAL,CAAiB6C,uBAAjB,CACE,IADF,EACQ,KAAK3C,SADb,EACwB,IADxB,EAC8B,IAD9B,EACoCgB,QADpC,EAC8CyB,iBAD9C,CADF;;AAIA;;;;AAIAN,0BAAoBS,iBAApB,GAAwC;AACtCC,iBAAS,CACP,CAAC,OAAD,EAAU,CAAC,OAAD,CAAV,CADO,EAEP,CAAC,MAAD,EAAS,CAAC,MAAD,EAAS,WAAT,EAAsB,OAAtB,CAAT,CAFO,EAGP,CAAC,UAAD,EAAa,CAAC,UAAD,CAAb,CAHO,EAIP,CAAC,UAAD,EAAa,CAAC,UAAD,CAAb,CAJO,EAKP,CAAC,OAAD,EAAU,CAAC,OAAD,CAAV,CALO,EAMP,CAAC,MAAD,EAAS,CAAC,IAAD,EAAO,IAAP,EAAa,WAAb,CAAT,CANO,EAOP,CAAC,OAAD,EAAU,CAAC,OAAD,CAAV,CAPO,EAQP,CAAC,QAAD,EAAW,CAAC,MAAD,EAAS,OAAT,CAAX,CARO,EASP,CAAC,MAAD,EAAS,CAAC,YAAD,EAAe,UAAf,EAA2B,MAA3B,CAAT,CATO,EAUP,CAAC,cAAD,EAAiB,CAAC,mBAAD,CAAjB,CAVO,CAD6B;AAatCC,gBAAQ,GAb8B;AActCC,4BAAoB,IAdkB;AAetCC,iBAAS;AACPN,6BAAmBA;AADZ;AAf6B,OAAxC;;AAoBA,WAAKO,0BAAL,CAAgCjC,QAAhC,EAA0CmB,mBAA1C;AACD;;;+CAE0BnB,Q,EAAUmB,mB,EAAqB;AACxD,WAAKjC,uBAAL,CAA6Bc,QAA7B,IAAyCmB,mBAAzC;AACD;;;2CAEsBe,E,EAAI;AACzB,aAAO,KAAKhD,uBAAL,CAA6BgD,EAA7B,CAAP;AACD;;;kCAEaA,E,EAAI;AAChB,UAAMpB,QAAQ,KAAK7B,OAAL,CAAaE,QAAb,CAAsB4B,SAAtB,CAAgCC,MAAhC,CAAuCF,KAArD;AADgB;AAAA;AAAA;;AAAA;AAEhB,8BAAiBA,KAAjB,mIAAwB;AAAA,cAAfG,IAAe;;AACtB,cAAIA,KAAKjB,QAAL,KAAkBkC,EAAtB,EAA0B;AACxB,mBAAOjB,IAAP;AACD;AACF;AANe;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAOhB,aAAO,IAAP;AACD;;AAED;;;;;;;oCAIgB;AACd;AACA;AACA,UAAI7B,kBAAkB,KAAKR,cAAL,CAAoBS,qBAApB,EAAtB;AACA,UAAI,KAAKJ,OAAL,CAAaE,QAAb,CAAsB4B,SAAtB,CAAgCC,MAAhC,CAAuCF,KAAvC,IAAgD,IAApD,EAA0D;AACxD,aAAK7B,OAAL,CAAaE,QAAb,CAAsB4B,SAAtB,CAAgCC,MAAhC,CAAuCF,KAAvC,GAA+C,EAA/C;AACD;AACD,UAAI,KAAK7B,OAAL,CAAaE,QAAb,CAAsB4B,SAAtB,CAAgCC,MAAhC,CAAuCF,KAAvC,GAA+C,CAAnD,EAAsD;AACpD,aAAK7B,OAAL,CAAaE,QAAb,CAAsB4B,SAAtB,CAAgCC,MAAhC,CAAuCF,KAAvC,CACKqB,IADL,CACU/C,gBAAgBD,QAAhB,CAAyB4B,SAAzB,CAAmCC,MAAnC,CAA0CF,KAA1C,CAAgD,CAAhD,CADV;AAED;AACF;;AAED;;;;;;;0CAIsBd,Q,EAAU;AAC9B,UAAMiB,OAAO,KAAKmB,aAAL,CAAmBpC,QAAnB,CAAb;AACA,UAAMqC,gBAAgB,KAAKC,sBAAL,CAA4BtC,QAA5B,CAAtB;AACA,UAAIwB,iBAAiBa,cAAcb,cAAnC;;AAEA;;;;;;;AAOAA,uBAAiB,KAAK7C,aAAL,CAAmB4D,wBAAnB,CAA4Cf,cAA5C,CAAjB;;AAEA;;;;AAIAA,uBAAiB,KAAK1C,WAAL,CAAiB0D,eAAjB,CAAiChB,cAAjC,CAAjB;AACAP,WAAKK,OAAL,GAAeE,cAAf;AACA,WAAKiB,IAAL;AACD;;;2CAEsB;AACrB,UAAI,KAAK7B,uBAAT,EAAkC;AAChC,aAAK/B,YAAL,CAAkB6D,QAAlB,CAA2B,QAA3B,EAAqC,QAArC;AACD,OAFD,MAEO;AACL,aAAK7D,YAAL,CAAkB8D,WAAlB,CAA8B,QAA9B;AACD;AACF;;;yCAEoB;AACnB,WAAK9D,YAAL,CAAkB8D,WAAlB,CAA8B,QAA9B;AACD;;;oDAE+B;AAC9B,WAAKF,IAAL;AACD;;;2BAEM;AACL,WAAK7D,cAAL,CAAoBgE,WAApB;AACD;;;;;;AAGHxE,yBAAyByE,OAAzB,GAAmC,CAC/B,SAD+B,EAE/B,WAF+B,EAG/B,QAH+B,EAI/B,cAJ+B,EAK/B,QAL+B,EAM/B,UAN+B,EAO/B,eAP+B,EAQ/B,gBAR+B,EAS/B,cAT+B,EAU/B,aAV+B,CAAnC;;kBAaezE,wB","file":"authorNotebookController.js","sourcesContent":["'use strict';\n\nclass AuthorNotebookController {\n\n  constructor(\n      $filter,\n      $mdDialog,\n      $state,\n      $stateParams,\n      $scope,\n      $timeout,\n      ConfigService,\n      ProjectService,\n      SpaceService,\n      UtilService) {\n    this.$filter = $filter;\n    this.$mdDialog = $mdDialog;\n    this.$state = $state;\n    this.$stateParams = $stateParams;\n    this.$scope = $scope;\n    this.$timeout = $timeout;\n    this.ConfigService = ConfigService;\n    this.ProjectService = ProjectService;\n    this.SpaceService = SpaceService;\n    this.UtilService = UtilService;\n    this.$translate = this.$filter('translate');\n    this.projectId = this.$stateParams.projectId;\n    this.project = this.ProjectService.project;\n    this.reportIdToAuthoringNote = {};\n\n    if (this.project.notebook == null) {\n      // some old projects may not have the notebook settings,\n      // so copy default settings from template project.\n      let projectTemplate = this.ProjectService.getNewProjectTemplate();\n      this.project.notebook = projectTemplate.notebook;\n    }\n    this.initializeNotesAuthoring();\n\n    /*\n     * Listen for the assetSelected event which occurs when the user\n     * selects an asset from the choose asset popup\n     */\n    this.$scope.$on('assetSelected', (event, args) => {\n      // make sure the event was fired for this component\n      if (args != null && args.projectId == this.projectId &&\n          args.assetItem != null && args.assetItem.fileName != null &&\n          args.target != null) {\n        /*\n         * get the assets directory path\n         * e.g.\n         * /wise/curriculum/3/\n         */\n        let assetsDirectoryPath =\n            this.ConfigService.getProjectAssetsDirectoryPath();\n        let fileName = args.assetItem.fileName;\n        let fullAssetPath = assetsDirectoryPath + '/' + fileName;\n\n        // the target is the summernote prompt element\n        let reportId = args.target;\n        let summernoteId = 'summernoteNotebook_' + reportId;\n        if (this.UtilService.isImage(fileName)) {\n          /*\n           * move the cursor back to its position when the asset chooser\n           * popup was clicked\n           */\n          $('#' + summernoteId).summernote('editor.restoreRange');\n          $('#' + summernoteId).summernote('editor.focus');\n\n          // add the image html\n          $('#' + summernoteId)\n              .summernote('insertImage', fullAssetPath, fileName);\n        } else if (this.UtilService.isVideo(fileName)) {\n          /*\n           * move the cursor back to its position when the asset chooser\n           * popup was clicked\n           */\n          $('#' + summernoteId).summernote('editor.restoreRange');\n          $('#' + summernoteId).summernote('editor.focus');\n\n          // insert the video element\n          let videoElement = document.createElement('video');\n          videoElement.controls = 'true';\n          videoElement.innerHTML =\n              '<source ng-src=\"' + fullAssetPath + '\" type=\"video/mp4\">';\n          $('#' + summernoteId).summernote('insertNode', videoElement);\n        }\n      }\n      this.$mdDialog.hide();\n    });\n\n    this.isPublicNotebookEnabled = this.ProjectService.isSpaceExists(\"public\");\n  }\n\n  initializeNotesAuthoring() {\n    let notes = this.project.notebook.itemTypes.report.notes;\n    if (notes != null) {\n      for (const note of notes) {\n        this.initializeNoteAuthoring(note);\n      }\n    }\n  }\n\n  initializeNoteAuthoring(note) {\n    const authoringReportNote = {};\n    const reportId = note.reportId;\n    authoringReportNote.summernoteId = 'summernoteNotebook_' + reportId;\n    let noteContent = this.ProjectService.replaceAssetPaths(note.content);\n    noteContent = this.UtilService.replaceWISELinks(noteContent);\n    authoringReportNote.summernoteHTML = noteContent;\n\n    // the tooltip text for the insert WISE asset button\n    const insertAssetString = this.$translate('INSERT_ASSET');\n\n    /*\n     * create the custom button for inserting WISE assets into\n     * summernote\n     */\n    const insertAssetButton =\n      this.UtilService.createInsertAssetButton(\n        this, this.projectId, null, null, reportId, insertAssetString);\n\n    /*\n     * the options that specifies the tools to display in the\n     * summernote prompt\n     */\n    authoringReportNote.summernoteOptions = {\n      toolbar: [\n        ['style', ['style']],\n        ['font', ['bold', 'underline', 'clear']],\n        ['fontname', ['fontname']],\n        ['fontsize', ['fontsize']],\n        ['color', ['color']],\n        ['para', ['ul', 'ol', 'paragraph']],\n        ['table', ['table']],\n        ['insert', ['link', 'video']],\n        ['view', ['fullscreen', 'codeview', 'help']],\n        ['customButton', ['insertAssetButton']]\n      ],\n      height: 300,\n      disableDragAndDrop: true,\n      buttons: {\n        insertAssetButton: insertAssetButton\n      }\n    };\n\n    this.setReportIdToAuthoringNote(reportId, authoringReportNote);\n  }\n\n  setReportIdToAuthoringNote(reportId, authoringReportNote) {\n    this.reportIdToAuthoringNote[reportId] = authoringReportNote;\n  }\n\n  getAuthoringReportNote(id) {\n    return this.reportIdToAuthoringNote[id];\n  }\n\n  getReportNote(id) {\n    const notes = this.project.notebook.itemTypes.report.notes;\n    for (let note of notes) {\n      if (note.reportId === id) {\n        return note;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Adds a new report note item to this project's notebook.\n   * Currently we limit 1 report note per project.\n   */\n  addReportNote() {\n    // some old projects may not have the notebook settings,\n    // so copy default settings from template project.\n    let projectTemplate = this.ProjectService.getNewProjectTemplate();\n    if (this.project.notebook.itemTypes.report.notes == null) {\n      this.project.notebook.itemTypes.report.notes = [];\n    }\n    if (this.project.notebook.itemTypes.report.notes < 1) {\n      this.project.notebook.itemTypes.report.notes\n          .push(projectTemplate.notebook.itemTypes.report.notes[0]);\n    }\n  }\n\n  /**\n   * A note was changed\n   * @param note the note that was changed\n   */\n  summernoteHTMLChanged(reportId) {\n    const note = this.getReportNote(reportId);\n    const authoringNote = this.getAuthoringReportNote(reportId);\n    let summernoteHTML = authoringNote.summernoteHTML;\n\n    /*\n     * remove the absolute asset paths\n     * e.g.\n     * <img src='https://wise.berkeley.edu/curriculum/3/assets/sun.png'/>\n     * will be changed to\n     * <img src='sun.png'/>\n     */\n    summernoteHTML = this.ConfigService.removeAbsoluteAssetPaths(summernoteHTML);\n\n    /*\n     * replace <a> and <button> elements with <wiselink> elements when\n     * applicable\n     */\n    summernoteHTML = this.UtilService.insertWISELinks(summernoteHTML);\n    note.content = summernoteHTML;\n    this.save();\n  }\n\n  togglePublicNotebook() {\n    if (this.isPublicNotebookEnabled) {\n      this.SpaceService.addSpace(\"public\", \"Public\");\n    } else {\n      this.SpaceService.removeSpace(\"public\");\n    }\n  }\n\n  disablePublicSpace() {\n    this.SpaceService.removeSpace(\"public\");\n  }\n\n  authoringViewComponentChanged() {\n    this.save();\n  }\n\n  save() {\n    this.ProjectService.saveProject();\n  }\n}\n\nAuthorNotebookController.$inject = [\n    '$filter',\n    '$mdDialog',\n    '$state',\n    '$stateParams',\n    '$scope',\n    '$timeout',\n    'ConfigService',\n    'ProjectService',\n    'SpaceService',\n    'UtilService'\n];\n\nexport default AuthorNotebookController;\n"]}