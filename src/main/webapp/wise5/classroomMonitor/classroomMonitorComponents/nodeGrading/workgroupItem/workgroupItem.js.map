{"version":3,"sources":["workgroupItem.es6"],"names":["WorkgroupItemController","$scope","$translate","AnnotationService","ConfigService","NotificationService","ProjectService","StudentStatusService","TeacherDataService","$onInit","statusClass","statusText","score","alertStatus","latestWorkTime","hasMaxScore","maxScore","nodeHasWork","nodeId","getAlertNotifications","$on","event","notification","toWorkgroupId","workgroupId","type","alertNotifications","push","updateModel","status","previousComponentState","args","annotation","isCompleted","hasWork","hasNewWork","hasAlert","length","hasNewAlert","getNodeScoreByWorkgroupIdAndNodeId","then","newWork","completed","visited","partiallyCompleted","noWork","notVisited","result","nAlerts","i","alert","timeDismissed","componentStates","getComponentStatesByNodeId","n","componentState","serverSaveTime","latestAnnotationTime","annotations","getAnnotationsByNodeId","fromWorkgroupId","getWorkgroupId","studentStatus","getStudentStatusForWorkgroupId","nodeStatus","nodeStatuses","getScore","$inject","WorkgroupItem","bindings","canViewStudentNames","canGradeStudentWork","showWork","controller","template"],"mappings":"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","file":"workgroupItem.js","sourcesContent":["\"use strict\";\n\nclass WorkgroupItemController {\n    constructor($scope,\n                $translate,\n                AnnotationService,\n                ConfigService,\n                NotificationService,\n                ProjectService,\n                StudentStatusService,\n                TeacherDataService) {\n        this.$scope = $scope;\n        this.$translate = $translate;\n        this.AnnotationService = AnnotationService;\n        this.ConfigService = ConfigService;\n        this.NotificationService = NotificationService;\n        this.ProjectService = ProjectService;\n        this.StudentStatusService = StudentStatusService;\n        this.TeacherDataService = TeacherDataService;\n\n        this.$onInit = () => {\n            this.statusClass = '';\n            this.statusText = '';\n            this.score = null;\n            this.alertStatus = null;\n            this.latestWorkTime = null;\n            this.hasMaxScore = (typeof this.maxScore === 'number');\n            this.nodeHasWork = this.ProjectService.nodeHasWork(this.nodeId);\n            this.getAlertNotifications();\n        };\n\n        this.$scope.$on('notificationAdded', (event, notification) => {\n            if (notification.toWorkgroupId === this.workgroupId && notification.type === 'CRaterResult') {\n                // there is a new notification for this workgroup and it is a CRaterResult\n                // TODO: expand to encompass other notification types that should be shown to teacher\n                this.alertNotifications.push(notification);\n                this.updateModel();\n            }\n        });\n\n        this.$scope.$on('notificationChanged', (event, notification) => {\n            if (notification.toWorkgroupId === this.workgroupId && notification.type === 'CRaterResult') {\n                // a CRaterResult notification for this workgroup has changed\n                // TODO: expand to encompass other notification types that should be shown to teacher\n                this.getAlertNotifications();\n            }\n        });\n\n        this.$scope.$on('studentStatusReceived', (event, status) => {\n            let workgroupId = status.workgroupId;\n            let nodeId = status.previousComponentState.nodeId;\n            if (workgroupId === this.workgroupId && nodeId === this.nodeId) {\n                // workgroup has a new componentState for this node\n                this.updateModel();\n            }\n        });\n\n        this.$scope.$on('annotationReceived', (event, args) => {\n            let annotation = args.annotation;\n\n            if (annotation) {\n                let workgroupId = annotation.toWorkgroupId;\n                let nodeId = annotation.nodeId;\n                if (workgroupId === this.workgroupId && nodeId === this.nodeId) {\n                    // workgroup has a new componentState for this node\n                    this.updateModel();\n                }\n            }\n        });\n    };\n\n    getAlertNotifications() {\n        let args = {};\n        args.nodeId = this.nodeId;\n        args.workgroupId = this.workgroupId;\n        this.alertNotifications = this.NotificationService.getAlertNotifications(args);\n        this.updateModel();\n    }\n\n    updateModel() {\n        let isCompleted = this.isCompleted();\n        let hasWork = this.hasWork();\n        let hasNewWork = this.hasNewWork();\n        let hasAlert = (this.alertNotifications.length > 0);\n        let hasNewAlert = this.hasNewAlert();\n        this.score = this.getNodeScoreByWorkgroupIdAndNodeId(this.workgroupId, this.nodeId);\n\n        if (hasNewWork) {\n            this.statusClass = 'info';\n            this.$translate('newWork').then(newWork => {\n                this.statusText = newWork;\n            });\n        } else if (isCompleted) {\n            this.statusClass = 'success';\n            if (this.hasMaxScore) {\n                this.$translate('completed').then(completed => {\n                    this.statusText = completed;\n                });\n            } else {\n                this.$translate('visited').then(visited => {\n                    this.statusText = visited;\n                });\n            }\n        } else if (hasWork) {\n            this.$translate('partiallyCompleted').then(partiallyCompleted => {\n                this.statusText = partiallyCompleted;\n            });\n        } else {\n            if (this.nodeHasWork) {\n                this.$translate('noWork').then(noWork => {\n                    this.statusText = noWork;\n                });\n            } else {\n                this.$translate('notVisited').then(notVisited => {\n                    this.statusText = notVisited;\n                });\n            }\n        }\n\n        if (hasNewAlert) {\n            this.statusClass = 'warn';\n            this.alertStatus = 'new';\n        } else if (hasAlert) {\n            this.alertStatus = 'dismissed';\n        }\n    }\n\n    hasNewAlert() {\n        let result = false;\n\n        let nAlerts = this.alertNotifications.length;\n        for (let i = 0; i < nAlerts; i++) {\n            let alert = this.alertNotifications[i];\n            if (!alert.timeDismissed) {\n                result = true;\n                break;\n            }\n        }\n\n        return result;\n    }\n\n    hasWork() {\n        // TODO: store this info in the nodeStatus so we don't have to calculate every time?\n        let result = false;\n\n        let componentStates = this.TeacherDataService.getComponentStatesByNodeId(this.nodeId);\n        let n = componentStates.length-1;\n\n        // loop through component states for this node, starting with most recent\n        for (let i = n; i > -1; i--) {\n            let componentState = componentStates[i];\n            if (componentState.workgroupId === this.workgroupId) {\n                result = true;\n                this.latestWorkTime = componentState.serverSaveTime;\n                break;\n            }\n        }\n\n        return result;\n    }\n\n    hasNewWork() {\n        // TODO: store this info in the nodeStatus so we don't have to calculate every time?\n        let result = false;\n        let latestAnnotationTime = null;\n\n        let annotations = this.TeacherDataService.getAnnotationsByNodeId(this.nodeId);\n        let n = annotations.length-1;\n\n        // loop through annotations for this node, starting with most recent\n        for (let i = n; i > -1; i--) {\n            let annotation = annotations[i];\n            // TODO: support checking for annotations from shared teachers?\n            if (annotation.toWorkgroupId === this.workgroupId && annotation.fromWorkgroupId === this.ConfigService.getWorkgroupId()) {\n                latestAnnotationTime = annotation.serverSaveTime;\n                break;\n            }\n        }\n\n        if (this.latestWorkTime > latestAnnotationTime) {\n            result = true;\n        }\n\n        return result;\n    }\n\n    isCompleted() {\n        let result = false;\n        let studentStatus = this.StudentStatusService.getStudentStatusForWorkgroupId(this.workgroupId);\n        let nodeStatus = studentStatus.nodeStatuses[this.nodeId];\n\n        if (nodeStatus) {\n            result = nodeStatus.isCompleted;\n        }\n\n        return result;\n    }\n\n    getNodeScoreByWorkgroupIdAndNodeId(workgroupId, nodeId) {\n        let score = this.AnnotationService.getScore(workgroupId, nodeId);\n        return (typeof score === 'number' ? score : '-');\n    }\n}\n\nWorkgroupItemController.$inject = [\n    '$scope',\n    '$translate',\n    'AnnotationService',\n    'ConfigService',\n    'NotificationService',\n    'ProjectService',\n    'StudentStatusService',\n    'TeacherDataService'\n];\n\nconst WorkgroupItem = {\n    bindings: {\n        canViewStudentNames: '<',\n        canGradeStudentWork: '<',\n        maxScore: '<',\n        nodeId: '<',\n        workgroupId: '<',\n        showWork: '<'\n    },\n    controller: WorkgroupItemController,\n    template:\n        `<md-list-item class=\"list-item list-item-condensed md-whiteframe-z1\"\n                       ng-class=\"{'list-item--warn': $ctrl.statusClass === 'warn', 'list-item--info': $ctrl.statusClass === 'info', 'list-item--expanded': $ctrl.showWork}\"\n                       ng-click=\"$ctrl.showWork = !$ctrl.showWork\"\n                       layout-wrap>\n            <div class=\"md-list-item-text\" layout=\"row\" flex>\n                <div flex layout=\"row\" layout-align=\"start center\">\n                    <workgroup-info workgroup-id=\"$ctrl.workgroupId\" can-view-student-names=\"$ctrl.canViewStudentNames\" alert-status=\"{{$ctrl.alertStatus}}\"></workgroup-info>\n                </div>\n                <div flex=\"30\" layout=\"row\" layout-align=\"center center\">\n                    <workgroup-node-status status-text=\"{{$ctrl.statusText}}\" status-class=\"{{$ctrl.statusClass}}\"></workgroup-node-status>\n                </div>\n                <div ng-if=\"$ctrl.hasMaxScore\" flex=\"20\" layout=\"row\" layout-align=\"center center\">\n                    <workgroup-node-score score=\"{{$ctrl.score}}\" max-score=\"{{$ctrl.maxScore}}\"></workgroup-node-score>\n                </div>\n            </div>\n        </md-list-item>\n        <workgroup-node-grading workgroup-id=\"$ctrl.workgroupId\"\n                                node-id=\"{{$ctrl.nodeId}}\"\n                                latest-work-time=\"$ctrl.latestWorkTime\"\n                                ng-show=\"$ctrl.showWork\"></workgroup-node-grading>`\n};\n\nexport default WorkgroupItem;\n"]}