{"version":3,"sources":["workgroupItem.es6"],"names":["WorkgroupItemController","$scope","$translate","AnnotationService","ConfigService","NotificationService","ProjectService","StudentStatusService","TeacherDataService","$onInit","statusClass","statusText","score","alertStatus","latestWorkTime","hasMaxScore","maxScore","nodeHasWork","nodeId","getAlertNotifications","$onChanges","changesObj","hiddenComponents","angular","copy","currentValue","$on","event","notification","toWorkgroupId","workgroupId","type","alertNotifications","push","updateModel","status","previousComponentState","args","annotation","studentWork","isCompleted","hasWork","hasNewWork","hasAlert","length","hasNewAlert","getNodeScoreByWorkgroupIdAndNodeId","then","newWork","completed","visited","partiallyCompleted","node","noWork","notVisited","result","nAlerts","i","alert","timeDismissed","componentStates","getComponentStatesByNodeId","n","componentState","serverSaveTime","latestAnnotationTime","annotations","getAnnotationsByNodeId","fromWorkgroupId","getWorkgroupId","studentStatus","getStudentStatusForWorkgroupId","nodeStatus","nodeStatuses","getScore","value","onUpdate","$inject","WorkgroupItem","bindings","canViewStudentNames","canGradeStudentWork","showWork","controller","template"],"mappings":"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","file":"workgroupItem.js","sourcesContent":["\"use strict\";\n\nclass WorkgroupItemController {\n    constructor($scope,\n                $translate,\n                AnnotationService,\n                ConfigService,\n                NotificationService,\n                ProjectService,\n                StudentStatusService,\n                TeacherDataService) {\n        this.$scope = $scope;\n        this.$translate = $translate;\n        this.AnnotationService = AnnotationService;\n        this.ConfigService = ConfigService;\n        this.NotificationService = NotificationService;\n        this.ProjectService = ProjectService;\n        this.StudentStatusService = StudentStatusService;\n        this.TeacherDataService = TeacherDataService;\n\n        this.$onInit = () => {\n            this.statusClass = '';\n            this.statusText = '';\n            this.score = null;\n            this.alertStatus = null;\n            this.latestWorkTime = null;\n            this.hasMaxScore = (typeof this.maxScore === 'number');\n            this.nodeHasWork = this.ProjectService.nodeHasWork(this.nodeId);\n            this.getAlertNotifications();\n        };\n\n        this.$onChanges = (changesObj) => {\n\n            if (changesObj.hiddenComponents) {\n                this.hiddenComponents = angular.copy(changesObj.hiddenComponents.currentValue);\n            }\n        };\n\n        this.$scope.$on('notificationAdded', (event, notification) => {\n            if (notification.toWorkgroupId === this.workgroupId && notification.type === 'CRaterResult') {\n                // there is a new notification for this workgroup and it is a CRaterResult\n                // TODO: expand to encompass other notification types that should be shown to teacher\n                this.alertNotifications.push(notification);\n                this.updateModel();\n            }\n        });\n\n        this.$scope.$on('notificationChanged', (event, notification) => {\n            if (notification.toWorkgroupId === this.workgroupId && notification.type === 'CRaterResult') {\n                // a CRaterResult notification for this workgroup has changed\n                // TODO: expand to encompass other notification types that should be shown to teacher\n                this.getAlertNotifications();\n            }\n        });\n\n        this.$scope.$on('studentStatusReceived', (event, status) => {\n            let workgroupId = status.workgroupId;\n            let nodeId = status.previousComponentState.nodeId;\n            if (workgroupId === this.workgroupId && nodeId === this.nodeId) {\n                // workgroup has a new componentState for this node\n                this.updateModel();\n            }\n        });\n\n        this.$scope.$on('annotationReceived', (event, args) => {\n            let annotation = args.annotation;\n\n            if (annotation) {\n                let workgroupId = annotation.toWorkgroupId;\n                let nodeId = annotation.nodeId;\n                if (workgroupId === this.workgroupId && nodeId === this.nodeId) {\n                    // workgroup has a new annotation for this node\n                    this.updateModel();\n                }\n            }\n        });\n\n        this.$scope.$on('studentWorkReceived', (event, args) => {\n            let studentWork = args.studentWork;\n\n            if (studentWork != null) {\n                let workgroupId = studentWork.workgroupId;\n                let nodeId = studentWork.nodeId;\n                if (workgroupId === this.workgroupId && nodeId === this.nodeId) {\n                    // workgroup has a new componentState for this node\n                    this.updateModel();\n                }\n            }\n        });\n    };\n\n    getAlertNotifications() {\n        let args = {};\n        args.nodeId = this.nodeId;\n        args.workgroupId = this.workgroupId;\n        this.alertNotifications = this.NotificationService.getAlertNotifications(args);\n        this.updateModel();\n    }\n\n    updateModel() {\n        let isCompleted = this.isCompleted();\n        let hasWork = this.hasWork();\n        let hasNewWork = this.hasNewWork();\n        let hasAlert = (this.alertNotifications.length > 0);\n        let hasNewAlert = this.hasNewAlert();\n        this.score = this.getNodeScoreByWorkgroupIdAndNodeId(this.workgroupId, this.nodeId);\n\n        if (hasNewWork) {\n            this.statusClass = 'info';\n            this.$translate('newWork').then(newWork => {\n                this.statusText = newWork;\n            });\n        } else if (isCompleted) {\n            this.statusClass = 'success';\n            if (this.hasMaxScore) {\n                this.$translate('completed').then(completed => {\n                    this.statusText = completed;\n                });\n            } else {\n                this.$translate('visited').then(visited => {\n                    this.statusText = visited;\n                });\n            }\n        } else if (hasWork) {\n            this.$translate('partiallyCompleted').then(partiallyCompleted => {\n                this.statusText = partiallyCompleted;\n            });\n        } else {\n            if (this.node) {\n                this.$translate('noWork').then(noWork => {\n                    this.statusText = noWork;\n                });\n            } else {\n                this.$translate('notVisited').then(notVisited => {\n                    this.statusText = notVisited;\n                });\n            }\n        }\n\n        if (hasNewAlert) {\n            this.statusClass = 'warn';\n            this.alertStatus = 'new';\n        } else if (hasAlert) {\n            this.alertStatus = 'dismissed';\n        }\n    }\n\n    hasNewAlert() {\n        let result = false;\n\n        let nAlerts = this.alertNotifications.length;\n        for (let i = 0; i < nAlerts; i++) {\n            let alert = this.alertNotifications[i];\n            if (!alert.timeDismissed) {\n                result = true;\n                break;\n            }\n        }\n\n        return result;\n    }\n\n    hasWork() {\n        // TODO: store this info in the nodeStatus so we don't have to calculate every time?\n        let result = false;\n\n        let componentStates = this.TeacherDataService.getComponentStatesByNodeId(this.nodeId);\n        let n = componentStates.length-1;\n\n        // loop through component states for this node, starting with most recent\n        for (let i = n; i > -1; i--) {\n            let componentState = componentStates[i];\n            if (componentState.workgroupId === this.workgroupId) {\n                result = true;\n                this.latestWorkTime = componentState.serverSaveTime;\n                break;\n            }\n        }\n\n        return result;\n    }\n\n    hasNewWork() {\n        // TODO: store this info in the nodeStatus so we don't have to calculate every time?\n        let result = false;\n        let latestAnnotationTime = null;\n\n        let annotations = this.TeacherDataService.getAnnotationsByNodeId(this.nodeId);\n        let n = annotations.length-1;\n\n        // loop through annotations for this node, starting with most recent\n        for (let i = n; i > -1; i--) {\n            let annotation = annotations[i];\n            // TODO: support checking for annotations from shared teachers?\n            if (annotation.toWorkgroupId === this.workgroupId && annotation.fromWorkgroupId === this.ConfigService.getWorkgroupId()) {\n                latestAnnotationTime = annotation.serverSaveTime;\n                break;\n            }\n        }\n\n        if (this.latestWorkTime > latestAnnotationTime) {\n            result = true;\n        }\n\n        return result;\n    }\n\n    isCompleted() {\n        let result = false;\n        let studentStatus = this.StudentStatusService.getStudentStatusForWorkgroupId(this.workgroupId);\n        let nodeStatus = studentStatus.nodeStatuses[this.nodeId];\n\n        if (nodeStatus) {\n            result = nodeStatus.isCompleted;\n        }\n\n        return result;\n    }\n\n    getNodeScoreByWorkgroupIdAndNodeId(workgroupId, nodeId) {\n        let score = this.AnnotationService.getScore(workgroupId, nodeId);\n        return (typeof score === 'number' ? score : '-');\n    }\n\n    updateHiddenCompnents(value) {\n        this.onUpdate({value: value});\n    }\n}\n\nWorkgroupItemController.$inject = [\n    '$scope',\n    '$translate',\n    'AnnotationService',\n    'ConfigService',\n    'NotificationService',\n    'ProjectService',\n    'StudentStatusService',\n    'TeacherDataService'\n];\n\nconst WorkgroupItem = {\n    bindings: {\n        canViewStudentNames: '<',\n        canGradeStudentWork: '<',\n        maxScore: '<',\n        nodeId: '<',\n        workgroupId: '<',\n        showWork: '<',\n        hiddenComponents: '<',\n        onUpdate: '&'\n    },\n    controller: WorkgroupItemController,\n    template:\n        `<md-list-item class=\"list-item list-item-condensed md-whiteframe-z1\"\n                       ng-class=\"{'list-item--warn': $ctrl.statusClass === 'warn', 'list-item--info': $ctrl.statusClass === 'info', 'list-item--expanded': $ctrl.showWork}\"\n                       ng-click=\"$ctrl.showWork = !$ctrl.showWork\"\n                       layout-wrap>\n            <div class=\"md-list-item-text\" layout=\"row\" flex>\n                <div flex layout=\"row\" layout-align=\"start center\">\n                    <workgroup-info workgroup-id=\"$ctrl.workgroupId\" can-view-student-names=\"$ctrl.canViewStudentNames\" alert-status=\"{{$ctrl.alertStatus}}\"></workgroup-info>\n                </div>\n                <div flex=\"30\" layout=\"row\" layout-align=\"center center\">\n                    <workgroup-node-status status-text=\"{{$ctrl.statusText}}\" status-class=\"{{$ctrl.statusClass}}\"></workgroup-node-status>\n                </div>\n                <div ng-if=\"$ctrl.hasMaxScore\" flex=\"20\" layout=\"row\" layout-align=\"center center\">\n                    <workgroup-node-score score=\"{{$ctrl.score}}\" max-score=\"{{$ctrl.maxScore}}\"></workgroup-node-score>\n                </div>\n            </div>\n        </md-list-item>\n        <workgroup-node-grading workgroup-id=\"$ctrl.workgroupId\"\n                                node-id=\"{{$ctrl.nodeId}}\"\n                                latest-work-time=\"$ctrl.latestWorkTime\"\n                                ng-if=\"$ctrl.showWork\"\n                                hidden-components=\"$ctrl.hiddenComponents\"\n                                on-update=\"$ctrl.updateHiddenCompnents(value)\"></workgroup-node-grading>`\n};\n\nexport default WorkgroupItem;\n"]}