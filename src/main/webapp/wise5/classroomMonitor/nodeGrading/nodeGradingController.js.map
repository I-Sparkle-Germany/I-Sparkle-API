{"version":3,"sources":["nodeGradingController.es6"],"names":["NodeGradingController","$filter","$mdDialog","$scope","$state","$stateParams","$timeout","AnnotationService","ConfigService","NodeService","NotificationService","ProjectService","StudentStatusService","TeacherDataService","$translate","nodeId","maxScore","getMaxScoreForNode","showScore","nodeHasWork","startNodeId","getStartNodeId","rootNode","getRootNode","sort","nodeGradingSort","hiddenComponents","showRubricButton","retrieveStudentDataByNodeId","then","nodeContent","teacherWorkgroupId","getWorkgroupId","periods","node","getNodeById","workgroups","getClassmateUserInfos","workgroupsById","workVisibilityById","canViewStudentNames","canGradeStudentWork","permissions","getPermissions","annotationMappings","componentStateHistory","setWorkgroupsById","nodeHasRubric","document","body","scrollTop","documentElement","$on","event","notification","type","workgroupId","toWorkgroupId","updateWorkgroup","status","previousComponentState","args","annotation","studentWork","context","componentId","componentType","category","data","saveEvent","l","length","i","id","init","workgroup","alertNotifications","getAlertNotificationsByWorkgroupId","hasAlert","hasNewAlert","workgroupHasNewAlert","completionStatus","getNodeCompletionStatusByWorkgroupId","hasNewWork","getWorkgroupCompletionStatus","score","getNodeScoreByWorkgroupId","angular","copy","getAlertNotifications","newAlert","alert","timeDismissed","isCompleted","latestWorkTime","getLatestWorkTimeByWorkgroupId","latestAnnotationTime","getLatestAnnotationTimeByWorkgroupId","studentStatus","getStudentStatusForWorkgroupId","nodeStatus","nodeStatuses","events","getEventsByWorkgroupIdAndNodeId","time","componentStates","getComponentStatesByNodeId","n","componentState","serverSaveTime","annotations","getAnnotationsByNodeId","fromWorkgroupId","getScore","hasWork","getComponentTemplatePath","components","isDisabled","c","component","lockAfterSubmit","getComponents","tempComponent","getLatestComponentStateByWorkgroupIdNodeIdAndComponentId","getComponentStatesByWorkgroupIdAndNodeId","getUserNameByWorkgroupId","stepWorkId","getAnnotationByStepWorkIdAndType","saveAnnotation","getPeriodIdByWorkgroupId","getCurrentPeriod","currentPeriod","periodId","completionPercentage","getNodeCompletion","averageScore","getNodeAverageScore","count","getWorkgroupIdsOnNode","show","currentPeriodId","currentWorkgroup","getCurrentWorkgroup","parseInt","value","target","viewportOffsetTop","getBoundingClientRect","top","updateScroll","newViewportOffsetTop","delta","content","nodeRubric","rubric","componentRubric","stepNumberAndTitle","getNodePositionAndTitleByNodeId","popupHeader","tabHeader","rubricContent","replaceAssetPaths","popupContent","tabContent","template","controller","DialogController","openRubricInNewTab","w","window","open","write","hide","closeRubric","clickOutsideToClose","escapeToClose","orderBy","$inject"],"mappings":"AAAA;;;;;;;;;;IAEMA,qB;AAEF,mCAAYC,OAAZ,EACYC,SADZ,EAEYC,MAFZ,EAGYC,MAHZ,EAIYC,YAJZ,EAKYC,QALZ,EAMYC,iBANZ,EAOYC,aAPZ,EAQYC,WARZ,EASYC,mBATZ,EAUYC,cAVZ,EAWYC,oBAXZ,EAYYC,kBAZZ,EAYgC;AAAA;;AAAA;;AAE5B,aAAKZ,OAAL,GAAeA,OAAf;AACA,aAAKC,SAAL,GAAiBA,SAAjB;AACA,aAAKE,MAAL,GAAcA,MAAd;AACA,aAAKD,MAAL,GAAcA,MAAd;AACA,aAAKE,YAAL,GAAoBA,YAApB;AACA,aAAKC,QAAL,GAAgBA,QAAhB;AACA,aAAKC,iBAAL,GAAyBA,iBAAzB;AACA,aAAKC,aAAL,GAAqBA,aAArB;AACA,aAAKC,WAAL,GAAmBA,WAAnB;AACA,aAAKC,mBAAL,GAA2BA,mBAA3B;AACA,aAAKC,cAAL,GAAsBA,cAAtB;AACA,aAAKC,oBAAL,GAA4BA,oBAA5B;AACA,aAAKC,kBAAL,GAA0BA,kBAA1B;;AAEA,aAAKC,UAAL,GAAkB,KAAKb,OAAL,CAAa,WAAb,CAAlB;;AAEA,aAAKc,MAAL,GAAc,KAAKV,YAAL,CAAkBU,MAAhC;;AAEA;AACA,aAAKC,QAAL,GAAgB,KAAKL,cAAL,CAAoBM,kBAApB,CAAuC,KAAKF,MAA5C,CAAhB;AACA,aAAKG,SAAL,GAAiB,KAAKP,cAAL,CAAoBQ,WAApB,CAAgC,KAAKJ,MAArC,CAAjB;;AAEA,YAAIK,cAAc,KAAKT,cAAL,CAAoBU,cAApB,EAAlB;AACA,aAAKC,QAAL,GAAgB,KAAKX,cAAL,CAAoBY,WAApB,CAAgCH,WAAhC,CAAhB;;AAEA,aAAKI,IAAL,GAAY,KAAKX,kBAAL,CAAwBY,eAApC;;AAEA,aAAKC,gBAAL,GAAwB,EAAxB;;AAEA,aAAKC,gBAAL,GAAwB,KAAxB;;AAEA;AACA,aAAKd,kBAAL,CAAwBe,2BAAxB,CAAoD,KAAKb,MAAzD,EAAiEc,IAAjE,CAAsE,kBAAU;;AAE5E;AACA,kBAAKC,WAAL,GAAmB,IAAnB;;AAEA,kBAAKC,kBAAL,GAA0B,MAAKvB,aAAL,CAAmBwB,cAAnB,EAA1B;;AAEA,kBAAKC,OAAL,GAAe,EAAf;;AAEA,gBAAIC,OAAO,MAAKvB,cAAL,CAAoBwB,WAApB,CAAgC,MAAKpB,MAArC,CAAX;;AAEA,gBAAImB,QAAQ,IAAZ,EAAkB;;AAEd;AACA,sBAAKJ,WAAL,GAAmBI,IAAnB;AACH;;AAED,kBAAKE,UAAL,GAAkB,MAAK5B,aAAL,CAAmB6B,qBAAnB,EAAlB;AACA,kBAAKC,cAAL,GAAsB,EAAtB,CAlB4E,CAkBlD;AAC1B,kBAAKC,kBAAL,GAA0B,EAA1B,CAnB4E,CAmB9C;;AAE9B,kBAAKC,mBAAL,GAA2B,IAA3B;AACA,kBAAKC,mBAAL,GAA2B,IAA3B;;AAEA,gBAAIC,cAAc,MAAKlC,aAAL,CAAmBmC,cAAnB,EAAlB;AACA,kBAAKH,mBAAL,GAA2BE,YAAYF,mBAAvC;AACA,kBAAKC,mBAAL,GAA2BC,YAAYD,mBAAvC;;AAEA,kBAAKG,kBAAL,GAA0B,EAA1B;;AAEA,kBAAKC,qBAAL,GAA6B,EAA7B;;AAEA,kBAAKC,iBAAL;;AAEA,kBAAKnB,gBAAL,GAAwB,MAAKoB,aAAL,EAAxB;;AAEA;AACAC,qBAASC,IAAT,CAAcC,SAAd,GAA0BF,SAASG,eAAT,CAAyBD,SAAzB,GAAqC,CAA/D;AACH,SAtCD;;AAwCA,aAAK/C,MAAL,CAAYiD,GAAZ,CAAgB,mBAAhB,EAAqC,UAACC,KAAD,EAAQC,YAAR,EAAyB;AAC1D,gBAAIA,aAAaC,IAAb,KAAsB,cAA1B,EAA0C;AACtC;AACA;AACA,oBAAIC,cAAcF,aAAaG,aAA/B;AACA,oBAAI,MAAKnB,cAAL,CAAoBkB,WAApB,CAAJ,EAAsC;AAClC,0BAAKE,eAAL,CAAqBF,WAArB;AACH;AACJ;AACJ,SATD;;AAWA,aAAKrD,MAAL,CAAYiD,GAAZ,CAAgB,qBAAhB,EAAuC,UAACC,KAAD,EAAQC,YAAR,EAAyB;AAC5D,gBAAIA,aAAaC,IAAb,KAAsB,cAA1B,EAA0C;AACtC;AACA;AACA,oBAAIC,cAAcF,aAAaG,aAA/B;AACA,oBAAI,MAAKnB,cAAL,CAAoBkB,WAApB,CAAJ,EAAsC;AAClC,0BAAKE,eAAL,CAAqBF,WAArB;AACH;AACJ;AACJ,SATD;;AAWA,aAAKrD,MAAL,CAAYiD,GAAZ,CAAgB,uBAAhB,EAAyC,UAACC,KAAD,EAAQM,MAAR,EAAmB;AACxD;AACA,gBAAIH,cAAcG,OAAOH,WAAzB;AACA,gBAAIzC,SAAS4C,OAAOC,sBAAP,CAA8B7C,MAA3C;AACA,gBAAIA,WAAW,MAAKA,MAAhB,IAA0B,MAAKuB,cAAL,CAAoBkB,WAApB,CAA9B,EAAgE;AAC5D;AACA,sBAAKE,eAAL,CAAqBF,WAArB;AACH;AACJ,SARD;;AAUA,aAAKrD,MAAL,CAAYiD,GAAZ,CAAgB,oBAAhB,EAAsC,UAACC,KAAD,EAAQQ,IAAR,EAAiB;AACnD,gBAAIC,aAAaD,KAAKC,UAAtB;;AAEA,gBAAIA,UAAJ,EAAgB;AACZ,oBAAIN,cAAcM,WAAWL,aAA7B;AACA,oBAAI1C,UAAS+C,WAAW/C,MAAxB;AACA,oBAAIA,YAAW,MAAKA,MAAhB,IAA0B,MAAKuB,cAAL,CAAoBkB,WAApB,CAA9B,EAAgE;AAC5D;AACA,0BAAKE,eAAL,CAAqBF,WAArB;AACH;AACJ;AACJ,SAXD;;AAaA,aAAKrD,MAAL,CAAYiD,GAAZ,CAAgB,qBAAhB,EAAuC,UAACC,KAAD,EAAQQ,IAAR,EAAiB;AACpD,gBAAIE,cAAcF,KAAKE,WAAvB;;AAEA,gBAAIA,eAAe,IAAnB,EAAyB;AACrB,oBAAIP,cAAcO,YAAYP,WAA9B;AACA,oBAAIzC,WAASgD,YAAYhD,MAAzB;AACA,oBAAIA,aAAW,MAAKA,MAAhB,IAA0B,MAAKuB,cAAL,CAAoBkB,WAApB,CAA9B,EAAgE;AAC5D;AACA,0BAAKE,eAAL,CAAqBF,WAArB;AACH;AACJ;AACJ,SAXD;;AAaA;AACA,YAAIQ,UAAU,kBAAd;AAAA,YAAkCjD,SAAS,KAAKA,MAAhD;AAAA,YAAwDkD,cAAc,IAAtE;AAAA,YAA4EC,gBAAgB,IAA5F;AAAA,YACIC,WAAW,YADf;AAAA,YAC6Bd,QAAQ,0BADrC;AAAA,YACiEe,OAAO,EAAErD,QAAQ,KAAKA,MAAf,EADxE;AAEA,aAAKF,kBAAL,CAAwBwD,SAAxB,CAAkCL,OAAlC,EAA2CjD,MAA3C,EAAmDkD,WAAnD,EAAgEC,aAAhE,EAA+EC,QAA/E,EAAyFd,KAAzF,EAAgGe,IAAhG;AACH;;AAED;;;;;;;4CAGoB;AAChB,gBAAIE,IAAI,KAAKlC,UAAL,CAAgBmC,MAAxB;AACA,iBAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIF,CAApB,EAAuBE,GAAvB,EAA4B;AACxB,oBAAIC,KAAK,KAAKrC,UAAL,CAAgBoC,CAAhB,EAAmBhB,WAA5B;AACA,qBAAKlB,cAAL,CAAoBmC,EAApB,IAA0B,KAAKrC,UAAL,CAAgBoC,CAAhB,CAA1B;AACA,qBAAKjC,kBAAL,CAAwBkC,EAAxB,IAA8B,KAA9B;;AAEA,qBAAKf,eAAL,CAAqBe,EAArB,EAAyB,IAAzB;AACH;AACJ;;AAED;;;;;;;;wCAKgBjB,W,EAAakB,I,EAAM;AAC/B,gBAAIC,YAAY,KAAKrC,cAAL,CAAoBkB,WAApB,CAAhB;;AAEA,gBAAImB,SAAJ,EAAe;AACX,oBAAIC,qBAAqB,KAAKC,kCAAL,CAAwCrB,WAAxC,CAAzB;AACAmB,0BAAUG,QAAV,GAAqBF,mBAAmBL,MAAxC;AACAI,0BAAUI,WAAV,GAAwB,KAAKC,oBAAL,CAA0BJ,kBAA1B,CAAxB;AACA,oBAAIK,mBAAmB,KAAKC,oCAAL,CAA0C1B,WAA1C,CAAvB;AACAmB,0BAAUQ,UAAV,GAAuBF,iBAAiBE,UAAxC;AACAR,0BAAUM,gBAAV,GAA6B,KAAKG,4BAAL,CAAkCH,gBAAlC,CAA7B;AACAN,0BAAUU,KAAV,GAAkB,KAAKC,yBAAL,CAA+B9B,WAA/B,CAAlB;;AAEA,oBAAI,CAACkB,IAAL,EAAW;AACP,yBAAKpC,cAAL,CAAoBkB,WAApB,IAAmC+B,QAAQC,IAAR,CAAab,SAAb,CAAnC;AACH;AACJ;AACJ;;;2DAEkCnB,W,EAAa;AAC5C,gBAAIK,OAAO,EAAX;AACAA,iBAAK9C,MAAL,GAAc,KAAKA,MAAnB;AACA8C,iBAAKL,WAAL,GAAmBA,WAAnB;AACA,mBAAO,KAAK9C,mBAAL,CAAyB+E,qBAAzB,CAA+C5B,IAA/C,CAAP;AACH;;;6CAEoBe,kB,EAAoB;AACrC,gBAAIc,WAAW,KAAf;;AAEA,gBAAIpB,IAAIM,mBAAmBL,MAA3B;AACA,iBAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIF,CAApB,EAAuBE,GAAvB,EAA4B;AACxB,oBAAImB,QAAQf,mBAAmBJ,CAAnB,CAAZ;AACA,oBAAI,CAACmB,MAAMC,aAAX,EAA0B;AACtBF,+BAAW,IAAX;AACA;AACH;AACJ;;AAED,mBAAOA,QAAP;AACH;;AAED;;;;;;;;;6DAMqClC,W,EAAa;AAC9C,gBAAIqC,cAAc,KAAlB;;AAEA;AACA,gBAAIC,iBAAiB,KAAKC,8BAAL,CAAoCvC,WAApC,CAArB;;AAGA,gBAAIwC,uBAAuB,KAAKC,oCAAL,CAA0CzC,WAA1C,CAA3B;;AAEA,gBAAIsC,cAAJ,EAAoB;AAChB;AACA,oBAAII,gBAAgB,KAAKtF,oBAAL,CAA0BuF,8BAA1B,CAAyD3C,WAAzD,CAApB;AACA,oBAAI4C,aAAaF,cAAcG,YAAd,CAA2B,KAAKtF,MAAhC,CAAjB;;AAEA,oBAAIqF,UAAJ,EAAgB;AACZP,kCAAcO,WAAWP,WAAzB;AACH;AACJ;;AAED,gBAAI,CAAC,KAAKlF,cAAL,CAAoBQ,WAApB,CAAgC,KAAKJ,MAArC,CAAL,EAAmD;AAC/C;;;;;AAKA,oBAAIuF,SAAS,KAAKzF,kBAAL,CAAwB0F,+BAAxB,CAAwD/C,WAAxD,EAAqE,KAAKzC,MAA1E,CAAb;;AAEA,oBAAIuF,UAAU,IAAV,IAAkBA,OAAO/B,MAAP,GAAgB,CAAtC,EAAyC;AACrCsB,kCAAc,IAAd;AACH;AACJ;;AAED,mBAAO;AACHA,6BAAaA,WADV;AAEHC,gCAAgBA,cAFb;AAGHE,sCAAsBA;AAHnB,aAAP;AAKH;;;uDAE8BxC,W,EAAa;AACxC,gBAAIgD,OAAO,IAAX;AACA,gBAAIC,kBAAkB,KAAK5F,kBAAL,CAAwB6F,0BAAxB,CAAmD,KAAK3F,MAAxD,CAAtB;AACA,gBAAI4F,IAAIF,gBAAgBlC,MAAhB,GAAuB,CAA/B;;AAEA;AACA,iBAAK,IAAIC,IAAImC,CAAb,EAAgBnC,IAAI,CAAC,CAArB,EAAwBA,GAAxB,EAA6B;AACzB,oBAAIoC,iBAAiBH,gBAAgBjC,CAAhB,CAArB;AACA,oBAAIoC,eAAepD,WAAf,KAA+BA,WAAnC,EAAgD;AAC5C;AACAgD,2BAAOI,eAAeC,cAAtB;AACA;AACH;AACJ;;AAED,mBAAOL,IAAP;AACH;;;6DAEoChD,W,EAAa;AAC9C,gBAAIgD,OAAO,IAAX;AACA,gBAAIM,cAAc,KAAKjG,kBAAL,CAAwBkG,sBAAxB,CAA+C,KAAKhG,MAApD,CAAlB;AACA,gBAAI4F,IAAIG,YAAYvC,MAAZ,GAAmB,CAA3B;;AAEA;AACA,iBAAK,IAAIC,IAAImC,CAAb,EAAgBnC,IAAI,CAAC,CAArB,EAAwBA,GAAxB,EAA6B;AACzB,oBAAIV,aAAagD,YAAYtC,CAAZ,CAAjB;AACA;AACA,oBAAIV,WAAWL,aAAX,KAA6BD,WAA7B,IAA4CM,WAAWkD,eAAX,KAA+B,KAAKxG,aAAL,CAAmBwB,cAAnB,EAA/E,EAAoH;AAChHwE,2BAAO1C,WAAW+C,cAAlB;AACA;AACH;AACJ;;AAED,mBAAOL,IAAP;AACH;;AAED;;;;;;;;kDAK0BhD,W,EAAa;AACnC,gBAAI6B,QAAQ,KAAK9E,iBAAL,CAAuB0G,QAAvB,CAAgCzD,WAAhC,EAA6C,KAAKzC,MAAlD,CAAZ;AACA,mBAAQ,OAAOsE,KAAP,KAAiB,QAAjB,GAA4BA,KAA5B,GAAoC,CAAC,CAA7C;AACH;;AAED;;;;;;;;;qDAM6BJ,gB,EAAkB;AAC3C,gBAAIiC,UAAUjC,iBAAiBa,cAAjB,KAAoC,IAAlD;AACA,gBAAID,cAAcZ,iBAAiBY,WAAnC;;AAEA;AACA,gBAAIlC,SAAS,CAAb,CAL2C,CAK3B;;AAEhB,gBAAIkC,WAAJ,EAAiB;AACblC,yBAAS,CAAT;AACH,aAFD,MAEO,IAAIuD,OAAJ,EAAa;AAChBvD,yBAAS,CAAT;AACH;;AAED,mBAAOA,MAAP;AACH;;AAED;;;;;;;;iDAKyBO,a,EAAe;AACpC,mBAAO,KAAKzD,WAAL,CAAiB0G,wBAAjB,CAA0CjD,aAA1C,CAAP;AACH;;AAED;;;;;;;wCAIgB;AACZ,gBAAIkD,aAAa,IAAjB;;AAEA,gBAAI,KAAKtF,WAAL,IAAoB,IAAxB,EAA8B;AAC1BsF,6BAAa,KAAKtF,WAAL,CAAiBsF,UAA9B;AACH;;AAED,gBAAIA,cAAc,IAAd,IAAsB,KAAKC,UAA/B,EAA2C;AACvC,qBAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIF,WAAW7C,MAA/B,EAAuC+C,GAAvC,EAA4C;AACxC,wBAAIC,YAAYH,WAAWE,CAAX,CAAhB;;AAEAC,8BAAUF,UAAV,GAAuB,IAAvB;AACH;AACJ;;AAED,gBAAID,cAAc,IAAd,IAAsB,KAAKtF,WAAL,CAAiB0F,eAA3C,EAA4D;AACxD,qBAAKF,IAAI,CAAT,EAAYA,IAAIF,WAAW7C,MAA3B,EAAmC+C,GAAnC,EAAwC;AACpCC,gCAAYH,WAAWE,CAAX,CAAZ;;AAEAC,8BAAUC,eAAV,GAA4B,IAA5B;AACH;AACJ;;AAED,mBAAOJ,UAAP;AACH;;;yCAEgBnD,W,EAAa;AAC1B,gBAAIsD,YAAY,IAAhB;;AAEA,gBAAItD,eAAe,IAAnB,EAAyB;AACrB,oBAAImD,aAAa,KAAKK,aAAL,EAAjB;;AAEA,oBAAIL,cAAc,IAAlB,EAAwB;AACpB,yBAAK,IAAIE,IAAI,CAAb,EAAgBA,IAAIF,WAAW7C,MAA/B,EAAuC+C,GAAvC,EAA4C;AACxC,4BAAII,gBAAgBN,WAAWE,CAAX,CAApB;;AAEA,4BAAII,iBAAiB,IAArB,EAA2B;AACvB,gCAAIzD,gBAAgByD,cAAcjD,EAAlC,EAAsC;AAClC8C,4CAAYG,aAAZ;AACA;AACH;AACJ;AACJ;AACJ;AACJ;;AAED,mBAAOH,SAAP;AACH;;AAED;;;;;;;;;2EAMmD/D,W,EAAcS,W,EAAa;AAC1E,gBAAI2C,iBAAiB,IAArB;;AAEA,gBAAIpD,eAAe,IAAf,IAAuBS,eAAe,IAA1C,EAAgD;AAC5C;AACA2C,iCAAiB,KAAK/F,kBAAL,CAAwB8G,wDAAxB,CAAiFnE,WAAjF,EAA8F,KAAKzC,MAAnG,EAA2GkD,WAA3G,CAAjB;AACH;;AAED,mBAAO2C,cAAP;AACH;;AAED;;;;;;;;;oFAM4DpD,W,EAAazC,M,EAAQkD,W,EAAa;AAC1F,gBAAI2C,iBAAiB,IAArB;;AAEA,gBAAIpD,eAAe,IAAf,IAAuBzC,UAAU,IAAjC,IAAyCkD,eAAe,IAA5D,EAAkE;;AAE9D;AACA2C,iCAAiB,KAAK/F,kBAAL,CAAwB8G,wDAAxB,CAAiFnE,WAAjF,EAA8FzC,MAA9F,EAAsGkD,WAAtG,CAAjB;AACH;;AAED,mBAAO2C,cAAP;AACH;;;iEAEwCpD,W,EAAazC,M,EAAQ;AAC1D,gBAAI0F,kBAAkB,KAAK5F,kBAAL,CAAwB+G,wCAAxB,CAAiEpE,WAAjE,EAA8EzC,MAA9E,CAAtB;;AAEA;;AAEA,mBAAO0F,eAAP;AACH;;;iDAEwBjD,W,EAAa;AAClC,mBAAO,KAAKhD,aAAL,CAAmBqH,wBAAnB,CAA4CrE,WAA5C,CAAP;AACH;;;yDAEgCsE,U,EAAYvE,I,EAAM;AAC/C,mBAAO,KAAKhD,iBAAL,CAAuBwH,gCAAvB,CAAwDD,UAAxD,EAAoEvE,IAApE,CAAP;AACH;;;2DAEkCC,W,EAAazC,M,EAAQ;AACpD,gBAAIsE,QAAQ,KAAK9E,iBAAL,CAAuB0G,QAAvB,CAAgCzD,WAAhC,EAA6CzC,MAA7C,CAAZ;AACA,mBAAQ,OAAOsE,KAAP,KAAiB,QAAjB,GAA4BA,KAA5B,GAAoC,GAA5C;AACH;;;qCAEYyC,U,EAAY;AACrB,gBAAIhE,aAAa,KAAKlB,kBAAL,CAAwBkF,aAAa,QAArC,CAAjB;AACA,iBAAKvH,iBAAL,CAAuByH,cAAvB,CAAsClE,UAAtC;AACH;;;uCAEcgE,U,EAAY;AACvB,gBAAIhE,aAAa,KAAKlB,kBAAL,CAAwBkF,aAAa,UAArC,CAAjB;AACA,iBAAKvH,iBAAL,CAAuByH,cAAvB,CAAsClE,UAAtC;AACH;;;qDAE4B;AACzB,iBAAK8D,wCAAL;AACH;;AAED;;;;;;;;iDAKyBpE,W,EAAa;AAClC,mBAAO,KAAKhD,aAAL,CAAmByH,wBAAnB,CAA4CzE,WAA5C,CAAP;AACH;;AAED;;;;;;2CAGmB;AACf,mBAAO,KAAK3C,kBAAL,CAAwBqH,gBAAxB,EAAP;AACH;;AAED;;;;;;;;0CAKkBnH,M,EAAQ;AACtB;AACA,gBAAIoH,gBAAgB,KAAKD,gBAAL,EAApB;AACA,gBAAIE,WAAWD,cAAcC,QAA7B;;AAEA;AACA,gBAAIC,uBAAuB,KAAKzH,oBAAL,CAA0B0H,iBAA1B,CAA4CvH,MAA5C,EAAoDqH,QAApD,CAA3B;;AAEA,mBAAOC,oBAAP;AACH;;AAED;;;;;;;;8CAKsB;AAClB;AACA,gBAAIF,gBAAgB,KAAKtH,kBAAL,CAAwBqH,gBAAxB,EAApB;AACA,gBAAIE,WAAWD,cAAcC,QAA7B;;AAEA;AACA,gBAAIG,eAAe,KAAK3H,oBAAL,CAA0B4H,mBAA1B,CAA8C,KAAKzH,MAAnD,EAA2DqH,QAA3D,CAAnB;;AAEA,mBAAQG,iBAAiB,IAAjB,GAAwB,KAAxB,GAAgC,KAAKtI,OAAL,CAAa,QAAb,EAAuBsI,YAAvB,EAAqC,CAArC,CAAxC;AACH;;AAED;;;;;;;sDAI8B;AAC1B;AACA,gBAAIJ,gBAAgB,KAAKD,gBAAL,EAApB;AACA,gBAAIE,WAAWD,cAAcC,QAA7B;;AAEA;AACA,gBAAIK,QAAQ,KAAK7H,oBAAL,CAA0B8H,qBAA1B,CAAgD,KAAKpH,QAAL,CAAcmD,EAA9D,EAAkE2D,QAAlE,EAA4E7D,MAAxF;;AAEA,mBAAOkE,KAAP;AACH;;AAED;;;;;;;;yCAKiBjF,W,EAAa;AAC1B,gBAAImF,OAAO,KAAX;;AAEA,gBAAIC,kBAAkB,KAAKV,gBAAL,GAAwBE,QAA9C;AACA,gBAAIzD,YAAY,KAAKrC,cAAL,CAAoBkB,WAApB,CAAhB;AACA,gBAAI4E,WAAWzD,UAAUyD,QAAzB;;AAEA,gBAAIQ,oBAAoB,CAAC,CAArB,IAA0BA,oBAAoBR,QAAlD,EAA4D;AACxD;AACA,oBAAIS,mBAAmB,KAAKhI,kBAAL,CAAwBiI,mBAAxB,EAAvB;AACA,oBAAID,gBAAJ,EAAsB;AAClB;AACA,wBAAIA,iBAAiBrF,WAAjB,KAAiCuF,SAASvF,WAAT,CAArC,EAA4D;AACxD;AACAmF,+BAAO,IAAP;AACH;AACJ,iBAND,MAMO;AACH;AACAA,2BAAO,IAAP;AACH;AACJ;;AAED,mBAAOA,IAAP;AACH;;;uCAEcnF,W,EAAawF,K,EAAO;AAC/B,iBAAKzG,kBAAL,CAAwBiB,WAAxB,IAAuC,CAAC,KAAKjB,kBAAL,CAAwBiB,WAAxB,CAAxC;AACH;;;iDAEwBwF,K,EAAO3F,K,EAAO;AAAA;;AACnC,gBAAI4F,SAAS5F,MAAM4F,MAAnB;AACA,gBAAIC,oBAAoBD,OAAOE,qBAAP,GAA+BC,GAAvD;;AAEA,iBAAK1H,gBAAL,GAAwBsH,KAAxB;AACA,iBAAKtH,gBAAL,GAAwB6D,QAAQC,IAAR,CAAa,KAAK9D,gBAAlB,CAAxB;;AAEA,iBAAKpB,QAAL,CAAc,YAAM;AAChB,uBAAK+I,YAAL,CAAkBJ,MAAlB,EAA0BC,iBAA1B;AACH,aAFD,EAEG,GAFH;AAIH;;;qCAEYD,M,EAAQC,iB,EAAmB;AACpC,gBAAII,uBAAuBL,OAAOE,qBAAP,GAA+BC,GAA1D;AACA,gBAAIG,QAAQL,oBAAoBI,oBAAhC;AACA,gBAAIpG,YAAYsG,QAAQtG,SAAxB;AACAsG,oBAAQtG,SAAR,GAAoBA,YAAYqG,KAAhC;AACH;;AAED;;;;;;;;wCAKgB;;AAEZ,gBAAI,KAAKzH,WAAL,IAAoB,IAAxB,EAA8B;;AAE1B;AACA,oBAAI2H,aAAa,KAAK3H,WAAL,CAAiB4H,MAAlC;;AAEA,oBAAID,cAAc,IAAd,IAAsBA,cAAc,EAAxC,EAA4C;AACxC;AACA,2BAAO,IAAP;AACH;;AAED;AACA,oBAAIrC,aAAa,KAAKtF,WAAL,CAAiBsF,UAAlC;;AAEA,oBAAIA,cAAc,IAAd,IAAsBA,WAAW7C,MAAX,IAAqB,CAA/C,EAAkD;;AAE9C;AACA,yBAAK,IAAI+C,IAAI,CAAb,EAAgBA,IAAIF,WAAW7C,MAA/B,EAAuC+C,GAAvC,EAA4C;AACxC,4BAAIC,YAAYH,WAAWE,CAAX,CAAhB;;AAEA,4BAAIC,aAAa,IAAjB,EAAuB;;AAEnB;AACA,gCAAIoC,kBAAkBpC,UAAUmC,MAAhC;;AAEA,gCAAIC,mBAAmB,IAAnB,IAA2BA,mBAAmB,EAAlD,EAAsD;AAClD;AACA,uCAAO,IAAP;AACH;AACJ;AACJ;AACJ;AACJ;;AAED,mBAAO,KAAP;AACH;;AAED;;;;;;;qCAIa;;AAET;AACA,gBAAIC,qBAAqB,KAAKjJ,cAAL,CAAoBkJ,+BAApB,CAAoD,KAAK9I,MAAzD,CAAzB;;AAEA;;;;AAIA,gBAAI+I,cAAc,0IAA0IF,kBAA1I,GAA+J,gRAAjL;;AAEA;;;AAGA,gBAAIG,YAAY,4QAA4QH,kBAA5Q,GAAiS,aAAjT;;AAEA;AACA,gBAAII,gBAAgB,sFAApB;;AAEA;AACA,gBAAIP,aAAa,KAAK3H,WAAL,CAAiB4H,MAAlC;;AAEA,gBAAID,cAAc,IAAlB,EAAwB;AACpBO,iCAAiBP,UAAjB;AACH;;AAED;AACA,gBAAIrC,aAAa,KAAKtF,WAAL,CAAiBsF,UAAlC;;AAEA,gBAAIA,cAAc,IAAd,IAAsBA,WAAW7C,MAAX,IAAqB,CAA/C,EAAkD;;AAE9C;AACA,qBAAK,IAAI+C,IAAI,CAAb,EAAgBA,IAAIF,WAAW7C,MAA/B,EAAuC+C,GAAvC,EAA4C;AACxC,wBAAIC,YAAYH,WAAWE,CAAX,CAAhB;;AAEA,wBAAIC,aAAa,IAAjB,EAAuB;;AAEnB;AACA,4BAAIoC,kBAAkBpC,UAAUmC,MAAhC;;AAEA,4BAAIC,mBAAmB,IAAnB,IAA2BA,mBAAmB,EAAlD,EAAsD;;AAElD,gCAAIK,iBAAiB,EAArB,EAAyB;AACrB;AACAA,iDAAiB,OAAjB;AACH;;AAED;AACAA,6CAAiBL,eAAjB;AACH;AACJ;AACJ;AACJ;;AAED;AACAK,4BAAgB,KAAKrJ,cAAL,CAAoBsJ,iBAApB,CAAsCD,aAAtC,CAAhB;;AAEA;AACA,gBAAIE,eAAeJ,cAAcE,aAAjC;;AAEA;AACA,gBAAIG,aAAaJ,YAAYC,aAA7B;;AAEA;AACA,iBAAK9J,SAAL,CAAeyI,IAAf,CAAoB;AAChByB,0BAAUF,YADM;AAEhBG,4BAAY,CAAC,QAAD,EAAW,WAAX,EACR,SAASC,gBAAT,CAA0BnK,MAA1B,EAAkCD,SAAlC,EAA6C;;AAEzC;AACAC,2BAAOoK,kBAAP,GAA4B,YAAW;;AAEnC;AACA,4BAAIC,IAAIC,OAAOC,IAAP,CAAY,EAAZ,EAAgB,QAAhB,CAAR;;AAEA;AACAF,0BAAExH,QAAF,CAAW2H,KAAX,CAAiBR,UAAjB;;AAEA;AACAjK,kCAAU0K,IAAV;AACH,qBAVD;;AAYA;AACAzK,2BAAO0K,WAAP,GAAqB,YAAW;AAC5B3K,kCAAU0K,IAAV;AACH,qBAFD;AAGH,iBApBO,CAFI;AAwBhBE,qCAAqB,IAxBL;AAyBhBC,+BAAe;AAzBC,aAApB;AA2BH;;;gCAEO/B,K,EAAO;;AAEX,oBAAQA,KAAR;AACI,qBAAK,MAAL;AACI,wBAAI,KAAKxH,IAAL,KAAc,MAAlB,EAA0B;AACtB,6BAAKA,IAAL,GAAY,OAAZ;AACH,qBAFD,MAEO;AACH,6BAAKA,IAAL,GAAY,MAAZ;AACH;AACD;AACJ,qBAAK,QAAL;AACI,wBAAI,KAAKA,IAAL,KAAc,QAAlB,EAA4B;AACxB,6BAAKA,IAAL,GAAY,SAAZ;AACH,qBAFD,MAEO;AACH,6BAAKA,IAAL,GAAY,QAAZ;AACH;AACD;AACJ,qBAAK,OAAL;AACI,wBAAI,KAAKA,IAAL,KAAc,OAAlB,EAA2B;AACvB,6BAAKA,IAAL,GAAY,QAAZ;AACH,qBAFD,MAEO;AACH,6BAAKA,IAAL,GAAY,OAAZ;AACH;AACD;AArBR;;AAwBA;AACA,iBAAKX,kBAAL,CAAwBY,eAAxB,GAA0C,KAAKD,IAA/C;AACH;;;qCAEY;AACT,gBAAIwJ,UAAU,EAAd;;AAEA,oBAAQ,KAAKxJ,IAAb;AACI,qBAAK,MAAL;AACIwJ,8BAAU,CAAC,cAAD,CAAV;AACA;AACJ,qBAAK,OAAL;AACIA,8BAAU,CAAC,eAAD,CAAV;AACA;AACJ,qBAAK,QAAL;AACIA,8BAAU,CAAC,kBAAD,EAAqB,cAArB,CAAV;AACA;AACJ,qBAAK,SAAL;AACIA,8BAAU,CAAC,mBAAD,EAAsB,cAAtB,CAAV;AACA;AACJ,qBAAK,OAAL;AACIA,8BAAU,CAAC,OAAD,EAAU,cAAV,CAAV;AACA;AACJ,qBAAK,QAAL;AACIA,8BAAU,CAAC,QAAD,EAAW,cAAX,CAAV;AACA;AAlBR;;AAqBA,mBAAOA,OAAP;AACH;;;;;;AAGLhL,sBAAsBiL,OAAtB,GAAgC,CAC5B,SAD4B,EAE5B,WAF4B,EAG5B,QAH4B,EAI5B,QAJ4B,EAK5B,cAL4B,EAM5B,UAN4B,EAO5B,mBAP4B,EAQ5B,eAR4B,EAS5B,aAT4B,EAU5B,qBAV4B,EAW5B,gBAX4B,EAY5B,sBAZ4B,EAa5B,oBAb4B,CAAhC;;kBAgBejL,qB","file":"nodeGradingController.js","sourcesContent":["'use strict';\r\n\r\nclass NodeGradingController {\r\n\r\n    constructor($filter,\r\n                $mdDialog,\r\n                $scope,\r\n                $state,\r\n                $stateParams,\r\n                $timeout,\r\n                AnnotationService,\r\n                ConfigService,\r\n                NodeService,\r\n                NotificationService,\r\n                ProjectService,\r\n                StudentStatusService,\r\n                TeacherDataService) {\r\n\r\n        this.$filter = $filter;\r\n        this.$mdDialog = $mdDialog;\r\n        this.$state = $state;\r\n        this.$scope = $scope;\r\n        this.$stateParams = $stateParams;\r\n        this.$timeout = $timeout;\r\n        this.AnnotationService = AnnotationService;\r\n        this.ConfigService = ConfigService;\r\n        this.NodeService = NodeService;\r\n        this.NotificationService = NotificationService;\r\n        this.ProjectService = ProjectService;\r\n        this.StudentStatusService = StudentStatusService;\r\n        this.TeacherDataService = TeacherDataService;\r\n\r\n        this.$translate = this.$filter('translate');\r\n\r\n        this.nodeId = this.$stateParams.nodeId;\r\n\r\n        // the max score for the node\r\n        this.maxScore = this.ProjectService.getMaxScoreForNode(this.nodeId);\r\n        this.showScore = this.ProjectService.nodeHasWork(this.nodeId);\r\n\r\n        let startNodeId = this.ProjectService.getStartNodeId();\r\n        this.rootNode = this.ProjectService.getRootNode(startNodeId);\r\n\r\n        this.sort = this.TeacherDataService.nodeGradingSort;\r\n\r\n        this.hiddenComponents = [];\r\n\r\n        this.showRubricButton = false;\r\n\r\n        // TODO: add loading indicator\r\n        this.TeacherDataService.retrieveStudentDataByNodeId(this.nodeId).then(result => {\r\n\r\n            // field that will hold the node content\r\n            this.nodeContent = null;\r\n\r\n            this.teacherWorkgroupId = this.ConfigService.getWorkgroupId();\r\n\r\n            this.periods = [];\r\n\r\n            var node = this.ProjectService.getNodeById(this.nodeId);\r\n\r\n            if (node != null) {\r\n\r\n                // field that will hold the node content\r\n                this.nodeContent = node;\r\n            }\r\n\r\n            this.workgroups = this.ConfigService.getClassmateUserInfos();\r\n            this.workgroupsById = {}; // object that will hold workgroup names, statuses, scores, notifications, etc.\r\n            this.workVisibilityById = {}; // object that specifies whether student work is visible for each workgroup\r\n\r\n            this.canViewStudentNames = true;\r\n            this.canGradeStudentWork = true;\r\n\r\n            let permissions = this.ConfigService.getPermissions();\r\n            this.canViewStudentNames = permissions.canViewStudentNames;\r\n            this.canGradeStudentWork = permissions.canGradeStudentWork;\r\n\r\n            this.annotationMappings = {};\r\n\r\n            this.componentStateHistory = [];\r\n\r\n            this.setWorkgroupsById();\r\n\r\n            this.showRubricButton = this.nodeHasRubric();\r\n\r\n            // scroll to the top of the page when the page loads\r\n            document.body.scrollTop = document.documentElement.scrollTop = 0;\r\n        });\r\n\r\n        this.$scope.$on('notificationAdded', (event, notification) => {\r\n            if (notification.type === 'CRaterResult') {\r\n                // there is a new CRaterResult notification\r\n                // TODO: expand to encompass other notification types that should be shown to teacher\r\n                let workgroupId = notification.toWorkgroupId;\r\n                if (this.workgroupsById[workgroupId]) {\r\n                    this.updateWorkgroup(workgroupId);\r\n                }\r\n            }\r\n        });\r\n\r\n        this.$scope.$on('notificationChanged', (event, notification) => {\r\n            if (notification.type === 'CRaterResult') {\r\n                // a CRaterResult notification has changed\r\n                // TODO: expand to encompass other notification types that should be shown to teacher\r\n                let workgroupId = notification.toWorkgroupId;\r\n                if (this.workgroupsById[workgroupId]) {\r\n                    this.updateWorkgroup(workgroupId);\r\n                }\r\n            }\r\n        });\r\n\r\n        this.$scope.$on('studentStatusReceived', (event, status) => {\r\n            // new student status received\r\n            let workgroupId = status.workgroupId;\r\n            let nodeId = status.previousComponentState.nodeId;\r\n            if (nodeId === this.nodeId && this.workgroupsById[workgroupId]) {\r\n                // a workgroup has a new componentState for this node\r\n                this.updateWorkgroup(workgroupId);\r\n            }\r\n        });\r\n\r\n        this.$scope.$on('annotationReceived', (event, args) => {\r\n            let annotation = args.annotation;\r\n\r\n            if (annotation) {\r\n                let workgroupId = annotation.toWorkgroupId;\r\n                let nodeId = annotation.nodeId;\r\n                if (nodeId === this.nodeId && this.workgroupsById[workgroupId]) {\r\n                    // a workgroup has a new annotation for this node\r\n                    this.updateWorkgroup(workgroupId);\r\n                }\r\n            }\r\n        });\r\n\r\n        this.$scope.$on('studentWorkReceived', (event, args) => {\r\n            let studentWork = args.studentWork;\r\n\r\n            if (studentWork != null) {\r\n                let workgroupId = studentWork.workgroupId;\r\n                let nodeId = studentWork.nodeId;\r\n                if (nodeId === this.nodeId && this.workgroupsById[workgroupId]) {\r\n                    // a workgroup has a new componentState for this node\r\n                    this.updateWorkgroup(workgroupId);\r\n                }\r\n            }\r\n        });\r\n\r\n        // save event when node grading view is displayed and save the nodeId that is displayed\r\n        let context = \"ClassroomMonitor\", nodeId = this.nodeId, componentId = null, componentType = null,\r\n            category = \"Navigation\", event = \"nodeGradingViewDisplayed\", data = { nodeId: this.nodeId };\r\n        this.TeacherDataService.saveEvent(context, nodeId, componentId, componentType, category, event, data);\r\n    }\r\n\r\n    /**\r\n     * Build the workgroupsById object\r\n     */\r\n    setWorkgroupsById() {\r\n        let l = this.workgroups.length;\r\n        for (let i = 0; i < l; i++) {\r\n            let id = this.workgroups[i].workgroupId;\r\n            this.workgroupsById[id] = this.workgroups[i];\r\n            this.workVisibilityById[id] = false;\r\n\r\n            this.updateWorkgroup(id, true);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Update statuses, scores, notifications, etc. for a workgroup object\r\n     * @param workgroupID a workgroup ID number\r\n     * @param init Boolean whether we're in controller initialization or not\r\n     */\r\n    updateWorkgroup(workgroupId, init) {\r\n        let workgroup = this.workgroupsById[workgroupId];\r\n\r\n        if (workgroup) {\r\n            let alertNotifications = this.getAlertNotificationsByWorkgroupId(workgroupId);\r\n            workgroup.hasAlert = alertNotifications.length;\r\n            workgroup.hasNewAlert = this.workgroupHasNewAlert(alertNotifications);\r\n            let completionStatus = this.getNodeCompletionStatusByWorkgroupId(workgroupId);\r\n            workgroup.hasNewWork = completionStatus.hasNewWork;\r\n            workgroup.completionStatus = this.getWorkgroupCompletionStatus(completionStatus);\r\n            workgroup.score = this.getNodeScoreByWorkgroupId(workgroupId);\r\n\r\n            if (!init) {\r\n                this.workgroupsById[workgroupId] = angular.copy(workgroup);\r\n            }\r\n        }\r\n    }\r\n\r\n    getAlertNotificationsByWorkgroupId(workgroupId) {\r\n        let args = {};\r\n        args.nodeId = this.nodeId;\r\n        args.workgroupId = workgroupId;\r\n        return this.NotificationService.getAlertNotifications(args);\r\n    }\r\n\r\n    workgroupHasNewAlert(alertNotifications) {\r\n        let newAlert = false;\r\n\r\n        let l = alertNotifications.length;\r\n        for (let i = 0; i < l; i++) {\r\n            let alert = alertNotifications[i];\r\n            if (!alert.timeDismissed) {\r\n                newAlert = true;\r\n                break;\r\n            }\r\n        }\r\n\r\n        return newAlert;\r\n    }\r\n\r\n    /**\r\n     * Returns an object with node completion status, latest work time, and latest annotation time\r\n     * for a workgroup for the current node\r\n     * @param workgroupId a workgroup ID number\r\n     * @returns Object with completion, latest work time, latest annotation time\r\n     */\r\n    getNodeCompletionStatusByWorkgroupId(workgroupId) {\r\n        let isCompleted = false;\r\n\r\n        // TODO: store this info in the nodeStatus so we don't have to calculate every time?\r\n        let latestWorkTime = this.getLatestWorkTimeByWorkgroupId(workgroupId);\r\n\r\n\r\n        let latestAnnotationTime = this.getLatestAnnotationTimeByWorkgroupId(workgroupId);\r\n\r\n        if (latestWorkTime) {\r\n            // workgroup has at least one componentState for this node, so check if node is completed\r\n            let studentStatus = this.StudentStatusService.getStudentStatusForWorkgroupId(workgroupId);\r\n            let nodeStatus = studentStatus.nodeStatuses[this.nodeId];\r\n\r\n            if (nodeStatus) {\r\n                isCompleted = nodeStatus.isCompleted;\r\n            }\r\n        }\r\n\r\n        if (!this.ProjectService.nodeHasWork(this.nodeId)) {\r\n            /*\r\n             * the step does not generate any work so we will look for a visit\r\n             * event to determine completion\r\n             */\r\n\r\n            var events = this.TeacherDataService.getEventsByWorkgroupIdAndNodeId(workgroupId, this.nodeId);\r\n\r\n            if (events != null && events.length > 0) {\r\n                isCompleted = true;\r\n            }\r\n        }\r\n\r\n        return {\r\n            isCompleted: isCompleted,\r\n            latestWorkTime: latestWorkTime,\r\n            latestAnnotationTime: latestAnnotationTime\r\n        };\r\n    }\r\n\r\n    getLatestWorkTimeByWorkgroupId(workgroupId) {\r\n        let time = null;\r\n        let componentStates = this.TeacherDataService.getComponentStatesByNodeId(this.nodeId);\r\n        let n = componentStates.length-1;\r\n\r\n        // loop through component states for this node, starting with most recent\r\n        for (let i = n; i > -1; i--) {\r\n            let componentState = componentStates[i];\r\n            if (componentState.workgroupId === workgroupId) {\r\n                // componentState is for given workgroupId\r\n                time = componentState.serverSaveTime;\r\n                break;\r\n            }\r\n        }\r\n\r\n        return time;\r\n    }\r\n\r\n    getLatestAnnotationTimeByWorkgroupId(workgroupId) {\r\n        let time = null;\r\n        let annotations = this.TeacherDataService.getAnnotationsByNodeId(this.nodeId);\r\n        let n = annotations.length-1;\r\n\r\n        // loop through annotations for this node, starting with most recent\r\n        for (let i = n; i > -1; i--) {\r\n            let annotation = annotations[i];\r\n            // TODO: support checking for annotations from shared teachers\r\n            if (annotation.toWorkgroupId === workgroupId && annotation.fromWorkgroupId === this.ConfigService.getWorkgroupId()) {\r\n                time = annotation.serverSaveTime;\r\n                break;\r\n            }\r\n        }\r\n\r\n        return time;\r\n    }\r\n\r\n    /**\r\n     * Returns the score for the current node for a given workgroupID\r\n     * @param workgroupId a workgroup ID number\r\n     * @returns Number score value (defaults to -1 if workgroup has no score)\r\n     */\r\n    getNodeScoreByWorkgroupId(workgroupId) {\r\n        let score = this.AnnotationService.getScore(workgroupId, this.nodeId);\r\n        return (typeof score === 'number' ? score : -1);\r\n    }\r\n\r\n    /**\r\n     * Returns a numerical status value for a given completion status object depending on node completion\r\n     * Available status values are: 0 (not visited/no work; default), 1 (partially completed), 2 (completed)\r\n     * @param completionStatus Object\r\n     * @returns Integer status value\r\n     */\r\n    getWorkgroupCompletionStatus(completionStatus) {\r\n        let hasWork = completionStatus.latestWorkTime !== null;\r\n        let isCompleted = completionStatus.isCompleted;\r\n\r\n        // TODO: store this info in the nodeStatus so we don't have to calculate every time (and can use more widely)?\r\n        let status = 0; // default\r\n\r\n        if (isCompleted) {\r\n            status = 2;\r\n        } else if (hasWork) {\r\n            status = 1;\r\n        }\r\n\r\n        return status;\r\n    }\r\n\r\n    /**\r\n     * Get the html template for the component\r\n     * @param componentType the component type\r\n     * @return the path to the html template for the component\r\n     */\r\n    getComponentTemplatePath(componentType) {\r\n        return this.NodeService.getComponentTemplatePath(componentType);\r\n    }\r\n\r\n    /**\r\n     * Get the components for this node.\r\n     * @return an array that contains the content for the components\r\n     */\r\n    getComponents() {\r\n        var components = null;\r\n\r\n        if (this.nodeContent != null) {\r\n            components = this.nodeContent.components;\r\n        }\r\n\r\n        if (components != null && this.isDisabled) {\r\n            for (var c = 0; c < components.length; c++) {\r\n                var component = components[c];\r\n\r\n                component.isDisabled = true;\r\n            }\r\n        }\r\n\r\n        if (components != null && this.nodeContent.lockAfterSubmit) {\r\n            for (c = 0; c < components.length; c++) {\r\n                component = components[c];\r\n\r\n                component.lockAfterSubmit = true;\r\n            }\r\n        }\r\n\r\n        return components;\r\n    }\r\n\r\n    getComponentById(componentId) {\r\n        var component = null;\r\n\r\n        if (componentId != null) {\r\n            var components = this.getComponents();\r\n\r\n            if (components != null) {\r\n                for (var c = 0; c < components.length; c++) {\r\n                    var tempComponent = components[c];\r\n\r\n                    if (tempComponent != null) {\r\n                        if (componentId === tempComponent.id) {\r\n                            component = tempComponent;\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return component;\r\n    }\r\n\r\n    /**\r\n     * Get the student data for a specific part\r\n     * @param the componentId\r\n     * @param the workgroupId id of Workgroup who created the component state\r\n     * @return the student data for the given component\r\n     */\r\n    getLatestComponentStateByWorkgroupIdAndComponentId(workgroupId,  componentId) {\r\n        var componentState = null;\r\n\r\n        if (workgroupId != null && componentId != null) {\r\n            // get the latest component state for the component\r\n            componentState = this.TeacherDataService.getLatestComponentStateByWorkgroupIdNodeIdAndComponentId(workgroupId, this.nodeId, componentId);\r\n        }\r\n\r\n        return componentState;\r\n    }\r\n\r\n    /**\r\n     * Get the student data for a specific part\r\n     * @param the componentId\r\n     * @param the workgroupId id of Workgroup who created the component state\r\n     * @return the student data for the given component\r\n     */\r\n    getLatestComponentStateByWorkgroupIdAndNodeIdAndComponentId(workgroupId, nodeId, componentId) {\r\n        var componentState = null;\r\n\r\n        if (workgroupId != null && nodeId != null && componentId != null) {\r\n\r\n            // get the latest component state for the component\r\n            componentState = this.TeacherDataService.getLatestComponentStateByWorkgroupIdNodeIdAndComponentId(workgroupId, nodeId, componentId);\r\n        }\r\n\r\n        return componentState;\r\n    }\r\n\r\n    getComponentStatesByWorkgroupIdAndNodeId(workgroupId, nodeId) {\r\n        var componentStates = this.TeacherDataService.getComponentStatesByWorkgroupIdAndNodeId(workgroupId, nodeId);\r\n\r\n        //AnnotationService.populateAnnotationMappings(this.annotationMappings, workgroupId, componentStates);\r\n\r\n        return componentStates;\r\n    }\r\n\r\n    getUserNameByWorkgroupId(workgroupId) {\r\n        return this.ConfigService.getUserNameByWorkgroupId(workgroupId);\r\n    }\r\n\r\n    getAnnotationByStepWorkIdAndType(stepWorkId, type) {\r\n        return this.AnnotationService.getAnnotationByStepWorkIdAndType(stepWorkId, type);\r\n    }\r\n\r\n    getNodeScoreByWorkgroupIdAndNodeId(workgroupId, nodeId) {\r\n        let score = this.AnnotationService.getScore(workgroupId, nodeId);\r\n        return (typeof score === 'number' ? score : '-');\r\n    }\r\n\r\n    scoreChanged(stepWorkId) {\r\n        var annotation = this.annotationMappings[stepWorkId + '-score'];\r\n        this.AnnotationService.saveAnnotation(annotation);\r\n    }\r\n\r\n    commentChanged(stepWorkId) {\r\n        var annotation = this.annotationMappings[stepWorkId + '-comment'];\r\n        this.AnnotationService.saveAnnotation(annotation);\r\n    }\r\n\r\n    setupComponentStateHistory() {\r\n        this.getComponentStatesByWorkgroupIdAndNodeId()\r\n    }\r\n\r\n    /**\r\n     * Get the period id for a workgroup id\r\n     * @param workgroupId the workgroup id\r\n     * @returns the period id for the workgroup id\r\n     */\r\n    getPeriodIdByWorkgroupId(workgroupId) {\r\n        return this.ConfigService.getPeriodIdByWorkgroupId(workgroupId);\r\n    }\r\n\r\n    /**\r\n     * Get the current period\r\n     */\r\n    getCurrentPeriod() {\r\n        return this.TeacherDataService.getCurrentPeriod();\r\n    }\r\n\r\n    /**\r\n     * Get the percentage of the class or period that has completed the node\r\n     * @param nodeId the node id\r\n     * @returns the percentage of the class or period that has completed the node\r\n     */\r\n    getNodeCompletion(nodeId) {\r\n        // get the currently selected period\r\n        let currentPeriod = this.getCurrentPeriod();\r\n        let periodId = currentPeriod.periodId;\r\n\r\n        // get the percentage of the class or period that has completed the node\r\n        let completionPercentage = this.StudentStatusService.getNodeCompletion(nodeId, periodId);\r\n\r\n        return completionPercentage;\r\n    }\r\n\r\n    /**\r\n     * Get the average score for the node\r\n     * @param nodeId the node id\r\n     * @returns the average score for the node\r\n     */\r\n    getNodeAverageScore() {\r\n        // get the currently selected period\r\n        let currentPeriod = this.TeacherDataService.getCurrentPeriod();\r\n        let periodId = currentPeriod.periodId;\r\n\r\n        // get the average score for the node\r\n        let averageScore = this.StudentStatusService.getNodeAverageScore(this.nodeId, periodId);\r\n\r\n        return (averageScore === null ? 'N/A' : this.$filter('number')(averageScore, 1));\r\n    }\r\n\r\n    /**\r\n     * Get the number of students in the current period\r\n     * @returns the number of students that are in the period\r\n     */\r\n    getNumberOfStudentsInPeriod() {\r\n        // get the currently selected period\r\n        let currentPeriod = this.getCurrentPeriod();\r\n        let periodId = currentPeriod.periodId;\r\n\r\n        // get the number of students that are on the node in the period\r\n        let count = this.StudentStatusService.getWorkgroupIdsOnNode(this.rootNode.id, periodId).length;\r\n\r\n        return count;\r\n    }\r\n\r\n    /**\r\n     * Checks whether a workgroup should be shown\r\n     * @param workgroupId the workgroupId to look for\r\n     * @returns boolean whether the workgroup should be shown\r\n     */\r\n    isWorkgroupShown(workgroupId) {\r\n        let show = false;\r\n\r\n        let currentPeriodId = this.getCurrentPeriod().periodId;\r\n        let workgroup = this.workgroupsById[workgroupId];\r\n        let periodId = workgroup.periodId;\r\n\r\n        if (currentPeriodId === -1 || currentPeriodId === periodId) {\r\n            // workgroup is in current period\r\n            let currentWorkgroup = this.TeacherDataService.getCurrentWorkgroup();\r\n            if (currentWorkgroup) {\r\n                // there is a currently selected workgroup, so check if this one matches\r\n                if (currentWorkgroup.workgroupId === parseInt(workgroupId)) {\r\n                    // workgroupIds match, so show this one\r\n                    show = true;\r\n                }\r\n            } else {\r\n                // there is no currently selected workgroup, so show this one\r\n                show = true;\r\n            }\r\n        }\r\n\r\n        return show;\r\n    }\r\n\r\n    onUpdateExpand(workgroupId, value) {\r\n        this.workVisibilityById[workgroupId] = !this.workVisibilityById[workgroupId];\r\n    }\r\n\r\n    onUpdateHiddenComponents(value, event) {\r\n        let target = event.target;\r\n        let viewportOffsetTop = target.getBoundingClientRect().top;\r\n\r\n        this.hiddenComponents = value;\r\n        this.hiddenComponents = angular.copy(this.hiddenComponents);\r\n\r\n        this.$timeout(() => {\r\n            this.updateScroll(target, viewportOffsetTop);\r\n        }, 100);\r\n\r\n    }\r\n\r\n    updateScroll(target, viewportOffsetTop) {\r\n        let newViewportOffsetTop = target.getBoundingClientRect().top;\r\n        let delta = viewportOffsetTop - newViewportOffsetTop;\r\n        let scrollTop = content.scrollTop;\r\n        content.scrollTop = scrollTop - delta;\r\n    }\r\n\r\n    /**\r\n     * Check if the step has a rubric or if any of the components in the step\r\n     * have a rubric\r\n     * @return whether the step or any of its components have a rubric\r\n     */\r\n    nodeHasRubric() {\r\n\r\n        if (this.nodeContent != null) {\r\n\r\n            // get the step rubric if any\r\n            var nodeRubric = this.nodeContent.rubric;\r\n\r\n            if (nodeRubric != null && nodeRubric != '') {\r\n                // the step has a rubric\r\n                return true;\r\n            }\r\n\r\n            // get the components\r\n            var components = this.nodeContent.components;\r\n\r\n            if (components != null && components.length != 0) {\r\n\r\n                // loop through all the components\r\n                for (var c = 0; c < components.length; c++) {\r\n                    var component = components[c];\r\n\r\n                    if (component != null) {\r\n\r\n                        // get a component rubric\r\n                        var componentRubric = component.rubric;\r\n\r\n                        if (componentRubric != null && componentRubric != '') {\r\n                            // a component has a rubric\r\n                            return true;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Show the rubric in the grading view. We will show the step rubric and the\r\n     * component rubrics.\r\n     */\r\n    showRubric() {\r\n\r\n        // get the step number and title\r\n        var stepNumberAndTitle = this.ProjectService.getNodePositionAndTitleByNodeId(this.nodeId);\r\n\r\n        /*\r\n         * create the header for the popup that contains the project title,\r\n         * 'Open in New Tab' button, and 'Close' button\r\n         */\r\n        var popupHeader = \"<div style='display: flex; margin-left: 30px; margin-right: 30px; margin-top: 30px; margin-bottom: 30px;'><div style='flex: 50%'><h3>\" + stepNumberAndTitle + \"</h3></div><div style='flex: 50%; text-align: right'><md-button class='md-primary md-raised' ng-click='openRubricInNewTab()' translate='openInNewTab'></md-button> <md-button class='md-primary md-raised' ng-click='closeRubric()' translate='CLOSE'></md-button></div></div>\";\r\n\r\n        /*\r\n         * create the header for the new tab that contains the project title\r\n         */\r\n        var tabHeader = \"<link rel='stylesheet' href='../wise5/lib/bootstrap/css/bootstrap.min.css' /><link rel='stylesheet' href='../wise5/lib/summernote/dist/summernote.css' /><div style='display: flex; margin-left: 30px; margin-right: 30px; margin-top: 30px; margin-bottom: 30px;'><h1>\" + stepNumberAndTitle + \"</h1></div>\";\r\n\r\n        // create the div that will hold the rubric content\r\n        var rubricContent = \"<div style='margin-left:30px;margin-right:30px;margin-top:30px;margin-bottom:30px;'>\";\r\n\r\n        // get the step rubric\r\n        var nodeRubric = this.nodeContent.rubric;\r\n\r\n        if (nodeRubric != null) {\r\n            rubricContent += nodeRubric;\r\n        }\r\n\r\n        // get the components\r\n        var components = this.nodeContent.components;\r\n\r\n        if (components != null && components.length != 0) {\r\n\r\n            // loop through all the components\r\n            for (var c = 0; c < components.length; c++) {\r\n                var component = components[c];\r\n\r\n                if (component != null) {\r\n\r\n                    // get a component rubric\r\n                    var componentRubric = component.rubric;\r\n\r\n                    if (componentRubric != null && componentRubric != '') {\r\n\r\n                        if (rubricContent != '') {\r\n                            // separate component rubrics with a line break\r\n                            rubricContent += '<br/>';\r\n                        }\r\n\r\n                        // append the component rubric\r\n                        rubricContent += componentRubric;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        // inject the asset paths into the rubrics\r\n        rubricContent = this.ProjectService.replaceAssetPaths(rubricContent);\r\n\r\n        // create the popup content\r\n        var popupContent = popupHeader + rubricContent;\r\n\r\n        // create the tab content\r\n        var tabContent = tabHeader + rubricContent;\r\n\r\n        // display the rubric in a popup\r\n        this.$mdDialog.show({\r\n            template: popupContent,\r\n            controller: ['$scope', '$mdDialog',\r\n                function DialogController($scope, $mdDialog) {\r\n\r\n                    // display the rubric in a new tab\r\n                    $scope.openRubricInNewTab = function() {\r\n\r\n                        // open a new tab\r\n                        var w = window.open('', '_blank');\r\n\r\n                        // write the rubric content to the new tab\r\n                        w.document.write(tabContent);\r\n\r\n                        // close the popup\r\n                        $mdDialog.hide();\r\n                    }\r\n\r\n                    // close the popup\r\n                    $scope.closeRubric = function() {\r\n                        $mdDialog.hide();\r\n                    }\r\n                }\r\n            ],\r\n            clickOutsideToClose: true,\r\n            escapeToClose: true\r\n        });\r\n    }\r\n\r\n    setSort(value) {\r\n\r\n        switch (value) {\r\n            case 'team':\r\n                if (this.sort === 'team') {\r\n                    this.sort = '-team';\r\n                } else {\r\n                    this.sort = 'team';\r\n                }\r\n                break;\r\n            case 'status':\r\n                if (this.sort === 'status') {\r\n                    this.sort = '-status';\r\n                } else {\r\n                    this.sort = 'status';\r\n                }\r\n                break;\r\n            case 'score':\r\n                if (this.sort === 'score') {\r\n                    this.sort = '-score';\r\n                } else {\r\n                    this.sort = 'score';\r\n                }\r\n                break;\r\n        }\r\n\r\n        // update value in the teacher data service so we can persist across view instances and current node changes\r\n        this.TeacherDataService.nodeGradingSort = this.sort;\r\n    }\r\n\r\n    getOrderBy() {\r\n        let orderBy = [];\r\n\r\n        switch (this.sort) {\r\n            case 'team':\r\n                orderBy = ['displayNames'];\r\n                break;\r\n            case '-team':\r\n                orderBy = ['-displayNames'];\r\n                break;\r\n            case 'status':\r\n                orderBy = ['completionStatus', 'displayNames'];\r\n                break;\r\n            case '-status':\r\n                orderBy = ['-completionStatus', 'displayNames'];\r\n                break;\r\n            case 'score':\r\n                orderBy = ['score', 'displayNames'];\r\n                break;\r\n            case '-score':\r\n                orderBy = ['-score', 'displayNames'];\r\n                break;\r\n        }\r\n\r\n        return orderBy;\r\n    }\r\n}\r\n\r\nNodeGradingController.$inject = [\r\n    '$filter',\r\n    '$mdDialog',\r\n    '$scope',\r\n    '$state',\r\n    '$stateParams',\r\n    '$timeout',\r\n    'AnnotationService',\r\n    'ConfigService',\r\n    'NodeService',\r\n    'NotificationService',\r\n    'ProjectService',\r\n    'StudentStatusService',\r\n    'TeacherDataService'\r\n];\r\n\r\nexport default NodeGradingController;\r\n"]}