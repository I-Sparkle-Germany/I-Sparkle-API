{"version":3,"sources":["studentGradingController.es6"],"names":["StudentGradingController","$mdDialog","$stateParams","AnnotationService","ConfigService","NotebookService","ProjectService","TeacherDataService","annotationMappings","workgroupId","parseInt","nodeIds","getFlattenedProjectAsNodeIds","branches","getBranches","teacherWorkgroupId","getWorkgroupId","canViewStudentNames","canGradeStudentWork","role","getTeacherRole","userName","getUserNameByWorkgroupId","document","body","scrollTop","documentElement","context","nodeId","componentId","componentType","category","event","data","saveEvent","result","isNodeIdInABranch","branchPaths","getBranchPathsByNodeId","bp","length","branchPathHasWork","branchPath","n","nodeIdInBranch","componentStates","getComponentStatesByWorkgroupIdAndNodeId","getNodePositionAndTitleByNodeId","getEventsByWorkgroupId","getEventsByWorkgroupIdAndNodeId","getAnnotationsToWorkgroupId","getAnnotationsToWorkgroupIdAndNodeId","stepWorkId","annotation","saveAnnotation","getComponentsByNodeId","componentState","getLatestComponentStateByWorkgroupIdNodeIdAndComponentId","$event","retrieveNotebookItems","then","notebookItems","reportItemId","config","itemTypes","report","notes","reportId","reportItem","getLatestNotebookItemByLocalNotebookItemId","reportItemContent","content","show","alert","title","htmlContent","ok","targetEvent","finally","undefined","$inject"],"mappings":"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","file":"studentGradingController.js","sourcesContent":["'use strict';\n\nclass StudentGradingController {\n\n    constructor($mdDialog,\n                $stateParams,\n                AnnotationService,\n                ConfigService,\n                NotebookService,\n                ProjectService,\n                TeacherDataService) {\n\n        this.$mdDialog = $mdDialog;\n        this.$stateParams = $stateParams;\n        this.AnnotationService = AnnotationService;\n        this.ConfigService = ConfigService;\n        this.NotebookService = NotebookService;\n        this.ProjectService = ProjectService;\n        this.TeacherDataService = TeacherDataService;\n\n        this.annotationMappings = {};\n\n        this.workgroupId = parseInt(this.$stateParams.workgroupId);\n\n        this.nodeIds = this.ProjectService.getFlattenedProjectAsNodeIds();\n\n        this.branches = this.ProjectService.getBranches();\n\n        this.teacherWorkgroupId = this.ConfigService.getWorkgroupId();\n        \n        this.canViewStudentNames = true;\n        this.canGradeStudentWork = true;\n        \n        // get the role of the teacher for the run e.g. 'owner', 'write', 'read'\n        var role = this.ConfigService.getTeacherRole(this.teacherWorkgroupId);\n        \n        if (role === 'owner') {\n            // the teacher is the owner of the run and has full access\n            this.canViewStudentNames = true;\n            this.canGradeStudentWork = true;\n        } else if (role === 'write') {\n            // the teacher is a shared teacher that can grade the student work\n            this.canViewStudentNames = true;\n            this.canGradeStudentWork = true;\n        } else if (role === 'read') {\n            // the teacher is a shared teacher that can only view the student work\n            this.canViewStudentNames = false;\n            this.canGradeStudentWork = false;\n        }\n        \n        if (this.canViewStudentNames) {\n            // display the student name\n            this.userName = this.ConfigService.getUserNameByWorkgroupId(this.workgroupId);\n        } else {\n            // do not display the student name. instead display the workgroup id.\n            this.userName = this.workgroupId;\n        }\n\n        // scroll to the top of the page when the page loads2\n        document.body.scrollTop = document.documentElement.scrollTop = 0;\n\n        // save event when student grading view is displayed\n        let context = \"ClassroomMonitor\", nodeId = null, componentId = null, componentType = null,\n            category = \"Navigation\", event = \"studentGradingViewDisplayed\", data = { workgroupId: this.workgroupId };\n        this.TeacherDataService.saveEvent(context, nodeId, componentId, componentType, category, event, data);\n    }\n\n    /**\n     * Check if we should show the given node id for the student. We will\n     * determine whether to show a node id or not by checking to see if\n     * the node id is in a branch. If the node id is not in a branch we\n     * will show it. If the node id is in a branch, we need to check which\n     * branch paths the node id is in. If the node id is in a branch path\n     * and the student has work for any node id in the branch path, we will\n     * show the node id passed into this function.\n     * @param nodeId the node id\n     * @return whether to show the node for this student\n     */\n    showNodeIdForStudent(nodeId) {\n        var result = false;\n\n        if (this.ProjectService.isNodeIdInABranch(this.branches, nodeId)) {\n            /*\n             * node is in a branch so we will check if we should show\n             * the node for this student. if the student has work in any\n             * step in the branch path, we will show all the nodes in the\n             * branch.\n             */\n\n            // get the branches this node id is in\n            var branchPaths = this.ProjectService.getBranchPathsByNodeId(this.branches, nodeId);\n\n            // loop through all the branch paths that this node id is in\n            for (var bp = 0; bp < branchPaths.length; bp++) {\n                var branchPathHasWork = false;\n\n                // get a branch path\n                var branchPath = branchPaths[bp];\n\n                // loop through all the node ids in the branch path\n                for (var n = 0; n < branchPath.length; n++) {\n\n                    // get a node id in the branch path\n                    var nodeIdInBranch = branchPath[n];\n\n                    // get the work for this student for the node id\n                    var componentStates = this.TeacherDataService.getComponentStatesByWorkgroupIdAndNodeId(this.workgroupId, nodeIdInBranch);\n\n                    if (componentStates != null && componentStates.length > 0) {\n                        /*\n                         * the student has work for the step so we will say\n                         * the branch path has work and that the node id\n                         * passed into the function should be shown\n                         */\n                        result = true;\n                    }\n                }\n            }\n\n        } else {\n            // node is not in a branch so we will show it\n            result = true;\n        }\n\n        return result;\n    };\n\n    getNodePositionAndTitleByNodeId(nodeId) {\n        return this.ProjectService.getNodePositionAndTitleByNodeId(nodeId);\n    };\n\n    getEventsByWorkgroupId(workgroupId) {\n        return this.TeacherDataService.getEventsByWorkgroupId(workgroupId);\n    };\n\n    getEventsByWorkgroupIdAndNodeId(workgroupId, nodeId) {\n        return this.TeacherDataService.getEventsByWorkgroupIdAndNodeId(workgroupId, nodeId);\n    };\n\n    getAnnotationsToWorkgroupId(workgroupId) {\n        return this.TeacherDataService.getAnnotationsToWorkgroupId(workgroupId);\n    };\n\n    getAnnotationsToWorkgroupIdAndNodeId(workgroupId, nodeId) {\n        return this.TeacherDataService.getAnnotationsToWorkgroupIdAndNodeId(workgroupId, nodeId);\n    };\n\n    getComponentStatesByWorkgroupIdAndNodeId(workgroupId, nodeId) {\n        return this.TeacherDataService.getComponentStatesByWorkgroupIdAndNodeId(workgroupId, nodeId);\n    };\n\n    scoreChanged(stepWorkId) {\n        var annotation = this.annotationMappings[stepWorkId + '-score'];\n        this.AnnotationService.saveAnnotation(annotation);\n    };\n\n    commentChanged(stepWorkId) {\n        var annotation = this.annotationMappings[stepWorkId + '-comment'];\n        this.AnnotationService.saveAnnotation(annotation);\n    }\n\n    getComponentsByNodeId(nodeId) {\n        return this.ProjectService.getComponentsByNodeId(nodeId);\n    }\n\n    /**\n     * Get the student data for a specific student for a specific component\n     * @param workgroupId the workgroupId id of Workgroup who created the component state\n     * @param nodeId the node id\n     * @param componentId the componentId the component id\n     * @return the student data for the given component\n     */\n    getLatestComponentStateByWorkgroupIdAndNodeIdAndComponentId(workgroupId, nodeId, componentId) {\n        var componentState = null;\n\n        if (workgroupId != null && nodeId != null && componentId != null) {\n\n            // get the latest component state for the component\n            componentState = this.TeacherDataService.getLatestComponentStateByWorkgroupIdNodeIdAndComponentId(workgroupId, nodeId, componentId);\n        }\n\n        return componentState;\n    }\n\n    showNotebookReport($event) {\n        this.NotebookService.retrieveNotebookItems(this.workgroupId).then((notebookItems) => {\n            // assume only one report for now\n            let reportItemId = this.NotebookService.config.itemTypes.report.notes[0].reportId;\n            let reportItem = this.NotebookService.getLatestNotebookItemByLocalNotebookItemId(reportItemId);\n            let reportItemContent = reportItem.content.content;\n            this.$mdDialog.show(this.$mdDialog.alert({\n                title: reportItem.content.title,\n                htmlContent: reportItemContent,\n                ok: 'Close',\n                targetEvent: $event\n            })).finally(() => { alert = undefined; });\n        });\n    }\n}\n\nStudentGradingController.$inject = [\n    '$mdDialog',\n    '$stateParams',\n    'AnnotationService',\n    'ConfigService',\n    'NotebookService',\n    'ProjectService',\n    'TeacherDataService'\n];\n\nexport default StudentGradingController;"]}