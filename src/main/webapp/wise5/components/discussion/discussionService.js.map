{"version":3,"sources":["discussionService.es6"],"names":["DiscussionService","$filter","$http","$rootScope","$q","$injector","ConfigService","StudentDataService","UtilService","getMode","TeacherDataService","get","$translate","component","type","prompt","isStudentAttachmentEnabled","gateClassmateResponses","runId","periodId","nodeId","componentId","resolve","reject","params","getStudentWork","getAnnotations","httpParams","method","url","getConfigParam","then","result","data","componentStates","componentEvents","nodeEvents","hasShowWorkConnectedComponentThatHasWork","hasNodeEnteredEvent","componentState","studentData","response","componentContent","connectedComponents","connectedComponent","getComponentStatesByNodeIdAndComponentId","length","nodeEvent","event","workgroupId","allPosts","topLevelComponentStateIdsFound","getComponentStatesByWorkgroupIdAndComponentId","componentStateIdReplyingTo","isTopLevelPost","isTopLevelComponentStateIdFound","id","concat","getPostAndAllReplies","push","componentStateId","indexOf","postAndAllReplies","componentStatesForNodeId","getComponentStatesByComponentId","starterSentence","ComponentService","$inject"],"mappings":"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","file":"discussionService.js","sourcesContent":["import ComponentService from '../componentService';\n\nclass DiscussionService extends ComponentService {\n  constructor($filter,\n      $http,\n      $rootScope,\n      $q,\n      $injector,\n      ConfigService,\n      StudentDataService,\n      UtilService) {\n    super($filter, StudentDataService, UtilService);\n    this.$http = $http;\n    this.$rootScope = $rootScope;\n    this.$q = $q;\n    this.$injector = $injector;\n    this.ConfigService = ConfigService;\n    if (this.ConfigService.getMode() === 'classroomMonitor') {\n      /*\n       * In the Classroom Monitor, we need access to the TeacherDataService so we can retrieve posts\n       * for all students.\n       */\n      this.TeacherDataService = this.$injector.get('TeacherDataService');\n    }\n  }\n\n  getComponentTypeLabel() {\n    return this.$translate('discussion.componentTypeLabel');\n  }\n\n  createComponent() {\n    const component = super.createComponent();\n    component.type = 'Discussion';\n    component.prompt = this.$translate('ENTER_PROMPT_HERE');\n    component.isStudentAttachmentEnabled = true;\n    component.gateClassmateResponses = true;\n    return component;\n  }\n\n  getClassmateResponses(runId, periodId, nodeId, componentId) {\n    return this.$q((resolve, reject) => {\n      const params = {\n        runId: runId,\n        periodId: periodId,\n        nodeId: nodeId,\n        componentId: componentId,\n        getStudentWork: true,\n        getAnnotations: true\n      };\n      const httpParams = {\n        method: 'GET',\n        url: this.ConfigService.getConfigParam('studentDataURL'),\n        params: params\n      };\n      this.$http(httpParams).then((result) => {\n        resolve(result.data);\n      });\n    });\n  }\n\n  isCompleted(component, componentStates, componentEvents, nodeEvents) {\n    if (this.hasShowWorkConnectedComponentThatHasWork(component)) {\n      if (this.hasNodeEnteredEvent(nodeEvents)) {\n        return true;\n      }\n    } else {\n      for (let componentState of componentStates) {\n        if (componentState.studentData.response != null) {\n          return true;\n        }\n      }\n    }\n    return false;\n  }\n\n  hasShowWorkConnectedComponentThatHasWork(componentContent) {\n    const connectedComponents = componentContent.connectedComponents;\n    if (connectedComponents != null) {\n      for (let connectedComponent of connectedComponents) {\n        if (connectedComponent.type == 'showWork') {\n          const componentStates =\n              this.StudentDataService.getComponentStatesByNodeIdAndComponentId(\n              connectedComponent.nodeId, connectedComponent.componentId);\n          if (componentStates.length > 0) {\n            return true;\n          }\n        }\n      }\n    }\n    return false;\n  }\n\n  hasNodeEnteredEvent(nodeEvents) {\n    for (let nodeEvent of nodeEvents) {\n      if (nodeEvent.event === 'nodeEntered') {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  /**\n   * Get all the posts associated with a workgroup id. This will get all the posts and replies that\n   * the workgroup posted or replied to as well as all the other replies classmates made.\n   * @param componentId the component id\n   * @param workgroupId the workgroup id\n   * @returns an array containing all the component states for top level posts and replies that are\n   * associated with the workgroup\n   */\n  getPostsAssociatedWithWorkgroupId(componentId, workgroupId) {\n    let allPosts = [];\n    const topLevelComponentStateIdsFound = [];\n    const componentStates =\n        this.TeacherDataService.getComponentStatesByWorkgroupIdAndComponentId(workgroupId, componentId);\n    for (let componentState of componentStates) {\n      const componentStateIdReplyingTo = componentState.studentData.componentStateIdReplyingTo;\n      if (this.isTopLevelPost(componentState)) {\n        if (!this.isTopLevelComponentStateIdFound(topLevelComponentStateIdsFound, componentState.id)) {\n          allPosts = allPosts.concat(this.getPostAndAllReplies(componentId, componentState.id));\n          topLevelComponentStateIdsFound.push(componentState.id);\n        }\n      } else {\n        if (!this.isTopLevelComponentStateIdFound(topLevelComponentStateIdsFound, componentStateIdReplyingTo)) {\n          allPosts = allPosts.concat(this.getPostAndAllReplies(componentId, componentStateIdReplyingTo));\n          topLevelComponentStateIdsFound.push(componentStateIdReplyingTo);\n        }\n      }\n    }\n    return allPosts;\n  }\n\n  isTopLevelPost(componentState) {\n    return componentState.studentData.componentStateIdReplyingTo == null;\n  }\n\n  isTopLevelComponentStateIdFound(topLevelComponentStateIdsFound, componentStateId) {\n    return topLevelComponentStateIdsFound.indexOf(componentStateId) != -1;\n  }\n\n  /**\n   * Get the top level post and all the replies to it\n   * @param componentId the component id\n   * @param componentStateId the component state id\n   * @returns an array containing the top level post and all the replies\n   */\n  getPostAndAllReplies(componentId, componentStateId) {\n    const postAndAllReplies = [];\n    const componentStatesForNodeId = this.TeacherDataService.getComponentStatesByComponentId(componentId);\n    for (let componentState of componentStatesForNodeId) {\n      if (componentStateId === componentState.id) {\n        postAndAllReplies.push(componentState);\n      } else {\n        const componentStateIdReplyingTo = componentState.studentData.componentStateIdReplyingTo;\n        if (componentStateId === componentStateIdReplyingTo) {\n          postAndAllReplies.push(componentState);\n        }\n      }\n    }\n    return postAndAllReplies;\n  }\n\n  componentUsesSaveButton() {\n    return false;\n  }\n\n  componentUsesSubmitButton() {\n    return false;\n  }\n\n  componentStateHasStudentWork(componentState, componentContent) {\n    if (componentState != null) {\n      const response = componentState.studentData.response;\n      if (componentContent == null) {\n        if (response != null && response !== '') {\n          return true;\n        }\n      } else {\n        const starterSentence = componentContent.starterSentence;\n        if (starterSentence == null || starterSentence === '') {\n          if (response != null && response !== '') {\n            return true;\n          }\n        } else {\n          if (response != null && response !== '' && response !== starterSentence) {\n            return true;\n          }\n        }\n      }\n    }\n\n    return false;\n  }\n}\n\nDiscussionService.$inject = [\n  '$filter',\n  '$http',\n  '$rootScope',\n  '$q',\n  '$injector',\n  'ConfigService',\n  'StudentDataService',\n  'UtilService'\n];\n\nexport default DiscussionService;\n"]}