{"version":3,"sources":["discussionService.es6"],"names":["DiscussionService","$filter","$http","$rootScope","$q","$injector","ConfigService","StudentDataService","UtilService","getMode","TeacherDataService","get","$translate","component","type","prompt","isStudentAttachmentEnabled","gateClassmateResponses","runId","periodId","components","resolve","reject","params","getStudentWork","getAnnotations","httpParams","method","url","getConfigParam","then","result","data","componentStates","componentEvents","nodeEvents","hasShowWorkConnectedComponentThatHasWork","hasNodeEnteredEvent","componentState","studentData","response","componentContent","connectedComponents","connectedComponent","getComponentStatesByNodeIdAndComponentId","nodeId","componentId","length","nodeEvent","event","workgroupId","allPosts","topLevelComponentStateIdsFound","getComponentStatesByWorkgroupIdAndComponentId","componentStateIdReplyingTo","isTopLevelPost","isTopLevelComponentStateIdFound","id","concat","getPostAndAllReplies","push","componentStateId","indexOf","postAndAllReplies","componentStatesForNodeId","getComponentStatesByComponentId","isStudentWorkHasAttachment","isComponentHasStarterSentence","isStudentWorkHasText","isStudentResponseDifferentFromStarterSentence","starterSentence","attachments","ComponentService","$inject"],"mappings":"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","file":"discussionService.js","sourcesContent":["import ComponentService from '../componentService';\n\nclass DiscussionService extends ComponentService {\n  constructor($filter,\n      $http,\n      $rootScope,\n      $q,\n      $injector,\n      ConfigService,\n      StudentDataService,\n      UtilService) {\n    super($filter, StudentDataService, UtilService);\n    this.$http = $http;\n    this.$rootScope = $rootScope;\n    this.$q = $q;\n    this.$injector = $injector;\n    this.ConfigService = ConfigService;\n    if (this.ConfigService.getMode() === 'classroomMonitor') {\n      /*\n       * In the Classroom Monitor, we need access to the TeacherDataService so we can retrieve posts\n       * for all students.\n       */\n      this.TeacherDataService = this.$injector.get('TeacherDataService');\n    }\n  }\n\n  getComponentTypeLabel() {\n    return this.$translate('discussion.componentTypeLabel');\n  }\n\n  createComponent() {\n    const component = super.createComponent();\n    component.type = 'Discussion';\n    component.prompt = this.$translate('ENTER_PROMPT_HERE');\n    component.isStudentAttachmentEnabled = true;\n    component.gateClassmateResponses = true;\n    return component;\n  }\n\n  getClassmateResponses(runId, periodId, components) {\n    return this.$q((resolve, reject) => {\n      const params = {\n        runId: runId,\n        periodId: periodId,\n        components: components,\n        getStudentWork: true,\n        getAnnotations: true\n      };\n      const httpParams = {\n        method: 'GET',\n        url: this.ConfigService.getConfigParam('studentDataURL'),\n        params: params\n      };\n      this.$http(httpParams).then((result) => {\n        resolve(result.data);\n      });\n    });\n  }\n\n  isCompleted(component, componentStates, componentEvents, nodeEvents) {\n    if (this.hasShowWorkConnectedComponentThatHasWork(component)) {\n      if (this.hasNodeEnteredEvent(nodeEvents)) {\n        return true;\n      }\n    } else {\n      for (let componentState of componentStates) {\n        if (componentState.studentData.response != null) {\n          return true;\n        }\n      }\n    }\n    return false;\n  }\n\n  hasShowWorkConnectedComponentThatHasWork(componentContent) {\n    const connectedComponents = componentContent.connectedComponents;\n    if (connectedComponents != null) {\n      for (let connectedComponent of connectedComponents) {\n        if (connectedComponent.type == 'showWork') {\n          const componentStates =\n              this.StudentDataService.getComponentStatesByNodeIdAndComponentId(\n              connectedComponent.nodeId, connectedComponent.componentId);\n          if (componentStates.length > 0) {\n            return true;\n          }\n        }\n      }\n    }\n    return false;\n  }\n\n  hasNodeEnteredEvent(nodeEvents) {\n    for (let nodeEvent of nodeEvents) {\n      if (nodeEvent.event === 'nodeEntered') {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  /**\n   * Get all the posts associated with a workgroup id. This will get all the posts and replies that\n   * the workgroup posted or replied to as well as all the other replies classmates made.\n   * @param componentId the component id\n   * @param workgroupId the workgroup id\n   * @returns an array containing all the component states for top level posts and replies that are\n   * associated with the workgroup\n   */\n  getPostsAssociatedWithWorkgroupId(componentId, workgroupId) {\n    let allPosts = [];\n    const topLevelComponentStateIdsFound = [];\n    const componentStates =\n        this.TeacherDataService.getComponentStatesByWorkgroupIdAndComponentId(workgroupId, componentId);\n    for (let componentState of componentStates) {\n      const componentStateIdReplyingTo = componentState.studentData.componentStateIdReplyingTo;\n      if (this.isTopLevelPost(componentState)) {\n        if (!this.isTopLevelComponentStateIdFound(topLevelComponentStateIdsFound, componentState.id)) {\n          allPosts = allPosts.concat(this.getPostAndAllReplies(componentId, componentState.id));\n          topLevelComponentStateIdsFound.push(componentState.id);\n        }\n      } else {\n        if (!this.isTopLevelComponentStateIdFound(topLevelComponentStateIdsFound, componentStateIdReplyingTo)) {\n          allPosts = allPosts.concat(this.getPostAndAllReplies(componentId, componentStateIdReplyingTo));\n          topLevelComponentStateIdsFound.push(componentStateIdReplyingTo);\n        }\n      }\n    }\n    return allPosts;\n  }\n\n  isTopLevelPost(componentState) {\n    return componentState.studentData.componentStateIdReplyingTo == null;\n  }\n\n  isTopLevelComponentStateIdFound(topLevelComponentStateIdsFound, componentStateId) {\n    return topLevelComponentStateIdsFound.indexOf(componentStateId) != -1;\n  }\n\n  /**\n   * Get the top level post and all the replies to it\n   * @param componentId the component id\n   * @param componentStateId the component state id\n   * @returns an array containing the top level post and all the replies\n   */\n  getPostAndAllReplies(componentId, componentStateId) {\n    const postAndAllReplies = [];\n    const componentStatesForNodeId = this.TeacherDataService.getComponentStatesByComponentId(componentId);\n    for (let componentState of componentStatesForNodeId) {\n      if (componentStateId === componentState.id) {\n        postAndAllReplies.push(componentState);\n      } else {\n        const componentStateIdReplyingTo = componentState.studentData.componentStateIdReplyingTo;\n        if (componentStateId === componentStateIdReplyingTo) {\n          postAndAllReplies.push(componentState);\n        }\n      }\n    }\n    return postAndAllReplies;\n  }\n\n  componentUsesSaveButton() {\n    return false;\n  }\n\n  componentUsesSubmitButton() {\n    return false;\n  }\n\n  componentStateHasStudentWork(componentState, componentContent) {\n    if (this.isStudentWorkHasAttachment(componentState)) {\n      return true;\n    }\n    if (this.isComponentHasStarterSentence(componentContent)) {\n      return this.isStudentWorkHasText(componentState) &&\n          this.isStudentResponseDifferentFromStarterSentence(componentState, componentContent);\n    } else {\n      return this.isStudentWorkHasText(componentState);\n    }\n  }\n\n  isComponentHasStarterSentence(componentContent) {\n    const starterSentence = componentContent.starterSentence;\n    return starterSentence != null && starterSentence !== '';\n  }\n\n  isStudentResponseDifferentFromStarterSentence(componentState, componentContent) {\n    const response = componentState.studentData.response;\n    const starterSentence = componentContent.starterSentence;\n    return response !== starterSentence;\n  }\n\n  isStudentWorkHasText(componentState) {\n    const response = componentState.studentData.response;\n    return response != null && response !== '';\n  }\n\n  isStudentWorkHasAttachment(componentState) {\n    const attachments = componentState.studentData.attachments;\n    return attachments != null && attachments.length > 0;\n  }\n}\n\nDiscussionService.$inject = [\n  '$filter',\n  '$http',\n  '$rootScope',\n  '$q',\n  '$injector',\n  'ConfigService',\n  'StudentDataService',\n  'UtilService'\n];\n\nexport default DiscussionService;\n"]}