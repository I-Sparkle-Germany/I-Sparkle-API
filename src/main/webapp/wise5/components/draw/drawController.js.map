{"version":3,"sources":["drawController.es6"],"names":["DrawController","$filter","$injector","$mdDialog","$q","$rootScope","$scope","$timeout","AnnotationService","ConfigService","DrawService","NodeService","NotebookService","ProjectService","StudentAssetService","StudentDataService","UtilService","isResetButtonVisible","notebookConfig","getNotebookConfig","drawingTool","latestConnectedComponentState","latestConnectedComponentParams","width","height","componentContent","componentType","type","isStudentMode","isSaveButtonVisible","showSaveButton","isSubmitButtonVisible","showSubmitButton","drawingToolId","nodeId","componentId","isGradingMode","isGradingRevisionMode","isOnlyShowWorkMode","componentState","id","angular","bind","initializeDrawingTool","initializeScopeGetComponentState","$on","event","args","isEventTargetThisComponent","imageObject","getImageObject","requestImageCallbackArgs","$emit","requester","notebookItem","studentWorkId","content","studentWorkIds","importWorkByStudentWorkId","broadcastDoneRenderingComponent","studentWork","isForThisComponent","isConnectedComponent","connectedComponentParams","getConnectedComponentParams","updateOn","isSubmit","performUpdate","makeCopyOfJSONObject","isCanvasEmpty","confirm","$translate","includeBackground","removeBackgroundFromComponentState","setDrawData","drawController","isDirty","isSubmitDirty","submit","DrawingTool","stamps","parseSVG","state","$","on","setBackgroundImage","val","resizeBackgroundToCanvas","resizeCanvasToBackground","shrinkBackgroundToCanvas","clear","save","removeAttr","load","hasShowWorkConnectedComponent","handleConnectedComponents","componentStateHasStudentWork","setStudentWork","hasConnectedComponent","starterDrawData","background","isAuthoringMode","hasMaxSubmitCount","hasSubmitsLeft","isSubmitButtonDisabled","disableComponentIfNecessary","studentDataChanged","toolName","category","data","selectedToolName","saveComponentEvent","find","hide","setupTools","isDisabled","canvas","removeListeners","tools","setupSelectTool","setupLineTool","setupShapeTool","setupFreeHandTool","setupTextTool","setupStampTool","setupCloneTool","setupStrokeColorTool","setupFillColorTool","setupStrokeWidthTool","setupSendBackTool","setupSendForwardTool","setupUndoTool","setupRedoTool","setupDeleteTool","selectTitle","select","show","lineTitle","line","shapeTitle","shape","freeHandTitle","freeHand","textTitle","text","stampTitle","stamp","cloneTitle","clone","strokeColorTitle","strokeColor","fillColorTitle","fillColor","strokeWidthTitle","strokeWidth","sendBackTitle","sendBack","sendForwardTitle","sendForward","undoTitle","undo","redoTitle","redo","deleteTitle","processLatestStudentWork","parentStudentWorkIds","action","deferred","defer","createNewComponentState","studentData","studentDataJSONString","getDrawData","drawData","submitCounter","createComponentStateAdditionalProcessing","promise","studentAsset","copyAssetForReference","then","copiedAsset","fabric","Image","fromURL","url","oImg","scaleToWidth","studentAssetId","add","canvasBase64Image","toDataURL","getImageObjectFromBase64String","objects","getObjects","length","$event","element","noteText","addNote","deregisterListener","snipDrawing","saveButtonClicked","getLatestComponentStateByNodeIdAndComponentId","componentStates","mergedComponentState","allDrawCanvasObjects","firstDrawData","c","drawDataJSON","fromJson","concat","connectedComponent","getConnectedComponentByComponentState","importWorkAsBackground","setComponentStateAsBackgroundImage","toJson","generateImageFromComponentState","image","ComponentController","$inject"],"mappings":"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","sourcesContent":["'use strict';\n\nimport ComponentController from '../componentController';\nimport drawingTool from '../../lib/drawingTool/drawing-tool';\nimport drawingToolVendor from '../../lib/drawingTool/vendor.min';\nimport html2canvas from 'html2canvas';\n\nclass DrawController extends ComponentController {\n  constructor($filter,\n      $injector,\n      $mdDialog,\n      $q,\n      $rootScope,\n      $scope,\n      $timeout,\n      AnnotationService,\n      ConfigService,\n      DrawService,\n      NodeService,\n      NotebookService,\n      ProjectService,\n      StudentAssetService,\n      StudentDataService,\n      UtilService) {\n    super($filter, $mdDialog, $rootScope, $scope,\n        AnnotationService, ConfigService, NodeService,\n        NotebookService, ProjectService, StudentAssetService,\n        StudentDataService, UtilService);\n    this.$injector = $injector;\n    this.$q = $q;\n    this.$timeout = $timeout;\n    this.DrawService = DrawService;\n\n    this.isResetButtonVisible = false;\n    this.notebookConfig = this.NotebookService.getNotebookConfig();\n    this.drawingTool = null;\n    this.latestConnectedComponentState = null;\n    this.latestConnectedComponentParams = null;\n    this.width = 800;\n    this.height = 600;\n\n    if (this.componentContent.width != null) {\n      this.width = this.componentContent.width;\n    }\n\n    if (this.componentContent.height != null) {\n      this.height = this.componentContent.height;\n    }\n\n    this.componentType = this.componentContent.type;\n\n    if (this.isStudentMode()) {\n      this.isSaveButtonVisible = this.componentContent.showSaveButton;\n      this.isSubmitButtonVisible = this.componentContent.showSubmitButton;\n      this.isResetButtonVisible = true;\n      this.drawingToolId = 'drawingtool_' + this.nodeId + '_' + this.componentId;\n    } else if (this.isGradingMode() || this.isGradingRevisionMode() || this.isOnlyShowWorkMode()) {\n      const componentState = this.$scope.componentState;\n      if (componentState != null) {\n        if (this.isGradingRevisionMode()) {\n          this.drawingToolId = 'drawingtool_gradingRevision_' + componentState.id;\n        } else {\n          this.drawingToolId = 'drawingtool_' + componentState.id;\n        }\n      }\n    }\n\n    /*\n     * Running this inside a timeout ensures that the code only runs after the markup is rendered.\n     * Maybe there's a better way to do this, like with an event?\n     */\n    this.$timeout(angular.bind(this, this.initializeDrawingTool));\n\n    this.initializeScopeGetComponentState(this.$scope, 'drawController');\n\n    /*\n     * Listen for the requestImage event which is fired when something needs an image representation\n     * of the student data from a specific component.\n     */\n    this.$scope.$on('requestImage', (event, args) => {\n      if (this.isEventTargetThisComponent(args)) {\n        const imageObject = this.getImageObject();\n        const requestImageCallbackArgs = {\n          nodeId: args.nodeId,\n          componentId: args.componentId,\n          imageObject: imageObject\n        };\n        this.$scope.$emit('requestImageCallback', requestImageCallbackArgs);\n      }\n    });\n\n    this.$scope.$on('notebookItemChosen', (event, args) => {\n      if (args.requester == this.nodeId + '-' + this.componentId) {\n        const notebookItem = args.notebookItem;\n        const studentWorkId = notebookItem.content.studentWorkIds[0];\n        this.importWorkByStudentWorkId(studentWorkId);\n      }\n    });\n\n    this.broadcastDoneRenderingComponent();\n  }\n\n  handleStudentWorkSavedToServerAdditionalProcessing(event, args) {\n    let componentState = args.studentWork;\n    if (this.isForThisComponent(componentState) &&\n        this.ProjectService.isConnectedComponent(\n            this.nodeId, this.componentId, componentState.componentId)) {\n      const connectedComponentParams = this.ProjectService.getConnectedComponentParams(this.componentContent, componentState.componentId);\n      if (connectedComponentParams != null) {\n        if (connectedComponentParams.updateOn === 'save' ||\n            (connectedComponentParams.updateOn === 'submit' && componentState.isSubmit)) {\n          let performUpdate = false;\n          /*\n           * make a copy of the component state so we don't accidentally\n           * change any values in the referenced object\n           */\n          componentState = this.UtilService.makeCopyOfJSONObject(componentState);\n\n          if (this.isCanvasEmpty()) {\n            performUpdate = true;\n          } else {\n            // the student has drawn on the canvas so we will ask them if they want to update it\n            if (confirm(this.$translate('draw.doYouWantToUpdateTheConnectedDrawing'))) {\n              performUpdate = true;\n            }\n          }\n\n          if (performUpdate) {\n            if (!connectedComponentParams.includeBackground) {\n              this.DrawService.removeBackgroundFromComponentState(componentState);\n            }\n            this.setDrawData(componentState);\n            this.$scope.drawController.isDirty = true;\n            this.$scope.drawController.isSubmitDirty = true;\n          }\n\n          /*\n           * remember the component state and connected component params\n           * in case we need to use them again later\n           */\n          this.latestConnectedComponentState = componentState;\n          this.latestConnectedComponentParams = connectedComponentParams;\n        }\n      }\n    }\n  }\n\n  handleNodeSubmit() {\n    this.submit('nodeSubmitButton');\n  }\n\n  initializeDrawingTool() {\n    this.drawingTool = new DrawingTool('#' + this.drawingToolId, {\n      stamps: this.componentContent.stamps || {},\n      parseSVG: true,\n      width: this.width,\n      height: this.height\n    });\n    let state = null;\n    $('#set-background').on('click', () => {\n      this.drawingTool.setBackgroundImage($('#background-src').val());\n    });\n    $('#resize-background').on('click', () => {\n      this.drawingTool.resizeBackgroundToCanvas();\n    });\n    $('#resize-canvas').on('click', () => {\n      this.drawingTool.resizeCanvasToBackground();\n    });\n    $('#shrink-background').on('click', () => {\n      this.drawingTool.shrinkBackgroundToCanvas();\n    });\n    $('#clear').on('click', () => {\n      this.drawingTool.clear(true);\n    });\n    $('#save').on('click', () => {\n      state = drawingTool.save();\n      $('#load').removeAttr('disabled');\n    });\n    $('#load').on('click', () => {\n      if (state === null) return;\n      this.drawingTool.load(state);\n    });\n\n    const componentState = this.$scope.componentState;\n    if (this.isStudentMode()) {\n      if (this.UtilService.hasShowWorkConnectedComponent(this.componentContent)) {\n        this.handleConnectedComponents();\n      }  else if (this.DrawService.componentStateHasStudentWork(componentState, this.componentContent)) {\n        this.setStudentWork(componentState);\n      } else if (this.UtilService.hasConnectedComponent(this.componentContent)) {\n        this.handleConnectedComponents();\n      } else if (componentState == null ||\n             !this.DrawService.componentStateHasStudentWork(componentState, this.componentContent)) {\n        if (this.componentContent.starterDrawData != null) {\n          this.drawingTool.load(this.componentContent.starterDrawData);\n        }\n        if (this.componentContent.background != null) {\n          this.drawingTool.setBackgroundImage(this.componentContent.background);\n        }\n      }\n    } else if (this.isAuthoringMode()) {\n      if (this.componentContent.starterDrawData != null) {\n        this.drawingTool.load(this.componentContent.starterDrawData);\n      }\n      if (this.componentContent.background != null) {\n        this.drawingTool.setBackgroundImage(this.componentContent.background);\n      }\n    } else {\n      this.setStudentWork(componentState);\n    }\n\n    if (this.hasMaxSubmitCount() && this.hasSubmitsLeft()) {\n      this.isSubmitButtonDisabled = true;\n    }\n\n    this.disableComponentIfNecessary();\n\n    /*\n     * Wait before we start listening for the drawing:changed event. We need to wait\n     * because the calls above to this.drawingTool.setBackgroundImage() will cause\n     * the drawing:changed event to be fired from the drawingTool, but when that happens,\n     * we don't want to call this.studentDataChanged() because it marks the student work\n     * as dirty. We only want to call this.studentDataChanged() when the drawing:changed\n     * event occurs in response to the student changing the drawing and this timeout\n     * will help make sure of that.\n     */\n    this.$timeout(angular.bind(this, () => {\n      this.drawingTool.on('drawing:changed', angular.bind(this, this.studentDataChanged));\n    }), 500);\n\n    if (this.isStudentMode()) {\n      this.drawingTool.on('tool:changed', (toolName) => {\n        const category = 'Tool';\n        const event = 'toolSelected';\n        const data = {\n          selectedToolName: toolName\n        };\n        this.StudentDataService.saveComponentEvent(this, category, event, data);\n      });\n    }\n\n    if (this.isGradingMode() || this.isGradingRevisionMode() || this.isOnlyShowWorkMode()) {\n      $('#' + this.drawingToolId).find('.dt-tools').hide();\n    } else {\n      this.setupTools();\n    }\n\n    if (this.isDisabled) {\n      this.drawingTool.canvas.removeListeners();\n    }\n  }\n\n  handleConnectedComponentsPostProcess() {\n    if (this.componentContent.background != null) {\n      this.drawingTool.setBackgroundImage(this.componentContent.background);\n    }\n  }\n\n  /**\n   * Setup the tools that we will make available to the student\n   */\n  setupTools() {\n    const tools = this.componentContent.tools;\n    if (tools == null) {\n      // we will display all the tools\n    } else {\n      // we will only display the tools the authored specified to show\n      const drawingTool = $('#' + this.drawingToolId);\n      this.setupSelectTool(drawingTool, tools);\n      this.setupLineTool(drawingTool, tools);\n      this.setupShapeTool(drawingTool, tools);\n      this.setupFreeHandTool(drawingTool, tools);\n      this.setupTextTool(drawingTool, tools);\n      this.setupStampTool(drawingTool, tools);\n      this.setupCloneTool(drawingTool, tools);\n      this.setupStrokeColorTool(drawingTool, tools);\n      this.setupFillColorTool(drawingTool, tools);\n      this.setupStrokeWidthTool(drawingTool, tools);\n      this.setupSendBackTool(drawingTool, tools);\n      this.setupSendForwardTool(drawingTool, tools);\n      this.setupUndoTool(drawingTool, tools);\n      this.setupRedoTool(drawingTool, tools);\n      this.setupDeleteTool(drawingTool, tools);\n      if (this.isDisabled) {\n        drawingTool.find('.dt-tools').hide();\n      }\n    }\n  }\n\n  setupSelectTool(drawingTool, tools) {\n    const selectTitle = this.$translate('draw.selectToolTooltip');\n    if (tools.select) {\n      drawingTool.find('[title=\"' + selectTitle + '\"]').show();\n    } else {\n      drawingTool.find('[title=\"' + selectTitle + '\"]').hide();\n    }\n  }\n\n  setupLineTool(drawingTool, tools) {\n    const lineTitle = this.$translate('draw.lineToolTooltip');\n    if (tools.line) {\n      drawingTool.find('[title=\"' + lineTitle + '\"]').show();\n    } else {\n      drawingTool.find('[title=\"' + lineTitle + '\"]').hide();\n    }\n  }\n\n  setupShapeTool(drawingTool, tools) {\n    const shapeTitle = this.$translate('draw.shapeToolTooltip');\n    if (tools.shape) {\n      drawingTool.find('[title=\"' + shapeTitle + '\"]').show();\n    } else {\n      drawingTool.find('[title=\"' + shapeTitle + '\"]').hide();\n    }\n  }\n\n  setupFreeHandTool(drawingTool, tools) {\n    const freeHandTitle = this.$translate('draw.freeHandToolTooltip');\n    if (tools.freeHand) {\n      drawingTool.find('[title=\"' + freeHandTitle + '\"]').show();\n    } else {\n      drawingTool.find('[title=\"' + freeHandTitle + '\"]').hide();\n    }\n  }\n\n  setupTextTool(drawingTool, tools) {\n    const textTitle = this.$translate('draw.textToolTooltip');\n    if (tools.text) {\n      drawingTool.find('[title=\"' + textTitle + '\"]').show();\n    } else {\n      drawingTool.find('[title=\"' + textTitle + '\"]').hide();\n    }\n  }\n\n  setupStampTool(drawingTool, tools) {\n    const stampTitle = this.$translate('draw.stampToolTooltip');\n    if (tools.stamp) {\n      drawingTool.find('[title=\"' + stampTitle + '\"]').show();\n    } else {\n      drawingTool.find('[title=\"' + stampTitle + '\"]').hide();\n    }\n  }\n\n  setupCloneTool(drawingTool, tools) {\n    const cloneTitle = this.$translate('draw.cloneToolTooltip');\n    if (tools.clone) {\n      drawingTool.find('[title=\"' + cloneTitle + '\"]').show();\n    } else {\n      drawingTool.find('[title=\"' + cloneTitle + '\"]').hide();\n    }\n  }\n\n  setupStrokeColorTool(drawingTool, tools) {\n    const strokeColorTitle = this.$translate('draw.strokeColorToolTooltip');\n    if (tools.strokeColor) {\n      drawingTool.find('[title=\"' + strokeColorTitle + '\"]').show();\n    } else {\n      drawingTool.find('[title=\"' + strokeColorTitle + '\"]').hide();\n    }\n  }\n\n  setupFillColorTool(drawingTool, tools) {\n    const fillColorTitle = this.$translate('draw.fillColorToolTooltip');\n    if (tools.fillColor) {\n      drawingTool.find('[title=\"' + fillColorTitle + '\"]').show();\n    } else {\n      drawingTool.find('[title=\"' + fillColorTitle + '\"]').hide();\n    }\n  }\n\n  setupStrokeWidthTool(drawingTool, tools) {\n    const strokeWidthTitle = this.$translate('draw.strokeWidthToolTooltip');\n    if (tools.strokeWidth) {\n      drawingTool.find('[title=\"' + strokeWidthTitle + '\"]').show();\n    } else {\n      drawingTool.find('[title=\"' + strokeWidthTitle + '\"]').hide();\n    }\n  }\n\n  setupSendBackTool(drawingTool, tools) {\n    const sendBackTitle = this.$translate('draw.sendBackToolTooltip');\n    if (tools.sendBack) {\n      drawingTool.find('[title=\"' + sendBackTitle + '\"]').show();\n    } else {\n      drawingTool.find('[title=\"' + sendBackTitle + '\"]').hide();\n    }\n  }\n\n  setupSendForwardTool(drawingTool, tools) {\n    const sendForwardTitle = this.$translate('draw.sendForwardToolTooltip');\n    if (tools.sendForward) {\n      drawingTool.find('[title=\"' + sendForwardTitle + '\"]').show();\n    } else {\n      drawingTool.find('[title=\"' + sendForwardTitle + '\"]').hide();\n    }\n  }\n\n  setupUndoTool(drawingTool, tools) {\n    const undoTitle = this.$translate('draw.undo');\n    if (tools.undo) {\n      drawingTool.find('[title=\"' + undoTitle + '\"]').show();\n    } else {\n      drawingTool.find('[title=\"' + undoTitle + '\"]').hide();\n    }\n  }\n\n  setupRedoTool(drawingTool, tools) {\n    const redoTitle = this.$translate('draw.redo');\n    if (tools.redo) {\n      drawingTool.find('[title=\"' + redoTitle + '\"]').show();\n    } else {\n      drawingTool.find('[title=\"' + redoTitle + '\"]').hide();\n    }\n  }\n\n  setupDeleteTool(drawingTool, tools) {\n    const deleteTitle = this.$translate('draw.deleteToolTooltip');\n    if (tools.delete) {\n      drawingTool.find('[title=\"' + deleteTitle + '\"]').show();\n    } else {\n      drawingTool.find('[title=\"' + deleteTitle + '\"]').hide();\n    }\n  }\n\n  setStudentWork(componentState) {\n    if (componentState != null) {\n      this.setDrawData(componentState);\n      this.processLatestStudentWork();\n    }\n  }\n\n  resetButtonClicked() {\n    if (confirm(this.$translate('draw.areYouSureYouWantToClearYourDrawing'))) {\n      this.drawingTool.clear();\n      if (this.UtilService.hasConnectedComponent(this.componentContent)) {\n        this.handleConnectedComponents();\n      } else if (this.latestConnectedComponentState && this.latestConnectedComponentParams) {\n        this.setDrawData(latestConnectedComponentState, latestConnectedComponentParams);\n      } else if (this.componentContent.starterDrawData != null) {\n        this.drawingTool.load(this.componentContent.starterDrawData);\n      }\n      if (this.componentContent.background != null && this.componentContent.background != '') {\n        this.drawingTool.setBackgroundImage(this.componentContent.background);\n      }\n      this.parentStudentWorkIds = null;\n    }\n  }\n\n  /**\n   * Create a new component state populated with the student data\n   * @param action the action that is triggering creating of this component state\n   * e.g. 'submit', 'save', 'change'\n   * @return a promise that will return a component state\n   */\n  createComponentState(action) {\n    const deferred = this.$q.defer();\n    const componentState = this.NodeService.createNewComponentState();\n    const studentData = {};\n    const studentDataJSONString = this.getDrawData();\n    studentData.drawData = studentDataJSONString;\n    studentData.submitCounter = this.submitCounter;\n    if (this.parentStudentWorkIds != null) {\n      studentData.parentStudentWorkIds = this.parentStudentWorkIds;\n    }\n    componentState.isSubmit = this.isSubmit;\n    componentState.studentData = studentData;\n    componentState.componentType = 'Draw';\n    componentState.nodeId = this.nodeId;\n    componentState.componentId = this.componentId;\n    this.isSubmit = false;\n    this.createComponentStateAdditionalProcessing(deferred, componentState, action);\n    return deferred.promise;\n  }\n\n  /**\n   * Add student asset images as objects in the drawing canvas\n   * @param studentAsset\n   */\n  attachStudentAsset(studentAsset) {\n    this.StudentAssetService.copyAssetForReference(studentAsset).then((copiedAsset) => {\n      fabric.Image.fromURL(copiedAsset.url, (oImg) => {\n        oImg.scaleToWidth(200);  // set max width and have height scale proportionally\n        // TODO: center image or put them at mouse position? Wasn't straight-forward, tried below but had issues...\n        //oImg.setLeft((this.drawingTool.canvas.width / 2) - (oImg.width / 2));  // center image vertically and horizontally\n        //oImg.setTop((this.drawingTool.canvas.height / 2) - (oImg.height / 2));\n        //oImg.center();\n        oImg.studentAssetId = copiedAsset.id;  // keep track of this asset id\n        this.drawingTool.canvas.add(oImg);   // add copied asset image to canvas\n      });\n    });\n  }\n\n  getDrawData() {\n    return this.drawingTool.save();\n  }\n\n  /**\n   * Get the image object representation of the student data\n   * @returns an image object\n   */\n  getImageObject() {\n    if (this.drawingTool != null && this.drawingTool.canvas != null) {\n      const canvasBase64Image = this.drawingTool.canvas.toDataURL('image/png');\n      return this.UtilService.getImageObjectFromBase64String(canvasBase64Image);\n    }\n    return null;\n  }\n\n  setDrawData(componentState) {\n    if (componentState != null) {\n      const studentData = componentState.studentData;\n      if (studentData.submitCounter != null) {\n        this.submitCounter = studentData.submitCounter;\n      }\n      const drawData = studentData.drawData;\n      if (drawData != null && drawData != '' && drawData != '{}') {\n        this.drawingTool.load(drawData);\n      }\n    }\n  }\n\n  /**\n   * Check if the student has drawn anything\n   * @returns whether the canvas is empty\n   */\n  isCanvasEmpty() {\n    if (this.drawingTool != null && this.drawingTool.canvas != null) {\n      const objects = this.drawingTool.canvas.getObjects();\n      if (objects != null && objects.length > 0) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  /**\n   * Snip the drawing by converting it to an image\n   * @param $event the click event\n   */\n  snipDrawing($event, studentWorkId) {\n    let canvas = angular.element('#drawingtool_' + this.nodeId + '_' + this.componentId + ' canvas');\n    if (canvas != null && canvas.length > 0) {\n      canvas = canvas[0];\n      const canvasBase64Image = canvas.toDataURL('image/png');\n      const imageObject = this.UtilService.getImageObjectFromBase64String(canvasBase64Image);\n      const noteText = null;\n      this.NotebookService.addNote($event, imageObject, noteText, [ studentWorkId ]);\n    }\n  }\n\n  snipButtonClicked($event) {\n    if (this.isDirty) {\n      const deregisterListener = this.$scope.$on('studentWorkSavedToServer',\n        (event, args) => {\n          let componentState = args.studentWork;\n          if (this.isForThisComponent(componentState)) {\n            this.snipDrawing($event, componentState.id);\n            deregisterListener();\n          }\n        }\n      );\n      this.saveButtonClicked();\n    } else {\n      const studentWork =\n          this.StudentDataService.getLatestComponentStateByNodeIdAndComponentId(this.nodeId, this.componentId)\n      this.snipDrawing($event, studentWork.id);\n    }\n  }\n\n  /**\n   * Create a component state with the merged student responses\n   * @param componentStates an array of component states\n   * @return a component state with the merged student responses\n   */\n  createMergedComponentState(componentStates) {\n    const mergedComponentState = this.NodeService.createNewComponentState();\n    if (componentStates != null) {\n      let allDrawCanvasObjects = [];\n      let firstDrawData = {};\n      for (let c = 0; c < componentStates.length; c++) {\n        const componentState = componentStates[c];\n        if (componentState.componentType == 'Draw') {\n          const studentData = componentState.studentData;\n          const drawData = studentData.drawData;\n          const drawDataJSON = angular.fromJson(drawData);\n          if (drawDataJSON != null && drawDataJSON.canvas != null &&\n              drawDataJSON.canvas.objects != null) {\n            if (c == 0) {\n              firstDrawData = drawDataJSON;\n            }\n            allDrawCanvasObjects = allDrawCanvasObjects.concat(drawDataJSON.canvas.objects);\n          }\n        } else if (componentState.componentType == 'Graph' ||\n            componentState.componentType == 'ConceptMap' ||\n            componentState.componentType == 'Embedded' ||\n            componentState.componentType == 'Label' ||\n            componentState.componentType == 'Table') {\n          const connectedComponent = this.UtilService\n              .getConnectedComponentByComponentState(this.componentContent, componentState);\n          if (connectedComponent.importWorkAsBackground === true) {\n            this.setComponentStateAsBackgroundImage(componentState);\n          }\n        }\n      }\n      if (allDrawCanvasObjects != null) {\n        const drawData = firstDrawData;\n        if (drawData.canvas != null && drawData.canvas.objects != null) {\n          drawData.canvas.objects = allDrawCanvasObjects;\n        }\n        mergedComponentState.studentData = {};\n        mergedComponentState.studentData.drawData = angular.toJson(drawData);\n      }\n    }\n    return mergedComponentState;\n  }\n\n  /**\n   * Create an image from a component state and set the image as the background.\n   * @param componentState A component state.\n   */\n  setComponentStateAsBackgroundImage(componentState) {\n    this.UtilService.generateImageFromComponentState(componentState).then((image) => {\n      this.drawingTool.setBackgroundImage(image.url);\n    });\n  }\n}\n\nDrawController.$inject = [\n  '$filter',\n  '$injector',\n  '$mdDialog',\n  '$q',\n  '$rootScope',\n  '$scope',\n  '$timeout',\n  'AnnotationService',\n  'ConfigService',\n  'DrawService',\n  'NodeService',\n  'NotebookService',\n  'ProjectService',\n  'StudentAssetService',\n  'StudentDataService',\n  'UtilService'];\n\nexport default DrawController;\n"],"file":"drawController.js"}