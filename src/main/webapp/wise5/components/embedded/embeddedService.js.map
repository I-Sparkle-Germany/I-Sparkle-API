{"version":3,"sources":["embeddedService.es6"],"names":["EmbeddedService","$filter","$q","StudentAssetService","UtilService","$translate","component","id","generateKey","type","url","showSaveButton","showSubmitButton","componentToCopy","createComponent","componentStates","componentEvents","nodeEvents","result","isCompletedFieldInComponentState","componentState","studentData","isCompleted","event","componentContent","deferred","defer","iframe","$","componentId","length","modelElement","contents","find","then","canvas","img_b64","toDataURL","imageObject","getImageObjectFromBase64String","uploadAsset","asset","resolve","promise","$inject"],"mappings":"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","file":"embeddedService.js","sourcesContent":["import NodeService from '../../services/nodeService';\nimport html2canvas from 'html2canvas';\n\nclass EmbeddedService extends NodeService {\n  constructor(\n      $filter,\n      $q,\n      StudentAssetService,\n      UtilService) {\n    super();\n    this.$filter = $filter;\n    this.$q = $q;\n    this.StudentAssetService = StudentAssetService;\n    this.UtilService = UtilService;\n    this.$translate = this.$filter('translate');\n  }\n\n  /**\n   * Get the component type label\n   * example\n   * \"Embedded\"\n   */\n  getComponentTypeLabel() {\n    return this.$translate('embedded.componentTypeLabel');\n  }\n\n  /**\n   * Create an Embedded component object\n   * @returns a new Embedded component object\n   */\n  createComponent() {\n    var component = {};\n    component.id = this.UtilService.generateKey();\n    component.type = 'Embedded';\n    component.url = '';\n    component.showSaveButton = false;\n    component.showSubmitButton = false;\n    return component;\n  }\n\n  /**\n   * Copies an existing Embedded component object\n   * @returns a copied Embedded component object\n   */\n  copyComponent(componentToCopy) {\n    var component = this.createComponent();\n    component.url = componentToCopy.url;\n    component.showSaveButton = componentToCopy.showSaveButton;\n    component.showSubmitButton = componentToCopy.showSubmitButton;\n    return component;\n  }\n\n  /**\n   * Check if the component was completed\n   * @param component the component object\n   * @param componentStates the component states for the specific component\n   * @param componentEvents the events for the specific component\n   * @param nodeEvents the events for the parent node of the component\n   * @returns whether the component was completed\n   */\n  isCompleted(component, componentStates, componentEvents, nodeEvents) {\n    var result = false;\n    var isCompletedFieldInComponentState = false;\n    if (componentStates != null) {\n      for (var componentState of componentStates) {\n        if (componentState != null) {\n          var studentData = componentState.studentData;\n          if (studentData != null) {\n            if (studentData.isCompleted != null) {\n              /*\n               * the model has set the isCompleted field in the\n               * student data\n               */\n              isCompletedFieldInComponentState = true;\n\n              if (studentData.isCompleted === true) {\n                /*\n                 * the model has set the isCompleted field to true\n                 * which means the student has completed the component\n                 */\n                return true;\n              }\n            }\n          }\n        }\n      }\n    }\n\n    if (isCompletedFieldInComponentState == false) {\n      /*\n       * the isCompleted field was not set into the component state so\n       * we will look for events to determine isCompleted\n       */\n\n      if (nodeEvents != null) {\n        for (var event of nodeEvents) {\n          if (event != null && event.event === 'nodeEntered') {\n            result = true;\n            break;\n          }\n        }\n      }\n    }\n    return result;\n  };\n\n  /**\n   * Whether this component generates student work\n   * @param component (optional) the component object. if the component object\n   * is not provided, we will use the default value of whether the\n   * component type usually has work.\n   * @return whether this component generates student work\n   */\n  componentHasWork(component) {\n    return false;\n  }\n\n  /**\n   * Whether this component uses a save button\n   * @return whether this component uses a save button\n   */\n  componentUsesSaveButton() {\n    return true;\n  }\n\n  /**\n   * Whether this component uses a submit button\n   * @return whether this component uses a submit button\n   */\n  componentUsesSubmitButton() {\n    return true;\n  }\n\n  /**\n   * Check if the component state has student work. Sometimes a component\n   * state may be created if the student visits a component but doesn't\n   * actually perform any work. This is where we will check if the student\n   * actually performed any work.\n   * @param componentState the component state object\n   * @param componentContent the component content\n   * @return whether the component state has any work\n   */\n  componentStateHasStudentWork(componentState, componentContent) {\n    if (componentState != null) {\n      let studentData = componentState.studentData;\n      if (studentData != null) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  /**\n   * The component state has been rendered in a <component></component> element\n   * and now we want to take a snapshot of the work.\n   * @param componentState The component state that has been rendered.\n   * @return A promise that will return an image object.\n   */\n  generateImageFromRenderedComponentState(componentState) {\n    let deferred = this.$q.defer();\n    let iframe = $('#componentApp_' + componentState.componentId);\n    if (iframe != null && iframe.length > 0) {\n      let modelElement = iframe.contents().find('html');\n      if (modelElement != null && modelElement.length > 0) {\n        modelElement = modelElement[0];\n        // convert the model element to a canvas element\n        html2canvas(modelElement).then((canvas) => {\n          let img_b64 = canvas.toDataURL('image/png');\n          let imageObject = this.UtilService.getImageObjectFromBase64String(img_b64);\n          // add the image to the student assets\n          this.StudentAssetService.uploadAsset(imageObject).then((asset) => {\n            deferred.resolve(asset);\n          });\n        });\n      }\n    }\n    return deferred.promise;\n  }\n}\n\nEmbeddedService.$inject = [\n  '$filter',\n  '$q',\n  'StudentAssetService',\n  'UtilService'\n];\n\nexport default EmbeddedService;\n"]}