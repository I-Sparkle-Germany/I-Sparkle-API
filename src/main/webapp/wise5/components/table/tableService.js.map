{"version":3,"sources":["tableService.es6"],"names":["TableService","$filter","$q","StudentAssetService","StudentDataService","UtilService","$translate","component","id","generateKey","type","prompt","showSaveButton","showSubmitButton","globalCellSize","numRows","numColumns","tableData","componentToCopy","createComponent","componentStateFromOtherComponent","componentState","createComponentState","otherComponentType","componentType","studentData","studentDataCopy","makeCopyOfJSONObject","componentStates","componentEvents","nodeEvents","node","componentHasEditableCells","length","submitRequired","c","l","isSubmit","r","row","cell","editable","componentContent","studentTableData","componentContentTableData","studentRows","studentRow","studentCell","getTableDataCellValue","componentContentCell","x","y","table","cellValue","text","deferred","defer","tableElement","angular","element","nodeId","componentId","then","canvas","img_b64","toDataURL","imageObject","getImageObjectFromBase64String","uploadAsset","asset","resolve","promise","$inject"],"mappings":";;;;;;;;AAAA;;;;AACA;;;;;;;;;;;;IAEMA,Y;;;AAEJ,wBAAYC,OAAZ,EACIC,EADJ,EAEIC,mBAFJ,EAGIC,kBAHJ,EAIIC,WAJJ,EAIiB;AAAA;;AAAA;;AAEf,UAAKJ,OAAL,GAAeA,OAAf;AACA,UAAKC,EAAL,GAAUA,EAAV;AACA,UAAKC,mBAAL,GAA2BA,mBAA3B;AACA,UAAKC,kBAAL,GAA0BA,kBAA1B;AACA,UAAKC,WAAL,GAAmBA,WAAnB;AACA,UAAKC,UAAL,GAAkB,MAAKL,OAAL,CAAa,WAAb,CAAlB;AAPe;AAQhB;;AAED;;;;;;;;;4CAKwB;AACtB,aAAO,KAAKK,UAAL,CAAgB,0BAAhB,CAAP;AACD;;AAED;;;;;;;sCAIkB;AAChB,UAAIC,YAAY,EAAhB;AACAA,gBAAUC,EAAV,GAAe,KAAKH,WAAL,CAAiBI,WAAjB,EAAf;AACAF,gBAAUG,IAAV,GAAiB,OAAjB;AACAH,gBAAUI,MAAV,GAAmB,EAAnB;AACAJ,gBAAUK,cAAV,GAA2B,KAA3B;AACAL,gBAAUM,gBAAV,GAA6B,KAA7B;AACAN,gBAAUO,cAAV,GAA2B,EAA3B;AACAP,gBAAUQ,OAAV,GAAoB,CAApB;AACAR,gBAAUS,UAAV,GAAuB,CAAvB;AACAT,gBAAUU,SAAV,GAAsB,CACpB,CACE;AACE,gBAAQ,EADV;AAEE,oBAAY,IAFd;AAGE,gBAAQ;AAHV,OADF,EAME;AACE,gBAAQ,EADV;AAEE,oBAAY,IAFd;AAGE,gBAAQ;AAHV,OANF,EAWE;AACE,gBAAQ,EADV;AAEE,oBAAY,IAFd;AAGE,gBAAQ;AAHV,OAXF,CADoB,EAkBpB,CACE;AACE,gBAAQ,EADV;AAEE,oBAAY,IAFd;AAGE,gBAAQ;AAHV,OADF,EAME;AACE,gBAAQ,EADV;AAEE,oBAAY,IAFd;AAGE,gBAAQ;AAHV,OANF,EAWE;AACE,gBAAQ,EADV;AAEE,oBAAY,IAFd;AAGE,gBAAQ;AAHV,OAXF,CAlBoB,EAmCpB,CACE;AACE,gBAAQ,EADV;AAEE,oBAAY,IAFd;AAGE,gBAAQ;AAHV,OADF,EAME;AACE,gBAAQ,EADV;AAEE,oBAAY,IAFd;AAGE,gBAAQ;AAHV,OANF,EAWE;AACE,gBAAQ,EADV;AAEE,oBAAY,IAFd;AAGE,gBAAQ;AAHV,OAXF,CAnCoB,CAAtB;;AAsDA,aAAOV,SAAP;AACD;;AAED;;;;;;;kCAIcW,e,EAAiB;AAC7B,UAAIX,YAAY,KAAKY,eAAL,EAAhB;AACAZ,gBAAUI,MAAV,GAAmBO,gBAAgBP,MAAnC;AACAJ,gBAAUK,cAAV,GAA2BM,gBAAgBN,cAA3C;AACAL,gBAAUM,gBAAV,GAA6BK,gBAAgBL,gBAA7C;AACAN,gBAAUO,cAAV,GAA2BI,gBAAgBJ,cAA3C;AACAP,gBAAUQ,OAAV,GAAoBG,gBAAgBH,OAApC;AACAR,gBAAUS,UAAV,GAAuBE,gBAAgBF,UAAvC;AACAT,gBAAUU,SAAV,GAAsBC,gBAAgBD,SAAtC;AACA,aAAOV,SAAP;AACD;;AAED;;;;;;;;;2CAMuBa,gC,EAAkC;AACvD,UAAIC,iBAAiB,IAArB;;AAEA,UAAID,oCAAoC,IAAxC,EAA8C;;AAE5C;AACAC,yBAAiB,KAAKjB,kBAAL,CAAwBkB,oBAAxB,EAAjB;;AAEA;AACA,YAAIC,qBAAqBH,iCAAiCI,aAA1D;;AAEA,YAAID,uBAAuB,OAA3B,EAAoC;AAClC;;AAEA;AACA,cAAIE,cAAcL,iCAAiCK,WAAnD;;AAEA;AACA,cAAIC,kBAAkB,KAAKrB,WAAL,CAAiBsB,oBAAjB,CAAsCF,WAAtC,CAAtB;;AAEA;AACAJ,yBAAeI,WAAf,GAA6BC,eAA7B;AACD;AACF;;AAED,aAAOL,cAAP;AACD;;;;;AAED;;;;;;;;;gCASYd,S,EAAWqB,e,EAAiBC,e,EAAiBC,U,EAAYC,I,EAAM;AACzE,UAAI,CAAC,KAAKC,yBAAL,CAA+BzB,SAA/B,CAAL,EAAgD;AAC9C;;;;AAIA,eAAO,IAAP;AACD;AACD,UAAIqB,mBAAmBA,gBAAgBK,MAAvC,EAA+C;AAC7C,YAAIC,iBAAiBH,KAAKlB,gBAAL,IAA0BN,UAAUM,gBAAV,IAA8B,CAACkB,KAAKnB,cAAnF;;AAEA;AACA,aAAK,IAAIuB,IAAI,CAAR,EAAWC,IAAIR,gBAAgBK,MAApC,EAA4CE,IAAIC,CAAhD,EAAmDD,GAAnD,EAAwD;;AAEtD;AACA,cAAId,iBAAiBO,gBAAgBO,CAAhB,CAArB;;AAEA;AACA,cAAIV,cAAcJ,eAAeI,WAAjC;;AAEA,cAAIA,eAAe,IAAnB,EAAyB;AACvB,gBAAIR,YAAYQ,YAAYR,SAA5B;;AAEA,gBAAIA,aAAa,IAAjB,EAAuB;AACrB;AACA;AACA,kBAAIiB,cAAJ,EAAoB;AAClB;AACA,oBAAIb,eAAegB,QAAnB,EAA6B;AAC3B,yBAAO,IAAP;AACD;AACF,eALD,MAKO;AACL,uBAAO,IAAP;AACD;AACF;AACF;AACF;AACF;;AAED,aAAO,KAAP;AACD;;;;;AAED;;;;;8CAK0B9B,S,EAAW;AACnC,UAAIA,aAAa,IAAjB,EAAuB;AACrB,YAAIU,YAAYV,UAAUU,SAA1B;AACA,YAAIA,aAAa,IAAjB,EAAuB;AACrB,eAAK,IAAIqB,IAAI,CAAb,EAAgBA,IAAIrB,UAAUgB,MAA9B,EAAsCK,GAAtC,EAA2C;AACzC,gBAAIC,MAAMtB,UAAUqB,CAAV,CAAV;AACA,gBAAIC,OAAO,IAAX,EAAiB;AACf,mBAAK,IAAIJ,IAAI,CAAb,EAAgBA,IAAII,IAAIN,MAAxB,EAAgCE,GAAhC,EAAqC;AACnC,oBAAIK,OAAOD,IAAIJ,CAAJ,CAAX;AACA,oBAAIK,QAAQ,IAAZ,EAAkB;AAChB,sBAAIA,KAAKC,QAAL,KAAkB,IAAtB,EAA4B;AAC1B,2BAAO,IAAP;AACD;AACF;AACF;AACF;AACF;AACF;AACF;;AAED,aAAO,KAAP;AACD;;AAED;;;;;;;;;;qCAOiBlC,S,EAAW;AAC1B,aAAO,IAAP;AACD;;AAED;;;;;;;8CAI0B;AACxB,aAAO,IAAP;AACD;;AAED;;;;;;;gDAI4B;AAC1B,aAAO,IAAP;AACD;;AAED;;;;;;;;;;;;iDAS6Bc,c,EAAgBqB,gB,EAAkB;;AAE7D,UAAIrB,kBAAkB,IAAtB,EAA4B;;AAE1B,YAAII,cAAcJ,eAAeI,WAAjC;;AAEA,YAAIA,eAAe,IAAnB,EAAyB;;AAEvB;AACA,cAAIkB,mBAAmBlB,YAAYR,SAAnC;;AAEA;AACA,cAAI2B,4BAA4BF,iBAAiBzB,SAAjD;;AAEA,cAAI0B,oBAAoB,IAAxB,EAA8B;;AAE5B,gBAAIE,cAAcF,gBAAlB;;AAEA;AACA,iBAAK,IAAIL,IAAI,CAAb,EAAgBA,IAAIO,YAAYZ,MAAhC,EAAwCK,GAAxC,EAA6C;AAC3C,kBAAIQ,aAAaD,YAAYP,CAAZ,CAAjB;;AAEA,kBAAIQ,cAAc,IAAlB,EAAwB;;AAEtB;AACA,qBAAK,IAAIX,IAAI,CAAb,EAAgBA,IAAIW,WAAWb,MAA/B,EAAuCE,GAAvC,EAA4C;;AAE1C;AACA,sBAAIY,cAAc,KAAKC,qBAAL,CAA2BV,CAA3B,EAA8BH,CAA9B,EAAiCQ,gBAAjC,CAAlB;;AAEA;AACA,sBAAIM,uBAAuB,KAAKD,qBAAL,CAA2BV,CAA3B,EAA8BH,CAA9B,EAAiCS,yBAAjC,CAA3B;;AAEA,sBAAIG,gBAAgBE,oBAApB,EAA0C;AACxC;;;;AAIA,2BAAO,IAAP;AACD;AACF;AACF;AACF;AACF;AACF;AACF;;AAED,aAAO,KAAP;AACD;;AAED;;;;;;;;;;;0CAQsBC,C,EAAGC,C,EAAGC,K,EAAO;;AAEjC,UAAIC,YAAY,IAAhB;;AAEA,UAAID,SAAS,IAAb,EAAmB;;AAEjB;AACA,YAAIb,MAAMa,MAAMD,CAAN,CAAV;;AAEA,YAAIZ,OAAO,IAAX,EAAiB;;AAEf;AACA,cAAIC,OAAOD,IAAIW,CAAJ,CAAX;;AAEA,cAAIV,QAAQ,IAAZ,EAAkB;;AAEhB;AACAa,wBAAYb,KAAKc,IAAjB;AACD;AACF;AACF;;AAED,aAAOD,SAAP;AACD;;AAED;;;;;;;;;4DAMwChC,c,EAAgB;AAAA;;AACtD,UAAIkC,WAAW,KAAKrD,EAAL,CAAQsD,KAAR,EAAf;AACA,UAAIC,eAAeC,QAAQC,OAAR,CAAgB,YAAYtC,eAAeuC,MAA3B,GAAoC,GAApC,GAA0CvC,eAAewC,WAAzE,CAAnB;AACA,UAAIJ,gBAAgB,IAAhB,IAAwBA,aAAaxB,MAAb,GAAsB,CAAlD,EAAqD;AACnDwB,uBAAeA,aAAa,CAAb,CAAf;AACA;AACA,mCAAYA,YAAZ,EAA0BK,IAA1B,CAA+B,UAACC,MAAD,EAAY;AACzC;AACA,cAAIC,UAAUD,OAAOE,SAAP,CAAiB,WAAjB,CAAd;;AAEA;AACA,cAAIC,cAAc,OAAK7D,WAAL,CAAiB8D,8BAAjB,CAAgDH,OAAhD,CAAlB;;AAEA;AACA,iBAAK7D,mBAAL,CAAyBiE,WAAzB,CAAqCF,WAArC,EAAkDJ,IAAlD,CAAuD,UAACO,KAAD,EAAW;AAChEd,qBAASe,OAAT,CAAiBD,KAAjB;AACD,WAFD;AAGD,SAXD;AAYD;AACD,aAAOd,SAASgB,OAAhB;AACD;;;;;;AAGHvE,aAAawE,OAAb,GAAuB,CACrB,SADqB,EAErB,IAFqB,EAGrB,qBAHqB,EAIrB,oBAJqB,EAKrB,aALqB,CAAvB;;kBAQexE,Y","file":"tableService.js","sourcesContent":["import NodeService from '../../services/nodeService';\nimport html2canvas from 'html2canvas';\n\nclass TableService extends NodeService {\n\n  constructor($filter,\n      $q,\n      StudentAssetService,\n      StudentDataService,\n      UtilService) {\n    super();\n    this.$filter = $filter;\n    this.$q = $q;\n    this.StudentAssetService = StudentAssetService;\n    this.StudentDataService = StudentDataService;\n    this.UtilService = UtilService;\n    this.$translate = this.$filter('translate');\n  }\n\n  /**\n   * Get the component type label\n   * example\n   * \"Table\"\n   */\n  getComponentTypeLabel() {\n    return this.$translate('table.componentTypeLabel');\n  }\n\n  /**\n   * Create an Table component object\n   * @returns a new Table component object\n   */\n  createComponent() {\n    var component = {};\n    component.id = this.UtilService.generateKey();\n    component.type = 'Table';\n    component.prompt = '';\n    component.showSaveButton = false;\n    component.showSubmitButton = false;\n    component.globalCellSize = 10;\n    component.numRows = 3;\n    component.numColumns = 3;\n    component.tableData = [\n      [\n        {\n          'text': '',\n          'editable': true,\n          'size': null\n        },\n        {\n          'text': '',\n          'editable': true,\n          'size': null\n        },\n        {\n          'text': '',\n          'editable': true,\n          'size': null\n        }\n      ],\n      [\n        {\n          'text': '',\n          'editable': true,\n          'size': null\n        },\n        {\n          'text': '',\n          'editable': true,\n          'size': null\n        },\n        {\n          'text': '',\n          'editable': true,\n          'size': null\n        }\n      ],\n      [\n        {\n          'text': '',\n          'editable': true,\n          'size': null\n        },\n        {\n          'text': '',\n          'editable': true,\n          'size': null\n        },\n        {\n          'text': '',\n          'editable': true,\n          'size': null\n        }\n      ]\n    ];\n\n    return component;\n  }\n\n  /**\n   * Copies an existing Table component object\n   * @returns a copied Table component object\n   */\n  copyComponent(componentToCopy) {\n    var component = this.createComponent();\n    component.prompt = componentToCopy.prompt;\n    component.showSaveButton = componentToCopy.showSaveButton;\n    component.showSubmitButton = componentToCopy.showSubmitButton;\n    component.globalCellSize = componentToCopy.globalCellSize;\n    component.numRows = componentToCopy.numRows;\n    component.numColumns = componentToCopy.numColumns;\n    component.tableData = componentToCopy.tableData;\n    return component;\n  }\n\n  /**\n   * Populate a component state with the data from another component state\n   * @param componentStateFromOtherComponent the component state to obtain the data from\n   * @return a new component state that contains the student data from the other\n   * component state\n   */\n  populateComponentState(componentStateFromOtherComponent) {\n    var componentState = null;\n\n    if (componentStateFromOtherComponent != null) {\n\n      // create an empty component state\n      componentState = this.StudentDataService.createComponentState();\n\n      // get the component type of the other component state\n      var otherComponentType = componentStateFromOtherComponent.componentType;\n\n      if (otherComponentType === 'Table') {\n        // the other component is an Table component\n\n        // get the student data from the other component state\n        var studentData = componentStateFromOtherComponent.studentData;\n\n        // create a copy of the student data\n        var studentDataCopy = this.UtilService.makeCopyOfJSONObject(studentData);\n\n        // set the student data into the new component state\n        componentState.studentData = studentDataCopy;\n      }\n    }\n\n    return componentState;\n  };\n\n  /**\n   * Check if the component was completed\n   * @param component the component object\n   * @param componentStates the component states for the specific component\n   * @param componentEvents the events for the specific component\n   * @param nodeEvents the events for the parent node of the component\n   * @param node parent node of the component\n   * @returns whether the component was completed\n   */\n  isCompleted(component, componentStates, componentEvents, nodeEvents, node) {\n    if (!this.componentHasEditableCells(component)) {\n      /*\n       * The component does not have any editable cells so we will say\n       * it is completed.\n       */\n      return true;\n    }\n    if (componentStates && componentStates.length) {\n      let submitRequired = node.showSubmitButton || (component.showSubmitButton && !node.showSaveButton);\n\n      // loop through all the component states\n      for (let c = 0, l = componentStates.length; c < l; c++) {\n\n        // the component state\n        let componentState = componentStates[c];\n\n        // get the student data from the component state\n        let studentData = componentState.studentData;\n\n        if (studentData != null) {\n          let tableData = studentData.tableData;\n\n          if (tableData != null) {\n            // there is a table data so the component has saved work\n            // TODO: check for actual student data from the table (compare to starting state)\n            if (submitRequired) {\n              // completion requires a submission, so check for isSubmit\n              if (componentState.isSubmit) {\n                return true;\n              }\n            } else {\n              return true;\n            }\n          }\n        }\n      }\n    }\n\n    return false;\n  };\n\n  /**\n   * Check if a table component has any editable cells.\n   * @param component The component content.\n   * @return Whether the component has any editable cells.\n   */\n  componentHasEditableCells(component) {\n    if (component != null) {\n      let tableData = component.tableData;\n      if (tableData != null) {\n        for (let r = 0; r < tableData.length; r++) {\n          let row = tableData[r];\n          if (row != null) {\n            for (let c = 0; c < row.length; c++) {\n              let cell = row[c];\n              if (cell != null) {\n                if (cell.editable === true) {\n                  return true;\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * Whether this component generates student work\n   * @param component (optional) the component object. if the component object\n   * is not provided, we will use the default value of whether the\n   * component type usually has work.\n   * @return whether this component generates student work\n   */\n  componentHasWork(component) {\n    return true;\n  }\n\n  /**\n   * Whether this component uses a save button\n   * @return whether this component uses a save button\n   */\n  componentUsesSaveButton() {\n    return true;\n  }\n\n  /**\n   * Whether this component uses a submit button\n   * @return whether this component uses a submit button\n   */\n  componentUsesSubmitButton() {\n    return true;\n  }\n\n  /**\n   * Check if the component state has student work. Sometimes a component\n   * state may be created if the student visits a component but doesn't\n   * actually perform any work. This is where we will check if the student\n   * actually performed any work.\n   * @param componentState the component state object\n   * @param componentContent the component content\n   * @return whether the component state has any work\n   */\n  componentStateHasStudentWork(componentState, componentContent) {\n\n    if (componentState != null) {\n\n      let studentData = componentState.studentData;\n\n      if (studentData != null) {\n\n        // get the table from the student data\n        let studentTableData = studentData.tableData;\n\n        // get the table from the component content\n        let componentContentTableData = componentContent.tableData;\n\n        if (studentTableData != null) {\n\n          let studentRows = studentTableData;\n\n          // loop through the student rows\n          for (let r = 0; r < studentRows.length; r++) {\n            let studentRow = studentRows[r];\n\n            if (studentRow != null) {\n\n              // loop through the student columns\n              for (let c = 0; c < studentRow.length; c++) {\n\n                // get cell from the student\n                let studentCell = this.getTableDataCellValue(r, c, studentTableData);\n\n                // get a cell from the component content\n                let componentContentCell = this.getTableDataCellValue(r, c, componentContentTableData);\n\n                if (studentCell !== componentContentCell) {\n                  /*\n                   * the cell values are not the same which means\n                   * the student has changed the table\n                   */\n                  return true;\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * Get the value of a cell in the table\n   * @param x the x coordinate\n   * @param y the y coordinate\n   * @param table (optional) table data to get the value from. this is used\n   * when we want to look up the value in the default authored table\n   * @returns the cell value (text or a number)\n   */\n  getTableDataCellValue(x, y, table) {\n\n    var cellValue = null;\n\n    if (table != null) {\n\n      // get the row we want\n      var row = table[y];\n\n      if (row != null) {\n\n        // get the cell we want\n        var cell = row[x];\n\n        if (cell != null) {\n\n          // set the value into the cell\n          cellValue = cell.text;\n        }\n      }\n    }\n\n    return cellValue;\n  }\n\n  /**\n   * The component state has been rendered in a <component></component> element\n   * and now we want to take a snapshot of the work.\n   * @param componentState The component state that has been rendered.\n   * @return A promise that will return an image object.\n   */\n  generateImageFromRenderedComponentState(componentState) {\n    let deferred = this.$q.defer();\n    let tableElement = angular.element('#table_' + componentState.nodeId + '_' + componentState.componentId);\n    if (tableElement != null && tableElement.length > 0) {\n      tableElement = tableElement[0];\n      // convert the table element to a canvas element\n      html2canvas(tableElement).then((canvas) => {\n        // get the canvas as a base64 string\n        let img_b64 = canvas.toDataURL('image/png');\n\n        // get the image object\n        let imageObject = this.UtilService.getImageObjectFromBase64String(img_b64);\n\n        // add the image to the student assets\n        this.StudentAssetService.uploadAsset(imageObject).then((asset) => {\n          deferred.resolve(asset);\n        });\n      });\n    }\n    return deferred.promise;\n  }\n}\n\nTableService.$inject = [\n  '$filter',\n  '$q',\n  'StudentAssetService',\n  'StudentDataService',\n  'UtilService'\n];\n\nexport default TableService;\n"]}