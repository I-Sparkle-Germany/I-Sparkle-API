{"version":3,"sources":["annotationController.es6"],"names":[],"mappings":"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","file":"annotationController.js","sourcesContent":["'use strict';\n\nclass AnnotationController {\n    constructor($scope,\n                $element,\n                $attrs,\n                AnnotationService,\n                ConfigService,\n                ProjectService,\n                UtilService) {\n        this.AnnotationService = AnnotationService;\n        this.ConfigService = ConfigService;\n        this.ProjectService = ProjectService;\n        this.UtilService = UtilService;\n        this.component = null;\n        this.value = null;\n\n        this.runId = ConfigService.getRunId();\n\n        if (this.nodeId != null && this.componentId != null) {\n            // get the component\n            this.component = this.ProjectService.getComponentByNodeIdAndComponentId(this.nodeId, this.componentId);\n            if (this.component) {\n                this.gradingMaxScore = this.component.maxScore;\n            }\n        }\n\n        if (this.mode === 'student') {\n\n            if (!this.annotation) {\n                let annotationParams = {};\n                annotationParams.nodeId = this.nodeId;\n                annotationParams.componentId = this.componentId;\n                annotationParams.fromWorkgroupId = this.fromWorkgroupId;\n                annotationParams.toWorkgroupId = this.toWorkgroupId;\n                annotationParams.type = this.type;\n                annotationParams.studentWorkId = this.componentStateId;\n\n                // get the latest annotation that matches the params\n                this.annotation = this.AnnotationService.getLatestAnnotation(annotationParams);\n            }\n\n            if (this.annotation != null) {\n                let data = this.annotation.data;\n                let dataJSONObject = angular.fromJson(data);\n\n                if (dataJSONObject) {\n                    this.value = dataJSONObject.value;\n                }\n            }\n        } else if (this.mode === 'grading') {\n\n            let annotationParams = {};\n            annotationParams.nodeId = this.nodeId;\n            annotationParams.componentId = this.componentId;\n            annotationParams.fromWorkgroupId = this.fromWorkgroupId;\n            annotationParams.toWorkgroupId = this.toWorkgroupId;\n            annotationParams.type = this.type;\n            annotationParams.studentWorkId = this.componentStateId;\n\n            if (this.active) {\n                /*\n                 * this directive instance is the active annotation that the teacher can use to\n                 * grade so we will get the latest annotation for the student work\n                 */\n                this.annotation = this.AnnotationService.getLatestAnnotation(annotationParams);\n            } else {\n                /*\n                 * this directive instance is not the active annotation so we will get the\n                 * annotation directly associated with the student work\n                 */\n                this.annotation = this.AnnotationService.getAnnotation(annotationParams);\n            }\n\n            if (this.annotation != null) {\n                if (this.componentStateId == this.annotation.studentWorkId) {\n                    /*\n                     * the annotation is for the component state that is being displayed.\n                     * sometimes the annotation may not be for the component state that\n                     * is being displayed which can happen when student submits work,\n                     * the teacher annotates it, and then the student submits new work.\n                     * when this happens, we will show the teacher annotation but the\n                     * annotation is associated with the first student work and not the\n                     * second student work. setting the annotationId in the scope will\n                     * cause the server to update the annotation as opposed to creating\n                     * a new annotation row in the database.\n                     */\n                    this.annotationId = this.annotation.id;\n                }\n            }\n\n            let toUserInfo = this.ConfigService.getUserInfoByWorkgroupId(this.toWorkgroupId);\n\n            if (toUserInfo != null) {\n                // set the period id\n                this.periodId = toUserInfo.periodId;\n            }\n\n            if (this.annotation != null) {\n\n                if (this.annotation.data != null) {\n                    this.value = this.annotation.data.value;\n                }\n            }\n        }\n    }\n\n    /**\n     * Save the annotation to the server\n     */\n    postAnnotation() {\n\n        if (this.runId != null &&\n            this.periodId != null &&\n            this.nodeId != null &&\n            this.componentId != null &&\n            this.fromWorkgroupId != null &&\n            this.toWorkgroupId != null &&\n            this.type != null &&\n            this.value != null) {\n\n            // get the current time\n            let clientSaveTime = new Date().getTime();\n\n            // get the value\n            let value = this.value;\n\n            // convert the value to a number if possible\n            value = this.UtilService.convertStringToNumber(value);\n\n            let data = {};\n            data.value = value;\n\n            // create the annotation object\n            let annotation = this.AnnotationService.createAnnotation(\n                this.annotationId,\n                this.runId,\n                this.periodId,\n                this.fromWorkgroupId,\n                this.toWorkgroupId,\n                this.nodeId,\n                this.componentId,\n                this.componentStateId,\n                this.type,\n                data,\n                clientSaveTime);\n\n            // save the annotation to the server\n            this.AnnotationService.saveAnnotation(annotation).then(result => {\n                var localAnnotation = result;\n\n                if (localAnnotation != null) {\n                    if (this.annotationId == null) {\n                        // set the annotation id if there was no annotation id\n                        this.annotationId = localAnnotation.id;\n                    }\n                }\n            });\n        }\n    };\n}\n\nAnnotationController.$inject = [\n    '$scope',\n    '$element',\n    '$attrs',\n    'AnnotationService',\n    'ConfigService',\n    'ProjectService',\n    'UtilService'\n];\n\nexport default AnnotationController;\n"]}