{"version":3,"sources":["annotationController.es6"],"names":["AnnotationController","$scope","$element","$attrs","AnnotationService","ConfigService","ProjectService","UtilService","component","value","runId","getRunId","nodeId","componentId","getComponentByNodeIdAndComponentId","gradingMaxScore","maxScore","mode","annotation","annotationParams","fromWorkgroupId","toWorkgroupId","type","studentWorkId","componentStateId","getLatestAnnotation","data","dataJSONObject","angular","fromJson","active","getAnnotation","annotationId","id","toUserInfo","getUserInfoByWorkgroupId","periodId","clientSaveTime","Date","getTime","convertStringToNumber","createAnnotation","saveAnnotation","then","localAnnotation","result","$inject"],"mappings":"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","file":"annotationController.js","sourcesContent":["'use strict';\n\nclass AnnotationController {\n    constructor($scope,\n                $element,\n                $attrs,\n                AnnotationService,\n                ConfigService,\n                ProjectService,\n                UtilService) {\n        this.AnnotationService = AnnotationService;\n        this.ConfigService = ConfigService;\n        this.ProjectService = ProjectService;\n        this.UtilService = UtilService;\n        this.component = null;\n        this.value = null;\n\n        this.runId = ConfigService.getRunId();\n\n        if (this.nodeId != null && this.componentId != null) {\n            // get the component\n            this.component = this.ProjectService.getComponentByNodeIdAndComponentId(this.nodeId, this.componentId);\n            if (this.component) {\n                this.gradingMaxScore = this.component.maxScore;\n            }\n        }\n\n        if (this.mode === 'student') {\n\n            if (!this.annotation) {\n                let annotationParams = {};\n                annotationParams.nodeId = this.nodeId;\n                annotationParams.componentId = this.componentId;\n                annotationParams.fromWorkgroupId = this.fromWorkgroupId;\n                annotationParams.toWorkgroupId = this.toWorkgroupId;\n                annotationParams.type = this.type;\n                annotationParams.studentWorkId = this.componentStateId;\n\n                // get the latest annotation that matches the params\n                this.annotation = this.AnnotationService.getLatestAnnotation(annotationParams);\n            }\n\n            if (this.annotation != null) {\n                let data = this.annotation.data;\n                let dataJSONObject = angular.fromJson(data);\n\n                if (dataJSONObject) {\n                    this.value = dataJSONObject.value;\n                }\n            }\n        } else if (this.mode === 'grading') {\n\n            let annotationParams = {};\n            annotationParams.nodeId = this.nodeId;\n            annotationParams.componentId = this.componentId;\n            annotationParams.fromWorkgroupId = this.fromWorkgroupId;\n            annotationParams.toWorkgroupId = this.toWorkgroupId;\n            annotationParams.type = this.type;\n            annotationParams.studentWorkId = this.componentStateId;\n\n            if (this.active) {\n                /*\n                 * this directive instance is the active annotation that the teacher can use to\n                 * grade so we will get the latest annotation for the student work\n                 */\n                this.annotation = this.AnnotationService.getLatestAnnotation(annotationParams);\n            } else {\n                /*\n                 * this directive instance is not the active annotation so we will get the\n                 * annotation directly associated with the student work\n                 */\n                this.annotation = this.AnnotationService.getAnnotation(annotationParams);\n            }\n\n            if (this.annotation != null) {\n                if (this.componentStateId == this.annotation.studentWorkId) {\n                    /*\n                     * the annotation is for the component state that is being displayed.\n                     * sometimes the annotation may not be for the component state that\n                     * is being displayed which can happen when student submits work,\n                     * the teacher annotates it, and then the student submits new work.\n                     * when this happens, we will show the teacher annotation but the\n                     * annotation is associated with the first student work and not the\n                     * second student work. setting the annotationId in the scope will\n                     * cause the server to update the annotation as opposed to creating\n                     * a new annotation row in the database.\n                     */\n                    this.annotationId = this.annotation.id;\n                }\n            }\n\n            let toUserInfo = this.ConfigService.getUserInfoByWorkgroupId(this.toWorkgroupId);\n\n            if (toUserInfo != null) {\n                // set the period id\n                this.periodId = toUserInfo.periodId;\n            }\n\n            if (this.annotation != null) {\n\n                if (this.annotation.data != null) {\n                    this.value = this.annotation.data.value;\n                }\n            }\n        }\n    }\n\n    /**\n     * Save the annotation to the server\n     */\n    postAnnotation() {\n\n        if (this.runId != null &&\n            this.periodId != null &&\n            this.nodeId != null &&\n            this.componentId != null &&\n            this.fromWorkgroupId != null &&\n            this.toWorkgroupId != null &&\n            this.type != null &&\n            this.value != null) {\n\n            // get the current time\n            let clientSaveTime = new Date().getTime();\n\n            // get the value\n            let value = this.value;\n\n            // convert the value to a number if possible\n            value = this.UtilService.convertStringToNumber(value);\n\n            let data = {};\n            data.value = value;\n\n            // create the annotation object\n            let annotation = this.AnnotationService.createAnnotation(\n                this.annotationId,\n                this.runId,\n                this.periodId,\n                this.fromWorkgroupId,\n                this.toWorkgroupId,\n                this.nodeId,\n                this.componentId,\n                this.componentStateId,\n                this.type,\n                data,\n                clientSaveTime);\n\n            // save the annotation to the server\n            this.AnnotationService.saveAnnotation(annotation).then(result => {\n                var localAnnotation = result;\n\n                if (localAnnotation != null) {\n                    if (this.annotationId == null) {\n                        // set the annotation id if there was no annotation id\n                        this.annotationId = localAnnotation.id;\n                    }\n                }\n            });\n        }\n    };\n}\n\nAnnotationController.$inject = [\n    '$scope',\n    '$element',\n    '$attrs',\n    'AnnotationService',\n    'ConfigService',\n    'ProjectService',\n    'UtilService'\n];\n\nexport default AnnotationController;\n"]}