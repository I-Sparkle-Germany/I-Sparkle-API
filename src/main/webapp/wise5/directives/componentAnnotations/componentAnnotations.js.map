{"version":3,"sources":["componentAnnotations.es6"],"names":["ComponentAnnotationsController","$scope","$element","$filter","$mdDialog","$timeout","ConfigService","ProjectService","StudentDataService","$translate","maxScoreDisplay","parseInt","maxScore","themeSettings","getThemeSettings","hideComponentScores","nodeId","componentId","latestAnnotationTime","isNew","label","icon","showScore","showComment","$on","event","args","studentWork","$onChanges","changes","processAnnotations","hide","latest","annotations","comment","score","commentSaveTime","serverSaveTime","scoreSaveTime","getLatestAnnotation","time","convertToClientTimestamp","nodeEvents","getEventsByNodeId","n","length","visitTime","i","latestState","getLatestComponentStateByNodeIdAndComponentId","saveTime","latestVisitTime","getLatestVisitTime","latestSaveTime","getLatestSaveTime","getLatestAnnotationTime","type","displayAnnotation","setLabelAndIcon","$inject","ComponentAnnotations","bindings","templateUrl","controller","controllerAs"],"mappings":"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","file":"componentAnnotations.js","sourcesContent":["'use strict';\n\nclass ComponentAnnotationsController {\n    constructor($scope,\n                $element,   // TODO remove after verifying that this is not being used\n                $filter,\n                $mdDialog,\n                $timeout,\n                ConfigService,\n                ProjectService,\n                StudentDataService) {\n        this.$scope = $scope;\n        this.$filter = $filter;\n        this.$mdDialog = $mdDialog;\n        this.ConfigService = ConfigService;\n        this.ProjectService = ProjectService;\n        this.StudentDataService = StudentDataService;\n\n        this.$translate = this.$filter('translate');\n\n        this.maxScoreDisplay = (parseInt(this.maxScore) > 0) ? '/' + this.maxScore : '';\n\n        this.themeSettings = this.ProjectService.getThemeSettings();\n        this.hideComponentScores = this.themeSettings.hideComponentScores;\n\n        this.nodeId = null;\n        this.componentId = null;\n\n        // the latest annoation time\n        this.latestAnnotationTime = null;\n\n        // whether the annotation is new or not\n        this.isNew = false;\n\n        // the annotation label\n        this.label = '';\n\n        // the avatar icon (default to person/teacher)\n        this.icon = 'person';\n\n        this.showScore = true;\n        this.showComment = true;\n\n        // watch for new component states\n        this.$scope.$on('studentWorkSavedToServer', (event, args) => {\n            let nodeId = args.studentWork.nodeId;\n            let componentId = args.studentWork.componentId;\n            if (nodeId === this.nodeId && componentId === this.componentId) {\n                this.isNew = false;\n            }\n        });\n\n        /* used to pop up annotation\n        $timeout(() => {\n            this.$mdDialog.show({\n                contentElement: '#componentAnnotationsCard',\n                parent: angular.element(document.body)\n            });\n        });\n        */\n\n        /* uncomment me and use me instead of timeout when we switch to angular 2\n        this.$onAfterViewInit = () => {\n            this.$mdDialog.show({\n                contentElement: '#componentAnnotationsCard',\n                parent: angular.element(document.body)\n            });\n        };\n        */\n\n        this.$onChanges = (changes) => {\n            //if (changes.annotations) {\n                //this.annotations = angular.copy(changes.annotations.currentValue);\n                this.processAnnotations();\n            //}\n        };\n    }\n\n    closeDialog() {\n        this.$mdDialog.hide();\n    }\n\n    /**\n     * Get the most recent annotation (from the current score and comment annotations)\n     * @return Object (latest annotation)\n     */\n    getLatestAnnotation() {\n        let latest = null;\n\n        if (this.annotations.comment || this.annotations.score) {\n            let commentSaveTime = this.annotations.comment ? this.annotations.comment.serverSaveTime : 0;\n            let scoreSaveTime = this.annotations.score ? this.annotations.score.serverSaveTime : 0;\n\n            if (commentSaveTime >= scoreSaveTime) {\n                latest = this.annotations.comment;\n            } else if (scoreSaveTime > commentSaveTime) {\n                latest = this.annotations.score;\n            }\n        }\n\n        return latest;\n    };\n\n    /**\n     * Calculate the save time of the latest annotation\n     * @return Number (latest annotation post time)\n     */\n    getLatestAnnotationTime() {\n        let latest = this.getLatestAnnotation();\n        let time = null;\n\n        if (latest) {\n            let serverSaveTime = latest.serverSaveTime;\n            time = this.ConfigService.convertToClientTimestamp(serverSaveTime)\n        }\n\n        return time;\n    };\n\n    /**\n     * Find nodeExited time of the latest node visit for this component\n     * @return Number (latest node exit time)\n     */\n    getLatestVisitTime() {\n        let nodeEvents = this.StudentDataService.getEventsByNodeId(this.nodeId);\n        let n = nodeEvents.length - 1;\n        let visitTime = null;\n\n        for (let i = n; i > 0; i--) {\n            let event = nodeEvents[i];\n            if (event.event === 'nodeExited') {\n                visitTime = this.ConfigService.convertToClientTimestamp(event.serverSaveTime);\n                break;\n            }\n        }\n\n        return visitTime;\n    };\n\n    /**\n     * Find and the latest save time for this component\n     * @return Number (latest save time)\n     */\n    getLatestSaveTime() {\n        let latestState = this.StudentDataService.getLatestComponentStateByNodeIdAndComponentId(this.nodeId, this.componentId);\n        let saveTime = null;\n\n        if (latestState) {\n            saveTime = this.ConfigService.convertToClientTimestamp(latestState.serverSaveTime);\n        }\n\n        return saveTime;\n    };\n\n    /**\n     * Check whether the current annotation for this component is new to the\n     * workgroup (i.e. if the workgroup hasn't seen the annotation on a previous\n     * node visit and the latest annotation came after the latest component state)\n     * @return Boolean (true or false)\n     */\n    isNewAnnotation() {\n        let latestVisitTime = this.getLatestVisitTime();\n        let latestSaveTime = this.getLatestSaveTime();\n        let latestAnnotationTime = this.getLatestAnnotationTime();\n        let isNew = true;\n\n        if (latestVisitTime && (latestVisitTime > latestAnnotationTime)) {\n            isNew = false;\n        }\n\n        if (latestSaveTime && (latestSaveTime > latestAnnotationTime)) {\n            isNew = false;\n        }\n\n        return isNew;\n    };\n\n    /**\n     * Set the label based on whether this is an automated or teacher annotation\n     **/\n    setLabelAndIcon() {\n        let latest = this.getLatestAnnotation();\n\n        if (latest) {\n            if (latest.type === 'autoComment' || latest.type === 'autoScore') {\n                this.label = this.$translate('automatedFeedbackLabel');\n                this.icon = 'keyboard';\n            } else {\n                this.label = this.$translate('teacherFeedbackLabel');\n                this.icon = \"person\";\n            }\n        }\n    };\n\n    processAnnotations() {\n        if (this.annotations != null) {\n            if (this.annotations.comment || this.annotations.score) {\n                this.nodeId = this.annotations.comment ? this.annotations.comment.nodeId : this.annotations.score.nodeId;\n                this.componentId = this.annotations.comment ? this.annotations.comment.componentId : this.annotations.score.nodeId;\n\n                if (!this.ProjectService.displayAnnotation(this.annotations.score)) {\n                    // we do not want to show the score\n                    this.showScore = false;\n                } else {\n                    this.showScore = true;\n\n                }\n\n                if (!this.ProjectService.displayAnnotation(this.annotations.comment)) {\n                    // we do not want to show the comment\n                    this.showComment = false;\n                } else {\n                    this.showComment = true;\n                }\n\n                // set the annotation label and icon\n                this.setLabelAndIcon();\n            }\n        }\n    };\n}\n\nComponentAnnotationsController.$inject = [\n    '$scope',\n    '$element',\n    '$filter',\n    '$mdDialog',\n    '$timeout',\n    'ConfigService',\n    'ProjectService',\n    'StudentDataService'\n];\n\nconst ComponentAnnotations = {\n    bindings: {\n        annotations: '<',\n        maxScore: '<'\n    },\n    templateUrl: 'wise5/directives/componentAnnotations/componentAnnotations.html',\n    controller: ComponentAnnotationsController,\n    controllerAs: 'componentAnnotationsCtrl'\n};\n\nexport default ComponentAnnotations;\n"]}