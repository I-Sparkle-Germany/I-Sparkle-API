{"version":3,"sources":["componentGrading.es6"],"names":["ComponentGradingController","$filter","$mdDialog","$scope","AnnotationService","ConfigService","ProjectService","TeacherDataService","UtilService","$translate","$onInit","runId","getRunId","toUserInfo","getUserInfoByWorkgroupId","toWorkgroupId","periodId","userNamesArray","getUserNamesByWorkgroupId","userNames","map","obj","name","join","$onChanges","changes","maxScore","currentValue","componentStates","getComponentStatesByWorkgroupIdAndComponentId","componentId","latestComponentStateTime","getLatestComponentStateTime","processAnnotations","$on","event","args","annotation","annotationNodeId","nodeId","annotationComponentId","getMaxScoreForComponent","latestAnnotations","getLatestComponentAnnotations","comment","latestComment","type","data","value","score","latestTeacherAnnotationTime","getLatestTeacherAnnotationTime","hasNewWork","checkHasNewWork","result","n","length","latestComponentState","id","studentWorkId","latest","latestScore","latestTeacherComment","latestTeacherScore","commentSaveTime","serverSaveTime","scoreSaveTime","getLatestTeacherAnnotation","time","convertToClientTimestamp","total","$event","workgroupId","show","parent","angular","element","document","body","targetEvent","fullscreen","template","locals","controller","RevisionsController","close","hide","$inject","clientSaveTime","Date","getTime","fromWorkgroupId","getWorkgroupId","convertStringToNumber","localNotebookItemId","notebookItemId","createAnnotation","annotationId","componentStateId","saveAnnotation","then","setMaxScoreForComponent","saveProject","ComponentGrading","bindings","active","templateUrl"],"mappings":"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","file":"componentGrading.js","sourcesContent":["'use strict';\r\n\r\nclass ComponentGradingController {\r\n    constructor($filter,\r\n                $mdDialog,\r\n                $scope,\r\n                AnnotationService,\r\n                ConfigService,\r\n                ProjectService,\r\n                TeacherDataService,\r\n                UtilService,) {\r\n        this.$filter = $filter;\r\n        this.$mdDialog = $mdDialog;\r\n        this.$scope = $scope;\r\n        this.AnnotationService = AnnotationService;\r\n        this.ConfigService = ConfigService;\r\n        this.ProjectService = ProjectService;\r\n        this.TeacherDataService = TeacherDataService;\r\n        this.UtilService = UtilService;\r\n\r\n        this.$translate = this.$filter('translate');\r\n\r\n        this.$onInit = () => {\r\n            this.runId = this.ConfigService.getRunId();\r\n\r\n            let toUserInfo = this.ConfigService.getUserInfoByWorkgroupId(this.toWorkgroupId);\r\n            if (toUserInfo) {\r\n                // set the period id\r\n                this.periodId = toUserInfo.periodId;\r\n            }\r\n\r\n            // get the workgroup user names\r\n            let userNamesArray = this.ConfigService.getUserNamesByWorkgroupId(this.toWorkgroupId);\r\n            this.userNames = userNamesArray.map( (obj) => {\r\n                return obj.name;\r\n            }).join(', ');\r\n        };\r\n\r\n        this.$onChanges = (changes) => {\r\n\r\n            if (changes.maxScore) {\r\n                this.maxScore = typeof changes.maxScore.currentValue === 'number' ? changes.maxScore.currentValue : 0;\r\n            }\r\n\r\n            this.componentStates = this.TeacherDataService.getComponentStatesByWorkgroupIdAndComponentId(this.toWorkgroupId, this.componentId);\r\n            this.latestComponentStateTime = this.getLatestComponentStateTime();\r\n\r\n            this.processAnnotations();\r\n        };\r\n\r\n        this.$scope.$on('annotationSavedToServer', (event, args) => {\r\n            // TODO: we're watching this here and in the parent component's controller; probably want to optimize!\r\n            if (args != null ) {\r\n\r\n                // get the annotation that was saved to the server\r\n                let annotation = args.annotation;\r\n\r\n                if (annotation != null) {\r\n\r\n                    // get the node id and component id of the annotation\r\n                    let annotationNodeId = annotation.nodeId;\r\n                    let annotationComponentId = annotation.componentId;\r\n\r\n                    // make sure the annotation was for this component\r\n                    if (this.nodeId === annotationNodeId &&\r\n                        this.componentId === annotationComponentId) {\r\n\r\n                        // get latest score and comment annotations for this component\r\n                        this.processAnnotations();\r\n                    }\r\n                }\r\n            }\r\n        });\r\n\r\n        this.$scope.$on('projectSaved', (event, args) => {\r\n            // update maxScore\r\n            this.maxScore = this.ProjectService.getMaxScoreForComponent(this.nodeId, this.componentId);\r\n        });\r\n\r\n    }\r\n\r\n    processAnnotations() {\r\n        this.latestAnnotations = this.AnnotationService.getLatestComponentAnnotations(this.nodeId, this.componentId, this.toWorkgroupId);\r\n\r\n        if (this.latestAnnotations && this.latestAnnotations.comment) {\r\n            let latestComment = this.latestAnnotations.comment;\r\n            if (latestComment.type === 'comment') {\r\n                this.comment = latestComment.data.value;\r\n            }\r\n        }\r\n\r\n        if (this.latestAnnotations && this.latestAnnotations.score) {\r\n            this.score = this.latestAnnotations.score.data.value;\r\n        }\r\n\r\n        this.latestTeacherAnnotationTime = this.getLatestTeacherAnnotationTime();\r\n\r\n        this.hasNewWork = this.checkHasNewWork();\r\n    }\r\n\r\n    checkHasNewWork() {\r\n        let result = false;\r\n\r\n        if (this.latestComponentStateTime) {\r\n            // there is work for this component\r\n\r\n            if (this.latestTeacherAnnotationTime) {\r\n                if (this.latestComponentStateTime > this.latestTeacherAnnotationTime) {\r\n                    // latest component state is newer than latest annotation, so work is new\r\n                    result = true;\r\n                    this.comment = null;\r\n                }\r\n            } else {\r\n                // there are no annotations, so work is new\r\n                result = true;\r\n            }\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Returns true if the latest comment is an auto comment and it's\r\n     * studentWorkId matches the latest component state's id\r\n     */\r\n    showAutoComment() {\r\n        let result = false;\r\n        if (this.latestAnnotations) {\r\n            let latestComment = this.latestAnnotations.comment;\r\n            if (latestComment && latestComment.type === 'autoComment') {\r\n                let n = this.componentStates.length;\r\n                if (n > 0) {\r\n                    let latestComponentState = this.componentStates[n-1]\r\n                    if (latestComponentState.id === latestComment.studentWorkId) {\r\n                        result = true;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Get the most recent teacher annotation (from the current score and comment annotations)\r\n     * @return Object (latest teacher annotation)\r\n     */\r\n    getLatestTeacherAnnotation() {\r\n        let latest = null;\r\n        let latestComment = this.latestAnnotations.comment;\r\n        let latestScore = this.latestAnnotations.score;\r\n        let latestTeacherComment = (latestComment && latestComment.type === 'comment') ? latestComment : null;\r\n        let latestTeacherScore = (latestScore && latestScore.type === 'score') ? latestScore : null;\r\n\r\n        if (latestTeacherComment || latestTeacherScore) {\r\n            let commentSaveTime = latestTeacherComment ? latestTeacherComment.serverSaveTime : 0;\r\n            let scoreSaveTime = latestTeacherScore ? latestTeacherScore.serverSaveTime : 0;\r\n\r\n            if (commentSaveTime >= scoreSaveTime) {\r\n                latest = latestTeacherComment;\r\n            } else if (scoreSaveTime > commentSaveTime) {\r\n                latest = latestTeacherScore;\r\n            }\r\n        }\r\n\r\n        return latest;\r\n    }\r\n\r\n    /**\r\n     * Calculate the save time of the latest teacher annotation\r\n     * @return Number (latest teacher annotation post time)\r\n     */\r\n    getLatestTeacherAnnotationTime() {\r\n        let latest = this.getLatestTeacherAnnotation();\r\n        let time = 0;\r\n\r\n        if (latest) {\r\n            let serverSaveTime = latest.serverSaveTime;\r\n            time = this.ConfigService.convertToClientTimestamp(serverSaveTime)\r\n        }\r\n\r\n        return time;\r\n    }\r\n\r\n    /**\r\n     * Calculate the save time of the latest component state\r\n     * @return Number (latest annotation post time)\r\n     */\r\n    getLatestComponentStateTime() {\r\n        let total = this.componentStates.length;\r\n        let time = null;\r\n\r\n        if (total) {\r\n            let latest = this.componentStates[total-1];\r\n\r\n            if (latest) {\r\n                let serverSaveTime = latest.serverSaveTime;\r\n                time = this.ConfigService.convertToClientTimestamp(serverSaveTime)\r\n            }\r\n        }\r\n\r\n        return time;\r\n    }\r\n\r\n    showRevisions($event) {\r\n        let workgroupId = this.toWorkgroupId;\r\n        let componentId = this.componentId;\r\n        let maxScore  = this.maxScore;\r\n        let userNames = this.userNames;\r\n\r\n        this.$mdDialog.show({\r\n            parent: angular.element(document.body),\r\n            targetEvent: $event,\r\n            fullscreen: true,\r\n            template:\r\n                `<md-dialog aria-label=\"{{ 'revisionsForTeam' | translate:{teamNames: userNames} }}\" class=\"dialog--wider\">\r\n                    <md-toolbar>\r\n                        <div class=\"md-toolbar-tools gray-darkest-bg\">\r\n                            <h2 class=\"overflow--ellipsis\">{{ 'revisionsForTeam' | translate:{teamNames: userNames} }}</h2>\r\n                        </div>\r\n                    </md-toolbar>\r\n                    <md-dialog-content>\r\n                        <div class=\"md-dialog-content gray-lighter-bg\">\r\n                            <workgroup-component-revisions workgroup-id=\"workgroupId\" component-id=\"{{ componentId }}\" max-score=\"maxScore\"></workgroup-component-revisions>\r\n                        </div>\r\n                    </md-dialog-content>\r\n                    <md-dialog-actions layout=\"row\" layout-align=\"end center\">\r\n                        <md-button class=\"md-primary\" ng-click=\"close()\" aria-label=\"{{ 'close' | translate }}\">{{ 'close' | translate }}</md-button>\r\n                    </md-dialog-actions>\r\n                </md-dialog>`,\r\n            locals: {\r\n                workgroupId: workgroupId,\r\n                componentId: componentId,\r\n                maxScore: maxScore,\r\n                userNames: userNames\r\n            },\r\n            controller: RevisionsController\r\n        });\r\n        function RevisionsController($scope, $mdDialog, workgroupId, componentId, maxScore, userNames) {\r\n            $scope.workgroupId = workgroupId;\r\n            $scope.componentId = componentId;\r\n            $scope.maxScore = maxScore;\r\n            $scope.userNames = userNames;\r\n            $scope.close = () => {\r\n                $mdDialog.hide();\r\n            };\r\n        }\r\n        RevisionsController.$inject = [\"$scope\", \"$mdDialog\", \"workgroupId\", \"componentId\", \"maxScore\", \"userNames\"];\r\n    }\r\n\r\n    /**\r\n     * Save the annotation to the server\r\n     * @param type String to indicate which type of annotation to post\r\n     */\r\n    postAnnotation(type) {\r\n\r\n        if (this.runId != null &&\r\n            this.periodId != null &&\r\n            this.nodeId != null &&\r\n            this.componentId != null &&\r\n            this.toWorkgroupId != null &&\r\n            type) {\r\n\r\n            // get the current time\r\n            let clientSaveTime = new Date().getTime();\r\n\r\n            // get the logged in teacher's id\r\n            let fromWorkgroupId = this.ConfigService.getWorkgroupId();\r\n\r\n            // get the value\r\n            let value = null;\r\n            if (type === 'score') {\r\n                value = this.score;\r\n                // convert the value to a number if possible\r\n                value = this.UtilService.convertStringToNumber(value);\r\n            } else if (type === 'comment') {\r\n                value = this.comment;\r\n            }\r\n\r\n            if ((type === 'comment' && value) || (type === 'score' && typeof value === 'number' && value >= 0)) {\r\n                let data = {};\r\n                data.value = value;\r\n                let localNotebookItemId = null;  // we're not grading notebook item in this view.\r\n                let notebookItemId = null;  // we're not grading notebook item in this view.\r\n\r\n                // create the annotation object\r\n                let annotation = this.AnnotationService.createAnnotation(\r\n                    this.annotationId,\r\n                    this.runId,\r\n                    this.periodId,\r\n                    this.fromWorkgroupId,\r\n                    this.toWorkgroupId,\r\n                    this.nodeId,\r\n                    this.componentId,\r\n                    this.componentStateId,\r\n                    localNotebookItemId,\r\n                    notebookItemId,\r\n                    type,\r\n                    data,\r\n                    clientSaveTime);\r\n\r\n                // save the annotation to the server\r\n                this.AnnotationService.saveAnnotation(annotation).then(result => {\r\n                    /*let localAnnotation = result;\r\n\r\n                    if (localAnnotation != null) {\r\n                        if (this.annotationId == null) {\r\n                            // set the annotation id if there was no annotation id\r\n                            this.annotationId = localAnnotation.id;\r\n                        }\r\n\r\n                        this.processAnnotations();\r\n                    }*/\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Save the maxScore of this component to the server\r\n     */\r\n    updateMaxScore() {\r\n\r\n        if (this.runId != null &&\r\n            this.periodId != null &&\r\n            this.nodeId != null &&\r\n            this.componentId != null) {\r\n\r\n            // get the new maxScore\r\n            let maxScore = this.maxScore;\r\n            // convert to number if possible\r\n            maxScore = this.UtilService.convertStringToNumber(maxScore);\r\n\r\n            if (typeof maxScore === 'number' && maxScore >= 0) {\r\n                this.ProjectService.setMaxScoreForComponent(this.nodeId, this.componentId, maxScore);\r\n                this.ProjectService.saveProject();\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nComponentGradingController.$inject = [\r\n    '$filter',\r\n    '$mdDialog',\r\n    '$scope',\r\n    'AnnotationService',\r\n    'ConfigService',\r\n    'ProjectService',\r\n    'TeacherDataService',\r\n    'UtilService'\r\n];\r\n\r\nconst ComponentGrading = {\r\n    bindings: {\r\n        nodeId: '<',\r\n        componentId: '<',\r\n        maxScore: '<',\r\n        fromWorkgroupId: '<',\r\n        toWorkgroupId: '<',\r\n        componentStateId: '<',\r\n        active: '<'\r\n    },\r\n    templateUrl: 'wise5/directives/componentGrading/componentGrading.html',\r\n    controller: ComponentGradingController\r\n};\r\n\r\nexport default ComponentGrading;\r\n"]}