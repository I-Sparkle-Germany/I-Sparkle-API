{"version":3,"sources":["componentGrading.es6"],"names":["ComponentGradingController","$scope","$translate","AnnotationService","ConfigService","TeacherDataService","UtilService","$onInit","runId","getRunId","toUserInfo","getUserInfoByWorkgroupId","toWorkgroupId","periodId","$onChanges","changes","maxScore","hasMaxScore","latestAnnotations","getLatestComponentAnnotations","nodeId","componentId","processAnnotations","componentStates","getComponentStatesByWorkgroupIdAndComponentId","latestComponentStateTime","getLatestComponentStateTime","comment","type","data","value","score","latestAnnotationTime","getLatestAnnotationTime","latest","commentSaveTime","serverSaveTime","scoreSaveTime","getLatestAnnotation","time","convertToClientTimestamp","total","length","clientSaveTime","Date","getTime","fromWorkgroupId","getWorkgroupId","convertStringToNumber","annotation","createAnnotation","annotationId","componentStateId","saveAnnotation","then","localAnnotation","result","id","$inject","ComponentGrading","bindings","active","templateUrl","controller"],"mappings":"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","file":"componentGrading.js","sourcesContent":["'use strict';\n\nclass ComponentGradingController {\n    constructor($scope,\n                $translate,\n                AnnotationService,\n                ConfigService,\n                TeacherDataService,\n                UtilService,) {\n        this.$scope = $scope;\n        this.$translate = $translate;\n        this.AnnotationService = AnnotationService;\n        this.ConfigService = ConfigService;\n        this.TeacherDataService = TeacherDataService;\n        this.UtilService = UtilService;\n\n        this.$onInit = () => {\n            this.runId = this.ConfigService.getRunId();\n\n            let toUserInfo = this.ConfigService.getUserInfoByWorkgroupId(this.toWorkgroupId);\n            if (toUserInfo) {\n                // set the period id\n                this.periodId = toUserInfo.periodId;\n            }\n        };\n\n        this.$onChanges = (changes) => {\n\n            if (changes.maxScore) {\n                this.hasMaxScore = (typeof this.maxScore === 'number');\n            }\n\n            this.latestAnnotations = this.AnnotationService.getLatestComponentAnnotations(this.nodeId, this.componentId, this.toWorkgroupId);\n            this.processAnnotations();\n\n            this.componentStates = this.TeacherDataService.getComponentStatesByWorkgroupIdAndComponentId(this.toWorkgroupId, this.componentId);\n            this.latestComponentStateTime = this.getLatestComponentStateTime();\n        };\n    }\n\n    processAnnotations() {\n        if (this.latestAnnotations && this.latestAnnotations.comment) {\n            if (this.latestAnnotations.comment.type === 'comment') {\n                this.comment = this.latestAnnotations.comment.data.value;\n            } else {\n                this.comment = null;\n            }\n        }\n\n        if (this.latestAnnotations && this.latestAnnotations.score) {\n            this.score = this.latestAnnotations.score.data.value;\n        }\n    }\n\n    hasNewWork() {\n        if (this.latestComponentStateTime) {\n            let latestAnnotationTime = this.getLatestAnnotationTime();\n            if (latestAnnotationTime && this.latestComponentStateTime > latestAnnotationTime) {\n                return true;\n            }\n        } else {\n            return false;\n        }\n    }\n\n    /**\n     * Get the most recent annotation (from the current score and comment annotations)\n     * @return Object (latest annotation)\n     */\n    getLatestAnnotation() {\n        let latest = null;\n\n        if (this.latestAnnotations.comment || this.latestAnnotations.score) {\n            let commentSaveTime = this.latestAnnotations.comment ? this.latestAnnotations.comment.serverSaveTime : 0;\n            let scoreSaveTime = this.latestAnnotations.score ? this.latestAnnotations.score.serverSaveTime : 0;\n\n            if (commentSaveTime >= scoreSaveTime) {\n                latest = this.latestAnnotations.comment;\n            } else if (scoreSaveTime > commentSaveTime) {\n                latest = this.latestAnnotations.score;\n            }\n        }\n\n        return latest;\n    }\n\n    /**\n     * Calculate the save time of the latest annotation\n     * @return Number (latest annotation post time)\n     */\n    getLatestAnnotationTime() {\n        let latest = this.getLatestAnnotation();\n        let time = null;\n\n        if (latest) {\n            let serverSaveTime = latest.serverSaveTime;\n            time = this.ConfigService.convertToClientTimestamp(serverSaveTime)\n        }\n\n        return time;\n    }\n\n    /**\n     * Calculate the save time of the latest component state\n     * @return Number (latest annotation post time)\n     */\n    getLatestComponentStateTime() {\n        let total = this.componentStates.length;\n        let time = null;\n\n        if (total) {\n            let latest = this.componentStates[total-1];\n\n            if (latest) {\n                let serverSaveTime = latest.serverSaveTime;\n                time = this.ConfigService.convertToClientTimestamp(serverSaveTime)\n            }\n        }\n\n        return time;\n    }\n\n    /**\n     * Save the annotation to the server\n     * @param type String to indicate which type of annotation to post\n     */\n    postAnnotation(type) {\n\n        if (this.runId != null &&\n            this.periodId != null &&\n            this.nodeId != null &&\n            this.componentId != null &&\n            this.toWorkgroupId != null &&\n            type) {\n\n            // get the current time\n            let clientSaveTime = new Date().getTime();\n\n            // get the logged in teacher's id\n            let fromWorkgroupId = this.ConfigService.getWorkgroupId();\n\n            // get the value\n            let value = null;\n            if (type === 'score') {\n                value = this.score;\n                // convert the value to a number if possible\n                value = this.UtilService.convertStringToNumber(value);\n            } else if (type === 'comment') {\n                value = this.comment;\n            }\n\n            if (value) {\n                let data = {};\n                data.value = value;\n\n                // create the annotation object\n                let annotation = this.AnnotationService.createAnnotation(\n                    this.annotationId,\n                    this.runId,\n                    this.periodId,\n                    this.fromWorkgroupId,\n                    this.toWorkgroupId,\n                    this.nodeId,\n                    this.componentId,\n                    this.componentStateId,\n                    type,\n                    data,\n                    clientSaveTime);\n\n                // save the annotation to the server\n                this.AnnotationService.saveAnnotation(annotation).then(result => {\n                    var localAnnotation = result;\n\n                    if (localAnnotation != null) {\n                        if (this.annotationId == null) {\n                            // set the annotation id if there was no annotation id\n                            this.annotationId = localAnnotation.id;\n                        }\n                    }\n                });\n            }\n        }\n    }\n}\n\nComponentGradingController.$inject = [\n    '$scope',\n    '$translate',\n    'AnnotationService',\n    'ConfigService',\n    'TeacherDataService',\n    'UtilService'\n];\n\nconst ComponentGrading = {\n    bindings: {\n        nodeId: '<',\n        componentId: '<',\n        maxScore: '<',\n        fromWorkgroupId: '<',\n        toWorkgroupId: '<',\n        componentStateId: '<',\n        active: '<'\n    },\n    templateUrl: 'wise5/directives/componentGrading/componentGrading.html',\n    controller: ComponentGradingController\n};\n\nexport default ComponentGrading;\n"]}