{"version":3,"sources":["nodeController.es6"],"names":["NodeController","$compile","$filter","$q","$rootScope","$scope","$state","$timeout","AnnotationService","ConfigService","NodeService","NotebookService","ProjectService","StudentDataService","$translate","autoSaveInterval","nodeId","nodeContent","nodeStatus","nodeTitle","dirtyComponentIds","dirtySubmitComponentIds","submit","workgroupId","getWorkgroupId","teacherWorkgroupId","getTeacherWorkgroupId","componentToScope","saveMessage","text","time","rubric","mode","getMode","getCurrentNode","isApplicationNode","getCurrentNodeId","currentNode","id","getNodeById","getNodeTitleByNodeId","nodeStatuses","calculateDisabled","startAutoSaveInterval","registerExitListener","hasTransitionLogic","evaluateTransitionLogicOn","evaluateTransitionLogic","latestComponentState","getLatestComponentStateByNodeIdAndComponentId","latestClientSaveTime","clientSaveTime","isSubmit","setSaveMessage","componentId","componentType","category","event","eventData","saveVLEEvent","createRubricTour","params","componentElement","$","originalBackgroundColor","css","animate","scrollTop","prop","$on","args","isAutoSave","nodeContainsComponent","createAndSaveComponentData","componentState","notifyConnectedParts","$broadcast","isDirty","index","indexOf","push","splice","nodeToExit","saveTriggeredBy","stopAutoSaveInterval","nodeUnloaded","script","retrieveScript","then","Function","call","rubricTour","arrowWidth","bubblePadding","bubbleWidth","container","steps","showPrevButton","showNextButton","scrollDuration","customRenderer","getRubricTemplate","customData","$ctrl","i18n","nextBtn","prevBtn","doneBtn","closeTooltip","thisTarget","target","placement","title","content","replaceAssetPaths","xOffset","arrowOffset","onShow","onShowRubric","viewed","components","getComponents","l","length","i","component","yOffset","step","hopscotch","endTour","startTour","details","buttons","tour","template","width","padding","isTour","stepNum","showClose","showCTA","ctaLabel","showPrev","showNext","templateHTML","outerHTML","getCurrStepNum","getCurrTour","childScope","revisions","componentStates","getComponentStatesByNodeIdAndComponentId","$event","isComponentDisabled","getRevisions","allowRevert","componentController","openResponseController","drawController","discussionController","tableController","graphController","lockAfterSubmit","getComponentStatesByNodeId","isSubmitted","isWorkSubmitted","isDisabled","c","tempComponent","tempComponentId","result","getComponentTemplatePath","showSaveButton","showSubmitButton","componentContent","message","autoSaveIntervalId","setInterval","clearInterval","createComponentStates","componentAnnotations","componentEvents","nodeStates","annotations","concat","saveToServer","savedStudentDataResponse","componentAnnotation","type","studentWorkList","latestStudentWork","serverSaveTime","convertToClientTimestamp","componentStatePromises","getComponentById","runId","getRunId","periodId","getPeriodId","getComponentState","componentStatePromise","getComponentStateFromChildScope","all","latestScoreAnnotation","latestCommentAnnotation","getLatestScoreAnnotation","getLatestCommentAnnotation","changedComponentId","connectedComponents","cc","connectedComponentParams","connectedComponentId","connectedNodeId","connectedComponent","componentScope","handleConnectedComponentStudentDataChanged","submitDirty","latestState","getComponentStateByComponentId","logOutListener","$inject"],"mappings":"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","file":"nodeController.js","sourcesContent":["class NodeController {\r\n    constructor($compile,\r\n                $filter,\r\n                $q,\r\n                $rootScope,\r\n                $scope,\r\n                $state,\r\n                $timeout,\r\n                AnnotationService,\r\n                ConfigService,\r\n                NodeService,\r\n                NotebookService,\r\n                ProjectService,\r\n                StudentDataService) {\r\n\r\n        this.$compile = $compile;\r\n        this.$filter = $filter;\r\n        this.$q = $q;\r\n        this.$rootScope = $rootScope;\r\n        this.$scope = $scope;\r\n        this.$state = $state;\r\n        this.$timeout = $timeout;\r\n        this.AnnotationService = AnnotationService;\r\n        this.ConfigService = ConfigService;\r\n        this.NodeService = NodeService;\r\n        this.NotebookService = NotebookService;\r\n        this.ProjectService = ProjectService;\r\n        this.StudentDataService = StudentDataService;\r\n\r\n        this.$translate = this.$filter('translate');\r\n\r\n        // the auto save interval in milliseconds\r\n        this.autoSaveInterval = 60000;\r\n\r\n        // the node id of the current node\r\n        this.nodeId = null;\r\n\r\n        // field that will hold the node content\r\n        this.nodeContent = null;\r\n\r\n        // field that will hold the node status\r\n        this.nodeStatus = null;\r\n\r\n        // field that will hold the node title\r\n        this.nodeTitle = null;\r\n\r\n        // array to hold ids of dirty component\r\n        this.dirtyComponentIds = [];\r\n\r\n        // array to hold ids of components where student work has changed since last submission\r\n        this.dirtySubmitComponentIds = [];\r\n\r\n        // whether the student work has changed since last submit\r\n        this.submit = false;\r\n\r\n        this.workgroupId = this.ConfigService.getWorkgroupId();\r\n\r\n        this.teacherWorkgroupId = this.ConfigService.getTeacherWorkgroupId();\r\n\r\n        /*\r\n         * an object that holds the mappings with the key being the component\r\n         * and the value being the scope object from the child controller\r\n         */\r\n        this.componentToScope = {};\r\n\r\n        // message to show next to save/submit buttons\r\n        this.saveMessage = {\r\n            text: '',\r\n            time: ''\r\n        };\r\n\r\n        // the step rubric\r\n        this.rubric = null;\r\n\r\n        // get the mode e.g. 'preview', 'student', 'authoring', 'grading', etc.\r\n        this.mode = this.ConfigService.getMode();\r\n\r\n        // perform setup of this node only if the current node is not a group.\r\n        if (this.StudentDataService.getCurrentNode() && this.ProjectService.isApplicationNode(this.StudentDataService.getCurrentNodeId())) {\r\n            // get the current node and node id\r\n            var currentNode = this.StudentDataService.getCurrentNode();\r\n            if (currentNode != null) {\r\n                this.nodeId = currentNode.id;\r\n            }\r\n\r\n            // get the node content\r\n            this.nodeContent = this.ProjectService.getNodeById(this.nodeId);\r\n\r\n            this.nodeTitle = this.ProjectService.getNodeTitleByNodeId(this.nodeId);\r\n\r\n            this.nodeStatus = this.StudentDataService.nodeStatuses[this.nodeId];\r\n\r\n            // populate the student work into this node\r\n            //this.setStudentWork();\r\n\r\n            // check if we need to lock this node\r\n            this.calculateDisabled();\r\n\r\n            //this.importWork();\r\n\r\n            // start the auto save interval\r\n            this.startAutoSaveInterval();\r\n\r\n            // register this controller to listen for the exit event\r\n            this.registerExitListener();\r\n\r\n            if (this.NodeService.hasTransitionLogic() && this.NodeService.evaluateTransitionLogicOn('enterNode')) {\r\n                this.NodeService.evaluateTransitionLogic();\r\n            }\r\n\r\n            // set save message with last save/submission\r\n            // for now, we'll use the latest component state (since we don't currently keep track of node-level saves)\r\n            // TODO: use node states once we implement node state saving\r\n            let latestComponentState = this.StudentDataService.getLatestComponentStateByNodeIdAndComponentId(this.nodeId);\r\n            if (latestComponentState) {\r\n                let latestClientSaveTime = latestComponentState.clientSaveTime;\r\n                if (latestComponentState.isSubmit) {\r\n                    this.setSaveMessage(this.$translate('LAST_SUBMITTED'), latestClientSaveTime);\r\n                } else {\r\n                    this.setSaveMessage(this.$translate('LAST_SAVED'), latestClientSaveTime);\r\n                }\r\n            }\r\n\r\n            // save nodeEntered event\r\n            var nodeId = this.nodeId;\r\n            var componentId = null;\r\n            var componentType = null;\r\n            var category = \"Navigation\";\r\n            var event = \"nodeEntered\";\r\n            var eventData = {};\r\n            eventData.nodeId = nodeId;\r\n            this.StudentDataService.saveVLEEvent(nodeId, componentId, componentType, category, event, eventData);\r\n\r\n            if (this.nodeContent != null) {\r\n                // get the step rubric\r\n                this.rubric = this.nodeContent.rubric;\r\n\r\n                // create the rubric tour bubbles\r\n                this.createRubricTour();\r\n            }\r\n\r\n            /*\r\n             * Check if the component id was provided in the state params. If\r\n             * it is provided, we will scroll to it and then briefly highlight\r\n             * it.\r\n             */\r\n            if (this.$state != null &&\r\n                this.$state.params != null &&\r\n                this.$state.params.componentId != null) {\r\n\r\n                // get the component id\r\n                var componentId = this.$state.params.componentId;\r\n\r\n                this.$timeout(() => {\r\n                    // get the UI element of the component\r\n                    let componentElement = $(\"#component_\" + componentId);\r\n\r\n                    if (componentElement != null) {\r\n                        // save the original background color\r\n                        let originalBackgroundColor = componentElement.css(\"backgroundColor\");\r\n\r\n                        // highlight the background briefly to draw attention to it\r\n                        componentElement.css(\"background-color\", \"#FFFF9C\");\r\n\r\n                        // scroll to the first new component that we've added\r\n                        $('#content').animate({\r\n                            scrollTop: componentElement.prop(\"offsetTop\")\r\n                        }, 1000);\r\n\r\n                        /*\r\n                         * remove the background highlighting so that it returns\r\n                         * to its original color\r\n                         */\r\n                        componentElement.css({\r\n                            'transition': 'background-color 3s ease-in-out',\r\n                            'background-color': originalBackgroundColor\r\n                        });\r\n                    }\r\n                }, 1000);\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Listen for the componentSaveTriggered event which occurs when a\r\n         * component is requesting student data to be saved\r\n         */\r\n        this.$scope.$on('componentSaveTriggered', (event, args) => {\r\n            var isAutoSave = false;\r\n\r\n            if (args != null) {\r\n                var nodeId = args.nodeId;\r\n                var componentId = args.componentId;\r\n\r\n                if (nodeId != null && componentId != null) {\r\n                    if (this.nodeId == nodeId && this.nodeContainsComponent(componentId)) {\r\n                        /*\r\n                         * obtain the component states from the children and save them\r\n                         * to the server\r\n                         */\r\n                        this.createAndSaveComponentData(isAutoSave, componentId);\r\n                    }\r\n                }\r\n            }\r\n        });\r\n\r\n        /**\r\n         * Listen for the componentSubmitTriggered event which occurs when a\r\n         * component is requesting student data to be submitted\r\n         */\r\n        this.$scope.$on('componentSubmitTriggered', (event, args) => {\r\n            var isAutoSave = false;\r\n            var isSubmit = true;\r\n\r\n            if (args != null) {\r\n                var nodeId = args.nodeId;\r\n                var componentId = args.componentId;\r\n\r\n                if (nodeId != null && componentId != null) {\r\n                    if (this.nodeId == nodeId && this.nodeContainsComponent(componentId)) {\r\n                        /*\r\n                         * obtain the component states from the children and save them\r\n                         * to the server\r\n                         */\r\n                        this.createAndSaveComponentData(isAutoSave, componentId, isSubmit);\r\n                    }\r\n                }\r\n            }\r\n        });\r\n\r\n        /**\r\n         * Listen for the componentStudentDataChanged event that will come from\r\n         * child component scopes\r\n         * @param event\r\n         * @param args the arguments provided when the event is fired\r\n         */\r\n        this.$scope.$on('componentStudentDataChanged', (event, args) => {\r\n            /*\r\n             * the student data in one of our child scopes has changed so\r\n             * we will need to save\r\n             */\r\n            if (args != null) {\r\n\r\n                // get the part id\r\n                var componentId = args.componentId;\r\n\r\n                // get the new component state\r\n                var componentState = args.componentState;\r\n\r\n                if (componentId != null && componentState != null) {\r\n\r\n                    if (componentState.nodeId == null) {\r\n\r\n                        if (args.nodeId != null) {\r\n                            /*\r\n                             * set the node id into the component state because\r\n                             * the component state hasn't had it set at this\r\n                             * point.\r\n                             */\r\n                            componentState.nodeId = args.nodeId;\r\n                        }\r\n                    }\r\n\r\n                    if (componentState.componentId == null) {\r\n\r\n                        if (args.componentId != null) {\r\n                            /*\r\n                             * set the component id into the component state\r\n                             * because the component state hasn't had it set at\r\n                             * this point.\r\n                             */\r\n                            componentState.componentId = args.componentId;\r\n                        }\r\n                    }\r\n\r\n                    /*\r\n                     * notify the parts that are connected that the student\r\n                     * data has changed\r\n                     */\r\n                    this.notifyConnectedParts(componentId, componentState);\r\n\r\n                    this.$scope.$broadcast('siblingComponentStudentDataChanged', args);\r\n                }\r\n            }\r\n        });\r\n\r\n        /**\r\n         * Listen for the componentDirty event that will come from child component\r\n         * scopes; notifies node that component has/doesn't have unsaved work\r\n         * @param event\r\n         * @param args the arguments provided when the event is fired\r\n         */\r\n        this.$scope.$on('componentDirty', (event, args) => {\r\n            let componentId = args.componentId;\r\n\r\n            if (componentId) {\r\n                let isDirty = args.isDirty;\r\n                let index = this.dirtyComponentIds.indexOf(componentId);\r\n\r\n                if (isDirty && index === -1) {\r\n                    // add component id to array of dirty components\r\n                    this.dirtyComponentIds.push(componentId);\r\n                } else if (!isDirty && index > -1){\r\n                    // remove component id from array of dirty components\r\n                    this.dirtyComponentIds.splice(index, 1);\r\n                }\r\n            }\r\n        });\r\n\r\n        /**\r\n         * Listen for the componentSubmitDirty event that will come from child\r\n         * component scopes; notifies node that work has/has not changed for a\r\n         * component since last submission\r\n         * @param event\r\n         * @param args the arguments provided when the event is fired\r\n         */\r\n        this.$scope.$on('componentSubmitDirty', (event, args) => {\r\n            let componentId = args.componentId;\r\n\r\n            if (componentId) {\r\n                let isDirty = args.isDirty;\r\n                let index = this.dirtySubmitComponentIds.indexOf(componentId);\r\n\r\n                if (isDirty && index === -1) {\r\n                    // add component id to array of dirty submit components\r\n                    this.dirtySubmitComponentIds.push(componentId);\r\n                } else if (!isDirty && index > -1){\r\n                    // remove component id from array of dirty submit components\r\n                    this.dirtySubmitComponentIds.splice(index, 1);\r\n                }\r\n            }\r\n        });\r\n\r\n        /**\r\n         * Listen for the 'exitNode' event which is fired when the student\r\n         * exits the node. This will perform saving when the student exits\r\n         * the node.\r\n         */\r\n        this.$scope.$on('exitNode', (event, args) => {\r\n            // get the node that is exiting\r\n            var nodeToExit = args.nodeToExit;\r\n\r\n            /*\r\n             * make sure the node id of the node that is exiting is\r\n             * this node\r\n             */\r\n            if (nodeToExit.id === this.nodeId) {\r\n                var saveTriggeredBy = 'exitNode';\r\n\r\n                // stop the auto save interval for this node\r\n                this.stopAutoSaveInterval();\r\n\r\n                /*\r\n                 * tell the parent that this node is done performing\r\n                 * everything it needs to do before exiting\r\n                 */\r\n                this.nodeUnloaded(this.nodeId);\r\n\r\n                // check if this node has transition logic that should be run when the student exits the node\r\n                if (this.NodeService.hasTransitionLogic() && this.NodeService.evaluateTransitionLogicOn('exitNode')) {\r\n                    // this node has transition logic\r\n                    this.NodeService.evaluateTransitionLogic();\r\n                }\r\n            }\r\n        });\r\n\r\n        // load script for this node, if any\r\n        let script = this.nodeContent.script;\r\n        if (script != null) {\r\n            this.ProjectService.retrieveScript(script).then((script) => {\r\n                new Function(script).call(this);\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Create the tour bubbles for all of the rubrics for this node\r\n     */\r\n    createRubricTour() {\r\n        this.rubricTour = {\r\n            id: 'rubricTour',\r\n            arrowWidth: 12,\r\n            bubblePadding: 0,\r\n            bubbleWidth: 800,\r\n            container: '#content',\r\n            steps: [],\r\n            showPrevButton: true,\r\n            showNextButton: true,\r\n            scrollDuration: 400,\r\n            customRenderer: this.getRubricTemplate,\r\n            customData: {\r\n                $ctrl: this\r\n            },\r\n            i18n: {\r\n                nextBtn: this.$translate('NEXT'),\r\n                prevBtn: this.$translate('PREVIOUS'),\r\n                doneBtn: this.$translate('DONE'),\r\n                closeTooltip: this.$translate('CLOSE')\r\n            }\r\n        };\r\n\r\n        if (this.rubric) {\r\n            let thisTarget = '#nodeRubric_' + this.nodeId;\r\n\r\n            // add a tour bubble for the node rubric\r\n            this.rubricTour.steps.push(\r\n                {\r\n                    target: thisTarget,\r\n                    placement: 'bottom',\r\n                    title: this.$translate('STEP_INFO'),\r\n                    content: this.ProjectService.replaceAssetPaths(this.rubric),\r\n                    xOffset: 'center',\r\n                    arrowOffset: 'center',\r\n                    onShow: this.onShowRubric,\r\n                    viewed: false\r\n                }\r\n            );\r\n        }\r\n\r\n        // add tour bubbles for each of the component rubrics\r\n        let components = this.getComponents();\r\n        let l = components.length, i = 0;\r\n        for (; i < l; i++) {\r\n            let component = components[i];\r\n\r\n            if (component.rubric) {\r\n                let thisTarget = '#rubric_' + component.id;\r\n                this.rubricTour.steps.push(\r\n                    {\r\n                        target: thisTarget,\r\n                        arrowOffset: 21,\r\n                        placement: 'right',\r\n                        yOffset: 1,\r\n                        title: this.$translate('ITEM_INFO'),\r\n                        content: this.ProjectService.replaceAssetPaths(component.rubric),\r\n                        onShow: this.onShowRubric,\r\n                        viewed: false\r\n                    }\r\n                );\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Show the tour bubble for the rubric with the given componentId or nodeId\r\n     * @param id componentId or nodeId of rubric to show\r\n     */\r\n    showRubric(id) {\r\n        if (this.rubricTour) {\r\n            let step = -1;\r\n            let index = 0;\r\n\r\n            let thisTarget = '#nodeRubric_' + this.nodeId;\r\n            if (this.nodeId === id) {\r\n                // the given id matches this nodeId\r\n                step = index;\r\n            }\r\n\r\n            if (step < 0) {\r\n                index++;\r\n\r\n                let components = this.getComponents();\r\n                let l = components.length, i = 0;\r\n                for (; i < l; i++) {\r\n                    let component = components[i];\r\n                    if (component.rubric) {\r\n                        thisTarget = '#rubric_' + component.id;\r\n                        if (component.id === id) {\r\n                            // the given id matches the current componentId\r\n                            step = index;\r\n                            break;\r\n                        }\r\n                        index++;\r\n                    }\r\n                }\r\n            }\r\n\r\n            // end any currently running rubric tour\r\n            hopscotch.endTour(this.rubricTour);\r\n            // show the rubric tour starting with the step for the matched index\r\n            hopscotch.startTour(this.rubricTour, step);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Create and return the custom template for the rubric tour bubbles\r\n     * @param details Object with the tour details\r\n     * @return HTML string\r\n     */\r\n    getRubricTemplate(details) {\r\n        let i18n = details.i18n;\r\n        let buttons = details.buttons;\r\n        let step = details.step;\r\n        let tour = details.tour;\r\n        let $ctrl = tour.customData.$ctrl;\r\n        let template =\r\n            `<div class=\"hopscotch-bubble-container help-bubble md-whiteframe-4dp\" style=\"width: ${ step.width }px; padding: ${ step.padding }px;\">\r\n                <md-toolbar class=\"md-subhead help-bubble__title md-toolbar--wise\">\r\n                    <div class=\"help-bubble___title__content\" layout=\"row\" layout-align=\"start center\" flex>\r\n                        <span>${ tour.isTour ? `${ i18n.stepNum } | ` : '' }${ step.title !== '' ? `${ step.title }` : '' }</span>\r\n                        <span flex></span>\r\n                        ${ buttons.showClose ? `<md-button class=\"md-icon-button hopscotch-close\">\r\n                            <md-icon aria-label=\"${ i18n.closeTooltip }\"> close </md-icon>\r\n                        </md-button>` : ''}\r\n                    </div>\r\n                </md-toolbar>\r\n                <div class=\"help-bubble__content\">\r\n                    ${ step.content  !== '' ? `${ step.content }` : '' }\r\n                    ${ buttons.showCTA ? `<md-button class=\"hopscotch-cta md-primary md-raised\">${ i18n.ctaLabel }</md-button>` : ''}\r\n                </div>\r\n                <md-divider></md-divider>\r\n                <div class=\"help-bubble__actions gray-lightest-bg\" layout=\"row\" layout-align=\"start center\">\r\n                    ${ buttons.showClose ? `<md-button class=\"button--small hopscotch-close\">${ i18n.closeTooltip }</md-button>` : ''}\r\n                    <span flex></span>\r\n                    ${ buttons.showPrev ? `<md-button class=\"button--small info hopscotch-prev\">${ i18n.prevBtn }</md-button>` : ''}\r\n                    ${ buttons.showNext ? `<md-button class=\"button--small info hopscotch-next\">${ i18n.nextBtn }</md-button>` : ''}\r\n                </md-card-actions>\r\n            </div>`;\r\n\r\n        // need to compile the template here because Hopscotch inserts raw html\r\n        let templateHTML = $ctrl.$compile(template)($ctrl.$scope)[0].outerHTML +\r\n            `<div class=\"hopscotch-bubble-arrow-container hopscotch-arrow\">\r\n                <div class=\"hopscotch-bubble-arrow-border\"></div>\r\n                <div class=\"hopscotch-bubble-arrow\"></div>\r\n            </div>`;\r\n        return templateHTML;\r\n    }\r\n\r\n    /**\r\n     * Callback for when a rubric tour bubble is shown\r\n     */\r\n    onShowRubric() {\r\n        // stop the pulsing animation on the info button for the rubric being shown\r\n        let index = hopscotch.getCurrStepNum();\r\n        hopscotch.getCurrTour().customData.$ctrl.rubricTour.steps[index].viewed = true;\r\n    }\r\n\r\n    /**\r\n     * The function that child component controllers will call to register\r\n     * themselves with this node\r\n     * @param childScope the child scope object\r\n     * @param component the component content for the component\r\n     */\r\n    registerComponentController(childScope, component) {\r\n        if (childScope != null && component != null) {\r\n            // get the component id\r\n            var componentId = component.id;\r\n\r\n            // add the component id to child scope mapping\r\n            this.componentToScope[componentId] = childScope;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Populate the student work into the node\r\n     */\r\n    setStudentWork() {\r\n\r\n    };\r\n\r\n    /**\r\n     * Import work from another node\r\n     */\r\n    importWork() {\r\n\r\n    };\r\n\r\n    /**\r\n     * Returns all the revisions made by this user for the specified component\r\n     */\r\n    getRevisions(componentId) {\r\n        var revisions = [];\r\n        // get the component states for this component\r\n        var componentStates = this.StudentDataService.getComponentStatesByNodeIdAndComponentId(this.nodeId, componentId);\r\n        return componentStates;\r\n    };\r\n\r\n    showRevisions($event, componentId, isComponentDisabled) {\r\n        var revisions = this.getRevisions(componentId);\r\n        var allowRevert = !isComponentDisabled;\r\n\r\n        // get the scope for the component\r\n        var childScope = this.componentToScope[componentId];\r\n\r\n        // TODO: generalize for other controllers\r\n        var componentController = null;\r\n\r\n        if (childScope.openResponseController) {\r\n            componentController = childScope.openResponseController;\r\n        } else if (childScope.drawController) {\r\n            componentController = childScope.drawController;\r\n        }\r\n\r\n        // broadcast showRevisions event\r\n        this.$rootScope.$broadcast('showRevisions', {revisions: revisions, componentController: componentController, allowRevert: allowRevert, $event: $event});\r\n    };\r\n\r\n    /**\r\n     * Show student assets\r\n     * @param $event\r\n     * @param componentId\r\n     */\r\n    showStudentAssets($event, componentId) {\r\n\r\n        // get the scope for the component\r\n        var childScope = this.componentToScope[componentId];\r\n\r\n        // TODO: generalize for other controllers\r\n        var componentController = null;\r\n\r\n        if (childScope.openResponseController) {\r\n            componentController = childScope.openResponseController;\r\n        } else if (childScope.drawController) {\r\n            componentController = childScope.drawController;\r\n        } else if (childScope.discussionController) {\r\n            componentController = childScope.discussionController;\r\n        } else if (childScope.tableController) {\r\n            componentController = childScope.tableController;\r\n        } else if (childScope.graphController) {\r\n            componentController = childScope.graphController;\r\n        }\r\n\r\n        this.$rootScope.$broadcast('showStudentAssets', {componentController: componentController, $event: $event});\r\n    };\r\n\r\n    /**\r\n     * Called when the student clicks the save button\r\n     */\r\n    saveButtonClicked() {\r\n\r\n        // notify the child components that the save button was clicked\r\n        this.$rootScope.$broadcast('nodeSaveClicked', {nodeId: this.nodeId});\r\n\r\n        var isAutoSave = false;\r\n\r\n        /*\r\n         * obtain the component states from the children and save them\r\n         * to the server\r\n         */\r\n        this.createAndSaveComponentData(isAutoSave);\r\n    };\r\n\r\n    /**\r\n     * Called when the student clicks the submit button\r\n     */\r\n    submitButtonClicked() {\r\n\r\n        // notify the child components that the submit button was clicked\r\n        this.$rootScope.$broadcast('nodeSubmitClicked', {nodeId: this.nodeId});\r\n\r\n        var isAutoSave = false;\r\n        var isSubmit = true;\r\n\r\n        /*\r\n         * obtain the component states from the children and save them\r\n         * to the server\r\n         */\r\n        this.createAndSaveComponentData(isAutoSave, null, isSubmit);\r\n    };\r\n\r\n    /**\r\n     * Check if we need to lock the node\r\n     */\r\n    calculateDisabled() {\r\n\r\n        var nodeId = this.nodeId;\r\n\r\n        // get the node content\r\n        var nodeContent = this.nodeContent;\r\n\r\n        if (nodeContent) {\r\n            var lockAfterSubmit = nodeContent.lockAfterSubmit;\r\n\r\n            if (lockAfterSubmit) {\r\n                // we need to lock the step after the student has submitted\r\n\r\n                // get the component states for the node\r\n                var componentStates = this.StudentDataService.getComponentStatesByNodeId(nodeId);\r\n\r\n                // check if any of the component states were submitted\r\n                var isSubmitted = this.NodeService.isWorkSubmitted(componentStates);\r\n\r\n                if (isSubmitted) {\r\n                    // the student has submitted work for this node\r\n                    this.isDisabled = true;\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Get the components for this node.\r\n     * @return an array that contains the content for the components.\r\n     */\r\n    getComponents() {\r\n        var components = null;\r\n\r\n        if (this.nodeContent != null) {\r\n            components = this.nodeContent.components;\r\n        }\r\n\r\n        if (components != null && this.isDisabled) {\r\n            for (var c = 0; c < components.length; c++) {\r\n                var component = components[c];\r\n\r\n                component.isDisabled = true;\r\n            }\r\n        }\r\n\r\n        if (components != null && this.nodeContent.lockAfterSubmit) {\r\n            for (c = 0; c < components.length; c++) {\r\n                component = components[c];\r\n\r\n                component.lockAfterSubmit = true;\r\n            }\r\n        }\r\n\r\n        return components;\r\n    };\r\n\r\n    /**\r\n     * Get the component given the component id\r\n     * @param componentId the component id we want\r\n     * @return the component object with the given component id\r\n     */\r\n    getComponentById(componentId) {\r\n\r\n        var component = null;\r\n\r\n        if (componentId != null) {\r\n\r\n            // get all the components\r\n            var components = this.getComponents();\r\n\r\n            // loop through all the components\r\n            for (var c = 0; c < components.length; c++) {\r\n\r\n                // get a component\r\n                var tempComponent = components[c];\r\n\r\n                if (tempComponent != null) {\r\n                    var tempComponentId = tempComponent.id;\r\n\r\n                    // check if the component id matches the one we want\r\n                    if (tempComponentId === componentId) {\r\n                        // the component id matches\r\n                        component = tempComponent;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return component;\r\n    };\r\n\r\n    /**\r\n     * Check if this node contains a given component id\r\n     * @param componentId the component id\r\n     * @returns whether this node contains the component\r\n     */\r\n    nodeContainsComponent(componentId) {\r\n        var result = false;\r\n\r\n        if (componentId != null) {\r\n\r\n            // get all the components\r\n            var components = this.getComponents();\r\n\r\n            // loop through all the components\r\n            for (var c = 0; c < components.length; c++) {\r\n\r\n                // get a component\r\n                var tempComponent = components[c];\r\n\r\n                if (tempComponent != null) {\r\n                    var tempComponentId = tempComponent.id;\r\n\r\n                    // check if the component id matches the one we want\r\n                    if (tempComponentId === componentId) {\r\n                        // the component id matches\r\n                        result = true;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    /**\r\n     * Get the html template for the component\r\n     * @param componentType the component type\r\n     * @return the path to the html template for the component\r\n     */\r\n    getComponentTemplatePath(componentType) {\r\n        return this.NodeService.getComponentTemplatePath(componentType);\r\n    };\r\n\r\n    /**\r\n     * Check whether we need to show the save button\r\n     * @return whether to show the save button\r\n     */\r\n    showSaveButton() {\r\n        var result = false;\r\n\r\n        if (this.nodeContent != null && this.nodeContent.showSaveButton) {\r\n            result = true;\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    /**\r\n     * Check whether we need to show the submit button\r\n     * @return whether to show the submit button\r\n     */\r\n    showSubmitButton() {\r\n        var result = false;\r\n\r\n        if (this.nodeContent != null && this.nodeContent.showSubmitButton) {\r\n            result = true;\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    /**\r\n     * Check whether we need to lock the component after the student\r\n     * submits an answer.\r\n     */\r\n    isLockAfterSubmit() {\r\n        var result = false;\r\n\r\n        if (this.componentContent != null) {\r\n\r\n            // check the lockAfterSubmit field in the component content\r\n            if (this.componentContent.lockAfterSubmit) {\r\n                result = true;\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    /**\r\n     * Set the message next to the save button\r\n     * @param message the message to display\r\n     * @param time the time to display\r\n     */\r\n    setSaveMessage(message, time) {\r\n        this.saveMessage.text = message;\r\n        this.saveMessage.time = time;\r\n    };\r\n\r\n    /**\r\n     * Start the auto save interval for this node\r\n     */\r\n    startAutoSaveInterval() {\r\n        this.autoSaveIntervalId = setInterval(() => {\r\n            // check if the student work is dirty\r\n            if (this.dirtyComponentIds.length) {\r\n                // the student work is dirty so we will save\r\n\r\n                var isAutoSave = true;\r\n\r\n                /*\r\n                 * obtain the component states from the children and save them\r\n                 * to the server\r\n                 */\r\n                this.createAndSaveComponentData(isAutoSave);\r\n            }\r\n        }, this.autoSaveInterval);\r\n    };\r\n\r\n    /**\r\n     * Stop the auto save interval for this node\r\n     */\r\n    stopAutoSaveInterval() {\r\n        clearInterval(this.autoSaveIntervalId);\r\n    };\r\n\r\n    /**\r\n     * Obtain the componentStates and annotations from the children and save them\r\n     * to the server\r\n     * @param isAutoSave whether the component states were auto saved\r\n     * @param componentId (optional) the component id of the component\r\n     * that triggered the save\r\n     * @param isSubmit (optional) whether this is a sumission or not\r\n     * @returns a promise that will save all the component states for the step\r\n     * that need saving\r\n     */\r\n    createAndSaveComponentData(isAutoSave, componentId, isSubmit) {\r\n\r\n        // obtain the component states from the children\r\n        return this.createComponentStates(isAutoSave, componentId, isSubmit).then((componentStates) => {\r\n            var componentAnnotations = [];\r\n            var componentEvents = null;\r\n            var nodeStates = null;\r\n\r\n            if ((componentStates != null && componentStates.length) ||\r\n                (componentAnnotations != null && componentAnnotations.length) ||\r\n                (componentEvents != null && componentEvents.length)) {\r\n\r\n                // get the annotations from the components\r\n                for (var c = 0; c < componentStates.length; c++) {\r\n                    var componentState = componentStates[c];\r\n\r\n                    if (componentState != null) {\r\n                        var annotations = componentState.annotations;\r\n\r\n                        if (annotations != null) {\r\n                            /*\r\n                             * add the annotations to our array of annotations that will\r\n                             * be saved to the server\r\n                             */\r\n                            componentAnnotations = componentAnnotations.concat(annotations);\r\n                        }\r\n\r\n                        // remove the annotations from the component state\r\n                        delete componentState.annotations;\r\n                    }\r\n                }\r\n\r\n                // save the component states to the server\r\n                return this.StudentDataService.saveToServer(componentStates, nodeStates, componentEvents, componentAnnotations).then((savedStudentDataResponse) => {\r\n                    if (savedStudentDataResponse) {\r\n                        // check if this node has transition logic that should be run when the student data changes\r\n                        if (this.NodeService.hasTransitionLogic() && this.NodeService.evaluateTransitionLogicOn('studentDataChanged')) {\r\n                            // this node has transition logic\r\n                            this.NodeService.evaluateTransitionLogic();\r\n                        }\r\n\r\n                        // check if this node has transition logic that should be run when the student score changes\r\n                        if (this.NodeService.hasTransitionLogic() && this.NodeService.evaluateTransitionLogicOn('scoreChanged')) {\r\n\r\n                            if (componentAnnotations != null && componentAnnotations.length > 0) {\r\n                                var evaluateTransitionLogic = false;\r\n\r\n                                // loop through all the annotations and check if any were score annotations\r\n                                for (var c = 0; c < componentAnnotations.length; c++) {\r\n                                    var componentAnnotation = componentAnnotations[c];\r\n\r\n                                    if (componentAnnotation != null) {\r\n                                        if (componentAnnotation.type === 'autoScore') {\r\n                                            evaluateTransitionLogic = true;\r\n                                        }\r\n                                    }\r\n                                }\r\n\r\n                                if (evaluateTransitionLogic) {\r\n                                    // the student score has changed so we will evaluate the transition logic\r\n                                    this.NodeService.evaluateTransitionLogic();\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                        let studentWorkList = savedStudentDataResponse.studentWorkList;\r\n                        if (!componentId && studentWorkList && studentWorkList.length) {\r\n                            // this was a step save or submission and student work was saved, so set save message\r\n                            let latestStudentWork = studentWorkList[studentWorkList.length - 1];\r\n                            let serverSaveTime = latestStudentWork.serverSaveTime;\r\n                            let clientSaveTime = this.ConfigService.convertToClientTimestamp(serverSaveTime);\r\n\r\n                            if (isAutoSave) {\r\n                                this.setSaveMessage(this.$translate('AUTO_SAVED'), clientSaveTime);\r\n                            } else if (isSubmit) {\r\n                                this.setSaveMessage(this.$translate('SUBMITTED'), clientSaveTime);\r\n                            } else {\r\n                                this.setSaveMessage(this.$translate('SAVED'), clientSaveTime);\r\n                            }\r\n                        } else {\r\n                            this.setSaveMessage('', null);\r\n                        }\r\n                    }\r\n\r\n                    return savedStudentDataResponse;\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Loop through this node's components and get/create component states\r\n     * @param isAutoSave whether the component states were auto saved\r\n     * @param componentId (optional) the component id of the component\r\n     * that triggered the save\r\n     * @param isSubmit (optional) whether this is a submission or not\r\n     * @returns an array of promises that will return component states\r\n     */\r\n    createComponentStates(isAutoSave, componentId, isSubmit) {\r\n        var components = [];\r\n        var componentStatePromises = [];\r\n\r\n        // get the components for this node\r\n        if (componentId) {\r\n            var component = this.getComponentById(componentId);\r\n            if (component) {\r\n                components.push(component);\r\n            }\r\n        } else {\r\n            components = this.getComponents();\r\n        }\r\n\r\n        if (components.length) {\r\n\r\n            var runId = this.ConfigService.getRunId();\r\n            var periodId = this.ConfigService.getPeriodId();\r\n            var workgroupId = this.ConfigService.getWorkgroupId();\r\n            var nodeId = this.nodeId;\r\n\r\n            // loop through all the components\r\n            for (var c = 0; c < components.length; c++) {\r\n\r\n                // get a component\r\n                var component = components[c];\r\n\r\n                if (component != null) {\r\n                    // get the component id\r\n                    var tempComponentId = component.id;\r\n                    var componentType = component.type;\r\n\r\n                    // get the scope for the component\r\n                    var childScope = this.componentToScope[tempComponentId];\r\n\r\n                    if (childScope != null) {\r\n                        if (childScope.getComponentState) {\r\n                            // get the component state promise from the child scope\r\n                            var componentStatePromise = this.getComponentStateFromChildScope(childScope, runId, periodId, workgroupId, nodeId, componentId, tempComponentId, componentType, isAutoSave, isSubmit);\r\n                            componentStatePromises.push(componentStatePromise);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return this.$q.all(componentStatePromises);\r\n    };\r\n\r\n    /**\r\n     * Get the component state from the child scope\r\n     * @param childScope the child scope\r\n     * @param runId the run id\r\n     * @param periodId the period id\r\n     * @param workgroupId the workgroup id\r\n     * @param nodeId the node id\r\n     * @param componentId the component id that has triggered the save\r\n     * @param tempComponentId the component id of the component we are obtaining\r\n     * a component state for\r\n     * @param componentType the component type\r\n     * @param isAutoSave whether this save was triggered by an auto save\r\n     * @param isSubmit whether this save was triggered by a submit\r\n     */\r\n    getComponentStateFromChildScope(childScope, runId, periodId, workgroupId, nodeId, componentId, tempComponentId, componentType, isAutoSave, isSubmit) {\r\n        return childScope.getComponentState(isSubmit).then((componentState) => {\r\n            if (componentState != null) {\r\n\r\n                componentState.runId = runId;\r\n                componentState.periodId = periodId;\r\n                componentState.workgroupId = workgroupId;\r\n                componentState.nodeId = this.nodeId;\r\n\r\n                // set the component id into the student work object\r\n                componentState.componentId = tempComponentId;\r\n\r\n                // set the component type\r\n                componentState.componentType = componentType;\r\n\r\n                if (componentId == null) {\r\n                    /*\r\n                     * the node has triggered the save so all the components will\r\n                     * either have isAutoSave set to true or false; if this is a\r\n                     * submission, all the components will have isSubmit set to true\r\n                     */\r\n                    componentState.isAutoSave = isAutoSave;\r\n\r\n                    if (isSubmit) {\r\n                        /*\r\n                         * set the isSubmit value in the component state if\r\n                         * it wasn't set by the component\r\n                         */\r\n                        if (componentState.isSubmit == null) {\r\n                            componentState.isSubmit = true;\r\n                        }\r\n                    }\r\n                } else {\r\n                    /*\r\n                     * a component has triggered the save so only that component will\r\n                     * have isAutoSave set to false; if this is a submission,\r\n                     * component will have isSubmit set to true\r\n                     */\r\n\r\n                    if (componentId === tempComponentId) {\r\n                        // this component triggered the save\r\n                        componentState.isAutoSave = false;\r\n\r\n                        if (isSubmit) {\r\n                            /*\r\n                             * set the isSubmit value in the component state if\r\n                             * it wasn't set by the component\r\n                             */\r\n                            if (componentState.isSubmit == null) {\r\n                                componentState.isSubmit = true;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n                return componentState\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get the latest annotations for a given component\r\n     * TODO: move to a parent component class in the future?\r\n     * @param componentId the component's id\r\n     * @return object containing the component's latest score and comment annotations\r\n     */\r\n    getLatestComponentAnnotations(componentId) {\r\n        let latestScoreAnnotation = null;\r\n        let latestCommentAnnotation = null;\r\n\r\n        let nodeId = this.nodeId;\r\n        let workgroupId = this.workgroupId;\r\n\r\n        // get the latest score annotation for this component\r\n        latestScoreAnnotation = this.AnnotationService.getLatestScoreAnnotation(nodeId, componentId, workgroupId, 'any');\r\n\r\n        // get the latest comment annotation for this component\r\n        latestCommentAnnotation = this.AnnotationService.getLatestCommentAnnotation(nodeId, componentId, workgroupId, 'any');\r\n\r\n        return {\r\n            'score': latestScoreAnnotation,\r\n            'comment': latestCommentAnnotation\r\n        };\r\n    };\r\n\r\n    /**\r\n     * Notify any connected components that the student data has changed\r\n     * @param componentId the component id that has changed\r\n     * @param componentState the new component state\r\n     */\r\n    notifyConnectedParts(changedComponentId, componentState) {\r\n\r\n        if (changedComponentId != null && componentState != null) {\r\n\r\n            // get all the components\r\n            var components = this.getComponents();\r\n\r\n            if (components != null) {\r\n\r\n                /*\r\n                 * loop through all the components and look for components\r\n                 * that are listening for the given component id to change.\r\n                 * only notify components that are listening for changes\r\n                 * from the specific component id.\r\n                 */\r\n                for (var c = 0; c < components.length; c++) {\r\n\r\n                    // get a component\r\n                    var tempComponent = components[c];\r\n\r\n                    if (tempComponent != null) {\r\n\r\n                        // get this component id\r\n                        var tempComponentId = tempComponent.id;\r\n\r\n                        /*\r\n                         * get the connected components that this component is\r\n                         * listening for\r\n                         */\r\n                        var connectedComponents = tempComponent.connectedComponents;\r\n\r\n                        if (connectedComponents != null) {\r\n\r\n                            // loop through all the connected components\r\n                            for (var cc = 0; cc < connectedComponents.length; cc++) {\r\n\r\n                                // get a connected component\r\n                                var connectedComponentParams = connectedComponents[cc];\r\n\r\n                                if (connectedComponentParams != null) {\r\n\r\n                                    // get the node id\r\n                                    var nodeId = connectedComponentParams.nodeId;\r\n\r\n                                    // get the component id\r\n                                    var componentId = connectedComponentParams.componentId;\r\n\r\n                                    /*\r\n                                     * get the id which is the old field that we used to store\r\n                                     * the component id in. this is here to maintain backwards\r\n                                     * compatibility.\r\n                                     */\r\n                                    var id = connectedComponentParams.id;\r\n\r\n                                    if (nodeId != null && componentId != null) {\r\n                                        // the node id and component id was provided\r\n                                        var connectedComponentId = componentId;\r\n                                        var connectedNodeId = nodeId;\r\n\r\n                                        // check if the component id matches the one that has changed\r\n                                        if (connectedNodeId == this.nodeId && connectedComponentId === changedComponentId) {\r\n\r\n                                            var connectedComponent = this.getComponentById(connectedComponentId);\r\n\r\n                                            // get the scope for the listening component\r\n                                            var componentScope = this.componentToScope[tempComponentId];\r\n\r\n                                            // check if the listening component has a handler function\r\n                                            if (componentScope.handleConnectedComponentStudentDataChanged != null) {\r\n\r\n                                                // tell the listening part to handle the student data changing\r\n                                                componentScope.handleConnectedComponentStudentDataChanged(connectedComponent, connectedComponentParams, componentState);\r\n                                            }\r\n                                        }\r\n                                    } else if (componentId != null) {\r\n                                        /*\r\n                                         * the node id was not provided but the component id was provided\r\n                                         * so we will assume the component id is in the current node\r\n                                         */\r\n                                        var connectedComponentId = componentId;\r\n\r\n                                        // check if the component id matches the one that has changed\r\n                                        if (connectedComponentId === changedComponentId) {\r\n\r\n                                            var connectedComponent = this.getComponentById(connectedComponentId);\r\n\r\n                                            // get the scope for the listening component\r\n                                            var componentScope = this.componentToScope[tempComponentId];\r\n\r\n                                            // check if the listening component has a handler function\r\n                                            if (componentScope.handleConnectedComponentStudentDataChanged != null) {\r\n\r\n                                                // tell the listening part to handle the student data changing\r\n                                                componentScope.handleConnectedComponentStudentDataChanged(connectedComponent, connectedComponentParams, componentState);\r\n                                            }\r\n                                        }\r\n                                    } else if (id != null) {\r\n                                        /*\r\n                                         * the node id and component id were not provided but the\r\n                                         * id was provided which is the old field we used to set\r\n                                         * the component id in. this is here to maintain backwards\r\n                                         * compatibility.\r\n                                         */\r\n                                        var connectedComponentId = id;\r\n\r\n                                        // check if the component id matches the one that has changed\r\n                                        if (connectedComponentId === changedComponentId) {\r\n\r\n                                            var connectedComponent = this.getComponentById(connectedComponentId);\r\n\r\n                                            // get the scope for the listening component\r\n                                            var componentScope = this.componentToScope[tempComponentId];\r\n\r\n                                            // check if the listening component has a handler function\r\n                                            if (componentScope.handleConnectedComponentStudentDataChanged != null) {\r\n\r\n                                                // tell the listening part to handle the student data changing\r\n                                                componentScope.handleConnectedComponentStudentDataChanged(connectedComponent, connectedComponentParams, componentState);\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Get the student data for a specific part\r\n     * @param the componentId\r\n     * @return the student data for the given component\r\n     */\r\n    getComponentStateByComponentId(componentId) {\r\n        var componentState = null;\r\n\r\n        if (componentId != null) {\r\n\r\n            // get the latest component state for the component\r\n            componentState = this.StudentDataService.getLatestComponentStateByNodeIdAndComponentId(this.nodeId, componentId);\r\n        }\r\n\r\n        return componentState;\r\n    };\r\n\r\n    /**\r\n     * Get the student data for a specific part\r\n     * @param the nodeId\r\n     * @param the componentId\r\n     * @return the student data for the given component\r\n     */\r\n    getComponentStateByNodeIdAndComponentId(nodeId, componentId) {\r\n        var componentState = null;\r\n\r\n        if (nodeId != null && componentId != null) {\r\n\r\n            // get the latest component state for the component\r\n            componentState = this.StudentDataService.getLatestComponentStateByNodeIdAndComponentId(nodeId, componentId);\r\n        }\r\n\r\n        return componentState;\r\n    };\r\n\r\n    nodeUnloaded(nodeId) {\r\n        hopscotch.endTour(this.rubricTour);\r\n\r\n        var isAutoSave = true;\r\n\r\n        this.createAndSaveComponentData(isAutoSave);\r\n\r\n        // save nodeExited event\r\n        var componentId = null;\r\n        var componentType = null;\r\n        var category = \"Navigation\";\r\n        var event = \"nodeExited\";\r\n        var eventData = {};\r\n        eventData.nodeId = nodeId;\r\n        this.StudentDataService.saveVLEEvent(nodeId, componentId, componentType, category, event, eventData);\r\n    };\r\n\r\n    /**\r\n     * Checks whether any of the node's components have unsubmitted work\r\n     * @return boolean whether or not there is unsubmitted work\r\n     */\r\n    getSubmitDirty() {\r\n        let submitDirty = false;\r\n        let components = this.getComponents();\r\n\r\n        if (components != null) {\r\n            for (let c = 0, l = components.length; c < l; c++) {\r\n                let id = components[c].id;\r\n                let latestState = this.getComponentStateByComponentId(id);\r\n\r\n                if (latestState && !latestState.isSubmit) {\r\n                    submitDirty = true;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n\r\n        return submitDirty;\r\n    };\r\n\r\n    /**\r\n     * Register the the listener that will listen for the exit event\r\n     * so that we can perform saving before exiting.\r\n     */\r\n    registerExitListener() {\r\n        /**\r\n         * Listen for the 'exit' event which is fired when the student exits\r\n         * the VLE. This will perform saving before exiting.\r\n         */\r\n        this.logOutListener = this.$scope.$on('exit', (event, args) => {\r\n\r\n            // stop the auto save interval for this node\r\n            this.stopAutoSaveInterval();\r\n\r\n            /*\r\n             * tell the parent that this node is done performing\r\n             * everything it needs to do before exiting\r\n             */\r\n            this.nodeUnloaded(this.nodeId);\r\n\r\n            // call this function to remove the listener\r\n            this.logOutListener();\r\n\r\n            /*\r\n             * tell the session service that this listener is done\r\n             * performing everything it needs to do before exiting\r\n             */\r\n            this.$rootScope.$broadcast('doneExiting');\r\n        });\r\n    };\r\n}\r\n\r\nNodeController.$inject = [\r\n    '$compile',\r\n    '$filter',\r\n    '$q',\r\n    '$rootScope',\r\n    '$scope',\r\n    '$state',\r\n    '$timeout',\r\n    'AnnotationService',\r\n    'ConfigService',\r\n    'NodeService',\r\n    'NotebookService',\r\n    'ProjectService',\r\n    'StudentDataService'\r\n];\r\n\r\nexport default NodeController;\r\n"]}