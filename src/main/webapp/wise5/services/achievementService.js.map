{"version":3,"sources":["achievementService.es6"],"names":["AchievementService","$http","$q","$rootScope","ConfigService","ProjectService","StudentDataService","UtilService","achievementsByWorkgroupId","debug","loadAchievements","str","console","log","workgroupId","type","isPreview","getWorkgroupId","Promise","resolve","achievementsURL","getAchievementsURL","config","method","url","params","getMode","periodId","getPeriodId","then","response","achievements","data","i","length","achievement","addOrUpdateAchievement","projectAchievement","getAchievementByAchievementId","achievementId","completed","deregisterFunction","debugOutput","id","achievementWorkgroupId","Array","found","w","a","push","deferred","defer","promise","headers","angular","toJson","$","param","result","fromJson","projectAchievements","getAchievements","isEnabled","projectAchievementItems","items","createNodeCompletedListener","createAggregateAchievementListener","getAchievementsByWorkgroupId","isVisible","alert","name","makeCopyOfJSONObject","newAchievement","createNewAchievement","saveAchievementToServer","$broadcast","thisAchievementService","thisAchievement","$on","event","args","nodeId","isAchievementCompleted","nodeIds","n","isCompleted","studentCompletedAchievement","achievementIds","tempAchievementId","$inject"],"mappings":"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","file":"achievementService.js","sourcesContent":["class AchievementService {\n    constructor($http, $q, $rootScope, ConfigService, ProjectService, StudentDataService, UtilService) {\n\n        this.$http = $http;\n        this.$q = $q;\n        this.$rootScope = $rootScope;\n        this.ConfigService = ConfigService;\n        this.ProjectService = ProjectService;\n        this.StudentDataService = StudentDataService;\n        this.UtilService = UtilService;\n        this.achievementsByWorkgroupId = {};  // an object of achievements, where key is workgroupId and value is the array of achievements for the workgroup.\n\n        // whether to print debug output to the console\n        this.debug = false;\n\n        // load the achievements in the project\n        this.loadAchievements();\n    }\n\n    /**\n     * Output the string to the console if debug=true\n     * @param str the string to output to the console\n     */\n    debugOutput(str) {\n        if (this.debug) {\n            console.log(str);\n        }\n    }\n\n    /**\n     * Retrieves achievements from the server\n     */\n    retrieveAchievements(workgroupId = null, type = null) {\n\n        if (this.ConfigService.isPreview()) {\n\n            // get the signed in workgroup id\n            var workgroupId = this.ConfigService.getWorkgroupId();\n\n            // initialize the achievements for the workgroup to an empty array\n            this.achievementsByWorkgroupId[workgroupId] = [];\n\n            return Promise.resolve(this.achievementsByWorkgroupId);\n        } else {\n            let achievementsURL = this.ConfigService.getAchievementsURL();\n\n            let config = {\n                method: \"GET\",\n                url: achievementsURL,\n                params: {}\n            };\n            if (workgroupId != null) {\n                config.params.workgroupId = workgroupId;\n            } else if (this.ConfigService.getMode() !== 'classroomMonitor') {\n                // get the achievements for the logged-in workgroup\n                config.params.workgroupId = this.ConfigService.getWorkgroupId();\n                config.params.periodId = this.ConfigService.getPeriodId();\n            }\n            if (type != null) {\n                config.params.type = type;\n            }\n\n            return this.$http(config).then((response) => {\n                let achievements = response.data;\n\n                if (achievements != null) {\n                    for (let i = 0; i < achievements.length; i++) {\n                        let achievement = achievements[i];\n\n                        // add the student achievement to our local data structure\n                        this.addOrUpdateAchievement(achievement);\n\n                        // get the project achievement object\n                        var projectAchievement = this.ProjectService.getAchievementByAchievementId(achievement.achievementId);\n\n                        if (projectAchievement != null) {\n\n                            /*\n                             * set the completed field to true in case we ever\n                             * need to easily see which achievements the student\n                             * has completed\n                             */\n                            projectAchievement.completed = true;\n\n                            if (projectAchievement.deregisterFunction != null) {\n                                /*\n                                 * the student has completed this achievement\n                                 * so we no longer need to listen for it\n                                 */\n                                projectAchievement.deregisterFunction();\n                                this.debugOutput('deregistering ' + projectAchievement.id);\n                            }\n                        }\n                    }\n                } else {\n                    this.achievementsByWorkgroupId = {};\n                }\n\n                return this.achievementsByWorkgroupId;\n            });\n        }\n    }\n\n    /**\n     * Add Achievement to local bookkeeping\n     * @param achievement the Achievement to add or update\n     */\n    addOrUpdateAchievement(achievement) {\n\n        if (achievement != null) {\n\n            // get the workgroup id\n            let achievementWorkgroupId = achievement.workgroupId;\n\n            /*\n             * initialize the workgroup's array of achievements if it does\n             * not exist yet\n             */\n            if (this.achievementsByWorkgroupId[achievementWorkgroupId] == null) {\n                this.achievementsByWorkgroupId[achievementWorkgroupId] = new Array();\n            }\n\n            // get the achievements the workgroup has completed\n            let achievements = this.achievementsByWorkgroupId[achievementWorkgroupId];\n\n            let found = false;\n\n            // loop through all the achievements this workgroup has completed\n            for (let w = 0; w < achievements.length; w++) {\n\n                // get an achievement the workgroup has compeleted\n                let a = achievements[w];\n\n                if (a.achievementId != null && a.achievementId === achievement.achievementId &&\n                            a.workgroupId != null && a.workgroupId === achievement.workgroupId) {\n                    /*\n                     * the achievement 10 character alphanumeric id matches and\n                     * the workgroup id matches so we will update it\n                     */\n                    achievements[w] = achievement;\n                    found = true;  // remember this so we don't insert later.\n                    break;\n                }\n            }\n\n            if (!found) {\n                // we did not find the achievement so we will add it to the array\n                achievements.push(achievement);\n            }\n        }\n    }\n\n    /**\n     * Saves the achievement for the logged-in user\n     * @param achievement\n     */\n    saveAchievementToServer(achievement) {\n\n        if (this.ConfigService.isPreview()) {\n            // if we're in preview, don't make any request to the server but pretend that we did\n            let deferred = this.$q.defer();\n            deferred.resolve(achievement);\n            return deferred.promise;\n\n        } else {\n\n            let config = {\n                method: \"POST\",\n                url: this.ConfigService.getAchievementsURL(),\n                headers: {\n                    'Content-Type': 'application/x-www-form-urlencoded'\n                }\n            };\n\n            let params = {\n                achievementId: achievement.achievementId,\n                workgroupId: achievement.workgroupId,\n                type: achievement.type\n            };\n            if (achievement.id != null) {\n                params.id = achievement.id;\n            }\n            if (achievement.data != null) {\n                params.data = angular.toJson(achievement.data);\n            }\n\n            config.data = $.param(params);\n\n            return this.$http(config).then((result) => {\n                let achievement = result.data;\n                if (achievement.data != null) {\n                    // parse the data string into a JSON object\n                    achievement.data = angular.fromJson(achievement.data);\n                }\n                this.addOrUpdateAchievement(achievement);\n                return achievement;\n            })\n        }\n    }\n\n    /**\n     * Creates a new achievement object\n     * @param type type of achievement [\"completion\", \"milestone\", etc]\n     * @param achievementId id of achievement in project content\n     * @param data other extra information about this achievement\n     * @param workgroupId id of workgroup whom this achievement is for\n     * @returns newly created achievement object\n     */\n    createNewAchievement(type, achievementId, data = null, workgroupId = null) {\n        if (workgroupId == null) {\n            workgroupId = this.ConfigService.getWorkgroupId();\n        }\n        return {\n            id: null,\n            type: type,\n            achievementId: achievementId,\n            workgroupId: workgroupId,\n            data: data\n        };\n    }\n\n    /**\n     * Load the achievements by creating listeners for the appropriate events\n     */\n    loadAchievements() {\n\n        var projectAchievements = this.ProjectService.getAchievements();\n\n        if (projectAchievements != null) {\n            if (projectAchievements.isEnabled) {\n\n                // get all the achievements in the project\n                var projectAchievementItems = projectAchievements.items;\n\n                if (projectAchievementItems != null) {\n\n                    // loop through all the achievements in the project\n                    for (var a = 0; a < projectAchievementItems.length; a++) {\n\n                        var projectAchievement = projectAchievementItems[a];\n\n                        if (projectAchievement != null) {\n\n                            var deregisterFunction = null;\n\n                            // create a listener for the achievement\n                            if (projectAchievement.type == 'milestone' || projectAchievement.type == 'completion') {\n                                deregisterFunction = this.createNodeCompletedListener(projectAchievement);\n                            } else if (projectAchievement.type == 'aggregate') {\n                                deregisterFunction = this.createAggregateAchievementListener(projectAchievement);\n                            }\n\n                            /*\n                             * set the deregisterFunction into the project\n                             * achievement so that we can deregister the\n                             * listener after the student has completed the\n                             * achievement\n                             */\n                            projectAchievement.deregisterFunction = deregisterFunction;\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    /**\n     * Check if the student has completed the achievement\n     * @param achievementId\n     * @return whether the student has completed the achievement\n     */\n    isAchievementCompleted(achievementId) {\n\n        if (achievementId != null) {\n\n            // get the student workgroup id\n            var workgroupId = this.ConfigService.getWorkgroupId();\n\n            // get all the achievements the student has completed\n            var achievements = this.getAchievementsByWorkgroupId(workgroupId);\n\n            if (achievements != null) {\n\n                // loop through all the achievements the student has completed\n                for (var a = 0; a < achievements.length; a++) {\n                    var achievement = achievements[a];\n\n                    if (achievement != null) {\n                        if (achievement.achievementId == achievementId) {\n                            /*\n                             * we have found the achievement with the matching\n                             * achievement id which means the student has\n                             * completed the achievement\n                             */\n                            return true;\n                        }\n                    }\n                }\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * The student has just completed an achievement\n     * @param achievement the achievement the student completed\n     */\n    studentCompletedAchievement(achievement) {\n\n        if (achievement != null) {\n\n            if (achievement.isVisible == true) {\n                /*\n                 * this is a visible achievement so we will display a message\n                 * to the student\n                 */\n                alert(\"Congratulations you completed: \" + achievement.name);\n                console.log(\"Congratulations you completed: \" + achievement.name);\n            }\n\n            // get the project achievement object\n            var projectAchievement = this.ProjectService.getAchievementByAchievementId(achievement.id);\n\n            if (projectAchievement != null && projectAchievement.deregisterFunction != null) {\n                /*\n                 * deregister the achievement listener now that the student has\n                 * completed the achievement\n                 */\n                projectAchievement.deregisterFunction();\n                this.debugOutput('deregistering ' + projectAchievement.id);\n            }\n\n            /*\n             * create a copy of the achievement to make sure we don't cause\n             * any referencing problems in the future\n             */\n            var achievement = this.UtilService.makeCopyOfJSONObject(achievement);\n\n            // get the student workgroup id\n            var workgroupId = this.ConfigService.getWorkgroupId();\n\n            // get the parameters for creating an achievement\n            var type = achievement.type;\n            var id = achievement.id;\n            var data = achievement;\n\n            // create the student achievement\n            var newAchievement = this.createNewAchievement(type, id, data, workgroupId);\n\n            // get all the achievements the student has completed\n            var achievements = this.getAchievementsByWorkgroupId(workgroupId);\n\n            // add the achievement to the array of student completed achievements\n            achievements.push(newAchievement);\n\n            // save the new achievement to the server\n            this.saveAchievementToServer(newAchievement);\n\n            // fire an achievementCompleted event\n            this.$rootScope.$broadcast('achievementCompleted', { achievementId: achievement.id });\n        }\n    }\n\n    /**\n     * Create a listener for the node completed achievement\n     * @param achievement the achievement to listen for\n     * @return the deregister function for the listener\n     */\n    createNodeCompletedListener(achievement) {\n\n        // save this to a variable so that we can access it in the callback\n        var thisAchievementService = this;\n\n        // save the achievement to a variable so that we can access it in the callback\n        var thisAchievement = achievement;\n\n        this.debugOutput('registering ' + achievement.id);\n\n        // listen for the nodeCompleted event\n        var deregisterFunction = this.$rootScope.$on('nodeCompleted', (event, args) => {\n            /*\n             * the nodeCompleted event was fired so we will check if this\n             * achievement has been completed\n             */\n\n            var achievement = thisAchievement;\n\n            if (achievement != null) {\n                this.debugOutput('createNodeCompletedListener checking ' + achievement.id + ' completed ' + args.nodeId);\n\n                // get the id of the achievement we need to check\n                var id = achievement.id;\n\n                if (!this.isAchievementCompleted(id)) {\n                    /*\n                     * the student has not completed this achievement yet\n                     * so we will now check if they have completed it\n                     */\n                    var params = achievement.params;\n\n                    if (params != null) {\n\n                        // get the node ids that need to be completed\n                        var nodeIds = params.nodeIds;\n\n                        var completed = false;\n\n                        /*\n                         * loop through all the node ids that need to be completed\n                         * for the achievement\n                         */\n                        for (var n = 0; n < nodeIds.length; n++) {\n                            var nodeId = nodeIds[n];\n\n                            if (n == 0) {\n                                // this is the first node id\n                                completed = this.StudentDataService.isCompleted(nodeId);\n                            } else {\n                                /*\n                                 * this is a node id after the first node id so\n                                 * we will use an and conditional\n                                 */\n                                completed = completed && this.StudentDataService.isCompleted(nodeId);\n                            }\n                        }\n\n                        if (completed) {\n                            // the student has just completed the achievement\n                            thisAchievementService.studentCompletedAchievement(achievement);\n                        }\n                    }\n                }\n            }\n        });\n\n        return deregisterFunction;\n    }\n\n    /**\n     * Create a listener for an aggregate achievement\n     * @param achievement the project achievement\n     * @return the deregister function for the listener\n     */\n    createAggregateAchievementListener(achievement) {\n\n        var thisAchievementService = this;\n        var thisAchievement = achievement;\n\n        this.debugOutput('registering ' + achievement.id);\n\n        // listen for the achievementCompleted event\n        var deregisterFunction = this.$rootScope.$on('achievementCompleted', (event, args) => {\n            /*\n             * the achievementCompleted event was fired so we will check if this\n             * achievement has been completed\n             */\n\n            var achievement = thisAchievement;\n\n            if (achievement != null) {\n                this.debugOutput('createAggregateAchievementListener checking ' + achievement.id + ' completed ' + args.achievementId);\n\n                // get the id of the achievement we need to check\n                var id = achievement.id;\n\n                // the achievement that was just completed\n                var achievementId = args.achievementId;\n\n                if (!this.isAchievementCompleted(id)) {\n                    /*\n                     * the student has not completed this achievement yet\n                     * so we will now check if they have completed it\n                     */\n\n                    var params = achievement.params;\n\n                    if (params != null) {\n\n                        // get the achievement ids that need to be completed\n                        var achievementIds = params.achievementIds;\n\n                        var completed = false;\n\n                        /*\n                         * loop through all the achievement ids that need to be\n                         * compeleted\n                         */\n                        for (var a = 0; a < achievementIds.length; a++) {\n                            var tempAchievementId = achievementIds[a];\n\n                            if (a == 0) {\n                                // this is the first node id\n                                completed = thisAchievementService.isAchievementCompleted(tempAchievementId);\n                            } else {\n                                /*\n                                 * this is a node id after the first node id so\n                                 * we will use an and conditional\n                                 */\n                                completed = completed && thisAchievementService.isAchievementCompleted(tempAchievementId);\n                            }\n                        }\n\n                        if (completed) {\n                            // the student has just completed the achievement\n                            thisAchievementService.studentCompletedAchievement(achievement);\n                        }\n                    }\n                }\n            }\n        });\n\n        return deregisterFunction;\n    }\n\n    /**\n     * Get achievements for a workgroup id\n     * @param workgroupId the workgroup id\n     * @return an array of achievements completed by the workgroup\n     */\n    getAchievementsByWorkgroupId(workgroupId = null) {\n\n        var achievements = [];\n\n        if (workgroupId == null) {\n            // get the signed in workgroup id\n            workgroupId = this.ConfigService.getWorkgroupId();\n        }\n\n        if (this.achievementsByWorkgroupId[workgroupId] == null) {\n            /*\n             * this workgroup does not have an array of achievements yet so we\n             * will make it\n             */\n            this.achievementsByWorkgroupId[workgroupId] = [];\n            achievements = this.achievementsByWorkgroupId[workgroupId];\n        } else if (this.achievementsByWorkgroupId[workgroupId] != null) {\n            // this workgroup has an array of achievements\n            achievements = this.achievementsByWorkgroupId[workgroupId];\n        }\n\n        return achievements;\n    }\n}\n\nAchievementService.$inject = [\n    '$http',\n    '$q',\n    '$rootScope',\n    'ConfigService',\n    'ProjectService',\n    'StudentDataService',\n    'UtilService'\n];\n\nexport default AchievementService;\n"]}