{"version":3,"sources":["annotationService.es6"],"names":["AnnotationService","$filter","$http","$q","$rootScope","ConfigService","ProjectService","UtilService","$translate","annotations","dummyAnnotationId","annotationId","annotation","id","params","nodeId","componentId","fromWorkgroupId","toWorkgroupId","type","a","length","tempAnnotation","match","constructor","Array","thisType","runId","periodId","studentWorkId","localNotebookItemId","notebookItemId","annotationType","data","clientSaveTime","push","requestToken","generateKey","addOrUpdateAnnotation","isPreview","savedAnnotationDataResponse","saveToServerSuccess","deferred","defer","resolve","promise","getRunId","workgroupId","getWorkgroupId","angular","toJson","httpParams","method","url","getConfigParam","headers","$","param","then","bind","result","localAnnotation","savedAnnotations","localAnnotations","savedAnnotation","y","serverSaveTime","$broadcast","updated","totalScore","scoresFound","isActive","scoreFound","indexOf","value","isNaN","score","tempNodeId","Date","parse","createAnnotation","scoreType","commentType","latestScoreAnnotation","getLatestScoreAnnotation","latestCommentAnnotation","getLatestCommentAnnotation","getLatestNotebookItemScoreAnnotation","getLatestNotebookItemCommentAnnotation","getAnnotations","acceptAnnotation","tempComponentId","tempToWorkgroupId","tempAnnotationType","scoreAnnotation","allGlobalAnnotations","getAllGlobalAnnotations","globalAnnotationsByNodeIdAndComponentId","filter","globalAnnotation","globalAnnotations","isGlobal","globalAnnotationGroups","annotationGroupName","annotationGroupCreatedTime","sameGroupFound","globalAnnotationGroup","annotationGroupNameAndTime","annotationGroup","console","error","activeGlobalAnnotationGroups","unGlobalizedTimestamp","activeGlobalAnnotationGroup","his","inActiveGlobalAnnotations","getLatestAnnotationByStudentWorkIdAndType","$inject"],"mappings":"AAAA;;;;;;;;;;IAEMA,iB;AACJ,6BACIC,OADJ,EAEIC,KAFJ,EAGIC,EAHJ,EAIIC,UAJJ,EAKIC,aALJ,EAMIC,cANJ,EAOIC,WAPJ,EAOiB;AAAA;;AACf,SAAKN,OAAL,GAAeA,OAAf;AACA,SAAKC,KAAL,GAAaA,KAAb;AACA,SAAKC,EAAL,GAAUA,EAAV;AACA,SAAKC,UAAL,GAAkBA,UAAlB;AACA,SAAKC,aAAL,GAAqBA,aAArB;AACA,SAAKC,cAAL,GAAsBA,cAAtB;AACA,SAAKC,WAAL,GAAmBA,WAAnB;AACA,SAAKC,UAAL,GAAkB,KAAKP,OAAL,CAAa,WAAb,CAAlB;AACA,SAAKQ,WAAL,GAAmB,IAAnB;;AAEA;;;;AAIA,SAAKC,iBAAL,GAAyB,CAAzB;AACD;;AAED;;;;;;;qCAGiB;AACf,aAAO,KAAKD,WAAZ;AACD;;AAED;;;;;;;sCAIkBE,Y,EAAc;AAAA;AAAA;AAAA;;AAAA;AAC9B,6BAAuB,KAAKF,WAA5B,8HAAyC;AAAA,cAAhCG,UAAgC;;AACvC,cAAIA,WAAWC,EAAX,KAAkBF,YAAtB,EAAoC;AAClC,mBAAOC,UAAP;AACD;AACF;AAL6B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAM9B,aAAO,IAAP;AACD;;AAED;;;;;;;;wCAKoBE,M,EAAQ;AAC1B,UAAIF,aAAa,IAAjB;;AAEA,UAAIE,UAAU,IAAd,EAAoB;AAClB,YAAIC,SAASD,OAAOC,MAApB;AACA,YAAIC,cAAcF,OAAOE,WAAzB;AACA,YAAIC,kBAAkBH,OAAOG,eAA7B;AACA,YAAIC,gBAAgBJ,OAAOI,aAA3B;AACA,YAAIC,OAAOL,OAAOK,IAAlB;;AAEA,YAAIV,cAAc,KAAKA,WAAvB;;AAEA,YAAIA,eAAe,IAAnB,EAAyB;AACvB,eAAK,IAAIW,IAAIX,YAAYY,MAAZ,GAAqB,CAAlC,EAAqCD,KAAK,CAA1C,EAA6CA,GAA7C,EAAkD;AAChD,gBAAIE,iBAAiBb,YAAYW,CAAZ,CAArB;;AAEA,gBAAIE,kBAAkB,IAAtB,EAA4B;AAC1B,kBAAIC,QAAQ,IAAZ;;AAEA,kBAAIR,UAAUO,eAAeP,MAAf,KAA0BA,MAAxC,EAAgD;AAC9CQ,wBAAQ,KAAR;AACD;AACD,kBAAIA,SAASP,WAAT,IAAwBM,eAAeN,WAAf,KAA+BA,WAA3D,EAAwE;AACtEO,wBAAQ,KAAR;AACD;AACD,kBAAIA,SAASN,eAAT,IAA4BK,eAAeL,eAAf,KAAmCA,eAAnE,EAAoF;AAClFM,wBAAQ,KAAR;AACD;AACD,kBAAIA,SAASL,aAAT,IAA0BI,eAAeJ,aAAf,KAAiCA,aAA/D,EAA8E;AAC5EK,wBAAQ,KAAR;AACD;AACD,kBAAIA,SAASJ,IAAb,EAAmB;AACjB,oBAAIA,KAAKK,WAAL,KAAqBC,KAAzB,EAAgC;AAAA;AAAA;AAAA;;AAAA;AAC9B,0CAAqBN,IAArB,mIAA2B;AAAA,0BAAlBO,QAAkB;;AACzB,0BAAIJ,eAAeH,IAAf,KAAwBO,QAA5B,EAAsC;AACpCH,gCAAQ,KAAR;AACD;AACF;AAL6B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAM/B,iBAND,MAMO;AACL,sBAAID,eAAeH,IAAf,KAAwBA,IAA5B,EAAkC;AAChCI,4BAAQ,KAAR;AACD;AACF;AACF;;AAED,kBAAIA,KAAJ,EAAW;AACTX,6BAAaU,cAAb;AACA;AACD;AACF;AACF;AACF;AACF;AACD,aAAOV,UAAP;AACD;;;;;AAED;;;;;;;;;;;;;;;qCAeiBD,Y,EAAcgB,K,EAAOC,Q,EAAUX,e,EAC5CC,a,EAAeH,M,EAAQC,W,EAAaa,a,EAAeC,mB,EACnDC,c,EAAgBC,c,EAAgBC,I,EAAMC,c,EAAgB;AACxD,UAAMtB,aAAa,EAAnB;AACAA,iBAAWC,EAAX,GAAgBF,YAAhB;AACAC,iBAAWe,KAAX,GAAmBA,KAAnB;AACAf,iBAAWgB,QAAX,GAAsBA,QAAtB;AACAhB,iBAAWK,eAAX,GAA6BA,eAA7B;AACAL,iBAAWM,aAAX,GAA2BA,aAA3B;AACAN,iBAAWG,MAAX,GAAoBA,MAApB;AACAH,iBAAWI,WAAX,GAAyBA,WAAzB;AACAJ,iBAAWiB,aAAX,GAA2BA,aAA3B;AACAjB,iBAAWkB,mBAAX,GAAiCA,mBAAjC;AACAlB,iBAAWmB,cAAX,GAA4BA,cAA5B;AACAnB,iBAAWO,IAAX,GAAkBa,cAAlB;AACApB,iBAAWqB,IAAX,GAAkBA,IAAlB;AACArB,iBAAWsB,cAAX,GAA4BA,cAA5B;AACA,aAAOtB,UAAP;AACD;;;;;AAED;;;;;mCAKeA,U,EAAY;AACzB,UAAIA,cAAc,IAAlB,EAAwB;AACtB,YAAIH,cAAc,EAAlB;AACAA,oBAAY0B,IAAZ,CAAiBvB,UAAjB;AACA,YAAIH,eAAe,IAAf,IAAuBA,YAAYY,MAAZ,GAAqB,CAAhD,EAAmD;AAAA;AAAA;AAAA;;AAAA;AACjD,kCAAuBZ,WAAvB,mIAAoC;AAAA,kBAA3BG,WAA2B;;AAClC,kBAAIA,eAAc,IAAlB,EAAwB;AACtBA,4BAAWwB,YAAX,GAA0B,KAAK7B,WAAL,CAAiB8B,WAAjB,EAA1B,CADsB,CACoC;AAC1D,qBAAKC,qBAAL,CAA2B1B,WAA3B;AACD;AACF;AANgD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAOlD,SAPD,MAOO;AACLH,wBAAc,EAAd;AACD;;AAED,YAAI,KAAKJ,aAAL,CAAmBkC,SAAnB,EAAJ,EAAoC;AAClC;AACA,cAAIC,8BAA8B;AAChC/B,yBAAaA;AADmB,WAAlC;AAGA,cAAIG,eAAa,KAAK6B,mBAAL,CAAyBD,2BAAzB,CAAjB;;AAEA,cAAIE,WAAW,KAAKvC,EAAL,CAAQwC,KAAR,EAAf;AACAD,mBAASE,OAAT,CAAiBhC,YAAjB;AACA,iBAAO8B,SAASG,OAAhB;AACD,SAVD,MAUO;AACL,cAAI/B,SAAS;AACXa,mBAAO,KAAKtB,aAAL,CAAmByC,QAAnB,EADI;AAEXC,yBAAa,KAAK1C,aAAL,CAAmB2C,cAAnB,EAFF;AAGXvC,yBAAawC,QAAQC,MAAR,CAAezC,WAAf;AAHF,WAAb;;AAMA,cAAI0C,aAAa;AACfC,oBAAQ,MADO;AAEfC,iBAAK,KAAKhD,aAAL,CAAmBiD,cAAnB,CAAkC,gBAAlC,CAFU;AAGfC,qBAAS,EAAC,gBAAgB,mCAAjB,EAHM;AAIftB,kBAAMuB,EAAEC,KAAF,CAAQ3C,MAAR;AAJS,WAAjB;;AAOA,iBAAO,KAAKZ,KAAL,CAAWiD,UAAX,EAAuBO,IAAvB,CAA4BT,QAAQU,IAAR,CAAa,IAAb,EAAmB,UAASC,MAAT,EAAiB;;AAErE,gBAAIC,kBAAkB,IAAtB;;AAEA,gBAAID,UAAU,IAAV,IAAkBA,OAAO3B,IAAP,IAAe,IAArC,EAA2C;AACzC,kBAAIO,+BAA8BoB,OAAO3B,IAAzC;AACA4B,gCAAkB,KAAKpB,mBAAL,CAAyBD,4BAAzB,CAAlB;AACD;;AAED,mBAAOqB,eAAP;AACD,WAVkC,CAA5B,CAAP;AAWD;AACF;AACF;;;wCAEmBrB,2B,EAA6B;AAC/C,UAAIqB,kBAAkB,IAAtB;AACA,UAAIrB,+BAA+B,IAAnC,EAAyC;AACvC,YAAIsB,mBAAmBtB,4BAA4B/B,WAAnD;AACA,YAAIsD,mBAAmB,KAAKtD,WAA5B;AACA,YAAIqD,oBAAoB,IAApB,IAA4BC,oBAAoB,IAApD,EAA0D;AAAA;AAAA;AAAA;;AAAA;AACxD,kCAA4BD,gBAA5B,mIAA8C;AAAA,kBAArCE,eAAqC;;AAC5C,mBAAK,IAAIC,IAAIF,iBAAiB1C,MAAjB,GAA0B,CAAvC,EAA0C4C,KAAK,CAA/C,EAAkDA,GAAlD,EAAuD;AACrDJ,kCAAkBE,iBAAiBE,CAAjB,CAAlB;;AAEA,oBAAIJ,gBAAgBhD,EAAhB,IAAsB,IAAtB,IACFgD,gBAAgBhD,EAAhB,KAAuBmD,gBAAgBnD,EADzC,EAC6C;;AAE3C;AACAgD,kCAAgBK,cAAhB,GAAiCF,gBAAgBE,cAAjD;AACA;;AAEA,uBAAK9D,UAAL,CAAgB+D,UAAhB,CAA2B,yBAA3B,EAAsD,EAACvD,YAAYiD,eAAb,EAAtD;AACA;AACD,iBATD,MASO,IAAIA,gBAAgBzB,YAAhB,IAAgC,IAAhC,IACTyB,gBAAgBzB,YAAhB,KAAiC4B,gBAAgB5B,YAD5C,EAC0D;;AAE/D;AACAyB,kCAAgBhD,EAAhB,GAAqBmD,gBAAgBnD,EAArC;AACAgD,kCAAgBK,cAAhB,GAAiCF,gBAAgBE,cAAjD;AACAL,kCAAgBzB,YAAhB,GAA+B,IAA/B,CAL+D,CAK1B;;AAErC,sBAAI,KAAK/B,aAAL,CAAmBkC,SAAnB,MAAkCsB,gBAAgBhD,EAAhB,IAAsB,IAA5D,EAAkE;AAChE;;;;AAIAgD,oCAAgBhD,EAAhB,GAAqB,KAAKH,iBAA1B;AACA;;;;AAIA,yBAAKA,iBAAL;AACD;;AAED,uBAAKN,UAAL,CAAgB+D,UAAhB,CAA2B,yBAA3B,EAAsD,EAACvD,YAAYiD,eAAb,EAAtD;AACA;AACD;AACF;AACF;AAvCuD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAwCzD;AACF;AACD,aAAOA,eAAP;AACD;;AAED;;;;;;;0CAIsBjD,U,EAAY;AAChC,UAAIA,cAAc,IAAlB,EAAwB;AACtB,YAAIwD,UAAU,KAAd;AACA,YAAM3D,cAAc,KAAKA,WAAzB;AACA,YAAIA,eAAe,IAAnB,EAAyB;AACvB,eAAK,IAAIW,IAAIX,YAAYY,MAAZ,GAAqB,CAAlC,EAAqCD,KAAK,CAA1C,EAA6CA,GAA7C,EAAkD;AAChD,gBAAME,iBAAiBb,YAAYW,CAAZ,CAAvB;AACA,gBAAIE,kBAAkB,IAAtB,EAA4B;AAC1B,kBAAIV,WAAWC,EAAX,IAAiBS,eAAeT,EAAhC,IACFD,WAAWG,MAAX,IAAqBO,eAAeP,MADlC,IAEFH,WAAWI,WAAX,IAA0BM,eAAeN,WAFvC,IAGFJ,WAAWK,eAAX,IAA8BK,eAAeL,eAH3C,IAIFL,WAAWM,aAAX,IAA4BI,eAAeJ,aAJzC,IAKFN,WAAWO,IAAX,IAAmBG,eAAeH,IALhC,IAMFP,WAAWiB,aAAX,IAA4BP,eAAeO,aANzC,IAOFjB,WAAWe,KAAX,IAAoBL,eAAeK,KAPjC,IAQFf,WAAWgB,QAAX,IAAuBN,eAAeM,QARxC,EAQkD;;AAEhD;AACAN,+BAAeW,IAAf,GAAsBrB,WAAWqB,IAAjC;AACAX,+BAAeY,cAAf,GAAgCtB,WAAWsB,cAA3C;AACAZ,+BAAe4C,cAAf,GAAgCtD,WAAWsD,cAA3C;AACAE,0BAAU,IAAV;AACD;AACF;AACF;AACF;AACD,YAAI,CAACA,OAAL,EAAc;AACZ;AACA3D,sBAAY0B,IAAZ,CAAiBvB,UAAjB;AACD;AACF;AACF;;;;;AAED;;;;mCAIeH,W,EAAa;AAC1B,WAAKA,WAAL,GAAmBA,WAAnB;AACD;;;;;AAED;;;;;kCAKcA,W,EAAasC,W,EAAa;AACtC,UAAIsB,aAAa,CAAjB;AACA,UAAMC,cAAc,EAApB;;AAEA,UAAI7D,eAAe,IAAf,IAAuBsC,eAAe,IAA1C,EAAgD;AAC9C,aAAK,IAAI3B,IAAIX,YAAYY,MAAZ,GAAqB,CAAlC,EAAqCD,KAAK,CAA1C,EAA6CA,GAA7C,EAAkD;AAChD,cAAMR,aAAaH,YAAYW,CAAZ,CAAnB;AACA,cAAIR,cAAc,IAAd,IAAsBA,WAAWM,aAAX,IAA4B6B,WAAtD,EAAmE;AACjE,gBAAInC,WAAWO,IAAX,KAAoB,OAApB,IAA+BP,WAAWO,IAAX,KAAoB,WAAvD,EAAoE;AAClE,kBAAMJ,SAASH,WAAWG,MAA1B;AACA,kBAAMC,cAAcJ,WAAWI,WAA/B;AACA,kBAAMiB,OAAOrB,WAAWqB,IAAxB;AACA,kBAAI,KAAK3B,cAAL,CAAoBiE,QAApB,CAA6BxD,MAA7B,EAAqCC,WAArC,CAAJ,EAAuD;AACrD,oBAAMwD,aAAazD,SAAS,GAAT,GAAeC,WAAlC;AACA,oBAAIsD,YAAYG,OAAZ,CAAoBD,UAApB,KAAmC,CAAC,CAAxC,EAA2C;AACzC,sBAAIvC,QAAQ,IAAZ,EAAkB;AAChB,wBAAMyC,QAAQzC,KAAKyC,KAAnB;AACA,wBAAI,CAACC,MAAMD,KAAN,CAAL,EAAmB;AACjB,0BAAIL,cAAc,IAAlB,EAAwB;AACtBA,qCAAaK,KAAb;AACD,uBAFD,MAEO;AACLL,sCAAcK,KAAd;AACD;;AAED;;;;;AAKAJ,kCAAYnC,IAAZ,CAAiBqC,UAAjB;AACD;AACF;AACF;AACF;AACF;AACF;AACF;AACF;AACD,aAAOH,UAAP;AACD;;AAED;;;;;;;;;6BAMStB,W,EAAahC,M,EAAQ;AAC5B,UAAI6D,QAAQ,IAAZ;;AAEA;;;;;AAKA,UAAMN,cAAc,EAApB;AACA,UAAM7D,cAAc,KAAKA,WAAzB;;AAEA,UAAIsC,eAAe,IAAf,IAAuBhC,UAAU,IAArC,EAA2C;AACzC,aAAK,IAAIK,IAAIX,YAAYY,MAAZ,GAAqB,CAAlC,EAAqCD,KAAK,CAA1C,EAA6CA,GAA7C,EAAkD;AAChD,cAAMR,aAAaH,YAAYW,CAAZ,CAAnB;AACA,cAAIR,cAAc,IAAd,IAAsBA,WAAWM,aAAX,IAA4B6B,WAAtD,EAAmE;AACjE,gBAAInC,WAAWO,IAAX,KAAoB,OAApB,IAA+BP,WAAWO,IAAX,KAAoB,WAAvD,EAAoE;AAClE,kBAAM0D,aAAajE,WAAWG,MAA9B;AACA,kBAAIA,UAAU8D,UAAd,EAA0B;AACxB,oBAAM7D,cAAcJ,WAAWI,WAA/B;AACA,oBAAMiB,OAAOrB,WAAWqB,IAAxB;AACA,oBAAMuC,aAAaK,aAAa,GAAb,GAAmB7D,WAAtC;AACA,oBAAIsD,YAAYG,OAAZ,CAAoBD,UAApB,KAAmC,CAAC,CAAxC,EAA2C;AACzC,sBAAIvC,QAAQ,IAAZ,EAAkB;AAChB,wBAAMyC,QAAQzC,KAAKyC,KAAnB;AACA,wBAAI,CAACC,MAAMD,KAAN,CAAL,EAAmB;AACjB,0BAAIE,SAAS,IAAb,EAAmB;AACjBA,gCAAQF,KAAR;AACD,uBAFD,MAEO;AACLE,iCAASF,KAAT;AACD;;AAED;;;;;AAKAJ,kCAAYnC,IAAZ,CAAiBqC,UAAjB;AACD;AACF;AACF;AACF;AACF;AACF;AACF;AACF;;AAED,aAAOI,KAAP;AACD;;AAED;;;;;;;;;;;;;8CAU0BjD,K,EAAOC,Q,EAAUb,M,EAAQC,W,EAC/CE,a,EAAee,I,EAAM;AACvB,UAAMtB,eAAe,IAArB;AACA,UAAMM,kBAAkB,IAAxB;AACA,UAAMY,gBAAgB,IAAtB;AACA,UAAMC,sBAAsB,IAA5B;AACA,UAAMC,iBAAiB,IAAvB;AACA,UAAMC,iBAAiB,WAAvB;AACA,UAAME,iBAAiB4C,KAAKC,KAAL,CAAW,IAAID,IAAJ,EAAX,CAAvB;AACA,UAAMlE,aAAa,KAAKoE,gBAAL,CACjBrE,YADiB,EACHgB,KADG,EACIC,QADJ,EACcX,eADd,EAC+BC,aAD/B,EAEjBH,MAFiB,EAETC,WAFS,EAEIa,aAFJ,EAEmBC,mBAFnB,EAEwCC,cAFxC,EAGjBC,cAHiB,EAGDC,IAHC,EAGKC,cAHL,CAAnB;AAKA,aAAOtB,UAAP;AACD;;AAED;;;;;;;;;;;;;gDAU4Be,K,EAAOC,Q,EAAUb,M,EAAQC,W,EACjDE,a,EAAee,I,EAAM;AACvB,UAAMtB,eAAe,IAArB;AACA,UAAMM,kBAAkB,IAAxB;AACA,UAAMY,gBAAgB,IAAtB;AACA,UAAMC,sBAAsB,IAA5B;AACA,UAAMC,iBAAiB,IAAvB;AACA,UAAMC,iBAAiB,aAAvB;AACA,UAAME,iBAAiB4C,KAAKC,KAAL,CAAW,IAAID,IAAJ,EAAX,CAAvB;AACA,UAAMlE,aAAa,KAAKoE,gBAAL,CAAsBrE,YAAtB,EAAoCgB,KAApC,EAA2CC,QAA3C,EACfX,eADe,EACEC,aADF,EACiBH,MADjB,EACyBC,WADzB,EACsCa,aADtC,EAEfC,mBAFe,EAEMC,cAFN,EAEsBC,cAFtB,EAEsCC,IAFtC,EAGfC,cAHe,CAAnB;AAIA,aAAOtB,UAAP;AACD;;AAED;;;;;;;;;;;;;;;sDAYkCe,K,EAAOC,Q,EAAUb,M,EAAQC,W,EACvDC,e,EAAiBC,a,EAAeW,a,EAAeI,I,EAAM;AACvD,UAAMtB,eAAe,IAArB;AACA,UAAMmB,sBAAsB,IAA5B;AACA,UAAMC,iBAAiB,IAAvB;AACA,UAAMC,iBAAiB,mBAAvB;AACA,UAAME,iBAAiB4C,KAAKC,KAAL,CAAW,IAAID,IAAJ,EAAX,CAAvB;AACA,UAAMlE,aAAa,KAAKoE,gBAAL,CAAsBrE,YAAtB,EAAoCgB,KAApC,EAA2CC,QAA3C,EACfX,eADe,EACEC,aADF,EACiBH,MADjB,EACyBC,WADzB,EACsCa,aADtC,EAEfC,mBAFe,EAEMC,cAFN,EAEsBC,cAFtB,EAEsCC,IAFtC,EAGfC,cAHe,CAAnB;AAIA,aAAOtB,UAAP;AACD;;AAED;;;;;;;;;;;;;;;;;;;;kDAiB8BG,M,EAAQC,W,EAAa+B,W,EAAakC,S,EAC5DC,W,EAAa;AACf,UAAIC,wBAAwB,KAAKC,wBAAL,CAA8BrE,MAA9B,EACxBC,WADwB,EACX+B,WADW,EACEkC,SADF,CAA5B;AAEA,UAAII,0BAA0B,KAAKC,0BAAL,CAAgCvE,MAAhC,EAC1BC,WAD0B,EACb+B,WADa,EACAmC,WADA,CAA9B;;AAGA,aAAO;AACL,iBAASC,qBADJ;AAEL,mBAAWE;AAFN,OAAP;AAID;;;;;AAED;;;;;qDAKiCtC,W,EAAajB,mB,EAAqB;AACjE,UAAIqD,wBAAwB,IAA5B;AACA,UAAIE,0BAA0B,IAA9B;AACAF,8BAAwB,KAAKI,oCAAL,CAA0CxC,WAA1C,EAAuDjB,mBAAvD,CAAxB;AACAuD,gCAA0B,KAAKG,sCAAL,CAA4CzC,WAA5C,EAAyDjB,mBAAzD,CAA1B;;AAEA,aAAO;AACL,iBAASqD,qBADJ;AAEL,mBAAWE;AAFN,OAAP;AAID;;;;;AAED;;;;;yDAKqCtC,W,EAAajB,mB,EAAqB;AACrE,UAAIrB,cAAc,KAAKgF,cAAL,EAAlB;AACA,WAAK,IAAIrE,IAAIX,YAAYY,MAAZ,GAAqB,CAAlC,EAAqCD,KAAK,CAA1C,EAA6CA,GAA7C,EAAkD;AAChD,YAAIR,aAAaH,YAAYW,CAAZ,CAAjB;AACA,YAAIR,cAAc,IAAd,IAAsBA,WAAWO,IAAX,KAAoB,OAA1C,IACAP,WAAWmB,cAAX,IAA6B,IAD7B,IAEAnB,WAAWkB,mBAAX,KAAmCA,mBAFvC,EAE4D;AAC1D,iBAAOlB,UAAP;AACD;AACF;AACD,aAAO,IAAP;AACD;;AAED;;;;;;;;2DAKuCmC,W,EAAajB,mB,EAAqB;AACvE,UAAIrB,cAAc,KAAKgF,cAAL,EAAlB;AACA,WAAK,IAAIrE,IAAIX,YAAYY,MAAZ,GAAqB,CAAlC,EAAqCD,KAAK,CAA1C,EAA6CA,GAA7C,EAAkD;AAChD,YAAIR,aAAaH,YAAYW,CAAZ,CAAjB;AACA,YAAIR,cAAc,IAAd,IAAsBA,WAAWO,IAAX,KAAoB,SAA1C,IACAP,WAAWmB,cAAX,IAA6B,IAD7B,IAEAnB,WAAWkB,mBAAX,KAAmCA,mBAFvC,EAE4D;AAC1D,iBAAOlB,UAAP;AACD;AACF;AACD,aAAO,IAAP;AACD;;AAGD;;;;;;;;;;;;;;;6CAYyBG,M,EAAQC,W,EAAa+B,W,EAAakC,S,EAAW;AACpE,UAAIrE,aAAa,IAAjB;AACA,UAAMH,cAAc,KAAKgF,cAAL,EAApB;;AAEA,UAAIR,aAAa,IAAjB,EAAuB;AACrBA,oBAAY,KAAZ;AACD;;AAED,WAAK,IAAI7D,IAAIX,YAAYY,MAAZ,GAAqB,CAAlC,EAAqCD,KAAK,CAA1C,EAA6CA,GAA7C,EAAkD;AAChD,YAAME,iBAAiBb,YAAYW,CAAZ,CAAvB;AACA,YAAIE,kBAAkB,IAAtB,EAA4B;AAC1B,cAAIoE,mBAAmB,KAAvB;AACA,cAAMb,aAAavD,eAAeP,MAAlC;AACA,cAAM4E,kBAAkBrE,eAAeN,WAAvC;AACA,cAAM4E,oBAAoBtE,eAAeJ,aAAzC;AACA,cAAM2E,qBAAqBvE,eAAeH,IAA1C;;AAEA,cAAIJ,UAAU8D,UAAV,IAAwB7D,eAAe2E,eAAvC,IACA5C,eAAe6C,iBADnB,EACsC;AACpC,gBAAIX,cAAc,KAAd,KAAwBY,uBAAuB,WAAvB,IAAsCA,uBAAuB,OAArF,CAAJ,EAAmG;AACjGH,iCAAmB,IAAnB;AACD,aAFD,MAEO,IAAIT,cAAc,WAAd,IAA6BY,uBAAuB,WAAxD,EAAqE;AAC1EH,iCAAmB,IAAnB;AACD,aAFM,MAEA,IAAIT,cAAc,OAAd,IAAyBY,uBAAuB,OAApD,EAA6D;AAClEH,iCAAmB,IAAnB;AACD;;AAED,gBAAIA,gBAAJ,EAAsB;AACpB9E,2BAAaU,cAAb;AACA;AACD;AACF;AACF;AACF;AACD,aAAOV,UAAP;AACD;;AAED;;;;;;;;;;;;;;;+CAY2BG,M,EAAQC,W,EAAa+B,W,EAAamC,W,EAAa;AACxE,UAAItE,aAAa,IAAjB;AACA,UAAMH,cAAc,KAAKgF,cAAL,EAApB;;AAEA,UAAIP,eAAe,IAAnB,EAAyB;AACvBA,sBAAc,KAAd;AACD;;AAED,WAAK,IAAI9D,IAAIX,YAAYY,MAAZ,GAAqB,CAAlC,EAAqCD,KAAK,CAA1C,EAA6CA,GAA7C,EAAkD;AAChD,YAAME,iBAAiBb,YAAYW,CAAZ,CAAvB;AACA,YAAIE,kBAAkB,IAAtB,EAA4B;AAC1B,cAAIoE,mBAAmB,KAAvB;AACA,cAAMb,aAAavD,eAAeP,MAAlC;AACA,cAAM4E,kBAAkBrE,eAAeN,WAAvC;AACA,cAAM4E,oBAAoBtE,eAAeJ,aAAzC;AACA,cAAM2E,qBAAqBvE,eAAeH,IAA1C;;AAEA,cAAIJ,UAAU8D,UAAV,IAAwB7D,eAAe2E,eAAvC,IACA5C,eAAe6C,iBADnB,EACsC;AACpC,gBAAIV,gBAAgB,KAAhB,KAA0BW,uBAAuB,aAAvB,IAAwCA,uBAAuB,SAAzF,CAAJ,EAAyG;AACvGH,iCAAmB,IAAnB;AACD,aAFD,MAEO,IAAIR,gBAAgB,aAAhB,IAAiCW,uBAAuB,aAA5D,EAA2E;AAChFH,iCAAmB,IAAnB;AACD,aAFM,MAEA,IAAIR,gBAAgB,SAAhB,IAA6BW,uBAAuB,SAAxD,EAAmE;AACxEH,iCAAmB,IAAnB;AACD;;AAED,gBAAIA,gBAAJ,EAAsB;AACpB9E,2BAAaU,cAAb;AACA;AACD;AACF;AACF;AACF;AACD,aAAOV,UAAP;AACD;;AAED;;;;;;;;qDAKiCkF,e,EAAiB;AAChD,UAAIA,mBAAmB,IAAvB,EAA6B;AAC3B,YAAM7D,OAAO6D,gBAAgB7D,IAA7B;;AAEA,YAAIA,QAAQ,IAAZ,EAAkB;AAChB,iBAAOA,KAAKyC,KAAZ;AACD;AACF;AACD,aAAO,IAAP;AACD;;AAED;;;;;;;kEAI8C3D,M,EAAQC,W,EAAa;AACjE,UAAI+E,uBAAuB,KAAKC,uBAAL,EAA3B;AACA,UAAIC,0CAA0CF,qBAAqBG,MAArB,CAA4B,UAACC,gBAAD,EAAsB;AAC9F,eAAOA,iBAAiBpF,MAAjB,KAA4BA,MAA5B,IAAsCoF,iBAAiBnF,WAAjB,KAAiCA,WAA9E;AACD,OAF6C,CAA9C;AAGA,aAAOiF,uCAAP;AACD;;;;;AAED;;;;8CAI0B;AACxB,UAAIG,oBAAoB,EAAxB;AADwB;AAAA;AAAA;;AAAA;AAExB,8BAAuB,KAAK3F,WAA5B,mIAAyC;AAAA,cAAhCG,UAAgC;;AACvC,cAAIA,cAAc,IAAd,IAAsBA,WAAWqB,IAAX,IAAmB,IAA7C,EAAmD;AACjD,gBAAIrB,WAAWqB,IAAX,CAAgBoE,QAApB,EAA8B;AAC5BD,gCAAkBjE,IAAlB,CAAuBvB,UAAvB;AACD;AACF;AACF;AARuB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AASxB,aAAOwF,iBAAP;AACD;;;;;AAED;;;;mDAI+B;AAC7B,UAAIE,yBAAyB,EAA7B;AAD6B;AAAA;AAAA;;AAAA;AAE7B,8BAAuB,KAAK7F,WAA5B,mIAAyC;AAAA,cAAhCG,UAAgC;;AACvC,cAAIA,cAAc,IAAd,IAAsBA,WAAWqB,IAAX,IAAmB,IAA7C,EAAmD;AACjD,gBAAIrB,WAAWqB,IAAX,CAAgBoE,QAApB,EAA8B;AAC5B;AACA,kBAAIzF,WAAWqB,IAAX,CAAgBsE,mBAAhB,IAAuC,IAAvC,IAA+C3F,WAAWqB,IAAX,CAAgBuE,0BAAhB,IAA8C,IAAjG,EAAuG;AACrG,oBAAIC,iBAAiB,KAArB;AADqG;AAAA;AAAA;;AAAA;AAErG,wCAAkCH,sBAAlC,mIAA0D;AAAA,wBAAjDI,qBAAiD;;AACxD,wBAAIA,sBAAsBC,0BAAtB,IAAqD/F,WAAWqB,IAAX,CAAgBsE,mBAAhB,GAAsC3F,WAAWqB,IAAX,CAAgBuE,0BAA/G,EAA4I;AAC1I;AACAE,4CAAsBjG,WAAtB,CAAkC0B,IAAlC,CAAuCvB,UAAvC;AACA6F,uCAAiB,IAAjB;AACD;AACF;AARoG;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AASrG,oBAAI,CAACA,cAAL,EAAqB;AACnB,sBAAIG,kBAAkB;AACpB,kDAA+BhG,WAAWqB,IAAX,CAAgBsE,mBAAhB,GAAsC3F,WAAWqB,IAAX,CAAgBuE,0BADjE;AAEpB,mCAAe,CAAC5F,UAAD;AAFK,mBAAtB;AAIA0F,yCAAuBnE,IAAvB,CAA4ByE,eAA5B;AACD;AACF,eAhBD,MAgBO;AACL;AACAC,wBAAQC,KAAR,CAAc,KAAKtG,UAAL,CAAgB,wCAAhB,IAA4DI,UAA1E;AACD;AACF;AACF;AACF;AA5B4B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AA6B7B,aAAO0F,sBAAP;AACD;;;;;AAED;;;;;;;;;;;;;;;;;;;;;;;sDAuBkC;AAChC,aAAO,KAAKS,4BAAZ;AACD;;;;;AAED;;;4DAGwC;AACtC,WAAKA,4BAAL,GAAoC,EAApC;;AADsC;AAAA;AAAA;;AAAA;AAGtC,8BAAuB,KAAKtG,WAA5B,mIAAyC;AAAA,cAAhCG,UAAgC;;AACvC,cAAIA,cAAc,IAAd,IAAsBA,WAAWqB,IAAX,IAAmB,IAA7C,EAAmD;AACjD,gBAAIrB,WAAWqB,IAAX,CAAgBoE,QAAhB,IAA4BzF,WAAWqB,IAAX,CAAgB+E,qBAAhB,IAAyC,IAAzE,EAA+E;AAC7E;AACA,kBAAIpG,WAAWqB,IAAX,CAAgBsE,mBAAhB,IAAuC,IAA3C,EAAiD;AAC/C,oBAAIE,iBAAiB,KAArB;AAD+C;AAAA;AAAA;;AAAA;AAE/C,wCAAwC,KAAKM,4BAA7C,mIAA2E;AAAA,wBAAlEE,2BAAkE;;AACzE,wBAAIA,4BAA4BV,mBAA5B,IAAoD3F,WAAWqB,IAAX,CAAgBsE,mBAAhB,GAAsC,GAAtC,GAA4C3F,WAAWqB,IAAX,CAAgBuE,0BAApH,EAAiJ;AAC/I;AACAS,kDAA4BxG,WAA5B,CAAwC0B,IAAxC,CAA6CvB,UAA7C;AACA6F,uCAAiB,IAAjB;AACD;AACF;AAR8C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAS/C,oBAAI,CAACA,cAAL,EAAqB;AACnB,sBAAIG,kBAAkB;AACpB,2CAAuBhG,WAAWqB,IAAX,CAAgBsE,mBAAhB,GAAsC,GAAtC,GAA4C3F,WAAWqB,IAAX,CAAgBuE,0BAD/D;AAEpB,mCAAe,CAAC5F,UAAD,CAFK;AAGpB,8BAAUA,WAAWG,MAHD;AAIpB,mCAAeH,WAAWI,WAJN;AAKpB,sCAAkBJ,WAAWsD;AALT,mBAAtB;AAOA,uBAAK6C,4BAAL,CAAkC5E,IAAlC,CAAuCyE,eAAvC;AACD;AACF,eAnBD,MAmBO;AACL;AACAC,wBAAQC,KAAR,CAAcI,IAAI1G,UAAJ,CAAe,wCAAf,IAA2DI,UAAzE;AACD;AACF;AACF;AACF;AAhCqC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAiCvC;;AAED;;;;;;;;mDAK+B;AAC7B,UAAIuG,4BAA4B,EAAhC;AAD6B;AAAA;AAAA;;AAAA;AAE7B,+BAAuB,KAAK1G,WAA5B,wIAAyC;AAAA,cAAhCG,UAAgC;;AACvC,cAAIA,cAAc,IAAd,IAAsBA,WAAWqB,IAAX,IAAmB,IAA7C,EAAmD;AACjD,gBAAIrB,WAAWqB,IAAX,CAAgBoE,QAAhB,IAA4BzF,WAAWqB,IAAX,CAAgB+E,qBAAhB,IAAyC,IAAzE,EAA+E;AAC7EG,wCAA0BhF,IAA1B,CAA+BvB,UAA/B;AACD;AACF;AACF;AAR4B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAS7B,aAAOuG,yBAAP;AACD;;;;;AAED;;;;;mEAK+CtF,a,EAAe;AAC5D,aAAO,KAAKuF,yCAAL,CAA+CvF,aAA/C,EAA8D,OAA9D,CAAP;AACD;;AAED;;;;;;;;qEAKiDA,a,EAAe;AAC9D,aAAO,KAAKuF,yCAAL,CAA+CvF,aAA/C,EAA8D,SAA9D,CAAP;AACD;;AAED;;;;;;;;gEAK4CA,a,EAAe;AACzD,aAAO,KAAKuF,yCAAL,CAA+CvF,aAA/C,EAA8D,WAA9D,CAAP;AACD;;AAED;;;;;;;;kEAK8CA,a,EAAe;AAC3D,aAAO,KAAKuF,yCAAL,CAA+CvF,aAA/C,EAA8D,aAA9D,CAAP;AACD;;AAED;;;;;;;;;8DAM0CA,a,EAAeV,I,EAAM;AAC7D,WAAK,IAAIC,IAAI,KAAKX,WAAL,CAAiBY,MAAjB,GAA0B,CAAvC,EAA0CD,KAAK,CAA/C,EAAkDA,GAAlD,EAAuD;AACrD,YAAMR,aAAa,KAAKH,WAAL,CAAiBW,CAAjB,CAAnB;;AAEA,YAAIR,cAAc,IAAlB,EAAwB;AACtB,cAAIiB,iBAAiBjB,WAAWiB,aAA5B,IAA6CV,QAAQP,WAAWO,IAApE,EAA0E;AACxE;;;;AAIA,mBAAOP,UAAP;AACD;AACF;AACF;AACD,aAAO,IAAP;AACD;;AAED;;;;;;;;kDAK8BiB,a,EAAe;AAC3C,UAAIpB,cAAc,EAAlB;AAD2C;AAAA;AAAA;;AAAA;AAE3C,+BAAuB,KAAKA,WAA5B,wIAAyC;AAAA,cAAhCG,UAAgC;;AACvC,cAAIA,cAAciB,iBAAiBjB,WAAWiB,aAA9C,EAA6D;AAC3DpB,wBAAY0B,IAAZ,CAAiBvB,UAAjB;AACD;AACF;AAN0C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAO3C,aAAOH,WAAP;AACD;;;;;;AAGHT,kBAAkBqH,OAAlB,GAA4B,CAC1B,SAD0B,EAE1B,OAF0B,EAG1B,IAH0B,EAI1B,YAJ0B,EAK1B,eAL0B,EAM1B,gBAN0B,EAO1B,aAP0B,CAA5B;;kBAUerH,iB","file":"annotationService.js","sourcesContent":["'use strict';\n\nclass AnnotationService {\n  constructor(\n      $filter,\n      $http,\n      $q,\n      $rootScope,\n      ConfigService,\n      ProjectService,\n      UtilService) {\n    this.$filter = $filter;\n    this.$http = $http;\n    this.$q = $q;\n    this.$rootScope = $rootScope;\n    this.ConfigService = ConfigService;\n    this.ProjectService = ProjectService;\n    this.UtilService = UtilService;\n    this.$translate = this.$filter('translate');\n    this.annotations = null;\n\n    /*\n     * A dummy annotation id that is used in preview mode when we simulate\n     * saving of annotation.\n     */\n    this.dummyAnnotationId = 1;\n  }\n\n  /**\n   * Get all the annotations\n   */\n  getAnnotations() {\n    return this.annotations;\n  }\n\n  /**\n   * Get the annotation with the specified id, or null if not found\n   * @param annotationId\n   */\n  getAnnotationById(annotationId) {\n    for (let annotation of this.annotations) {\n      if (annotation.id === annotationId) {\n        return annotation;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Get the latest annotation with the given params\n   * @param params an object containing the params to match\n   * @returns the latest annotation that matches the params\n   */\n  getLatestAnnotation(params) {\n    let annotation = null;\n\n    if (params != null) {\n      let nodeId = params.nodeId;\n      let componentId = params.componentId;\n      let fromWorkgroupId = params.fromWorkgroupId;\n      let toWorkgroupId = params.toWorkgroupId;\n      let type = params.type;\n\n      let annotations = this.annotations;\n\n      if (annotations != null) {\n        for (let a = annotations.length - 1; a >= 0; a--) {\n          let tempAnnotation = annotations[a];\n\n          if (tempAnnotation != null) {\n            let match = true;\n\n            if (nodeId && tempAnnotation.nodeId !== nodeId) {\n              match = false;\n            }\n            if (match && componentId && tempAnnotation.componentId !== componentId) {\n              match = false;\n            }\n            if (match && fromWorkgroupId && tempAnnotation.fromWorkgroupId !== fromWorkgroupId) {\n              match = false;\n            }\n            if (match && toWorkgroupId && tempAnnotation.toWorkgroupId !== toWorkgroupId) {\n              match = false;\n            }\n            if (match && type) {\n              if (type.constructor === Array) {\n                for (let thisType of type) {\n                  if (tempAnnotation.type !== thisType) {\n                    match = false;\n                  }\n                }\n              } else {\n                if (tempAnnotation.type !== type) {\n                  match = false;\n                }\n              }\n            }\n\n            if (match) {\n              annotation = tempAnnotation;\n              break;\n            }\n          }\n        }\n      }\n    }\n    return annotation;\n  };\n\n  /**\n   * Create an annotation object\n   * @param annotationId the annotation id\n   * @param runId the run id\n   * @param periodId the period id\n   * @param fromWorkgroupId the from workgroup id\n   * @param toWorkgroupId the to workgroup id\n   * @param nodeId the node id\n   * @param componentId the component id\n   * @param studentWorkId the student work id\n   * @param annotationType the annotation type\n   * @param data the data\n   * @param clientSaveTime the client save time\n   * @returns an annotation object\n   */\n  createAnnotation(annotationId, runId, periodId, fromWorkgroupId,\n      toWorkgroupId, nodeId, componentId, studentWorkId, localNotebookItemId,\n      notebookItemId, annotationType, data, clientSaveTime) {\n    const annotation = {};\n    annotation.id = annotationId;\n    annotation.runId = runId;\n    annotation.periodId = periodId;\n    annotation.fromWorkgroupId = fromWorkgroupId;\n    annotation.toWorkgroupId = toWorkgroupId;\n    annotation.nodeId = nodeId;\n    annotation.componentId = componentId;\n    annotation.studentWorkId = studentWorkId;\n    annotation.localNotebookItemId = localNotebookItemId;\n    annotation.notebookItemId = notebookItemId;\n    annotation.type = annotationType;\n    annotation.data = data;\n    annotation.clientSaveTime = clientSaveTime;\n    return annotation;\n  };\n\n  /**\n   * Save the annotation to the server\n   * @param annotation the annotation object\n   * @returns a promise\n   */\n  saveAnnotation(annotation) {\n    if (annotation != null) {\n      let annotations = [];\n      annotations.push(annotation);\n      if (annotations != null && annotations.length > 0) {\n        for (let annotation of annotations) {\n          if (annotation != null) {\n            annotation.requestToken = this.UtilService.generateKey(); // use this to keep track of unsaved annotations.\n            this.addOrUpdateAnnotation(annotation);\n          }\n        }\n      } else {\n        annotations = [];\n      }\n\n      if (this.ConfigService.isPreview()) {\n        // if we're in preview, don't make any request to the server but pretend we did\n        let savedAnnotationDataResponse = {\n          annotations: annotations\n        };\n        let annotation = this.saveToServerSuccess(savedAnnotationDataResponse);\n\n        let deferred = this.$q.defer();\n        deferred.resolve(annotation);\n        return deferred.promise;\n      } else {\n        let params = {\n          runId: this.ConfigService.getRunId(),\n          workgroupId: this.ConfigService.getWorkgroupId(),\n          annotations: angular.toJson(annotations)\n        };\n\n        let httpParams = {\n          method: \"POST\",\n          url: this.ConfigService.getConfigParam('teacherDataURL'),\n          headers: {'Content-Type': 'application/x-www-form-urlencoded'},\n          data: $.param(params)\n        };\n\n        return this.$http(httpParams).then(angular.bind(this, function(result) {\n\n          let localAnnotation = null;\n\n          if (result != null && result.data != null) {\n            let savedAnnotationDataResponse = result.data;\n            localAnnotation = this.saveToServerSuccess(savedAnnotationDataResponse);\n          }\n\n          return localAnnotation;\n        }));\n      }\n    }\n  };\n\n  saveToServerSuccess(savedAnnotationDataResponse) {\n    let localAnnotation = null;\n    if (savedAnnotationDataResponse != null) {\n      let savedAnnotations = savedAnnotationDataResponse.annotations;\n      let localAnnotations = this.annotations;\n      if (savedAnnotations != null && localAnnotations != null) {\n        for (let savedAnnotation of savedAnnotations) {\n          for (let y = localAnnotations.length - 1; y >= 0; y--) {\n            localAnnotation = localAnnotations[y];\n\n            if (localAnnotation.id != null &&\n              localAnnotation.id === savedAnnotation.id) {\n\n              // we have found the matching local annotation so we will update it\n              localAnnotation.serverSaveTime = savedAnnotation.serverSaveTime;\n              //localAnnotation.requestToken = null; // requestToken is no longer needed.\n\n              this.$rootScope.$broadcast('annotationSavedToServer', {annotation: localAnnotation});\n              break;\n            } else if (localAnnotation.requestToken != null &&\n              localAnnotation.requestToken === savedAnnotation.requestToken) {\n\n              // we have found the matching local annotation so we will update it\n              localAnnotation.id = savedAnnotation.id;\n              localAnnotation.serverSaveTime = savedAnnotation.serverSaveTime;\n              localAnnotation.requestToken = null; // requestToken is no longer needed.\n\n              if (this.ConfigService.isPreview() && localAnnotation.id == null) {\n                /*\n                 * we are in preview mode so we will set a dummy\n                 * annotation id into the annotation\n                 */\n                localAnnotation.id = this.dummyAnnotationId;\n                /*\n                 * increment the dummy annotation id for the next\n                 * annotation\n                 */\n                this.dummyAnnotationId++;\n              }\n\n              this.$rootScope.$broadcast('annotationSavedToServer', {annotation: localAnnotation});\n              break;\n            }\n          }\n        }\n      }\n    }\n    return localAnnotation;\n  }\n\n  /**\n   * Add or update the annotation to our local collection\n   * @param annotation the annotation object\n   */\n  addOrUpdateAnnotation(annotation) {\n    if (annotation != null) {\n      let updated = false;\n      const annotations = this.annotations;\n      if (annotations != null) {\n        for (let a = annotations.length - 1; a >= 0; a--) {\n          const tempAnnotation = annotations[a];\n          if (tempAnnotation != null) {\n            if (annotation.id == tempAnnotation.id &&\n              annotation.nodeId == tempAnnotation.nodeId &&\n              annotation.componentId == tempAnnotation.componentId &&\n              annotation.fromWorkgroupId == tempAnnotation.fromWorkgroupId &&\n              annotation.toWorkgroupId == tempAnnotation.toWorkgroupId &&\n              annotation.type == tempAnnotation.type &&\n              annotation.studentWorkId == tempAnnotation.studentWorkId &&\n              annotation.runId == tempAnnotation.runId &&\n              annotation.periodId == tempAnnotation.periodId) {\n\n              // the annotation matches so we will update it\n              tempAnnotation.data = annotation.data;\n              tempAnnotation.clientSaveTime = annotation.clientSaveTime;\n              tempAnnotation.serverSaveTime = annotation.serverSaveTime;\n              updated = true;\n            }\n          }\n        }\n      }\n      if (!updated) {\n        // we did not find a match so we will add it\n        annotations.push(annotation);\n      }\n    }\n  };\n\n  /**\n   * Set the annotations\n   * @param annotations the annotations aray\n   */\n  setAnnotations(annotations) {\n    this.annotations = annotations;\n  };\n\n  /**\n   * Get the total score for a workgroup\n   * @param annotations an array of annotations\n   * @param workgroupId the workgroup id\n   */\n  getTotalScore(annotations, workgroupId) {\n    let totalScore = 0;\n    const scoresFound = [];\n\n    if (annotations != null && workgroupId != null) {\n      for (let a = annotations.length - 1; a >= 0; a--) {\n        const annotation = annotations[a];\n        if (annotation != null && annotation.toWorkgroupId == workgroupId) {\n          if (annotation.type === 'score' || annotation.type === \"autoScore\") {\n            const nodeId = annotation.nodeId;\n            const componentId = annotation.componentId;\n            const data = annotation.data;\n            if (this.ProjectService.isActive(nodeId, componentId)) {\n              const scoreFound = nodeId + '-' + componentId;\n              if (scoresFound.indexOf(scoreFound) == -1) {\n                if (data != null) {\n                  const value = data.value;\n                  if (!isNaN(value)) {\n                    if (totalScore == null) {\n                      totalScore = value;\n                    } else {\n                      totalScore += value;\n                    }\n\n                    /*\n                     * remember that we have found a score for this component\n                     * so that we don't double count it if the teacher scored\n                     * the component more than once\n                     */\n                    scoresFound.push(scoreFound);\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n    return totalScore;\n  }\n\n  /**\n   * Get the score for a workgroup for a node\n   * @param workgroupId the workgroup id\n   * @param nodeId the node id\n   * @returns the score for a workgroup for a node\n   */\n  getScore(workgroupId, nodeId) {\n    let score = null;\n\n    /*\n     * an array to keep track of the components that we have obtained a\n     * score for. we do not want to double count components if the student\n     * has received a score multiple times for a node from the teacher.\n     */\n    const scoresFound = [];\n    const annotations = this.annotations;\n\n    if (workgroupId != null && nodeId != null) {\n      for (let a = annotations.length - 1; a >= 0; a--) {\n        const annotation = annotations[a];\n        if (annotation != null && annotation.toWorkgroupId == workgroupId) {\n          if (annotation.type === 'score' || annotation.type === 'autoScore') {\n            const tempNodeId = annotation.nodeId;\n            if (nodeId == tempNodeId) {\n              const componentId = annotation.componentId;\n              const data = annotation.data;\n              const scoreFound = tempNodeId + '-' + componentId;\n              if (scoresFound.indexOf(scoreFound) == -1) {\n                if (data != null) {\n                  const value = data.value;\n                  if (!isNaN(value)) {\n                    if (score == null) {\n                      score = value;\n                    } else {\n                      score += value;\n                    }\n\n                    /*\n                     * remember that we have found a score for this component\n                     * so that we don't double count it if the teacher scored\n                     * the component more than once\n                     */\n                    scoresFound.push(scoreFound);\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n\n    return score;\n  }\n\n  /**\n   * Create an auto score annotation\n   * @param runId the run id\n   * @param periodId the period id\n   * @param nodeId the node id\n   * @param componentId the component id\n   * @param toWorkgroupId the student workgroup id\n   * @param data the annotation data\n   * @returns the auto score annotation\n   */\n  createAutoScoreAnnotation(runId, periodId, nodeId, componentId,\n      toWorkgroupId, data) {\n    const annotationId = null;\n    const fromWorkgroupId = null;\n    const studentWorkId = null;\n    const localNotebookItemId = null;\n    const notebookItemId = null;\n    const annotationType = 'autoScore';\n    const clientSaveTime = Date.parse(new Date());\n    const annotation = this.createAnnotation(\n      annotationId, runId, periodId, fromWorkgroupId, toWorkgroupId,\n      nodeId, componentId, studentWorkId, localNotebookItemId, notebookItemId,\n      annotationType, data, clientSaveTime\n    );\n    return annotation;\n  }\n\n  /**\n   * Create an auto comment annotation\n   * @param runId the run id\n   * @param periodId the period id\n   * @param nodeId the node id\n   * @param componentId the component id\n   * @param toWorkgroupId the student workgroup id\n   * @param data the annotation data\n   * @returns the auto comment annotation\n   */\n  createAutoCommentAnnotation(runId, periodId, nodeId, componentId,\n      toWorkgroupId, data) {\n    const annotationId = null;\n    const fromWorkgroupId = null;\n    const studentWorkId = null;\n    const localNotebookItemId = null;\n    const notebookItemId = null;\n    const annotationType = 'autoComment';\n    const clientSaveTime = Date.parse(new Date());\n    const annotation = this.createAnnotation(annotationId, runId, periodId,\n        fromWorkgroupId, toWorkgroupId, nodeId, componentId, studentWorkId,\n        localNotebookItemId, notebookItemId, annotationType, data,\n        clientSaveTime);\n    return annotation;\n  }\n\n  /**\n   * Create an auto comment annotation\n   * @param runId the run id\n   * @param periodId the period id\n   * @param nodeId the node id\n   * @param componentId the component id\n   * @param fromWorkgroupId the teacher workgroup id\n   * @param toWorkgroupId the student workgroup id\n   * @param studentWorkId the component state id\n   * @param data the annotation data\n   * @returns the inappropriate flag annotation\n   */\n  createInappropriateFlagAnnotation(runId, periodId, nodeId, componentId,\n      fromWorkgroupId, toWorkgroupId, studentWorkId, data) {\n    const annotationId = null;\n    const localNotebookItemId = null;\n    const notebookItemId = null;\n    const annotationType = 'inappropriateFlag';\n    const clientSaveTime = Date.parse(new Date());\n    const annotation = this.createAnnotation(annotationId, runId, periodId,\n        fromWorkgroupId, toWorkgroupId, nodeId, componentId, studentWorkId,\n        localNotebookItemId, notebookItemId, annotationType, data,\n        clientSaveTime);\n    return annotation;\n  }\n\n  /**\n   * Get the latest annotations for a given component (as an object)\n   * @param nodeId the node id\n   * @param componentId the component id\n   * @param workgroupId the workgroup id\n   * @param scoreType (optional) the type of score\n   * e.g.\n   * 'autoScore' for auto graded score\n   * 'score' for teacher graded score\n   * 'any' for auto graded score or teacher graded score\n   * @param commentType (optional) the type of comment\n   * e.g.\n   * 'autoComment' for auto graded comment\n   * 'comment' for teacher graded comment\n   * 'any' for auto graded comment or teacher graded comment\n   * @return object containing the component's latest score and comment annotations\n   */\n  getLatestComponentAnnotations(nodeId, componentId, workgroupId, scoreType,\n      commentType) {\n    let latestScoreAnnotation = this.getLatestScoreAnnotation(nodeId,\n        componentId, workgroupId, scoreType);\n    let latestCommentAnnotation = this.getLatestCommentAnnotation(nodeId,\n        componentId, workgroupId, commentType);\n\n    return {\n      'score': latestScoreAnnotation,\n      'comment': latestCommentAnnotation\n    };\n  };\n\n  /**\n   * Get the latest annotations for a given notebook item (as an object)\n   * @param workgroupId the workgroup id that did the notebook\n   * @param localNotebookItemId unique id for note and its revisions [\"finalReport\", \"xyzabc\", ...]\n   */\n  getLatestNotebookItemAnnotations(workgroupId, localNotebookItemId) {\n    let latestScoreAnnotation = null;\n    let latestCommentAnnotation = null;\n    latestScoreAnnotation = this.getLatestNotebookItemScoreAnnotation(workgroupId, localNotebookItemId);\n    latestCommentAnnotation = this.getLatestNotebookItemCommentAnnotation(workgroupId, localNotebookItemId);\n\n    return {\n      'score': latestScoreAnnotation,\n      'comment': latestCommentAnnotation\n    };\n  };\n\n  /**\n   * Get the latest score annotation for this workgroup and localNotebookItemId, or null if not found\n   * @param workgroupId the workgroup id that did the notebook\n   * @param localNotebookItemId unique id for note and its revisions [\"finalReport\", \"xyzabc\", ...]\n   */\n  getLatestNotebookItemScoreAnnotation(workgroupId, localNotebookItemId) {\n    let annotations = this.getAnnotations();\n    for (let a = annotations.length - 1; a >= 0; a--) {\n      let annotation = annotations[a];\n      if (annotation != null && annotation.type === \"score\" &&\n          annotation.notebookItemId != null &&\n          annotation.localNotebookItemId === localNotebookItemId) {\n        return annotation;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Get the latest comment annotation for this workgroup and localNotebookItemId, or null if not found\n   * @param workgroupId the workgroup id that did the notebook\n   * @param localNotebookItemId unique id for note and its revisions [\"finalReport\", \"xyzabc\", ...]\n   */\n  getLatestNotebookItemCommentAnnotation(workgroupId, localNotebookItemId) {\n    let annotations = this.getAnnotations();\n    for (let a = annotations.length - 1; a >= 0; a--) {\n      let annotation = annotations[a];\n      if (annotation != null && annotation.type === \"comment\" &&\n          annotation.notebookItemId != null &&\n          annotation.localNotebookItemId === localNotebookItemId) {\n        return annotation;\n      }\n    }\n    return null;\n  }\n\n\n  /**\n   * Get the latest score annotation\n   * @param nodeId the node id\n   * @param componentId the component id\n   * @param workgroupId the workgroup id\n   * @param scoreType (optional) the type of score\n   * e.g.\n   * 'autoScore' for auto graded score\n   * 'score' for teacher graded score\n   * 'any' for auto graded score or teacher graded score\n   * @returns the latest score annotation\n   */\n  getLatestScoreAnnotation(nodeId, componentId, workgroupId, scoreType) {\n    let annotation = null;\n    const annotations = this.getAnnotations();\n\n    if (scoreType == null) {\n      scoreType = 'any';\n    }\n\n    for (let a = annotations.length - 1; a >= 0; a--) {\n      const tempAnnotation = annotations[a];\n      if (tempAnnotation != null) {\n        let acceptAnnotation = false;\n        const tempNodeId = tempAnnotation.nodeId;\n        const tempComponentId = tempAnnotation.componentId;\n        const tempToWorkgroupId = tempAnnotation.toWorkgroupId;\n        const tempAnnotationType = tempAnnotation.type;\n\n        if (nodeId == tempNodeId && componentId == tempComponentId &&\n            workgroupId == tempToWorkgroupId) {\n          if (scoreType === 'any' && (tempAnnotationType === 'autoScore' || tempAnnotationType === 'score')) {\n            acceptAnnotation = true;\n          } else if (scoreType === 'autoScore' && tempAnnotationType === 'autoScore') {\n            acceptAnnotation = true;\n          } else if (scoreType === 'score' && tempAnnotationType === 'score') {\n            acceptAnnotation = true;\n          }\n\n          if (acceptAnnotation) {\n            annotation = tempAnnotation;\n            break;\n          }\n        }\n      }\n    }\n    return annotation;\n  }\n\n  /**\n   * Get the latest comment annotation\n   * @param nodeId the node id\n   * @param componentId the component id\n   * @param workgroupId the workgroup id\n   * @param commentType (optional) the type of comment\n   * e.g.\n   * 'autoComment' for auto graded comment\n   * 'comment' for teacher graded comment\n   * 'any' for auto graded comment or teacher graded comment\n   * @returns the latest comment annotation\n   */\n  getLatestCommentAnnotation(nodeId, componentId, workgroupId, commentType) {\n    let annotation = null;\n    const annotations = this.getAnnotations();\n\n    if (commentType == null) {\n      commentType = 'any';\n    }\n\n    for (let a = annotations.length - 1; a >= 0; a--) {\n      const tempAnnotation = annotations[a];\n      if (tempAnnotation != null) {\n        let acceptAnnotation = false;\n        const tempNodeId = tempAnnotation.nodeId;\n        const tempComponentId = tempAnnotation.componentId;\n        const tempToWorkgroupId = tempAnnotation.toWorkgroupId;\n        const tempAnnotationType = tempAnnotation.type;\n\n        if (nodeId == tempNodeId && componentId == tempComponentId &&\n            workgroupId == tempToWorkgroupId) {\n          if (commentType === 'any' && (tempAnnotationType === 'autoComment' || tempAnnotationType === 'comment')) {\n            acceptAnnotation = true;\n          } else if (commentType === 'autoComment' && tempAnnotationType === 'autoComment') {\n            acceptAnnotation = true;\n          } else if (commentType === 'comment' && tempAnnotationType === 'comment') {\n            acceptAnnotation = true;\n          }\n\n          if (acceptAnnotation) {\n            annotation = tempAnnotation;\n            break;\n          }\n        }\n      }\n    }\n    return annotation;\n  }\n\n  /**\n   * Get the score value from the score annotation\n   * @param scoreAnnotation a score annotation\n   * @returns the score value e.g. 5\n   */\n  getScoreValueFromScoreAnnotation(scoreAnnotation) {\n    if (scoreAnnotation != null) {\n      const data = scoreAnnotation.data;\n\n      if (data != null) {\n        return data.value;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Get all global annotations that are active and inactive for a specified node and component\n   * @returns all global annotations that are active and inactive for a specified node and component\n   */\n  getAllGlobalAnnotationsByNodeIdAndComponentId(nodeId, componentId) {\n    let allGlobalAnnotations = this.getAllGlobalAnnotations();\n    let globalAnnotationsByNodeIdAndComponentId = allGlobalAnnotations.filter((globalAnnotation) => {\n      return globalAnnotation.nodeId === nodeId && globalAnnotation.componentId === componentId;\n    });\n    return globalAnnotationsByNodeIdAndComponentId;\n  };\n\n  /**\n   * Get all global annotations that are active and inactive\n   * @returns all global annotations that are active and inactive\n   */\n  getAllGlobalAnnotations() {\n    let globalAnnotations = [];\n    for (let annotation of this.annotations) {\n      if (annotation != null && annotation.data != null) {\n        if (annotation.data.isGlobal) {\n          globalAnnotations.push(annotation);\n        }\n      }\n    }\n    return globalAnnotations;\n  };\n\n  /**\n   * Get all global annotations that are active and inactive and groups them by annotation group name\n   * @returns all global annotations that are active and inactive\n   */\n  getAllGlobalAnnotationGroups() {\n    let globalAnnotationGroups = [];\n    for (let annotation of this.annotations) {\n      if (annotation != null && annotation.data != null) {\n        if (annotation.data.isGlobal) {\n          // check if this global annotation can be grouped (has the same annotationGroupName as another that we've seen before)\n          if (annotation.data.annotationGroupName != null && annotation.data.annotationGroupCreatedTime != null) {\n            let sameGroupFound = false;\n            for (let globalAnnotationGroup of globalAnnotationGroups) {\n              if (globalAnnotationGroup.annotationGroupNameAndTime == (annotation.data.annotationGroupName + annotation.data.annotationGroupCreatedTime)) {\n                // push this annotation to the end of the group\n                globalAnnotationGroup.annotations.push(annotation);\n                sameGroupFound = true;\n              }\n            }\n            if (!sameGroupFound) {\n              let annotationGroup = {\n                \"annotationGroupNameAndTime\": (annotation.data.annotationGroupName + annotation.data.annotationGroupCreatedTime),\n                \"annotations\": [annotation]\n              };\n              globalAnnotationGroups.push(annotationGroup);\n            }\n          } else {\n            // each global annotation should have a name, so it shouldn't get here\n            console.error(this.$translate('GLOBAL_ANNOTATION_DOES_NOT_HAVE_A_NAME') + annotation);\n          }\n        }\n      }\n    }\n    return globalAnnotationGroups;\n  };\n\n  /**\n   * Get all global annotations that are active\n   * @returns all global annotations that are active, in a group\n   * [\n   * {\n     *   annotationGroupName:\"score1\",\n     *   annotations:[\n     *   {\n     *     type:autoScore,\n     *     value:1\n     *   },\n     *   {\n     *     type:autoComment,\n     *     value:\"you received a score of 1.\"\n     *   }\n     *   ]\n     * },\n   * {\n     *   annotationGroupName:\"score2\",\n     *   annotations:[...]\n     * }\n   * ]\n   */\n  getActiveGlobalAnnotationGroups() {\n    return this.activeGlobalAnnotationGroups;\n  };\n\n  /**\n   * Calculates the active global annotations and groups them by annotation group name\n   */\n  calculateActiveGlobalAnnotationGroups() {\n    this.activeGlobalAnnotationGroups = [];\n\n    for (let annotation of this.annotations) {\n      if (annotation != null && annotation.data != null) {\n        if (annotation.data.isGlobal && annotation.data.unGlobalizedTimestamp == null) {\n          // check if this global annotation can be grouped (has the same annotationGroupName as another that we've seen before)\n          if (annotation.data.annotationGroupName != null) {\n            let sameGroupFound = false;\n            for (let activeGlobalAnnotationGroup of this.activeGlobalAnnotationGroups) {\n              if (activeGlobalAnnotationGroup.annotationGroupName == (annotation.data.annotationGroupName + '_' + annotation.data.annotationGroupCreatedTime)) {\n                // push this annotation to the end of the group\n                activeGlobalAnnotationGroup.annotations.push(annotation);\n                sameGroupFound = true;\n              }\n            }\n            if (!sameGroupFound) {\n              let annotationGroup = {\n                \"annotationGroupName\": annotation.data.annotationGroupName + '_' + annotation.data.annotationGroupCreatedTime,\n                \"annotations\": [annotation],\n                \"nodeId\": annotation.nodeId,\n                \"componentId\": annotation.componentId,\n                \"serverSaveTime\": annotation.serverSaveTime\n              };\n              this.activeGlobalAnnotationGroups.push(annotationGroup);\n            }\n          } else {\n            // each global annotation should have a name, so it shouldn't get here\n            console.error(his.$translate('GLOBAL_ANNOTATION_DOES_NOT_HAVE_A_NAME') + annotation);\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * Get all global annotations that are in-active\n   * @returns all global annotations that are in-active\n   * In-active global annotations has data.isGlobal = false and data.unGlobalizedTimestamp is set.\n   */\n  getInActiveGlobalAnnotations() {\n    let inActiveGlobalAnnotations = [];\n    for (let annotation of this.annotations) {\n      if (annotation != null && annotation.data != null) {\n        if (annotation.data.isGlobal && annotation.data.unGlobalizedTimestamp != null) {\n          inActiveGlobalAnnotations.push(annotation);\n        }\n      }\n    }\n    return inActiveGlobalAnnotations;\n  };\n\n  /**\n   * Get the latest teacher score annotation for a student work id\n   * @param studentWorkId the student work id\n   * @return the latest teacher score annotation for the student work\n   */\n  getLatestTeacherScoreAnnotationByStudentWorkId(studentWorkId) {\n    return this.getLatestAnnotationByStudentWorkIdAndType(studentWorkId, 'score');\n  }\n\n  /**\n   * Get the latest teacher comment annotation for a student work id\n   * @param studentWorkId the student work id\n   * @return the latest teacher comment annotation for the student work\n   */\n  getLatestTeacherCommentAnnotationByStudentWorkId(studentWorkId) {\n    return this.getLatestAnnotationByStudentWorkIdAndType(studentWorkId, 'comment');\n  }\n\n  /**\n   * Get the latest auto score annotation for a student work id\n   * @param studentWorkId the student work id\n   * @return the latest auto score annotation for the student work\n   */\n  getLatestAutoScoreAnnotationByStudentWorkId(studentWorkId) {\n    return this.getLatestAnnotationByStudentWorkIdAndType(studentWorkId, 'autoScore');\n  }\n\n  /**\n   * Get the latest auto comment annotation for a student work id\n   * @param studentWorkId the student work id\n   * @return the latest auto comment annotation for the student work\n   */\n  getLatestAutoCommentAnnotationByStudentWorkId(studentWorkId) {\n    return this.getLatestAnnotationByStudentWorkIdAndType(studentWorkId, 'autoComment');\n  }\n\n  /**\n   * Get the latest annotation for the given student work and annotation type\n   * @param studentWorkId the student work id\n   * @param type the type of annotation\n   * @return the latest annotation for the given student work and annotation type\n   */\n  getLatestAnnotationByStudentWorkIdAndType(studentWorkId, type) {\n    for (let a = this.annotations.length - 1; a >= 0; a--) {\n      const annotation = this.annotations[a];\n\n      if (annotation != null) {\n        if (studentWorkId == annotation.studentWorkId && type == annotation.type) {\n          /*\n           * we have found an annotation with the given student work\n           * id and annotation type\n           */\n          return annotation;\n        }\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Get the annotations for the given student work\n   * @param studentWorkId the student work id\n   * @return array of annotations for the given student work\n   */\n  getAnnotationsByStudentWorkId(studentWorkId) {\n    let annotations = [];\n    for (let annotation of this.annotations) {\n      if (annotation && studentWorkId == annotation.studentWorkId) {\n        annotations.push(annotation);\n      }\n    }\n    return annotations;\n  }\n}\n\nAnnotationService.$inject = [\n  '$filter',\n  '$http',\n  '$q',\n  '$rootScope',\n  'ConfigService',\n  'ProjectService',\n  'UtilService'\n];\n\nexport default AnnotationService;\n"]}