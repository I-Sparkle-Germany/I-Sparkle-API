{"version":3,"sources":["notebookService.es6"],"names":["NotebookService","$http","$q","$rootScope","ConfigService","ProjectService","StudentAssetService","StudentDataService","config","enabled","label","icon","enableAddNew","addIcon","itemTypes","note","requireTextOnEveryNote","enableLink","enableClipping","enableStudentUploads","type","singular","plural","link","color","question","report","notes","reports","notebookConfig","project","notebook","angular","merge","ev","itemId","$broadcast","file","itemToDelete","items","getNotebookByWorkgroup","deletedItems","i","length","item","splice","push","workgroupId","hasOwnProperty","last","reportId","getLatestNotebookItemByLocalNotebookItemId","reportNotes","reportNote","templateReportItem","id","localNotebookItemId","content","periodId","isPreview","getWorkgroupId","notebooksByWorkgroup","allItems","groupNotebookItems","deferred","defer","resolve","promise","method","url","getStudentNotebookURL","params","then","response","allNotebookItems","data","notebookItem","studentAssetId","studentAsset","getAssetById","studentWorkId","studentWork","getStudentWorkByStudentWorkId","fromJson","e","calculateTotalUsage","notebookByWorkgroup","ni","notebookItemLocalNotebookItemId","notebookItemLocalNotebookItemIdKey","allRevisionsForThisLocalNotebookItemId","lastRevision","serverDeleteTime","notebookItemId","nodeId","title","clientSaveTime","clientDeleteTime","reject","headers","getPeriodId","toJson","Date","parse","$","param","result","isOpen","currentNode","componentId","componentType","category","eventData","curentNodeId","event","saveVLEEvent","$inject"],"mappings":"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","file":"notebookService.js","sourcesContent":["class NotebookService {\r\n  constructor($http, $q, $rootScope, ConfigService, ProjectService,\r\n      StudentAssetService, StudentDataService) {\r\n    this.$http = $http;\r\n    this.$q = $q;\r\n    this.$rootScope = $rootScope;\r\n    this.ConfigService = ConfigService;\r\n    this.ProjectService = ProjectService;\r\n    this.StudentAssetService = StudentAssetService;\r\n    this.StudentDataService = StudentDataService;\r\n\r\n    // default notebook configuration\r\n    // TODO: i18n\r\n    // TODO: decide on desired defaults\r\n    // TODO: allow wise instance to set default enabled/disabled for each type in wise config?\r\n    this.config = {\r\n      enabled: false,\r\n      label: \"Notebook\",\r\n      icon: \"book\",\r\n      enableAddNew: true,\r\n      addIcon: \"note_add\",\r\n      itemTypes: {\r\n        note: {\r\n          enabled: true,\r\n          requireTextOnEveryNote: false,\r\n          enableLink: true,\r\n          enableClipping: true,\r\n          enableStudentUploads: true,\r\n          type: \"note\",\r\n          label: {\r\n            singular: \"note\",\r\n            plural: \"notes\",\r\n            link: \"Manage Notes\",\r\n            icon: \"note\",\r\n            color: \"#1565C0\"\r\n          }\r\n        },\r\n        question: {\r\n          enabled: false,\r\n          enableLink: true,\r\n          enableClipping: true,\r\n          enableStudentUploads: true,\r\n          type: \"question\",\r\n          label: {\r\n            singular: \"question\",\r\n            plural: \"questions\",\r\n            link: \"Manage Questions\",\r\n            icon: \"live_help\",\r\n            color: \"#F57C00\"\r\n          }\r\n        },\r\n        report: {\r\n          enabled: false,\r\n          enableLink: true,\r\n          type: \"report\",\r\n          label: {\r\n            singular: \"report\",\r\n            plural: \"reports\",\r\n            link: \"Report\",\r\n            icon: \"assignment\",\r\n            color: \"#AD1457\"\r\n          },\r\n          notes: []\r\n        }\r\n      }\r\n    };\r\n\r\n    this.reports = [];\r\n\r\n    this.notebookConfig = {};\r\n    if (this.ProjectService.project) {\r\n      this.notebookConfig = this.ProjectService.project.notebook;\r\n      // update local notebook config, preserving any defaults that aren't overriden\r\n      if (this.notebookConfig !== null && typeof this.notebookConfig === 'object') {\r\n        this.config = angular.merge(this.config, this.notebookConfig);\r\n      }\r\n    }\r\n  }\r\n\r\n  editItem(ev, itemId) {\r\n    this.$rootScope.$broadcast('editNote', {itemId: itemId, ev: ev});\r\n  };\r\n\r\n  addNewItem(ev, file) {\r\n    this.$rootScope.$broadcast('addNewNote', {ev: ev, file: file});\r\n  };\r\n\r\n  deleteItem(itemToDelete) {\r\n    const items = this.getNotebookByWorkgroup().items;\r\n    const deletedItems = this.getNotebookByWorkgroup().deletedItems;\r\n    for (let i = 0; i < items.length; i++) {\r\n      const item = items[i];\r\n      if (item === itemToDelete) {\r\n        items.splice(i, 1);\r\n        deletedItems.push(itemToDelete);\r\n      }\r\n    }\r\n  };\r\n\r\n  // looks up notebook item by local notebook item id, including deleted notes\r\n  getLatestNotebookItemByLocalNotebookItemId(itemId, workgroupId = null) {\r\n    if (this.getNotebookByWorkgroup(workgroupId).items.hasOwnProperty(itemId)) {\r\n      const items = this.getNotebookByWorkgroup(workgroupId).items[itemId];\r\n      return items.last();\r\n    } else if (this.getNotebookByWorkgroup(workgroupId).deletedItems.hasOwnProperty(itemId)) {\r\n      const items = this.getNotebookByWorkgroup(workgroupId).deletedItems[itemId];\r\n      return items.last();\r\n    } else {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // returns student's report item if they've done work, or the template if they haven't.\r\n  getLatestNotebookReportItemByReportId(reportId, workgroupId = null) {\r\n    return this.getLatestNotebookItemByLocalNotebookItemId(reportId, workgroupId);\r\n  }\r\n\r\n  // returns the authored report item\r\n  getTemplateReportItemByReportId(reportId) {\r\n    const reportNotes = this.notebookConfig.itemTypes.report.notes;\r\n    for (let reportNote of reportNotes) {\r\n      if (reportNote.reportId == reportId) {\r\n        let templateReportItem = {\r\n          id: null,\r\n          type: \"report\",\r\n          localNotebookItemId: reportId,\r\n          content: reportNote\r\n        };\r\n        return templateReportItem;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  calculateTotalUsage() {\r\n    // get the total size\r\n    /*\r\n    let totalSizeSoFar = 0;\r\n    for (let i = 0; i < this.getNotebookByWorkgroup().items.length; i++) {\r\n        const notebookItem = this.getNotebookByWorkgroup().items[i];\r\n        if (notebookItem.studentAsset != null) {\r\n            const notebookItemSize = notebookItem.studentAsset.fileSize;\r\n            totalSizeSoFar += notebookItemSize;\r\n        }\r\n    }\r\n    this.getNotebookByWorkgroup().totalSize = totalSizeSoFar;\r\n    this.getNotebookByWorkgroup().totalSizeMax = this.ConfigService.getStudentMaxTotalAssetsSize();\r\n    this.getNotebookByWorkgroup().usagePercentage = this.notebook.totalSize / this.notebook.totalSizeMax * 100;\r\n    */\r\n  };\r\n\r\n  getNotebookConfig() {\r\n    return this.config;\r\n  };\r\n\r\n  /**\r\n   * Returns the report content for the specified reportId, or null if not exists.\r\n   * @param reportId\r\n   */\r\n  getReportNoteContentByReportId(reportId) {\r\n    const reportNotes = this.notebookConfig.itemTypes.report.notes;\r\n    for (let reportNote of reportNotes) {\r\n      if (reportNote.reportId === reportId) {\r\n        return reportNote;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  isNotebookEnabled() {\r\n    return this.config.enabled;\r\n  };\r\n\r\n  retrieveNotebookItems(workgroupId = null, periodId = null) {\r\n    if (this.ConfigService.isPreview()) {\r\n      // we are previewing the project, initialize dummy student data\r\n      const workgroupId = this.ConfigService.getWorkgroupId();\r\n      this.notebooksByWorkgroup = {};\r\n      this.notebooksByWorkgroup[workgroupId] = {};\r\n      this.notebooksByWorkgroup[workgroupId].allItems = [];\r\n      this.notebooksByWorkgroup[workgroupId].items = [];\r\n      this.notebooksByWorkgroup[workgroupId].deletedItems = [];\r\n      this.groupNotebookItems();\r\n      // if we're in preview, don't make any request to the server but pretend we did\r\n      const deferred = this.$q.defer();\r\n      deferred.resolve(this.notebooksByWorkgroup[workgroupId]);\r\n      return deferred.promise;\r\n    } else {\r\n      const config = {\r\n        method : 'GET',\r\n        url : this.ConfigService.getStudentNotebookURL(),\r\n        params : {}\r\n      };\r\n      if (workgroupId != null) {\r\n        config.params.workgroupId = workgroupId;\r\n      }\r\n      if (periodId != null) {\r\n        config.params.periodId = periodId;\r\n      }\r\n      return this.$http(config).then((response) => {\r\n        this.notebooksByWorkgroup = {};\r\n        const allNotebookItems = response.data;\r\n        for (let notebookItem of allNotebookItems) {\r\n          try {\r\n            if (notebookItem.studentAssetId != null) {\r\n              // if this notebook item is a StudentAsset item, add the association here\r\n              notebookItem.studentAsset = this.StudentAssetService.getAssetById(notebookItem.studentAssetId);\r\n            } else if (notebookItem.studentWorkId != null) {\r\n              // if this notebook item is a StudentWork item, add the association here\r\n              notebookItem.studentWork = this.StudentDataService.getStudentWorkByStudentWorkId(notebookItem.studentWorkId);\r\n            } else if (notebookItem.type === \"note\" || notebookItem.type === \"report\") {\r\n              notebookItem.content = angular.fromJson(notebookItem.content);\r\n            }\r\n            const workgroupId = notebookItem.workgroupId;\r\n            if (this.notebooksByWorkgroup.hasOwnProperty(workgroupId)) {\r\n              // we already have create a notebook for this workgroup before, so we'll append this notebook item to the array\r\n              this.notebooksByWorkgroup[workgroupId].allItems.push(notebookItem);\r\n            } else {\r\n              // otherwise, we'll create a new notebook field and add the item to the array\r\n              this.notebooksByWorkgroup[workgroupId] = { allItems: [notebookItem] };\r\n            }\r\n          } catch (e) {\r\n            // keep going, ignore this error\r\n          }\r\n        }\r\n        this.groupNotebookItems(); // group notebook items based on item.localNotebookItemId\r\n        this.calculateTotalUsage();\r\n\r\n        return this.notebooksByWorkgroup;\r\n      });\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Groups the notebook items together in to a map-like structure inside this.notebook.items.\r\n   * {\r\n   *    \"abc123\": [{localNotebookItemId:\"abc123\", \"text\":\"first revision\"}, {localNotebookItemId:\"abc123\", \"text\":\"second revision\"}],\r\n   *    \"def456\": [{localNotebookItemId:\"def456\", \"text\":\"hello\"}, {localNotebookItemId:\"def456\", \"text\":\"hello my friend\"}]\r\n   * }\r\n   */\r\n  groupNotebookItems() {\r\n    for (let workgroupId in this.notebooksByWorkgroup) {\r\n      if (this.notebooksByWorkgroup.hasOwnProperty(workgroupId)) {\r\n        const notebookByWorkgroup = this.notebooksByWorkgroup[workgroupId];\r\n        notebookByWorkgroup.items = {};\r\n        notebookByWorkgroup.deletedItems = {};  // reset deleted items\r\n        for (let ni = 0; ni < notebookByWorkgroup.allItems.length; ni++) {\r\n          const notebookItem = notebookByWorkgroup.allItems[ni];\r\n          const notebookItemLocalNotebookItemId = notebookItem.localNotebookItemId;\r\n          if (notebookByWorkgroup.items.hasOwnProperty(notebookItemLocalNotebookItemId)) {\r\n            // if this was already added before, we'll append this notebook item to the array\r\n            notebookByWorkgroup.items[notebookItemLocalNotebookItemId].push(notebookItem);\r\n          } else {\r\n            // otherwise, we'll create a new field and add the item to the array\r\n            notebookByWorkgroup.items[notebookItemLocalNotebookItemId] = [notebookItem];\r\n          }\r\n        }\r\n        // now go through the items and look at the last revision of each item. If it's deleted, then move the entire item array to deletedItems\r\n        for (let notebookItemLocalNotebookItemIdKey in notebookByWorkgroup.items) {\r\n          if (notebookByWorkgroup.items.hasOwnProperty(notebookItemLocalNotebookItemIdKey)) {\r\n            // get the last note revision\r\n            const allRevisionsForThisLocalNotebookItemId = notebookByWorkgroup.items[notebookItemLocalNotebookItemIdKey];\r\n            if (allRevisionsForThisLocalNotebookItemId != null) {\r\n              const lastRevision = allRevisionsForThisLocalNotebookItemId[allRevisionsForThisLocalNotebookItemId.length - 1];\r\n              if (lastRevision != null && lastRevision.serverDeleteTime != null) {\r\n                // the last revision for this not deleted, so move the entire note (with all its revisions) to deletedItems\r\n                notebookByWorkgroup.deletedItems[notebookItemLocalNotebookItemIdKey] = allRevisionsForThisLocalNotebookItemId;\r\n                delete notebookByWorkgroup.items[notebookItemLocalNotebookItemIdKey];  // then remove it from the items array\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns the notebook item with the specified notebook item id.\r\n   */\r\n  getNotebookItemByNotebookItemId(notebookItemId, workgroupId = null) {\r\n    const notebookByWorkgroup = this.getNotebookByWorkgroup(workgroupId);\r\n    if (notebookByWorkgroup != null) {\r\n      const allNotebookItems = notebookByWorkgroup.allItems;\r\n      for (let notebookItem of allNotebookItems) {\r\n        if (notebookItem.id === notebookItemId) {\r\n          return notebookItem;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  getNotebookByWorkgroup(workgroupId = null) {\r\n    if (workgroupId == null) {\r\n      workgroupId = this.ConfigService.getWorkgroupId();\r\n    }\r\n    let notebookByWorkgroup = this.notebooksByWorkgroup[workgroupId];\r\n    if (notebookByWorkgroup == null) {\r\n      notebookByWorkgroup = {\r\n        allItems: [],\r\n        items: {},\r\n        deletedItems: {}\r\n      }\r\n    }\r\n    return notebookByWorkgroup;\r\n  }\r\n\r\n  saveNotebookItem(notebookItemId, nodeId, localNotebookItemId, type, title, content, clientSaveTime = null, clientDeleteTime = null) {\r\n    if (this.ConfigService.isPreview()) {\r\n      return this.$q((resolve, reject) => {\r\n        let notebookItem = {\r\n          content: content,\r\n          localNotebookItemId: localNotebookItemId,\r\n          nodeId: nodeId,\r\n          notebookItemId: notebookItemId,\r\n          title: title,\r\n          type: type,\r\n          workgroupId: this.ConfigService.getWorkgroupId(),\r\n          clientSaveTime: clientSaveTime,\r\n          clientDeleteTime: clientDeleteTime\r\n        };\r\n        if (clientDeleteTime != null) {\r\n          // preview user wants to delete this note, so mock the server deletion by setting the server delete time\r\n          notebookItem.serverDeleteTime = clientDeleteTime;\r\n        } else {\r\n          notebookItem.serverDeleteTime = null;\r\n        }\r\n        // add/update notebook\r\n        let workgroupId = notebookItem.workgroupId;\r\n        if (this.notebooksByWorkgroup.hasOwnProperty(workgroupId)) {\r\n          // we already have create a notebook for this workgroup before, so we'll append this notebook item to the array\r\n          this.notebooksByWorkgroup[workgroupId].allItems.push(notebookItem);\r\n        } else {\r\n          // otherwise, we'll create a new notebook field and add the item to the array\r\n          this.notebooksByWorkgroup[workgroupId] = { allItems: [notebookItem] };\r\n        }\r\n\r\n        this.groupNotebookItems();\r\n        this.groupNotebookItems();\r\n        this.$rootScope.$broadcast('notebookUpdated', {notebook: this.notebooksByWorkgroup[workgroupId]});\r\n        resolve();\r\n      });\r\n    } else {\r\n      let config = {\r\n        method: \"POST\",\r\n        url: this.ConfigService.getStudentNotebookURL(),\r\n        headers: {'Content-Type': 'application/x-www-form-urlencoded'}\r\n      };\r\n      let params = {\r\n        workgroupId: this.ConfigService.getWorkgroupId(),\r\n        periodId: this.ConfigService.getPeriodId(),\r\n        notebookItemId: notebookItemId,\r\n        localNotebookItemId: localNotebookItemId,\r\n        nodeId: nodeId,\r\n        type: type,\r\n        title: title,\r\n        content: angular.toJson(content),\r\n        clientSaveTime: Date.parse(new Date()),\r\n        clientDeleteTime: clientDeleteTime\r\n      };\r\n      if (params.clientSaveTime == null) {\r\n        params.clientSaveTime = Date.parse(new Date());\r\n      }\r\n      config.data = $.param(params);\r\n\r\n      return this.$http(config).then((result) => {\r\n        let notebookItem = result.data;\r\n        if (notebookItem != null) {\r\n          if (notebookItem.type === \"note\" || notebookItem.type === \"report\") {\r\n            notebookItem.content = angular.fromJson(notebookItem.content);\r\n          }\r\n          // add/update notebook\r\n          let workgroupId = notebookItem.workgroupId;\r\n          if (this.notebooksByWorkgroup.hasOwnProperty(workgroupId)) {\r\n            // we already have create a notebook for this workgroup before, so we'll append this notebook item to the array\r\n            this.notebooksByWorkgroup[workgroupId].allItems.push(notebookItem);\r\n          } else {\r\n            // otherwise, we'll create a new notebook field and add the item to the array\r\n            this.notebooksByWorkgroup[workgroupId] = { allItems: [notebookItem] };\r\n          }\r\n\r\n          this.groupNotebookItems();\r\n          this.$rootScope.$broadcast('notebookUpdated', {notebook: this.notebooksByWorkgroup[workgroupId]});\r\n        }\r\n        return result.data;\r\n      });\r\n    }\r\n  };\r\n\r\n  saveNotebookToggleEvent(isOpen, currentNode) {\r\n    let nodeId = null, componentId = null, componentType = null, category = \"Notebook\";\r\n    let eventData = {\r\n      curentNodeId: currentNode == null ? null : currentNode.id\r\n    };\r\n    let event = isOpen ? \"notebookOpened\" : \"notebookClosed\";\r\n    this.StudentDataService.saveVLEEvent(nodeId, componentId, componentType, category, event, eventData);\r\n  };\r\n}\r\n\r\nNotebookService.$inject = [\r\n  '$http',\r\n  '$q',\r\n  '$rootScope',\r\n  'ConfigService',\r\n  'ProjectService',\r\n  'StudentAssetService',\r\n  'StudentDataService'\r\n];\r\n\r\nexport default NotebookService;\r\n"]}