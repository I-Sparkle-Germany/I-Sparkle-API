{"version":3,"sources":["projectAssetService.es6"],"names":["ProjectAssetService","$q","$http","$rootScope","ConfigService","ProjectService","Upload","UtilService","projectAssets","projectAssetTotalSizeMax","getConfigParam","projectAssetUsagePercentage","assetItem","params","assetFileName","fileName","httpParams","method","url","headers","data","$","param","then","result","projectAssetsJSON","window","location","projectAssetURL","get","calculateAssetUsage","files","promises","map","file","upload","fields","progress","evt","progressPercentage","parseInt","loaded","total","success","status","config","uploadedFilename","name","alert","all","assets","projectJSONString","angular","toJson","project","usedHtmlFiles","a","length","asset","endsWith","indexOf","push","getHtmlFiles","htmlFiles","allContent","h","htmlFile","htmlFileContent","used","htmlFileNames","projectAssetsDirectoryPath","getProjectAssetsDirectoryPath","htmlFileName","promise","$inject"],"mappings":"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","file":"projectAssetService.js","sourcesContent":["class ProjectAssetService {\n    constructor($q, $http, $rootScope, ConfigService, ProjectService, Upload, UtilService) {\n        this.$q = $q;\n        this.$http = $http;\n        this.$rootScope = $rootScope;\n        this.ConfigService = ConfigService;\n        this.ProjectService = ProjectService;\n        this.Upload = Upload;\n        this.UtilService = UtilService;\n        this.projectAssets = {};\n        this.projectAssetTotalSizeMax = this.ConfigService.getConfigParam('projectAssetTotalSizeMax');\n        this.projectAssetUsagePercentage = 0;\n    }\n\n    deleteAssetItem(assetItem) {\n\n        let params = {\n            assetFileName: assetItem.fileName\n        };\n\n        let httpParams = {\n            method: 'POST',\n            url: this.ConfigService.getConfigParam('projectAssetURL'),\n            headers: {'Content-Type': 'application/x-www-form-urlencoded'},\n            data: $.param(params)\n        };\n\n        return this.$http(httpParams).then((result) => {\n            let projectAssetsJSON = result.data;\n            this.projectAssets = projectAssetsJSON;\n            return projectAssetsJSON;\n        });\n    }\n\n    downloadAssetItem(assetItem) {\n      let assetFileName = assetItem.fileName;\n\n      // ask the browser to download this asset by setting the location\n      window.location = this.ConfigService.getConfigParam('projectAssetURL') + \"/download?assetFileName=\" + assetFileName;\n    }\n\n    getFullAssetItemURL(assetItem) {\n        return this.ConfigService.getConfigParam('projectBaseURL') + \"assets/\" + assetItem.fileName;\n    }\n\n    retrieveProjectAssets() {\n        var projectAssetURL = this.ConfigService.getConfigParam('projectAssetURL');\n\n        return this.$http.get(projectAssetURL).then((result) => {\n            var projectAssetsJSON = result.data;\n            this.projectAssets = projectAssetsJSON;\n            this.calculateAssetUsage();\n            return projectAssetsJSON;\n        });\n    }\n\n    uploadAssets(files) {\n        var projectAssetURL = this.ConfigService.getConfigParam('projectAssetURL');\n\n        var promises = files.map((file) => {\n            return this.Upload.upload({\n                url: projectAssetURL,\n                fields: {\n                },\n                file: file\n            }).progress((evt) => {\n                var progressPercentage = parseInt(100.0 * evt.loaded / evt.total);\n                //console.log('progress: ' + progressPercentage + '% ' + evt.config.file.name);\n            }).success((result, status, headers, config) => {\n                // Only set the projectAssets if the result is an object.\n                // Sometimes it's an error message string.\n                if (typeof result === 'object') {\n                    // upload was successful.\n                    this.projectAssets = result;\n                    let uploadedFilename = config.file.name;\n                    return uploadedFilename;\n                } else if (typeof result === 'string') {\n                    // This is an error and should be displayed to the user.\n                    alert(result);\n                }\n\n                return result;\n            });\n        });\n        return this.$q.all(promises);\n    }\n\n    /**\n     * Calculate which assets are used or not used\n     */\n    calculateAssetUsage() {\n\n        /*\n         * a list of all the project assets. each element in the list is an\n         * object that contains the file name and file size\n         */\n        var assets = this.projectAssets;\n\n        // get the project content as a string\n        var projectJSONString = angular.toJson(this.ProjectService.project);\n\n        // an array to hold the html files that the project uses\n        var usedHtmlFiles = [];\n\n        if (assets != null && assets.files != null) {\n\n            /*\n             * loop through all the asset files to find the html files that\n             * are actually used in the project\n             */\n            for (var a = 0; a < assets.files.length; a++) {\n                var asset = assets.files[a];\n\n                if (asset != null) {\n                    var fileName = asset.fileName;\n\n                    // check if the file is an html file\n                    if (this.UtilService.endsWith(fileName, \".html\") || this.UtilService.endsWith(fileName, \".htm\")) {\n                        // the file is an html file\n\n                        // check if the html file is used in the project\n                        if (projectJSONString.indexOf(fileName) != -1) {\n                            // the file is used in the project\n                            usedHtmlFiles.push(fileName);\n                        }\n                    }\n                }\n            }\n        }\n\n        /*\n         * Retrieve all the html files that are used in the project. If there\n         * are not html files that are used in the project, then then() will\n         * still be called.\n         */\n        this.getHtmlFiles(usedHtmlFiles).then((htmlFiles) => {\n\n            /*\n             * this variable will hold the project json string as well as\n             * the html file content so we can look for assets that are used\n             * in the project\n             */\n            var allContent = projectJSONString;\n\n            // loop through all the html files that are used in the project\n            for (var h = 0; h < htmlFiles.length; h++) {\n                var htmlFile = htmlFiles[h];\n\n                if (htmlFile != null) {\n\n                    // get the html file content\n                    var htmlFileContent = htmlFile.data;\n\n                    // add the html file content to our allContent variable\n                    allContent += '\\n';\n                    allContent += htmlFileContent;\n                }\n            }\n\n            if (assets != null && assets.files != null) {\n\n                // loop through all the assets\n                for (var a = 0; a < assets.files.length; a++) {\n                    var asset = assets.files[a];\n\n                    if (asset != null) {\n                        var fileName = asset.fileName;\n\n                        if (allContent.indexOf(fileName) != -1) {\n                            // the file is used in the project\n                            asset.used = true;\n                        } else {\n                            // the file is not used in the project\n                            asset.used = false;\n                        }\n                    }\n                }\n            }\n        });\n    }\n\n    /**\n     * Retrieve html files using a promise all\n     * @param htmlFileNames a list of html file names\n     * @return a promise that will retrieve all the html files\n     */\n    getHtmlFiles(htmlFileNames) {\n\n        var promises = [];\n\n        // get the project assets path e.g. /wise/curriculum/3/assets\n        var projectAssetsDirectoryPath = this.ConfigService.getProjectAssetsDirectoryPath();\n\n        // loop through all the html file names\n        for (var h = 0; h < htmlFileNames.length; h++) {\n\n            // get an html file name\n            var htmlFileName = htmlFileNames[h];\n\n            // create a promise that will return the contents of the html file\n            var promise = this.$http.get(projectAssetsDirectoryPath + '/' + htmlFileName);\n\n            // add the promise to our list of promises\n            promises.push(promise);\n        }\n\n        return this.$q.all(promises);\n    }\n}\n\nProjectAssetService.$inject = [\n    '$q',\n    '$http',\n    '$rootScope',\n    'ConfigService',\n    'ProjectService',\n    'Upload',\n    'UtilService'\n];\n\nexport default ProjectAssetService;\n"]}