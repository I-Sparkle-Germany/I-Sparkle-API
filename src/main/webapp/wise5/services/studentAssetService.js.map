{"version":3,"sources":["studentAssetService.es6"],"names":[],"mappings":"AAAA;;;;;;;;;;IAEM,mB;AACF,iCAAY,KAAZ,EAAmB,EAAnB,EAAuB,MAAvB,EAA+B,UAA/B,EAA2C,aAA3C,EAA0D;AAAA;;AACtD,aAAK,KAAL,GAAa,KAAb;AACA,aAAK,EAAL,GAAU,EAAV;AACA,aAAK,MAAL,GAAc,MAAd;AACA,aAAK,UAAL,GAAkB,UAAlB;AACA,aAAK,aAAL,GAAqB,aAArB;;AAEA,aAAK,SAAL,GAAiB,EAAjB,CAPsD,CAOhC;AACzB;;;;qCAEY,O,EAAS;AAClB,iBAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,KAAK,SAAL,CAAe,MAAnC,EAA2C,GAA3C,EAAgD;AAC5C,oBAAI,QAAQ,KAAK,SAAL,CAAe,CAAf,CAAZ;AACA,oBAAI,MAAM,EAAN,KAAa,OAAjB,EAA0B;AACtB,2BAAO,KAAP;AACH;AACJ;AACD,mBAAO,IAAP;AACH;;;yCAEgB;AAAA;;AACb,gBAAI,SAAS,EAAb;AACA,mBAAO,MAAP,GAAgB,KAAhB;AACA,mBAAO,GAAP,GAAa,KAAK,aAAL,CAAmB,mBAAnB,EAAb;AACA,mBAAO,MAAP,GAAgB,EAAhB;AACA,mBAAO,MAAP,CAAc,WAAd,GAA4B,KAAK,aAAL,CAAmB,cAAnB,EAA5B;AACA,mBAAO,KAAK,KAAL,CAAW,MAAX,EAAmB,IAAnB,CAAwB,UAAC,QAAD,EAAc;AACzC;AACA,oBAAI,SAAS,EAAb;AACA,oBAAI,SAAS,SAAS,IAAtB;AACA,oBAAI,wBAAwB,MAAK,aAAL,CAAmB,wBAAnB,EAA5B;AACA,qBAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,OAAO,MAA3B,EAAmC,GAAnC,EAAwC;AACpC,wBAAI,QAAQ,OAAO,CAAP,CAAZ;AACA,wBAAI,CAAC,MAAM,YAAP,IAAuB,MAAM,gBAAN,IAA0B,IAAjD,IAAyD,MAAM,QAAN,KAAmB,WAAhF,EAA6F;AACzF,8BAAM,GAAN,GAAY,wBAAwB,MAAM,QAA1C;AACA,4BAAI,MAAK,OAAL,CAAa,KAAb,CAAJ,EAAyB;AACrB,kCAAM,IAAN,GAAa,OAAb;AACA,kCAAM,OAAN,GAAgB,MAAM,GAAtB;AACH,yBAHD,MAGO,IAAI,MAAK,OAAL,CAAa,KAAb,CAAJ,EAAyB;AAC5B,kCAAM,IAAN,GAAa,OAAb;AACA,kCAAM,OAAN,GAAgB,8BAAhB;AACH,yBAHM,MAGA;AACH,kCAAM,IAAN,GAAa,MAAb;AACA,kCAAM,OAAN,GAAgB,6BAAhB;AACH;AACD,+BAAO,IAAP,CAAY,KAAZ;AACH;AACJ;AACD,sBAAK,SAAL,GAAiB,MAAjB;AACA,uBAAO,MAAP;AACH,aAxBM,CAAP;AAyBH;;;wCAEe,K,EAAO;AACnB,gBAAI,kBAAkB,MAAM,GAA5B;;AAEA;AACA,gBAAI,SAAS,EAAb;AACA,mBAAO,MAAP,GAAgB,KAAhB;AACA,mBAAO,GAAP,GAAa,eAAb;AACA,mBAAO,KAAK,KAAL,CAAW,MAAX,EAAmB,IAAnB,CAAwB,UAAC,QAAD,EAAc;AACzC,uBAAO,SAAS,IAAhB;AACH,aAFM,CAAP;AAGH;;;gCAEO,K,EAAO;AACX,gBAAI,UAAU,KAAd;AACA,gBAAI,sBAAsB,CAAC,KAAD,EAAQ,KAAR,EAAe,MAAf,EAAuB,KAAvB,CAA1B;AACA,gBAAI,SAAS,IAAb,EAAmB;AACf,oBAAI,WAAW,MAAM,GAArB;AACA,oBAAI,YAAY,IAAZ,IAAoB,SAAS,WAAT,CAAqB,GAArB,MAA8B,CAAC,CAAvD,EAA0D;AACtD,wBAAI,iBAAiB,SAAS,SAAT,CAAmB,SAAS,WAAT,CAAqB,GAArB,IAA4B,CAA/C,CAArB;AACA,wBAAI,oBAAoB,OAApB,CAA4B,eAAe,WAAf,EAA5B,KAA6D,CAAC,CAAlE,EAAqE;AACjE,kCAAU,IAAV;AACH;AACJ;AACJ;AACD,mBAAO,OAAP;AACH;;;gCAEO,K,EAAO;AACX,gBAAI,UAAU,KAAd;AACA,gBAAI,sBAAsB,CAAC,KAAD,EAAQ,KAAR,EAAe,KAAf,EAAsB,KAAtB,EAA6B,KAA7B,EAAoC,KAApC,EAA2C,MAA3C,CAA1B;AACA,gBAAI,SAAS,IAAb,EAAmB;AACf,oBAAI,WAAW,MAAM,GAArB;AACA,oBAAI,YAAY,IAAZ,IAAoB,SAAS,WAAT,CAAqB,GAArB,KAA6B,CAAC,CAAtD,EAAyD;AACrD,wBAAI,iBAAiB,SAAS,SAAT,CAAmB,SAAS,WAAT,CAAqB,GAArB,IAA4B,CAA/C,CAArB;AACA,wBAAI,oBAAoB,OAApB,CAA4B,eAAe,WAAf,EAA5B,KAA6D,CAAC,CAAlE,EAAqE;AACjE,kCAAU,IAAV;AACH;AACJ;AACJ;AACD,mBAAO,OAAP;AACH;;;oCAEW,I,EAAM;AAAA;;AACd,gBAAI,mBAAmB,KAAK,aAAL,CAAmB,mBAAnB,EAAvB;AACA,gBAAI,WAAW,KAAK,EAAL,CAAQ,KAAR,EAAf;;AAEA,iBAAK,MAAL,CAAY,MAAZ,CAAmB;AACf,qBAAK,gBADU;AAEf,wBAAQ;AACJ,6BAAS,KAAK,aAAL,CAAmB,QAAnB,EADL;AAEJ,mCAAe,KAAK,aAAL,CAAmB,cAAnB,EAFX;AAGJ,gCAAY,KAAK,aAAL,CAAmB,WAAnB,EAHR;AAIJ,sCAAkB,KAAK,KAAL,CAAW,IAAI,IAAJ,EAAX;AAJd,iBAFO;AAQf,sBAAM;AARS,aAAnB,EASG,OATH,CASW,UAAC,KAAD,EAAQ,MAAR,EAAgB,OAAhB,EAAyB,MAAzB,EAAoC;AAC3C,oBAAI,UAAU,OAAd,EAAuB;AACnB,0BAAM,+BAAN;AACH,iBAFD,MAEO;AACH,wBAAI,wBAAwB,OAAK,aAAL,CAAmB,wBAAnB,EAA5B;AACA,0BAAM,GAAN,GAAY,wBAAwB,MAAM,QAA1C;AACA,wBAAI,OAAK,OAAL,CAAa,KAAb,CAAJ,EAAyB;AACrB,8BAAM,IAAN,GAAa,OAAb;AACA,8BAAM,OAAN,GAAgB,MAAM,GAAtB;AACH,qBAHD,MAGO,IAAI,OAAK,OAAL,CAAa,KAAb,CAAJ,EAAyB;AAC5B,8BAAM,IAAN,GAAa,OAAb;AACA,8BAAM,OAAN,GAAgB,8BAAhB;AACH,qBAHM,MAGA;AACH,8BAAM,IAAN,GAAa,MAAb;AACA,8BAAM,OAAN,GAAgB,6BAAhB;AACH;AACD,2BAAK,SAAL,CAAe,IAAf,CAAoB,KAApB;AACA,2BAAK,UAAL,CAAgB,UAAhB,CAA2B,sBAA3B;AACA,6BAAS,OAAT,CAAiB,KAAjB;AACH;AACJ,aA7BD,EA6BG,KA7BH,CA6BS,UAAC,KAAD,EAAQ,MAAR,EAAgB,OAAhB,EAAyB,MAAzB,EAAoC;AACzC,sBAAM,8JAAN;AACH,aA/BD;;AAiCA,mBAAO,SAAS,OAAhB;AACH;;;qCAEY,K,EAAO;AAAA;;AAChB,gBAAI,mBAAmB,KAAK,aAAL,CAAmB,mBAAnB,EAAvB;AACA,gBAAI,WAAW,MAAM,GAAN,CAAU,UAAC,IAAD,EAAU;AAC/B,uBAAO,OAAK,MAAL,CAAY,MAAZ,CAAmB;AACtB,yBAAK,gBADiB;AAEtB,4BAAQ;AACJ,iCAAS,OAAK,aAAL,CAAmB,QAAnB,EADL;AAEJ,uCAAe,OAAK,aAAL,CAAmB,cAAnB,EAFX;AAGJ,oCAAY,OAAK,aAAL,CAAmB,WAAnB,EAHR;AAIJ,0CAAkB,KAAK,KAAL,CAAW,IAAI,IAAJ,EAAX;AAJd,qBAFc;AAQtB,0BAAM;AARgB,iBAAnB,EASJ,QATI,CASK,UAAC,GAAD,EAAS;AACjB,wBAAI,qBAAqB,SAAS,QAAQ,IAAI,MAAZ,GAAqB,IAAI,KAAlC,CAAzB;AACA;AACH,iBAZM,EAYJ,OAZI,CAYI,UAAC,IAAD,EAAO,MAAP,EAAe,OAAf,EAAwB,MAAxB,EAAmC;AAC1C;AACH,iBAdM,CAAP;AAeH,aAhBc,CAAf;AAiBA,mBAAO,KAAK,EAAL,CAAQ,GAAR,CAAY,QAAZ,CAAP;AACH;;;;;AAED;8CACsB,Y,EAAc;AAAA;;AAChC,gBAAI,SAAS,EAAb;AACA,mBAAO,MAAP,GAAgB,MAAhB;AACA,mBAAO,GAAP,GAAa,KAAK,aAAL,CAAmB,mBAAnB,KAA2C,OAAxD;AACA,mBAAO,OAAP,GAAiB,EAAC,gBAAgB,mCAAjB,EAAjB;AACA,gBAAI,SAAS,EAAb;AACA,mBAAO,cAAP,GAAwB,aAAa,EAArC;AACA,mBAAO,WAAP,GAAqB,KAAK,aAAL,CAAmB,cAAnB,EAArB;AACA,mBAAO,QAAP,GAAkB,KAAK,aAAL,CAAmB,WAAnB,EAAlB;AACA,mBAAO,cAAP,GAAwB,KAAK,KAAL,CAAW,IAAI,IAAJ,EAAX,CAAxB;;AAEA,mBAAO,IAAP,GAAc,EAAE,KAAF,CAAQ,MAAR,CAAd;;AAEA,mBAAO,KAAK,KAAL,CAAW,MAAX,EAAmB,IAAnB,CAAwB,UAAC,MAAD,EAAY;AACvC,oBAAI,cAAc,OAAO,IAAzB;AACA,oBAAI,eAAe,IAAnB,EAAyB;AACrB,wBAAI,wBAAwB,OAAK,aAAL,CAAmB,wBAAnB,EAA5B;AACA,wBAAI,YAAY,YAAZ,IAA4B,YAAY,QAAZ,KAAyB,WAAzD,EAAsE;AAClE,oCAAY,GAAZ,GAAkB,wBAAwB,YAAY,QAAtD;AACA,4BAAI,OAAK,OAAL,CAAa,WAAb,CAAJ,EAA+B;AAC3B,wCAAY,IAAZ,GAAmB,OAAnB;AACA,wCAAY,OAAZ,GAAsB,YAAY,GAAlC;AACH,yBAHD,MAGO,IAAI,OAAK,OAAL,CAAa,WAAb,CAAJ,EAA+B;AAClC,wCAAY,IAAZ,GAAmB,OAAnB;AACA,wCAAY,OAAZ,GAAsB,8BAAtB;AACH,yBAHM,MAGA;AACH,wCAAY,IAAZ,GAAmB,MAAnB;AACA,wCAAY,OAAZ,GAAsB,6BAAtB;AACH;AACD;AACA,+BAAO,WAAP;AACH;AACJ;AACD,uBAAO,IAAP;AACH,aArBM,CAAP;AAsBH;;;oCAEW,Y,EAAc;AAAA;;AACtB,gBAAI,SAAS,EAAb;AACA,mBAAO,MAAP,GAAgB,MAAhB;AACA,mBAAO,GAAP,GAAa,KAAK,aAAL,CAAmB,mBAAnB,KAA2C,SAAxD;AACA,mBAAO,OAAP,GAAiB,EAAC,gBAAgB,mCAAjB,EAAjB;AACA,gBAAI,SAAS,EAAb;AACA,mBAAO,cAAP,GAAwB,aAAa,EAArC;AACA,mBAAO,WAAP,GAAqB,KAAK,aAAL,CAAmB,cAAnB,EAArB;AACA,mBAAO,QAAP,GAAkB,KAAK,aAAL,CAAmB,WAAnB,EAAlB;AACA,mBAAO,gBAAP,GAA0B,KAAK,KAAL,CAAW,IAAI,IAAJ,EAAX,CAA1B;AACA,mBAAO,IAAP,GAAc,EAAE,KAAF,CAAQ,MAAR,CAAd;;AAEA,mBAAO,KAAK,KAAL,CAAW,MAAX,EAAmB,IAAnB,CAAwB,UAAC,MAAD,EAAY;AACvC;AACA;AACA,uBAAK,SAAL,GAAiB,OAAK,SAAL,CAAe,MAAf,CAAsB,OAAK,SAAL,CAAe,OAAf,CAAuB,YAAvB,CAAtB,EAA4D,CAA5D,CAAjB;AACA,uBAAK,UAAL,CAAgB,UAAhB,CAA2B,sBAA3B;AACA,uBAAO,YAAP;AACH,aANM,CAAP;AAOH;;;;;;AAGL,oBAAoB,OAApB,GAA8B,CAAC,OAAD,EAAU,IAAV,EAAgB,QAAhB,EAA0B,YAA1B,EAAwC,eAAxC,CAA9B;;kBAEe,mB","file":"studentAssetService.js","sourcesContent":["'use strict';\n\nclass StudentAssetService {\n    constructor($http, $q, Upload, $rootScope, ConfigService) {\n        this.$http = $http;\n        this.$q = $q;\n        this.Upload = Upload;\n        this.$rootScope = $rootScope;\n        this.ConfigService = ConfigService;\n\n        this.allAssets = [];  // keep track of student's assets\n    }\n\n    getAssetById(assetId) {\n        for (var a = 0; a < this.allAssets.length; a++) {\n            var asset = this.allAssets[a];\n            if (asset.id === assetId) {\n                return asset;\n            }\n        }\n        return null;\n    };\n\n    retrieveAssets() {\n        var config = {};\n        config.method = 'GET';\n        config.url = this.ConfigService.getStudentAssetsURL();\n        config.params = {};\n        config.params.workgroupId = this.ConfigService.getWorkgroupId();\n        return this.$http(config).then((response) => {\n            // loop through the assets and make them into JSON object with more details\n            var result = [];\n            var assets = response.data;\n            var studentUploadsBaseURL = this.ConfigService.getStudentUploadsBaseURL();\n            for (var a = 0; a < assets.length; a++) {\n                var asset = assets[a];\n                if (!asset.isReferenced && asset.serverDeleteTime == null && asset.fileName !== '.DS_Store') {\n                    asset.url = studentUploadsBaseURL + asset.filePath;\n                    if (this.isImage(asset)) {\n                        asset.type = 'image';\n                        asset.iconURL = asset.url;\n                    } else if (this.isAudio(asset)) {\n                        asset.type = 'audio';\n                        asset.iconURL = 'wise5/vle/notebook/audio.png';\n                    } else {\n                        asset.type = 'file';\n                        asset.iconURL = 'wise5/vle/notebook/file.png';\n                    }\n                    result.push(asset);\n                }\n            }\n            this.allAssets = result;\n            return result;\n        });\n    };\n\n    getAssetContent(asset) {\n        var assetContentURL = asset.url;\n\n        // retrieve the csv file and parse it\n        var config = {};\n        config.method = 'GET';\n        config.url = assetContentURL;\n        return this.$http(config).then((response) => {\n            return response.data;\n        });\n    };\n\n    isImage(asset) {\n        var isImage = false;\n        var imageFileExtensions = ['png', 'jpg', 'jpeg', 'gif'];\n        if (asset != null) {\n            var assetURL = asset.url;\n            if (assetURL != null && assetURL.lastIndexOf('.') !== -1) {\n                var assetExtension = assetURL.substring(assetURL.lastIndexOf('.') + 1);\n                if (imageFileExtensions.indexOf(assetExtension.toLowerCase()) != -1) {\n                    isImage = true;\n                }\n            }\n        }\n        return isImage;\n    };\n\n    isAudio(asset) {\n        var isAudio = false;\n        var imageFileExtensions = ['wav', 'mp3', 'ogg', 'm4a', 'm4p', 'raw', 'aiff'];\n        if (asset != null) {\n            var assetURL = asset.url;\n            if (assetURL != null && assetURL.lastIndexOf('.') != -1) {\n                var assetExtension = assetURL.substring(assetURL.lastIndexOf('.') + 1);\n                if (imageFileExtensions.indexOf(assetExtension.toLowerCase()) != -1) {\n                    isAudio = true;\n                }\n            }\n        }\n        return isAudio;\n    };\n\n    uploadAsset(file) {\n        var studentAssetsURL = this.ConfigService.getStudentAssetsURL();\n        var deferred = this.$q.defer();\n\n        this.Upload.upload({\n            url: studentAssetsURL,\n            fields: {\n                'runId': this.ConfigService.getRunId(),\n                'workgroupId': this.ConfigService.getWorkgroupId(),\n                'periodId': this.ConfigService.getPeriodId(),\n                'clientSaveTime': Date.parse(new Date())\n            },\n            file: file\n        }).success((asset, status, headers, config) => {\n            if (asset === \"error\") {\n                alert(\"There was an error uploading.\");\n            } else {\n                var studentUploadsBaseURL = this.ConfigService.getStudentUploadsBaseURL();\n                asset.url = studentUploadsBaseURL + asset.filePath;\n                if (this.isImage(asset)) {\n                    asset.type = 'image';\n                    asset.iconURL = asset.url;\n                } else if (this.isAudio(asset)) {\n                    asset.type = 'audio';\n                    asset.iconURL = 'wise5/vle/notebook/audio.png';\n                } else {\n                    asset.type = 'file';\n                    asset.iconURL = 'wise5/vle/notebook/file.png';\n                }\n                this.allAssets.push(asset);\n                this.$rootScope.$broadcast('studentAssetsUpdated');\n                deferred.resolve(asset);\n            }\n        }).error((asset, status, headers, config) => {\n            alert(\"There was an error uploading. You might have reached your file upload limit or the file you tried to upload was too large. Please ask your teacher for help.\");\n        });\n\n        return deferred.promise;\n    };\n\n    uploadAssets(files) {\n        var studentAssetsURL = this.ConfigService.getStudentAssetsURL();\n        var promises = files.map((file) => {\n            return this.Upload.upload({\n                url: studentAssetsURL,\n                fields: {\n                    'runId': this.ConfigService.getRunId(),\n                    'workgroupId': this.ConfigService.getWorkgroupId(),\n                    'periodId': this.ConfigService.getPeriodId(),\n                    'clientSaveTime': Date.parse(new Date())\n                },\n                file: file\n            }).progress((evt) => {\n                var progressPercentage = parseInt(100.0 * evt.loaded / evt.total);\n                //console.log('progress: ' + progressPercentage + '% ' + evt.config.file.name);\n            }).success((data, status, headers, config) => {\n                //console.log('file ' + config.file.name + 'uploaded. Response: ' + JSON.stringify(data));\n            });\n        });\n        return this.$q.all(promises);\n    };\n\n    // given asset, makes a copy of it so steps can use for reference. Returns newly-copied asset.\n    copyAssetForReference(studentAsset) {\n        var config = {};\n        config.method = 'POST';\n        config.url = this.ConfigService.getStudentAssetsURL() + '/copy';\n        config.headers = {'Content-Type': 'application/x-www-form-urlencoded'};\n        var params = {};\n        params.studentAssetId = studentAsset.id;\n        params.workgroupId = this.ConfigService.getWorkgroupId();\n        params.periodId = this.ConfigService.getPeriodId();\n        params.clientSaveTime = Date.parse(new Date());\n\n        config.data = $.param(params);\n\n        return this.$http(config).then((result) => {\n            var copiedAsset = result.data;\n            if (copiedAsset != null) {\n                var studentUploadsBaseURL = this.ConfigService.getStudentUploadsBaseURL();\n                if (copiedAsset.isReferenced && copiedAsset.fileName !== '.DS_Store') {\n                    copiedAsset.url = studentUploadsBaseURL + copiedAsset.filePath;\n                    if (this.isImage(copiedAsset)) {\n                        copiedAsset.type = 'image';\n                        copiedAsset.iconURL = copiedAsset.url;\n                    } else if (this.isAudio(copiedAsset)) {\n                        copiedAsset.type = 'audio';\n                        copiedAsset.iconURL = 'wise5/vle/notebook/audio.png';\n                    } else {\n                        copiedAsset.type = 'file';\n                        copiedAsset.iconURL = 'wise5/vle/notebook/file.png';\n                    }\n                    //this.$rootScope.$broadcast('studentAssetsUpdated');\n                    return copiedAsset;\n                }\n            }\n            return null;\n        });\n    };\n\n    deleteAsset(studentAsset) {\n        var config = {};\n        config.method = 'POST';\n        config.url = this.ConfigService.getStudentAssetsURL() + '/remove';\n        config.headers = {'Content-Type': 'application/x-www-form-urlencoded'};\n        var params = {};\n        params.studentAssetId = studentAsset.id;\n        params.workgroupId = this.ConfigService.getWorkgroupId();\n        params.periodId = this.ConfigService.getPeriodId();\n        params.clientDeleteTime = Date.parse(new Date());\n        config.data = $.param(params);\n\n        return this.$http(config).then((result) => {\n            //var deletedAsset = result.data;\n            // also remove from local copy of all assets\n            this.allAssets = this.allAssets.splice(this.allAssets.indexOf(studentAsset), 1);\n            this.$rootScope.$broadcast('studentAssetsUpdated');\n            return studentAsset;\n        });\n    };\n}\n\nStudentAssetService.$inject = ['$http', '$q', 'Upload', '$rootScope', 'ConfigService'];\n\nexport default StudentAssetService;\n"]}