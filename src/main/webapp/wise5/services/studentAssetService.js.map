{"version":3,"sources":["studentAssetService.es6"],"names":[],"mappings":"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","file":"studentAssetService.js","sourcesContent":["'use strict';\n\nclass StudentAssetService {\n    constructor($http, $q, Upload, $rootScope, ConfigService) {\n        this.$http = $http;\n        this.$q = $q;\n        this.Upload = Upload;\n        this.$rootScope = $rootScope;\n        this.ConfigService = ConfigService;\n\n        this.allAssets = [];  // keep track of student's assets\n    }\n\n    getAssetById(assetId) {\n        for (var a = 0; a < this.allAssets.length; a++) {\n            var asset = this.allAssets[a];\n            if (asset.id === assetId) {\n                return asset;\n            }\n        }\n        return null;\n    };\n\n    retrieveAssets() {\n        var config = {};\n        config.method = 'GET';\n        config.url = this.ConfigService.getStudentAssetsURL();\n        config.params = {};\n        config.params.workgroupId = this.ConfigService.getWorkgroupId();\n        return this.$http(config).then((response) => {\n            // loop through the assets and make them into JSON object with more details\n            var result = [];\n            var assets = response.data;\n            var studentUploadsBaseURL = this.ConfigService.getStudentUploadsBaseURL();\n            for (var a = 0; a < assets.length; a++) {\n                var asset = assets[a];\n                if (!asset.isReferenced && asset.serverDeleteTime == null && asset.fileName !== '.DS_Store') {\n                    asset.url = studentUploadsBaseURL + asset.filePath;\n                    if (this.isImage(asset)) {\n                        asset.type = 'image';\n                        asset.iconURL = asset.url;\n                    } else if (this.isAudio(asset)) {\n                        asset.type = 'audio';\n                        asset.iconURL = 'wise5/vle/notebook/audio.png';\n                    } else {\n                        asset.type = 'file';\n                        asset.iconURL = 'wise5/vle/notebook/file.png';\n                    }\n                    result.push(asset);\n                }\n            }\n            this.allAssets = result;\n            return result;\n        });\n    };\n\n    getAssetContent(asset) {\n        var assetContentURL = asset.url;\n\n        // retrieve the csv file and parse it\n        var config = {};\n        config.method = 'GET';\n        config.url = assetContentURL;\n        return this.$http(config).then((response) => {\n            return response.data;\n        });\n    };\n\n    isImage(asset) {\n        var isImage = false;\n        var imageFileExtensions = ['png', 'jpg', 'jpeg', 'gif'];\n        if (asset != null) {\n            var assetURL = asset.url;\n            if (assetURL != null && assetURL.lastIndexOf('.') !== -1) {\n                var assetExtension = assetURL.substring(assetURL.lastIndexOf('.') + 1);\n                if (imageFileExtensions.indexOf(assetExtension.toLowerCase()) != -1) {\n                    isImage = true;\n                }\n            }\n        }\n        return isImage;\n    };\n\n    isAudio(asset) {\n        var isAudio = false;\n        var imageFileExtensions = ['wav', 'mp3', 'ogg', 'm4a', 'm4p', 'raw', 'aiff'];\n        if (asset != null) {\n            var assetURL = asset.url;\n            if (assetURL != null && assetURL.lastIndexOf('.') != -1) {\n                var assetExtension = assetURL.substring(assetURL.lastIndexOf('.') + 1);\n                if (imageFileExtensions.indexOf(assetExtension.toLowerCase()) != -1) {\n                    isAudio = true;\n                }\n            }\n        }\n        return isAudio;\n    };\n\n    uploadAsset(file) {\n        var studentAssetsURL = this.ConfigService.getStudentAssetsURL();\n        var deferred = this.$q.defer();\n\n        this.Upload.upload({\n            url: studentAssetsURL,\n            fields: {\n                'runId': this.ConfigService.getRunId(),\n                'workgroupId': this.ConfigService.getWorkgroupId(),\n                'periodId': this.ConfigService.getPeriodId(),\n                'clientSaveTime': Date.parse(new Date())\n            },\n            file: file\n        }).success((asset, status, headers, config) => {\n            if (asset === \"error\") {\n                alert(\"There was an error uploading.\");\n            } else {\n                var studentUploadsBaseURL = this.ConfigService.getStudentUploadsBaseURL();\n                asset.url = studentUploadsBaseURL + asset.filePath;\n                if (this.isImage(asset)) {\n                    asset.type = 'image';\n                    asset.iconURL = asset.url;\n                } else if (this.isAudio(asset)) {\n                    asset.type = 'audio';\n                    asset.iconURL = 'wise5/vle/notebook/audio.png';\n                } else {\n                    asset.type = 'file';\n                    asset.iconURL = 'wise5/vle/notebook/file.png';\n                }\n                this.allAssets.push(asset);\n                this.$rootScope.$broadcast('studentAssetsUpdated');\n                deferred.resolve(asset);\n            }\n        }).error((asset, status, headers, config) => {\n            alert(\"There was an error uploading. You might have reached your file upload limit or the file you tried to upload was too large. Please ask your teacher for help.\");\n        });\n\n        return deferred.promise;\n    };\n\n    uploadAssets(files) {\n        var studentAssetsURL = this.ConfigService.getStudentAssetsURL();\n        var promises = files.map((file) => {\n            return this.Upload.upload({\n                url: studentAssetsURL,\n                fields: {\n                    'runId': this.ConfigService.getRunId(),\n                    'workgroupId': this.ConfigService.getWorkgroupId(),\n                    'periodId': this.ConfigService.getPeriodId(),\n                    'clientSaveTime': Date.parse(new Date())\n                },\n                file: file\n            }).progress((evt) => {\n                var progressPercentage = parseInt(100.0 * evt.loaded / evt.total);\n                //console.log('progress: ' + progressPercentage + '% ' + evt.config.file.name);\n            }).success((data, status, headers, config) => {\n                //console.log('file ' + config.file.name + 'uploaded. Response: ' + JSON.stringify(data));\n            });\n        });\n        return this.$q.all(promises);\n    };\n\n    // given asset, makes a copy of it so steps can use for reference. Returns newly-copied asset.\n    copyAssetForReference(studentAsset) {\n        var config = {};\n        config.method = 'POST';\n        config.url = this.ConfigService.getStudentAssetsURL() + '/copy';\n        config.headers = {'Content-Type': 'application/x-www-form-urlencoded'};\n        var params = {};\n        params.studentAssetId = studentAsset.id;\n        params.workgroupId = this.ConfigService.getWorkgroupId();\n        params.periodId = this.ConfigService.getPeriodId();\n        params.clientSaveTime = Date.parse(new Date());\n\n        config.data = $.param(params);\n\n        return this.$http(config).then((result) => {\n            var copiedAsset = result.data;\n            if (copiedAsset != null) {\n                var studentUploadsBaseURL = this.ConfigService.getStudentUploadsBaseURL();\n                if (copiedAsset.isReferenced && copiedAsset.fileName !== '.DS_Store') {\n                    copiedAsset.url = studentUploadsBaseURL + copiedAsset.filePath;\n                    if (this.isImage(copiedAsset)) {\n                        copiedAsset.type = 'image';\n                        copiedAsset.iconURL = copiedAsset.url;\n                    } else if (this.isAudio(copiedAsset)) {\n                        copiedAsset.type = 'audio';\n                        copiedAsset.iconURL = 'wise5/vle/notebook/audio.png';\n                    } else {\n                        copiedAsset.type = 'file';\n                        copiedAsset.iconURL = 'wise5/vle/notebook/file.png';\n                    }\n                    //this.$rootScope.$broadcast('studentAssetsUpdated');\n                    return copiedAsset;\n                }\n            }\n            return null;\n        });\n    };\n\n    deleteAsset(studentAsset) {\n        var config = {};\n        config.method = 'POST';\n        config.url = this.ConfigService.getStudentAssetsURL() + '/remove';\n        config.headers = {'Content-Type': 'application/x-www-form-urlencoded'};\n        var params = {};\n        params.studentAssetId = studentAsset.id;\n        params.workgroupId = this.ConfigService.getWorkgroupId();\n        params.periodId = this.ConfigService.getPeriodId();\n        params.clientDeleteTime = Date.parse(new Date());\n        config.data = $.param(params);\n\n        return this.$http(config).then((result) => {\n            //var deletedAsset = result.data;\n            // also remove from local copy of all assets\n            this.allAssets = this.allAssets.splice(this.allAssets.indexOf(studentAsset), 1);\n            this.$rootScope.$broadcast('studentAssetsUpdated');\n            return studentAsset;\n        });\n    };\n}\n\nStudentAssetService.$inject = ['$http', '$q', 'Upload', '$rootScope', 'ConfigService'];\n\nexport default StudentAssetService;\n"]}