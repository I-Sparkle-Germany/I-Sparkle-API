{"version":3,"sources":["studentDataService.es6"],"names":["StudentDataService","$filter","$http","$injector","$q","$rootScope","AnnotationService","ConfigService","ProjectService","UtilService","$translate","currentNode","previousStep","studentData","stackHistory","visitedNodesHistory","nodeStatuses","runStatus","maxScore","maxPlanningNodeNumber","saveToServerRequestCount","dummyStudentWorkId","$on","event","args","calculateActiveGlobalAnnotationGroups","globalAnnotationGroups","getActiveGlobalAnnotationGroups","map","globalAnnotationGroup","globalAnnotations","annotations","globalAnnotation","data","isGlobal","unGlobalizeConditional","unGlobalizeCriteriaArray","unGlobalizeCriteria","anySatified","i","length","unGlobalizeCriteriaResult","evaluateCriteria","unGlobalizedTimestamp","Date","parse","saveAnnotations","allSatisfied","annotation","handleAnnotationReceived","isPreview","componentStates","nodeStates","events","userName","userId","setAnnotations","populateHistories","updateNodeStatuses","studentDataURL","getConfigParam","httpParams","method","url","params","workgroupId","getWorkgroupId","runId","getRunId","getStudentWork","getEvents","getAnnotations","toWorkgroupId","then","result","resultData","studentWorkList","s","studentWork","componentId","push","project","nodes","p","planningGroupNode","planning","lastestNodeStateForPlanningGroupNode","getLatestNodeStateByNodeId","id","studentModifiedNodes","studentModifiedNode","studentModifiedNodeId","n","ids","parseProject","runStatusURL","headers","nodeId","nodeStatus","getNodes","planningNodes","getPlanningNodes","groups","getGroups","concat","node","isGroupNode","updateNodeStatusByNode","group","g","depth","getNodeDepth","sort","a","b","getMaxScore","$broadcast","tempNodeStatus","isVisitable","isCompleted","constraintsForNode","getConstraintsForNode","isVisible","isVisibleResults","isVisitableResults","firstResult","c","constraintForNode","tempResult","evaluateConstraint","action","isVisibleResult","isVisitableResult","isVisited","isNodeVisited","getNodeStatusByNodeId","setNodeStatusByNodeId","previousIsCompletedValue","progress","getNodeProgressById","icon","getNodeIconByNodeId","latestComponentStatesForNode","getLatestComponentStateByNodeId","latestComponentStateClientSaveTime","clientSaveTime","latestComponentStateServerSaveTime","serverSaveTime","removalCriteria","evaluateNodeConstraint","visitedNodes","getVisitedNodesHistory","transitionsToNodeId","v","visitedNodeId","transitions","getTransitionsByFromAndToNodeId","isStartNode","removalConditional","tempCriteria","criteria","functionName","name","evaluateBranchPathTakenCriteria","evaluateIsVisitedCriteria","evaluateIsVisitedAfterCriteria","evaluateIsRevisedAfterCriteria","evaluateIsVisitedAndRevisedAfterCriteria","evaluateIsCompletedCriteria","evaluateIsCorrectCriteria","evaluateChoiceChosenCriteria","evaluateIsPlanningActivityCompletedCriteria","evaluateScoreCriteria","evaluateUsedXSubmitsCriteria","getComponentStatesByNodeIdAndComponentId","componentState","isCorrect","planningStepsCreated","planningStepsCompleted","planningStepsCreatedSatisfied","planningStepsCompletedSatisfied","getNodeStatesByNodeId","ns","planningStepCount","nodeState","type","planningNodeTemplateId","expectedFromNodeId","fromNodeId","expectedToNodeId","toNodeId","branchPathTakenEvents","getBranchPathTakenEventsByNodeId","branchPathTakenEvent","e","isVisitedAfter","isVisitedAfterNodeId","criteriaCreatedTimestamp","isRevisedAfter","isRevisedAfterNodeId","isRevisedAfterComponentId","latestComponentStateForRevisedComponent","getLatestComponentStateByNodeIdAndComponentId","isVisitedAndRevisedAfter","serviceName","has","service","get","choiceChosen","scores","scoreType","latestScoreAnnotation","getLatestScoreAnnotation","scoreValue","getScoreValueFromScoreAnnotation","indexOf","toString","requiredSubmitCount","manualSubmitCounter","highestSubmitCounter","isSubmit","submitCounter","updateStackHistory","updateVisitedNodesHistory","index","stackHistoryResult","indexOfNodeId","splice","timestamp","nodeStatesByNodeId","tempNodeId","notebookItemId","component","category","alert","context","componentType","saveEvent","newEvent","createNewEvent","saveToServer","projectId","getProjectId","periodId","getPeriodId","requestToken","generateKey","addComponentState","addNodeState","addEvent","addAnnotation","savedStudentDataResponse","saveToServerSuccess","deferred","defer","resolve","promise","angular","toJson","$","param","saveStudentStatus","savedStudentWorkList","localStudentWorkList","savedStudentWork","l","localStudentWork","getMode","savedEvents","localEvents","savedEvent","localEvent","savedAnnotations","localAnnotations","savedAnnotation","localAnnotation","studentStatusURL","getStudentStatusURL","currentNodeId","getCurrentNodeId","getNodeStatuses","projectCompletion","getProjectCompletion","studentStatusJSON","status","studentStatusParams","latestComponentState","submitDirty","getLatestComponentState","latestNodeState","allNodeStatesByNodeId","componentStateNodeId","componentStateComponentId","studentWorkId","componentStatesByNodeId","componentStatesByNodeIdAndComponentId","eventsByNodeId","eventNodeId","eventComponentId","eventName","getNodeById","isActive","completedItems","completedItemsWithWork","totalItems","totalItemsWithWork","nodeIds","getChildNodeIdsById","groupProgress","hasWork","nodeHasWork","completionPct","Math","round","completionPctWithWork","componentEvents","getEventsByNodeIdAndComponentId","nodeEvents","getEventsByNodeId","getComponentByNodeIdAndComponentId","isGroup","components","getComponentsByNodeId","showPreviousWorkNodeId","showPreviousWorkComponentId","tempNode","tempComponentId","tempComponent","isComponentCompleted","console","log","setCurrentNode","previousCurrentNode","previousNode","nodeToExit","endCurrentNode","setCurrentNodeByNodeId","nodeClickLocked","strData","strDelimiter","objPattern","RegExp","arrData","arrMatches","exec","strMatchedDelimiter","strMatchedValue","replace","finalValue","floatVal","parseFloat","isNaN","getTotalScore","currentMaxPlanningNodeNumber","getNodeStates","nodeStateNodeId","isPlanning","planningNodeIdRegEx","match","planningNodeNumber","parseInt","latestComponentStates","getComponentStatesByNodeId","completionCriteria","inOrder","tempTimestamp","completionCriterion","tempComponentState","getComponentStateSubmittedAfter","getComponentStateSavedAfter","tempEvent","getVisitEventAfter","showClassmateWorkSource","onlyGetLatest","hasOwnProperty","nodeMaxScore","getMaxScoreForNode","$inject"],"mappings":"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","file":"studentDataService.js","sourcesContent":["\r\nclass StudentDataService {\r\n    constructor($filter,\r\n                $http,\r\n                $injector,\r\n                $q,\r\n                $rootScope,\r\n                AnnotationService,\r\n                ConfigService,\r\n                ProjectService,\r\n                UtilService) {\r\n\r\n        this.$filter = $filter;\r\n        this.$http = $http;\r\n        this.$injector = $injector;\r\n        this.$q = $q;\r\n        this.$rootScope = $rootScope;\r\n        this.AnnotationService = AnnotationService;\r\n        this.ConfigService = ConfigService;\r\n        this.ProjectService = ProjectService;\r\n        this.UtilService = UtilService;\r\n\r\n        this.$translate = this.$filter('translate');\r\n\r\n        this.currentNode = null;\r\n        this.previousStep = null;\r\n        this.studentData = null;\r\n        this.stackHistory = [];  // array of node id's\r\n        this.visitedNodesHistory = [];\r\n        this.nodeStatuses = {};\r\n        this.runStatus = null;\r\n        this.maxScore = null;\r\n\r\n        this.maxPlanningNodeNumber = 0;\r\n\r\n        /*\r\n         * A counter to keep track of how many saveToServer requests we have\r\n         * made that we haven't received a response for yet. When this value\r\n         * goes back down to 0, we will send update the student status and then\r\n         * save it to the server.\r\n         */\r\n        this.saveToServerRequestCount = 0;\r\n\r\n        /*\r\n         * A dummy student work id that is used in preview mode when we simulate\r\n         * saving of student data.\r\n         */\r\n        this.dummyStudentWorkId = 1;\r\n\r\n        // listen for node status changes\r\n        this.$rootScope.$on('nodeStatusesChanged', (event, args) => {\r\n            // calculate active global annotations and group them by group name as needed\r\n            this.AnnotationService.calculateActiveGlobalAnnotationGroups();\r\n\r\n            // go through the global annotations and see if they can be un-globalized by checking if their criterias have been met.\r\n            let globalAnnotationGroups = this.AnnotationService.getActiveGlobalAnnotationGroups();\r\n            globalAnnotationGroups.map((globalAnnotationGroup) => {\r\n                let globalAnnotations = globalAnnotationGroup.annotations;\r\n                globalAnnotations.map((globalAnnotation) => {\r\n                    if (globalAnnotation.data != null && globalAnnotation.data.isGlobal) {\r\n                        let unGlobalizeConditional = globalAnnotation.data.unGlobalizeConditional;\r\n                        let unGlobalizeCriteriaArray = globalAnnotation.data.unGlobalizeCriteria;\r\n                        if (unGlobalizeCriteriaArray != null) {\r\n                            if (unGlobalizeConditional === \"any\") {\r\n                                // at least one criteria in unGlobalizeCriteriaArray must be satisfied in any order before un-globalizing this annotation\r\n                                let anySatified = false;\r\n                                for (let i = 0; i < unGlobalizeCriteriaArray.length; i++) {\r\n                                    let unGlobalizeCriteria = unGlobalizeCriteriaArray[i];\r\n                                    let unGlobalizeCriteriaResult = this.evaluateCriteria(unGlobalizeCriteria);\r\n                                    anySatified = anySatified || unGlobalizeCriteriaResult;\r\n                                }\r\n                                if (anySatified) {\r\n                                    globalAnnotation.data.unGlobalizedTimestamp = Date.parse(new Date());  // save when criteria was satisfied\r\n                                    this.saveAnnotations([globalAnnotation]);  // save changes to server\r\n                                }\r\n                            } else if (unGlobalizeConditional === \"all\") {\r\n                                // all criteria in unGlobalizeCriteriaArray must be satisfied in any order before un-globalizing this annotation\r\n                                let allSatisfied = true;\r\n                                for (let i = 0; i < unGlobalizeCriteriaArray.length; i++) {\r\n                                    let unGlobalizeCriteria = unGlobalizeCriteriaArray[i];\r\n                                    let unGlobalizeCriteriaResult = this.evaluateCriteria(unGlobalizeCriteria);\r\n                                    allSatisfied = allSatisfied && unGlobalizeCriteriaResult;\r\n                                }\r\n                                if (allSatisfied) {\r\n                                    globalAnnotation.data.unGlobalizedTimestamp = Date.parse(new Date());  // save when criteria was satisfied\r\n                                    this.saveAnnotations([globalAnnotation]);  // save changes to server\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                });\r\n            })\r\n        });\r\n\r\n        /**\r\n         * Listen for the 'newAnnotationReceived' event which is fired when\r\n         * student receives a new annotation from the server\r\n         */\r\n        this.$rootScope.$on('newAnnotationReceived', (event, args) => {\r\n            if (args) {\r\n                // get the annotation that was saved to the server\r\n                let annotation = args.annotation;\r\n                this.handleAnnotationReceived(annotation);\r\n            }\r\n        });\r\n    }\r\n\r\n    retrieveStudentData() {\r\n\r\n        if (this.ConfigService.isPreview()) {\r\n            // we are previewing the project\r\n\r\n            // initialize dummy student data\r\n            this.studentData = {};\r\n            this.studentData.componentStates = [];\r\n            this.studentData.nodeStates = [];\r\n            this.studentData.events = [];\r\n            this.studentData.annotations = [];\r\n            this.studentData.userName = this.$translate('PREVIEW_STUDENT');\r\n            this.studentData.userId = '0';\r\n\r\n            // set the annotations into the annotation service\r\n            this.AnnotationService.setAnnotations(this.studentData.annotations);\r\n\r\n            // populate the student history\r\n            this.populateHistories(this.studentData.events);\r\n\r\n            // update the node statuses\r\n            this.updateNodeStatuses();\r\n        } else {\r\n            // we are in a run\r\n\r\n            // get the url to get the student data\r\n            var studentDataURL = this.ConfigService.getConfigParam('studentDataURL');\r\n\r\n            var httpParams = {};\r\n            httpParams.method = 'GET';\r\n            httpParams.url = studentDataURL;\r\n\r\n            // set the workgroup id and run id\r\n            var params = {};\r\n            params.workgroupId = this.ConfigService.getWorkgroupId();\r\n            params.runId = this.ConfigService.getRunId();\r\n            params.getStudentWork = true;\r\n            params.getEvents = true;\r\n            params.getAnnotations = true;\r\n            params.toWorkgroupId = this.ConfigService.getWorkgroupId();\r\n            httpParams.params = params;\r\n\r\n            // make the request for the student data\r\n            return this.$http(httpParams).then((result) => {\r\n                var resultData = result.data;\r\n                if (resultData != null) {\r\n\r\n                    this.studentData = {};\r\n\r\n                    // get student work\r\n                    this.studentData.componentStates = [];\r\n                    this.studentData.nodeStates = [];\r\n                    var studentWorkList = resultData.studentWorkList;\r\n                    for (var s = 0; s < studentWorkList.length; s++) {\r\n                        var studentWork = studentWorkList[s];\r\n                        if (studentWork.componentId != null) {\r\n                            this.studentData.componentStates.push(studentWork);\r\n                        } else {\r\n                            this.studentData.nodeStates.push(studentWork);\r\n                        }\r\n                    }\r\n\r\n                    // Check to see if this Project contains any Planning activities\r\n                    if (this.ProjectService.project.nodes != null && this.ProjectService.project.nodes.length > 0) {\r\n                        // Overload/add new nodes based on student's work in the NodeState for the planning group.\r\n                        for (let p = 0; p < this.ProjectService.project.nodes.length; p++) {\r\n                            let planningGroupNode = this.ProjectService.project.nodes[p];\r\n                            if (planningGroupNode.planning) {\r\n                                let lastestNodeStateForPlanningGroupNode = this.getLatestNodeStateByNodeId(planningGroupNode.id);\r\n                                if (lastestNodeStateForPlanningGroupNode != null) {\r\n                                    let studentModifiedNodes = lastestNodeStateForPlanningGroupNode.studentData.nodes;\r\n                                    if (studentModifiedNodes != null) {\r\n                                        for (let s = 0; s < studentModifiedNodes.length; s++) {\r\n                                            let studentModifiedNode = studentModifiedNodes[s];  // Planning Node that student modified or new instances.\r\n                                            let studentModifiedNodeId = studentModifiedNode.id;\r\n                                            if (studentModifiedNode.planning) {\r\n                                                // If this is a Planning Node that exists in the project, replace the one in the original project with this one.\r\n                                                for (let n = 0; n < this.ProjectService.project.nodes.length; n++) {\r\n                                                    if (this.ProjectService.project.nodes[n].id === studentModifiedNodeId) {\r\n                                                        // Only overload the ids. This will allow authors to add more planningNodes during the run if needed.\r\n                                                        this.ProjectService.project.nodes[n].ids = studentModifiedNode.ids;\r\n                                                    }\r\n                                                }\r\n                                            } else {\r\n                                                // Otherwise, this is an instance of a PlanningNode template, so just append it to the end of the Project.nodes\r\n                                                this.ProjectService.project.nodes.push(studentModifiedNode);\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                        // Re-parse the project with the modified changes\r\n                        this.ProjectService.parseProject();\r\n                    }\r\n\r\n                    // get events\r\n                    this.studentData.events = resultData.events;\r\n\r\n                    // get annotations\r\n                    this.studentData.annotations = resultData.annotations;\r\n\r\n                    this.AnnotationService.setAnnotations(this.studentData.annotations);\r\n\r\n                    // populate the student history\r\n                    this.populateHistories(this.studentData.events);\r\n\r\n                    // update the node statuses\r\n                    this.updateNodeStatuses();\r\n                }\r\n\r\n                return this.studentData;\r\n            });\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Retrieve the run status\r\n     */\r\n    retrieveRunStatus() {\r\n\r\n        if (this.ConfigService.isPreview()) {\r\n            // we are previewing the project\r\n            this.runStatus = {};\r\n        } else {\r\n            // we are in a run\r\n            var runStatusURL = this.ConfigService.getConfigParam('runStatusURL');\r\n            var runId = this.ConfigService.getConfigParam('runId');\r\n\r\n            //create the params for the request\r\n            var params = {\r\n                runId:runId\r\n            };\r\n\r\n            var httpParams = {};\r\n            httpParams.method = 'GET';\r\n            httpParams.headers = {'Content-Type': 'application/x-www-form-urlencoded'};\r\n            httpParams.url = runStatusURL;\r\n            httpParams.params = params;\r\n\r\n            // make the request for the run status\r\n            return this.$http(httpParams).then((result) => {\r\n                if (result != null) {\r\n                    var data = result.data;\r\n                    if (data != null) {\r\n                        // remember the run status\r\n                        this.runStatus = data;\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    getNodeStatuses() {\r\n        return this.nodeStatuses;\r\n    };\r\n\r\n    setNodeStatusByNodeId(nodeId, nodeStatus) {\r\n\r\n        if (nodeId != null && nodeStatus != null) {\r\n            var nodeStatuses = this.nodeStatuses;\r\n\r\n            if (nodeStatuses != null) {\r\n                nodeStatuses[nodeId] = nodeStatus;\r\n            }\r\n        }\r\n    }\r\n\r\n    getNodeStatusByNodeId(nodeId) {\r\n        var nodeStatus = null;\r\n\r\n        var nodeStatuses = this.nodeStatuses;\r\n\r\n        if (nodeId != null && nodeStatuses != null) {\r\n            nodeStatus = nodeStatuses[nodeId];\r\n        }\r\n\r\n        return nodeStatus;\r\n    };\r\n\r\n    updateNodeStatuses() {\r\n        let nodes = this.ProjectService.getNodes();\r\n        let planningNodes = this.ProjectService.getPlanningNodes();\r\n        var groups = this.ProjectService.getGroups();\r\n\r\n        if (nodes != null) {\r\n            if (planningNodes != null) {\r\n                nodes = nodes.concat(planningNodes);\r\n            }\r\n\r\n            for (var n = 0; n < nodes.length; n++) {\r\n                var node = nodes[n];\r\n                if (!this.ProjectService.isGroupNode(node.id)) {\r\n                    this.updateNodeStatusByNode(node);\r\n                }\r\n            }\r\n        }\r\n\r\n        var group;\r\n        if (groups != null) {\r\n            for (var g = 0; g < groups.length; g++) {\r\n                group = groups[g];\r\n                group.depth = this.ProjectService.getNodeDepth(group.id);\r\n            }\r\n\r\n            // sort by descending depth order (need to calculate completion for lowest level groups first)\r\n            groups.sort(function(a, b) {\r\n                return b.depth - a.depth;\r\n            });\r\n\r\n            for (var i = 0; i < groups.length; i++) {\r\n                group = groups[i];\r\n                this.updateNodeStatusByNode(group);\r\n            }\r\n        }\r\n\r\n        // update max score\r\n        this.maxScore = this.getMaxScore();\r\n\r\n        this.$rootScope.$broadcast('nodeStatusesChanged');\r\n    };\r\n\r\n    /**\r\n     * Update the node status for a node\r\n     * @param node the node to update\r\n     */\r\n    updateNodeStatusByNode(node) {\r\n\r\n        if (node != null) {\r\n            var nodeId = node.id;\r\n\r\n            var tempNodeStatus = {};\r\n            tempNodeStatus.nodeId = nodeId;\r\n            tempNodeStatus.isVisitable = true;\r\n            tempNodeStatus.isCompleted = true;\r\n\r\n            // get the constraints that affect this node\r\n            var constraintsForNode = this.ProjectService.getConstraintsForNode(node);\r\n\r\n            if (this.ConfigService.getConfigParam('constraints') == false) {\r\n                /*\r\n                 * constraints have been disabled, most likely because we are\r\n                 * in preview without constraints mode\r\n                 */\r\n                constraintsForNode = null;\r\n            }\r\n\r\n            if (constraintsForNode == null || constraintsForNode.length == 0) {\r\n                // this node does not have any constraints so it is clickable\r\n                tempNodeStatus.isVisible = true;\r\n                tempNodeStatus.isVisitable = true;\r\n            } else {\r\n\r\n                var isVisibleResults = [];\r\n                var isVisitableResults = [];\r\n\r\n                var result = false;\r\n                var firstResult = true;\r\n\r\n                // loop through all the constraints that affect this node\r\n                for (var c = 0; c < constraintsForNode.length; c++) {\r\n                    var constraintForNode = constraintsForNode[c];\r\n\r\n                    if (constraintForNode != null) {\r\n\r\n                        // evaluate the constraint to see if the node can be visited\r\n                        var tempResult = this.evaluateConstraint(node, constraintForNode);\r\n\r\n                        var action = constraintForNode.action;\r\n\r\n                        if (action != null) {\r\n                            if (action === 'makeThisNodeNotVisible') {\r\n                                isVisibleResults.push(tempResult);\r\n                            } else if (action === 'makeThisNodeNotVisitable') {\r\n                                isVisitableResults.push(tempResult);\r\n                            } else if (action === 'makeAllNodesAfterThisNotVisible') {\r\n                                isVisibleResults.push(tempResult);\r\n                            } else if (action === 'makeAllNodesAfterThisNotVisitable') {\r\n                                isVisitableResults.push(tempResult);\r\n                            } else if (action === 'makeAllOtherNodesNotVisible') {\r\n                                isVisibleResults.push(tempResult);\r\n                            } else if (action === 'makeAllOtherNodesNotVisitable') {\r\n                                isVisitableResults.push(tempResult);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n                var isVisible = true;\r\n                var isVisitable = true;\r\n\r\n                for (var a = 0; a < isVisibleResults.length; a++) {\r\n                    var isVisibleResult = isVisibleResults[a];\r\n\r\n                    isVisible = isVisible && isVisibleResult;\r\n                }\r\n\r\n                for (var b = 0; b < isVisitableResults.length; b++) {\r\n                    var isVisitableResult = isVisitableResults[b];\r\n\r\n                    isVisitable = isVisitable && isVisitableResult;\r\n                }\r\n\r\n                tempNodeStatus.isVisible = isVisible;\r\n                tempNodeStatus.isVisitable = isVisitable;\r\n            }\r\n\r\n            tempNodeStatus.isCompleted = this.isCompleted(nodeId);\r\n            tempNodeStatus.isVisited = this.isNodeVisited(nodeId);\r\n\r\n            var nodeStatus = this.getNodeStatusByNodeId(nodeId);\r\n\r\n            if (nodeStatus == null) {\r\n                this.setNodeStatusByNodeId(nodeId, tempNodeStatus);\r\n            } else {\r\n\r\n                /*\r\n                 * get the previous isCompleted value so that we can later check\r\n                 * if it has changed\r\n                 */\r\n                var previousIsCompletedValue = this.nodeStatuses[nodeId].isCompleted;\r\n\r\n                this.nodeStatuses[nodeId].isVisited = tempNodeStatus.isVisited;\r\n                this.nodeStatuses[nodeId].isVisible = tempNodeStatus.isVisible;\r\n                this.nodeStatuses[nodeId].isVisitable = tempNodeStatus.isVisitable;\r\n                this.nodeStatuses[nodeId].isCompleted = tempNodeStatus.isCompleted;\r\n\r\n                if (previousIsCompletedValue == false && tempNodeStatus.isCompleted) {\r\n                    /*\r\n                     * the node status just changed from false to true so we\r\n                     * will fire an event\r\n                     */\r\n\r\n                    this.$rootScope.$broadcast('nodeCompleted', { nodeId: nodeId });\r\n                }\r\n            }\r\n\r\n            this.nodeStatuses[nodeId].progress = this.getNodeProgressById(nodeId);\r\n            this.nodeStatuses[nodeId].icon = this.ProjectService.getNodeIconByNodeId(nodeId);\r\n\r\n            // get the latest component state for the node\r\n            var latestComponentStatesForNode = this.getLatestComponentStateByNodeId(nodeId);\r\n\r\n            if (latestComponentStatesForNode != null) {\r\n                // set the latest component state timestamp into the node status\r\n                this.nodeStatuses[nodeId].latestComponentStateClientSaveTime = latestComponentStatesForNode.clientSaveTime;\r\n                this.nodeStatuses[nodeId].latestComponentStateServerSaveTime = latestComponentStatesForNode.serverSaveTime;\r\n            }\r\n        }\r\n\r\n        //return nodeStatus;\r\n    };\r\n\r\n    /**\r\n     * Evaluate the constraint\r\n     * @param node the node\r\n     * @param constraintForNode the constraint object\r\n     * @returns whether the node has satisfied the constraint\r\n     */\r\n    evaluateConstraint(node, constraintForNode) {\r\n        var result = false;\r\n\r\n        if (constraintForNode != null) {\r\n\r\n            var removalCriteria = constraintForNode.removalCriteria;\r\n\r\n            if (removalCriteria != null) {\r\n                result = this.evaluateNodeConstraint(node, constraintForNode);\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    /**\r\n     * Evaluate the guided navigation constraint\r\n     * @param node the node\r\n     * @param constraintForNode the constraint object\r\n     * @returns whether the node can be visited or not\r\n     */\r\n    evaluateGuidedNavigationConstraint(node, constraintForNode) {\r\n\r\n        var result = false;\r\n\r\n        if (node != null) {\r\n            var nodeId = node.id;\r\n\r\n            if (this.isNodeVisited(nodeId)) {\r\n                // the node has been visited before so it should be clickable\r\n                result = true;\r\n            } else {\r\n\r\n                // get all the nodes that have been visited\r\n                var visitedNodes = this.getVisitedNodesHistory();\r\n\r\n                var transitionsToNodeId = [];\r\n\r\n                // loop through all the ndoes that have been visited\r\n                for (var v = 0; v < visitedNodes.length; v++) {\r\n                    var visitedNodeId = visitedNodes[v];\r\n\r\n                    // get the transitions from the visited node to the node status node\r\n                    var transitions = this.ProjectService.getTransitionsByFromAndToNodeId(visitedNodeId, nodeId);\r\n\r\n                    // TODO: check if the transition can be used by the student\r\n\r\n                    // concat the node ids\r\n                    transitionsToNodeId = transitionsToNodeId.concat(transitions);\r\n                }\r\n\r\n                if (transitionsToNodeId != null && transitionsToNodeId.length > 0) {\r\n                    // there is a transition between the current node and the node status node\r\n\r\n                    /*\r\n                     * there are transitions from the current node to the node status node so\r\n                     * the node status node is clickable\r\n                     */\r\n                    result = true;\r\n                } else {\r\n                    /*\r\n                     * there is no transition between the visited nodes and the node status node\r\n                     * so we will set the node to be not clickable\r\n                     */\r\n                    result = false;\r\n                }\r\n\r\n                if (this.ProjectService.isStartNode(node)) {\r\n                    /*\r\n                     * the node is the start node of the project or a start node of a group\r\n                     * so we will make it clickable\r\n                     */\r\n                    result = true;\r\n                }\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    /**\r\n     * Evaluate the node constraint\r\n     * @param node the node\r\n     * @param constraintForNode the constraint object\r\n     * @returns whether the node satisifies the constraint\r\n     */\r\n    evaluateNodeConstraint(node, constraintForNode) {\r\n        var result = false;\r\n\r\n        if (constraintForNode != null) {\r\n            var removalCriteria = constraintForNode.removalCriteria;\r\n            var removalConditional = constraintForNode.removalConditional;\r\n\r\n            if (removalCriteria == null) {\r\n                result = true;\r\n            } else {\r\n                var firstResult = true;\r\n\r\n                // loop through all the criteria that need to be satisifed\r\n                for (var c = 0; c < removalCriteria.length; c++) {\r\n\r\n                    // get a criteria\r\n                    var tempCriteria = removalCriteria[c];\r\n\r\n                    if (tempCriteria != null) {\r\n\r\n                        // evaluate the criteria\r\n                        var tempResult = this.evaluateCriteria(tempCriteria);\r\n\r\n                        if (firstResult) {\r\n                            // this is the first criteria in this for loop\r\n                            result = tempResult;\r\n                            firstResult = false;\r\n                        } else {\r\n                            // this is not the first criteria\r\n\r\n                            if (removalConditional === 'any') {\r\n                                // any of the criteria can be true to remove the constraint\r\n                                result = result || tempResult;\r\n                            } else {\r\n                                // all the criteria need to be true to remove the constraint\r\n                                result = result && tempResult;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n\r\n    /**\r\n     * Evaluate the criteria\r\n     * @param criteria the criteria\r\n     * @returns whether the criteria is satisfied or not\r\n     */\r\n    evaluateCriteria(criteria) {\r\n\r\n        var result = false;\r\n\r\n        if (criteria != null) {\r\n\r\n            var functionName = criteria.name;\r\n\r\n            if (functionName == null) {\r\n\r\n            } else if (functionName === 'branchPathTaken') {\r\n                result = this.evaluateBranchPathTakenCriteria(criteria);\r\n            } else if (functionName === 'isVisible') {\r\n\r\n            } else if (functionName === 'isVisitable') {\r\n\r\n            } else if (functionName === 'isVisited') {\r\n                result = this.evaluateIsVisitedCriteria(criteria);\r\n            } else if (functionName === 'isVisitedAfter') {\r\n                result = this.evaluateIsVisitedAfterCriteria(criteria);\r\n            } else if (functionName === 'isRevisedAfter') {\r\n                result = this.evaluateIsRevisedAfterCriteria(criteria);\r\n            } else if (functionName === 'isVisitedAndRevisedAfter') {\r\n                result = this.evaluateIsVisitedAndRevisedAfterCriteria(criteria);\r\n            } else if (functionName === 'isCompleted') {\r\n                result = this.evaluateIsCompletedCriteria(criteria);\r\n            } else if (functionName === 'isCorrect') {\r\n                result = this.evaluateIsCorrectCriteria(criteria);\r\n            } else if (functionName === 'choiceChosen') {\r\n                result = this.evaluateChoiceChosenCriteria(criteria);\r\n            } else if (functionName === 'isPlanningActivityCompleted') {\r\n                result = this.evaluateIsPlanningActivityCompletedCriteria(criteria);\r\n            } else if (functionName === 'score') {\r\n                result = this.evaluateScoreCriteria(criteria);\r\n            } else if (functionName === 'usedXSubmits') {\r\n                result = this.evaluateUsedXSubmitsCriteria(criteria);\r\n            } else if (functionName === '') {\r\n\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    /**\r\n     * Check if the isCompleted criteria was satisfied\r\n     * @param criteria an isCompleted criteria\r\n     * @returns whether the criteria was satisfied or not\r\n     */\r\n    evaluateIsCompletedCriteria(criteria) {\r\n        var result = false;\r\n\r\n        if (criteria != null && criteria.params != null) {\r\n            var params = criteria.params;\r\n            var nodeId = params.nodeId;\r\n\r\n            result = this.isCompleted(nodeId);\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Check if the isCorrect criteria was satisfied\r\n     * @param criteria an isCorrect criteria\r\n     * @returns whether the criteria was satisfied or not\r\n     */\r\n    evaluateIsCorrectCriteria(criteria) {\r\n\r\n        if (criteria != null && criteria.params != null) {\r\n\r\n            // get the criteria params\r\n            var params = criteria.params;\r\n            var nodeId = params.nodeId;\r\n            var componentId = params.componentId;\r\n\r\n            if (nodeId != null && componentId != null) {\r\n\r\n                // get the component states for the component\r\n                var componentStates = this.getComponentStatesByNodeIdAndComponentId(nodeId, componentId);\r\n\r\n                if (componentStates != null) {\r\n\r\n                    // loop through all the component states\r\n                    for (var c = 0; c < componentStates.length; c++) {\r\n\r\n                        var componentState = componentStates[c];\r\n\r\n                        if (componentState != null) {\r\n\r\n                            var studentData = componentState.studentData;\r\n\r\n                            if (studentData != null) {\r\n                                if (studentData.isCorrect) {\r\n                                    // the student answered correctly\r\n                                    return true;\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Check if the isPlanningActivityCompleted criteria was satisfied\r\n     * @param criteria a isPlanningActivityCompleted criteria\r\n     * @returns whether the criteria was satisfied or not\r\n     */\r\n    evaluateIsPlanningActivityCompletedCriteria(criteria) {\r\n        var result = false;\r\n\r\n        if (criteria != null && criteria.params != null) {\r\n\r\n            var params = criteria.params;\r\n\r\n            // get the group id\r\n            var nodeId = params.nodeId;\r\n\r\n            // get the number of planning steps the student needs to create\r\n            var planningStepsCreated = params.planningStepsCreated;\r\n\r\n            // get whether the student needs to complete all the steps in the activity\r\n            var planningStepsCompleted = params.planningStepsCompleted;\r\n\r\n            var planningStepsCreatedSatisfied = false;\r\n            var planningStepsCompletedSatisfied = false;\r\n\r\n            var planningNodes = [];\r\n\r\n            if (planningStepsCreated == null) {\r\n                // there is no value set so we will regard it as satisfied\r\n                planningStepsCreatedSatisfied = true;\r\n            } else {\r\n                /*\r\n                 * there is a value for number of planning steps that need to be created\r\n                 * so we will check if the student created enough planning steps\r\n                 */\r\n\r\n                // get the node states for the activity\r\n                var nodeStates = this.getNodeStatesByNodeId(nodeId);\r\n\r\n                if (nodeStates != null) {\r\n\r\n                    /*\r\n                     * loop through all the node states from newest to oldest\r\n                     * for the sake of efficiency\r\n                     */\r\n                    for (var ns = nodeStates.length - 1; ns >= 0; ns--) {\r\n\r\n                        var planningStepCount = 0;\r\n\r\n                        var nodeState = nodeStates[ns];\r\n\r\n                        if (nodeState != null) {\r\n\r\n                            // get the student data\r\n                            var studentData = nodeState.studentData;\r\n\r\n                            if (studentData != null) {\r\n\r\n                                // get the nodes\r\n                                var nodes = studentData.nodes;\r\n\r\n                                if (nodes != null) {\r\n\r\n                                    // loop through the nodes\r\n                                    for (var n = 0; n < nodes.length; n++) {\r\n                                        var node = nodes[n];\r\n\r\n                                        if (node != null) {\r\n                                            if (node.type === 'node' && node.planningNodeTemplateId != null) {\r\n                                                // we have found a planning step the student created\r\n                                                planningStepCount++;\r\n                                            }\r\n                                        }\r\n                                    }\r\n\r\n                                    if (planningStepCount >= planningStepsCreated) {\r\n                                        // the student has created a sufficient number of planning steps\r\n                                        planningStepsCreatedSatisfied = true;\r\n                                        planningNodes = nodes;\r\n                                        break;\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (planningStepsCompleted == null) {\r\n                planningStepsCompletedSatisfied = true;\r\n            } else {\r\n                /*\r\n                 * check if the activity is completed. this checks if all\r\n                 * the children of the activity are completed.\r\n                 */\r\n                if (this.isCompleted(nodeId)) {\r\n                    planningStepsCompletedSatisfied = true;\r\n                }\r\n            }\r\n\r\n            if (planningStepsCreatedSatisfied && planningStepsCompletedSatisfied) {\r\n                result = true;\r\n            }\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Check if this branchPathTaken criteria was satisfied\r\n     * @param criteria a branchPathTaken criteria\r\n     * @returns whether the branchPathTaken criteria was satisfied\r\n     */\r\n    evaluateBranchPathTakenCriteria(criteria) {\r\n        var result = false;\r\n\r\n        if (criteria != null && criteria.params != null) {\r\n            // get the expected from and to node ids\r\n            var expectedFromNodeId = criteria.params.fromNodeId;\r\n            var expectedToNodeId = criteria.params.toNodeId;\r\n\r\n            // get all the branchPathTaken events from the from node id\r\n            var branchPathTakenEvents = this.getBranchPathTakenEventsByNodeId(expectedFromNodeId);\r\n\r\n            if (branchPathTakenEvents != null) {\r\n\r\n                // loop through all the branchPathTaken events\r\n                for (var b = 0; b < branchPathTakenEvents.length; b++) {\r\n                    var branchPathTakenEvent = branchPathTakenEvents[b];\r\n\r\n                    if (branchPathTakenEvent != null) {\r\n                        var data = branchPathTakenEvent.data;\r\n\r\n                        if (data != null) {\r\n                            // get the from and to node ids of the event\r\n                            var fromNodeId = data.fromNodeId;\r\n                            var toNodeId = data.toNodeId;\r\n\r\n                            if (expectedFromNodeId === fromNodeId && expectedToNodeId === toNodeId) {\r\n                                // the from and to node ids match the ones we are looking for\r\n                                result = true;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    /**\r\n     * Check if the isVisited criteria was satisfied\r\n     * @param criteria the isVisited criteria\r\n     * @returns whether the node id is visited\r\n     */\r\n    evaluateIsVisitedCriteria(criteria) {\r\n\r\n        var isVisited = false;\r\n\r\n        if (criteria != null && criteria.params != null) {\r\n\r\n            // get the node id we want to check if was visited\r\n            var nodeId = criteria.params.nodeId;\r\n\r\n            // get all the events\r\n            var events = this.studentData.events;\r\n\r\n            if (events != null) {\r\n\r\n                // loop through all the events\r\n                for (var e = 0; e < events.length; e++) {\r\n                    var event = events[e];\r\n\r\n                    if (event != null) {\r\n                        if (nodeId == event.nodeId && 'nodeEntered' === event.event) {\r\n                            // the student has entered the node before\r\n                            isVisited = true;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return isVisited;\r\n    }\r\n\r\n    /**\r\n     * Check if the isVisitedAfter criteria was satisfied\r\n     * @param criteria the isVisitedAfter criteria\r\n     * @returns whether the node id is visited after the criteriaCreatedTimestamp\r\n     */\r\n    evaluateIsVisitedAfterCriteria(criteria) {\r\n\r\n        let isVisitedAfter = false;\r\n\r\n        if (criteria != null && criteria.params != null) {\r\n\r\n            // get the node id we want to check if was visited\r\n            let isVisitedAfterNodeId = criteria.params.isVisitedAfterNodeId;\r\n            let criteriaCreatedTimestamp = criteria.params.criteriaCreatedTimestamp;\r\n\r\n            // get all the events\r\n            let events = this.studentData.events;\r\n\r\n            if (events != null) {\r\n\r\n                // loop through all the events\r\n                for (let e = 0; e < events.length; e++) {\r\n                    let event = events[e];\r\n\r\n                    if (event != null) {\r\n                        if (isVisitedAfterNodeId == event.nodeId && 'nodeEntered' === event.event && event.clientSaveTime > criteriaCreatedTimestamp) {\r\n                            // the student has entered the node after the criteriaCreatedTimestamp\r\n                            isVisitedAfter = true;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return isVisitedAfter;\r\n    }\r\n\r\n    /**\r\n     * Check if the isRevisedAfter criteria was satisfied\r\n     * @param criteria the isRevisedAfter criteria\r\n     * @returns whether the specified node&component was revisted after the criteriaCreatedTimestamp\r\n     */\r\n    evaluateIsRevisedAfterCriteria(criteria) {\r\n\r\n        let isRevisedAfter = false;\r\n\r\n        if (criteria != null && criteria.params != null) {\r\n\r\n            // get the node id we want to check if was visited\r\n            let isRevisedAfterNodeId = criteria.params.isRevisedAfterNodeId;\r\n            let isRevisedAfterComponentId = criteria.params.isRevisedAfterComponentId;\r\n            let criteriaCreatedTimestamp = criteria.params.criteriaCreatedTimestamp;\r\n\r\n            // the student has entered the node after the criteriaCreatedTimestamp.\r\n            // now check if student has revised the work after this event\r\n            let latestComponentStateForRevisedComponent = this.getLatestComponentStateByNodeIdAndComponentId(isRevisedAfterNodeId, isRevisedAfterComponentId);\r\n            if (latestComponentStateForRevisedComponent.clientSaveTime > criteriaCreatedTimestamp) {\r\n                isRevisedAfter = true;\r\n            }\r\n        }\r\n\r\n        return isRevisedAfter;\r\n    }\r\n\r\n    /**\r\n     * Check if the isVisitedAndRevisedAfter criteria was satisfied\r\n     * @param criteria the isVisitedAndRevisedAfter criteria\r\n     * @returns whether the specified nodes were visited and specified node&component was revisted after the criteriaCreatedTimestamp\r\n     */\r\n    evaluateIsVisitedAndRevisedAfterCriteria(criteria) {\r\n\r\n        let isVisitedAndRevisedAfter = false;\r\n\r\n        if (criteria != null && criteria.params != null) {\r\n\r\n            // get the node id we want to check if was visited\r\n            let isVisitedAfterNodeId = criteria.params.isVisitedAfterNodeId;\r\n            let isRevisedAfterNodeId = criteria.params.isRevisedAfterNodeId;\r\n            let isRevisedAfterComponentId = criteria.params.isRevisedAfterComponentId;\r\n            let criteriaCreatedTimestamp = criteria.params.criteriaCreatedTimestamp;\r\n\r\n            // get all the events\r\n            let events = this.studentData.events;\r\n\r\n            if (events != null) {\r\n\r\n                // loop through all the events\r\n                for (let e = 0; e < events.length; e++) {\r\n                    let event = events[e];\r\n\r\n                    if (event != null) {\r\n                        if (isVisitedAfterNodeId == event.nodeId && 'nodeEntered' === event.event && event.clientSaveTime > criteriaCreatedTimestamp) {\r\n                            // the student has entered the node after the criteriaCreatedTimestamp.\r\n                            // now check if student has revised the work after this event\r\n                            let latestComponentStateForRevisedComponent = this.getLatestComponentStateByNodeIdAndComponentId(isRevisedAfterNodeId, isRevisedAfterComponentId);\r\n                            if (latestComponentStateForRevisedComponent.clientSaveTime > event.clientSaveTime) {\r\n                                isVisitedAndRevisedAfter = true;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return isVisitedAndRevisedAfter;\r\n    }\r\n\r\n    /**\r\n     * Get all the branchPathTaken events by node id\r\n     * @params fromNodeId the from node id\r\n     * @returns all the branchPathTaken events from the given node id\r\n     */\r\n    getBranchPathTakenEventsByNodeId(fromNodeId) {\r\n\r\n        var branchPathTakenEvents = [];\r\n        var events = this.studentData.events;\r\n\r\n        if (events != null) {\r\n\r\n            // loop through all the events\r\n            for (var e = 0; e < events.length; e++) {\r\n                var event = events[e];\r\n\r\n                if (event != null) {\r\n                    if (fromNodeId === event.nodeId && 'branchPathTaken' === event.event) {\r\n                        // we have found a branchPathTaken event from the from node id\r\n                        branchPathTakenEvents.push(event);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return branchPathTakenEvents;\r\n    }\r\n\r\n    /**\r\n     * Evaluate the choice chosen criteria\r\n     * @param criteria the criteria to evaluate\r\n     * @returns a boolean value whether the criteria was satisfied or not\r\n     */\r\n    evaluateChoiceChosenCriteria(criteria) {\r\n\r\n        var result = false;\r\n\r\n        var serviceName = 'MultipleChoiceService';  // Assume MC component.\r\n\r\n        if (this.$injector.has(serviceName)) {\r\n\r\n            // get the MultipleChoiceService\r\n            var service = this.$injector.get(serviceName);\r\n\r\n            // check if the criteria was satisfied\r\n            result = service.choiceChosen(criteria);\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    /**\r\n     * Evaluate the score criteria\r\n     * @param criteria the criteria to evaluate\r\n     * @returns a boolean value whether the criteria was satisfied or not\r\n     */\r\n    evaluateScoreCriteria(criteria) {\r\n\r\n        var result = false;\r\n\r\n        var params = criteria.params;\r\n\r\n        if (params != null) {\r\n\r\n            var nodeId = params.nodeId;\r\n            var componentId = params.componentId;\r\n            var scores = params.scores;\r\n            var workgroupId = this.ConfigService.getWorkgroupId();\r\n            var scoreType = 'any';\r\n\r\n            if (nodeId != null && componentId != null && scores != null) {\r\n\r\n                // get the latest score annotation\r\n                var latestScoreAnnotation = this.AnnotationService.getLatestScoreAnnotation(nodeId, componentId, workgroupId, scoreType);\r\n\r\n                if (latestScoreAnnotation != null) {\r\n\r\n                    // get the score value\r\n                    var scoreValue = this.AnnotationService.getScoreValueFromScoreAnnotation(latestScoreAnnotation);\r\n\r\n                    // check if the score value matches what the criteria is looking for. works when scores is array of integers or integer strings\r\n                    if (scores.indexOf(scoreValue) != -1 || (scoreValue != null && scores.indexOf(scoreValue.toString()) != -1)) {\r\n                        /*\r\n                         * the student has received a score that matches a score\r\n                         * we're looking for\r\n                         */\r\n                        result = true;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    /**\r\n     * Evaluate the used x submits criteria which requires the student to submit\r\n     * at least x number of times.\r\n     * @param criteria the criteria to evaluate\r\n     * @returns a boolean value whether the student submitted at least x number\r\n     * of times\r\n     */\r\n    evaluateUsedXSubmitsCriteria(criteria) {\r\n        var result = false;\r\n\r\n        var params = criteria.params;\r\n\r\n        if (params != null) {\r\n\r\n            // get the node id and component id to check the submit counter for\r\n            var nodeId = params.nodeId;\r\n            var componentId = params.componentId;\r\n\r\n            // get the number of submits required\r\n            var requiredSubmitCount = params.requiredSubmitCount;\r\n\r\n            if (nodeId != null && componentId != null) {\r\n\r\n                // get the component states for the component\r\n                var componentStates = this.getComponentStatesByNodeIdAndComponentId(nodeId, componentId);\r\n\r\n                if (componentStates != null) {\r\n\r\n                    // counter for manually counting the component states with isSubmit=true\r\n                    var manualSubmitCounter = 0;\r\n\r\n                    // counter for remembering the highest submitCounter value found in studentData objects\r\n                    var highestSubmitCounter = 0;\r\n\r\n                    /*\r\n                     * We are counting with two submit counters for backwards compatibility.\r\n                     * Some componentStates only have isSubmit=true and do not keep an\r\n                     * updated submitCounter for the number of submits.\r\n                     */\r\n\r\n                    // loop through all the component states\r\n                    for (var c = 0; c < componentStates.length; c++) {\r\n\r\n                        var componentState = componentStates[c];\r\n\r\n                        if (componentState != null) {\r\n\r\n                            if (componentState.isSubmit) {\r\n                                // this is a submit component state\r\n                                manualSubmitCounter++;\r\n                            }\r\n\r\n                            var studentData = componentState.studentData;\r\n\r\n                            if (studentData != null) {\r\n\r\n                                if (studentData.submitCounter != null) {\r\n                                    if (studentData.submitCounter > highestSubmitCounter) {\r\n                                        /*\r\n                                         * the submit counter in the student data is higher\r\n                                         * than we have previously seen\r\n                                         */\r\n                                        highestSubmitCounter = studentData.submitCounter;\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    if (manualSubmitCounter >= requiredSubmitCount || highestSubmitCounter >= requiredSubmitCount) {\r\n                        // the student submitted the required number of times\r\n                        result = true;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Populate the stack history and visited nodes history\r\n     * @param events the events\r\n     */\r\n    populateHistories(events) {\r\n        this.stackHistory = [];\r\n        this.visitedNodesHistory = [];\r\n\r\n        if (events != null) {\r\n\r\n            // loop through all the events\r\n            for (var e = 0; e < events.length; e++) {\r\n                var event = events[e];\r\n\r\n                if (event != null) {\r\n\r\n                    // look for the nodeEntered event\r\n                    if (event.event === 'nodeEntered') {\r\n\r\n                        // the student has visited this node id before\r\n                        this.updateStackHistory(event.nodeId);\r\n                        this.updateVisitedNodesHistory(event.nodeId);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    getStackHistoryAtIndex(index) {\r\n        if (index < 0) {\r\n            index = this.stackHistory.length + index;\r\n        }\r\n        var stackHistoryResult = null;\r\n        if (this.stackHistory != null && this.stackHistory.length > 0) {\r\n            stackHistoryResult = this.stackHistory[index];\r\n        }\r\n        return stackHistoryResult;\r\n    };\r\n\r\n    getStackHistory() {\r\n        return this.stackHistory;\r\n    };\r\n\r\n    updateStackHistory(nodeId) {\r\n        var indexOfNodeId = this.stackHistory.indexOf(nodeId);\r\n        if (indexOfNodeId === -1) {\r\n            this.stackHistory.push(nodeId);\r\n        } else {\r\n            this.stackHistory.splice(indexOfNodeId + 1, this.stackHistory.length);\r\n        }\r\n    };\r\n\r\n    updateVisitedNodesHistory(nodeId) {\r\n        var indexOfNodeId = this.visitedNodesHistory.indexOf(nodeId);\r\n        if (indexOfNodeId === -1) {\r\n            this.visitedNodesHistory.push(nodeId);\r\n        }\r\n    };\r\n\r\n    getVisitedNodesHistory() {\r\n        return this.visitedNodesHistory;\r\n    };\r\n\r\n    isNodeVisited(nodeId) {\r\n        var result = false;\r\n        var visitedNodesHistory = this.visitedNodesHistory;\r\n\r\n        if (visitedNodesHistory != null) {\r\n            var indexOfNodeId = visitedNodesHistory.indexOf(nodeId);\r\n\r\n            if (indexOfNodeId !== -1) {\r\n                result = true;\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    createComponentState() {\r\n        var componentState = {};\r\n\r\n        componentState.timestamp = Date.parse(new Date());\r\n\r\n        return componentState;\r\n    };\r\n\r\n    addComponentState(componentState) {\r\n        if (this.studentData != null && this.studentData.componentStates != null) {\r\n            this.studentData.componentStates.push(componentState);\r\n\r\n            this.updateNodeStatuses();\r\n        }\r\n    };\r\n\r\n    addNodeState(nodeState) {\r\n        if (this.studentData != null && this.studentData.nodeStates != null) {\r\n            this.studentData.nodeStates.push(nodeState);\r\n\r\n            this.updateNodeStatuses();\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Returns all NodeStates\r\n     * @returns Array of all NodeStates\r\n     */\r\n    getNodeStates() {\r\n        let nodeStates = [];\r\n\r\n        if (this.studentData != null && this.studentData.nodeStates != null) {\r\n            nodeStates = this.studentData.nodeStates;\r\n        }\r\n\r\n        return nodeStates;\r\n    };\r\n\r\n    /**\r\n     * Get all NodeStates for a specific node\r\n     * @param nodeId id of node\r\n     * @returns Array of NodeStates for the specified node\r\n     */\r\n    getNodeStatesByNodeId(nodeId) {\r\n        var nodeStatesByNodeId = [];\r\n\r\n        if (this.studentData != null && this.studentData.nodeStates != null) {\r\n            var nodeStates = this.studentData.nodeStates;\r\n\r\n            for (var n = 0; n < nodeStates.length; n++) {\r\n                var nodeState = nodeStates[n];\r\n\r\n                if (nodeState != null) {\r\n                    var tempNodeId = nodeState.nodeId;\r\n\r\n                    if (nodeId === tempNodeId) {\r\n                        nodeStatesByNodeId.push(nodeState);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return nodeStatesByNodeId;\r\n    };\r\n\r\n    addEvent(event) {\r\n        if (this.studentData != null && this.studentData.events != null) {\r\n            this.studentData.events.push(event);\r\n        }\r\n    };\r\n\r\n    addAnnotation(annotation) {\r\n        if (this.studentData != null && this.studentData.annotations != null) {\r\n            this.studentData.annotations.push(annotation);\r\n        }\r\n    };\r\n\r\n    handleAnnotationReceived(annotation) {\r\n        // add the annotation to the local annotations array\r\n        this.studentData.annotations.push(annotation);\r\n\r\n        if (annotation.notebookItemId) {\r\n            // broadcast the event that a new notebook item annotation has been received\r\n            this.$rootScope.$broadcast('notebookItemAnnotationReceived', {annotation: annotation});\r\n        } else {\r\n            // broadcast the event that a new annotation has been received\r\n            this.$rootScope.$broadcast('annotationReceived', {annotation: annotation});\r\n        }\r\n    }\r\n\r\n    saveComponentEvent(component, category, event, data) {\r\n        if (component == null || category == null || event == null) {\r\n            alert(this.$translate('STUDENT_DATA_SERVICE_SAVE_COMPONENT_EVENT_COMPONENT_CATEGORY_EVENT_ERROR'));\r\n            return;\r\n        }\r\n        var context = \"Component\";\r\n        var nodeId = component.nodeId;\r\n        var componentId = component.componentId;\r\n        var componentType = component.componentType;\r\n        if (nodeId == null || componentId == null || componentType == null) {\r\n            alert(this.$translate('STUDENT_DATA_SERVICE_SAVE_COMPONENT_EVENT_NODE_ID_COMPONENT_ID_COMPONENT_TYPE_ERROR'));\r\n            return;\r\n        }\r\n        this.saveEvent(context, nodeId, componentId, componentType, category, event, data);\r\n    };\r\n\r\n    saveVLEEvent(nodeId, componentId, componentType, category, event, data) {\r\n        if (category == null || event == null) {\r\n            alert(this.$translate('STUDENT_DATA_SERVICE_SAVE_VLE_EVENT_CATEGORY_EVENT_ERROR'));\r\n            return;\r\n        }\r\n        var context = \"VLE\";\r\n        this.saveEvent(context, nodeId, componentId, componentType, category, event, data);\r\n    };\r\n\r\n    saveEvent(context, nodeId, componentId, componentType, category, event, data) {\r\n        var events = [];\r\n        var newEvent = this.createNewEvent();\r\n        newEvent.context = context;\r\n        newEvent.nodeId = nodeId;\r\n        newEvent.componentId = componentId;\r\n        newEvent.type = componentType;\r\n        newEvent.category = category;\r\n        newEvent.event = event;\r\n        newEvent.data = data;\r\n        events.push(newEvent);\r\n        var componentStates = null;\r\n        var nodeStates = null;\r\n        var annotations = null;\r\n        this.saveToServer(componentStates, nodeStates, events, annotations);\r\n    };\r\n\r\n    /**\r\n     * Create a new empty event\r\n     * @return a new empty event\r\n     */\r\n    createNewEvent() {\r\n        var event = {};\r\n\r\n        event.projectId = this.ConfigService.getProjectId();\r\n        event.runId = this.ConfigService.getRunId();\r\n        event.periodId = this.ConfigService.getPeriodId();\r\n        event.workgroupId = this.ConfigService.getWorkgroupId();\r\n        event.clientSaveTime = Date.parse(new Date());\r\n\r\n        return event;\r\n    };\r\n\r\n    saveNodeStates(nodeStates) {\r\n        var componentStates = null;\r\n        var events = null;\r\n        var annotations = null;\r\n        this.saveToServer(componentStates, nodeStates, events, annotations);\r\n    };\r\n\r\n\r\n    saveAnnotations(annotations) {\r\n        var componentStates = null;\r\n        var nodeStates = null;\r\n        var events = null;\r\n        this.saveToServer(componentStates, nodeStates, events, annotations);\r\n    };\r\n\r\n    saveToServer(componentStates, nodeStates, events, annotations) {\r\n\r\n        /*\r\n         * increment the request count since we are about to save data\r\n         * to the server\r\n         */\r\n        this.saveToServerRequestCount += 1;\r\n\r\n        // merge componentStates and nodeStates into StudentWork before posting\r\n        var studentWorkList = [];\r\n        if (componentStates != null && componentStates.length > 0) {\r\n            for (var c = 0; c < componentStates.length; c++) {\r\n                var componentState = componentStates[c];\r\n\r\n                if (componentState != null) {\r\n                    componentState.requestToken = this.UtilService.generateKey(); // use this to keep track of unsaved componentStates.\r\n                    this.addComponentState(componentState);\r\n                    studentWorkList.push(componentState);\r\n                }\r\n            }\r\n        }\r\n\r\n        if (nodeStates != null && nodeStates.length > 0) {\r\n            for (var n = 0; n < nodeStates.length; n++) {\r\n                var nodeState = nodeStates[n];\r\n\r\n                if (nodeState != null) {\r\n                    nodeState.requestToken = this.UtilService.generateKey(); // use this to keep track of unsaved componentStates.\r\n                    this.addNodeState(nodeState);\r\n                    studentWorkList.push(nodeState);\r\n                }\r\n            }\r\n        }\r\n\r\n        if (events != null && events.length > 0) {\r\n            for (var e = 0; e < events.length; e++) {\r\n                var event = events[e];\r\n\r\n                if (event != null) {\r\n                    event.requestToken = this.UtilService.generateKey(); // use this to keep track of unsaved events.\r\n                    this.addEvent(event);\r\n                }\r\n            }\r\n        } else {\r\n            events = [];\r\n        }\r\n\r\n        if (annotations != null && annotations.length > 0) {\r\n            for (var a = 0; a < annotations.length; a++) {\r\n                var annotation = annotations[a];\r\n\r\n                if (annotation != null) {\r\n                    annotation.requestToken = this.UtilService.generateKey(); // use this to keep track of unsaved annotations.\r\n                    if (annotation.id == null) {\r\n                        // add to local annotation array if this annotation has not been saved to the server before.\r\n                        this.addAnnotation(annotation);\r\n                    }\r\n                }\r\n            }\r\n        } else {\r\n            annotations = [];\r\n        }\r\n\r\n        if (this.ConfigService.isPreview()) {\r\n            var savedStudentDataResponse = {\r\n                studentWorkList: studentWorkList,\r\n                events: events,\r\n                annotations: annotations\r\n            };\r\n\r\n            // if we're in preview, don't make any request to the server but pretend we did\r\n            this.saveToServerSuccess(savedStudentDataResponse);\r\n            let deferred = this.$q.defer();\r\n            deferred.resolve(savedStudentDataResponse);\r\n            return deferred.promise;\r\n        } else {\r\n            // set the workgroup id and run id\r\n            var params = {};\r\n            params.projectId = this.ConfigService.getProjectId();\r\n            params.runId = this.ConfigService.getRunId();\r\n            params.workgroupId = this.ConfigService.getWorkgroupId();\r\n            params.studentWorkList = angular.toJson(studentWorkList);\r\n            params.events = angular.toJson(events);\r\n            params.annotations = angular.toJson(annotations);\r\n\r\n            // get the url to POST the student data\r\n            var httpParams = {};\r\n            httpParams.method = 'POST';\r\n            httpParams.url = this.ConfigService.getConfigParam('studentDataURL');\r\n            httpParams.headers = {'Content-Type': 'application/x-www-form-urlencoded'};\r\n            httpParams.data = $.param(params);\r\n\r\n            // make the request to post the student data\r\n            return this.$http(httpParams).then(\r\n                result => {\r\n                    // get the local references to the component states that were posted and set their id and serverSaveTime\r\n                    if (result != null && result.data != null) {\r\n                        var savedStudentDataResponse = result.data;\r\n\r\n                        this.saveToServerSuccess(savedStudentDataResponse);\r\n\r\n                        return savedStudentDataResponse;\r\n                    }\r\n                }, result => {\r\n                    // a server error occured\r\n\r\n                    /*\r\n                     * decrement the request count since this request failed\r\n                     * but is now completed\r\n                     */\r\n                    this.saveToServerRequestCount -= 1;\r\n\r\n                    return null;\r\n                }\r\n            );\r\n        }\r\n    };\r\n\r\n    saveToServerSuccess(savedStudentDataResponse) {\r\n\r\n        /*\r\n         * decrement the request count since we have received a response to\r\n         * one of our save requests\r\n         */\r\n        this.saveToServerRequestCount -= 1;\r\n\r\n        if (this.saveToServerRequestCount == 0) {\r\n            /*\r\n             * we have received the reponse to all of the saveToServer requests\r\n             * so we will now update the student status and save it to the\r\n             * server\r\n             */\r\n            this.updateNodeStatuses();\r\n            this.saveStudentStatus();\r\n        }\r\n\r\n        // set dummy serverSaveTime for use if we're in preview mode\r\n        let serverSaveTime = Date.parse(new Date());\r\n\r\n        // handle saved studentWork\r\n        if (savedStudentDataResponse.studentWorkList) {\r\n            let savedStudentWorkList = savedStudentDataResponse.studentWorkList;\r\n            let localStudentWorkList = this.studentData.componentStates;\r\n            if (this.studentData.nodeStates) {\r\n                localStudentWorkList = localStudentWorkList.concat(this.studentData.nodeStates);\r\n            }\r\n\r\n            // set the id and serverSaveTime in the local studentWorkList\r\n            for (var i = 0; i < savedStudentWorkList.length; i++) {\r\n                var savedStudentWork = savedStudentWorkList[i];\r\n\r\n                /*\r\n                 * loop through all the student work that were posted\r\n                 * to find the one with the matching request token\r\n                 */\r\n                for (var l = localStudentWorkList.length - 1; l >= 0; l--) {\r\n                    var localStudentWork = localStudentWorkList[l];\r\n                    if (localStudentWork.requestToken &&\r\n                        localStudentWork.requestToken === savedStudentWork.requestToken) {\r\n                        localStudentWork.id = savedStudentWork.id;\r\n                        localStudentWork.serverSaveTime = savedStudentWork.serverSaveTime ? savedStudentWork.serverSaveTime : serverSaveTime;\r\n                        localStudentWork.requestToken = null; // requestToken is no longer needed.\r\n\r\n                        if (this.ConfigService.getMode() == \"preview\" && localStudentWork.id == null) {\r\n                            /*\r\n                             * we are in preview mode so we will set a dummy\r\n                             * student work id into the student work\r\n                             */\r\n                            localStudentWork.id = this.dummyStudentWorkId;\r\n\r\n                            /*\r\n                             * increment the dummy student work id for the next\r\n                             * student work\r\n                             */\r\n                            this.dummyStudentWorkId++;\r\n                        }\r\n\r\n                        this.$rootScope.$broadcast('studentWorkSavedToServer', {studentWork: localStudentWork});\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        // handle saved events\r\n        if (savedStudentDataResponse.events) {\r\n            var savedEvents = savedStudentDataResponse.events;\r\n\r\n            var localEvents = this.studentData.events;\r\n\r\n            // set the id and serverSaveTime in the local event\r\n            for (var i = 0; i < savedEvents.length; i++) {\r\n                var savedEvent = savedEvents[i];\r\n\r\n                /*\r\n                 * loop through all the events that were posted\r\n                 * to find the one with the matching request token\r\n                 */\r\n                for (var l = localEvents.length - 1; l >= 0; l--) {\r\n                    var localEvent = localEvents[l];\r\n                    if (localEvent.requestToken &&\r\n                        localEvent.requestToken === savedEvent.requestToken) {\r\n                        localEvent.id = savedEvent.id;\r\n                        localEvent.serverSaveTime = savedEvent.serverSaveTime ? savedEvent.serverSaveTime : serverSaveTime;\r\n                        localEvent.requestToken = null; // requestToken is no longer needed.\r\n\r\n                        this.$rootScope.$broadcast('eventSavedToServer', {event: localEvent});\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        // handle saved annotations\r\n        if (savedStudentDataResponse.annotations) {\r\n            var savedAnnotations = savedStudentDataResponse.annotations;\r\n\r\n            var localAnnotations = this.studentData.annotations;\r\n\r\n            // set the id and serverSaveTime in the local annotation\r\n            for (var i = 0; i < savedAnnotations.length; i++) {\r\n                var savedAnnotation = savedAnnotations[i];\r\n\r\n                /*\r\n                 * loop through all the events that were posted\r\n                 * to find the one with the matching request token\r\n                 */\r\n                for (var l = localAnnotations.length - 1; l >= 0; l--) {\r\n                    var localAnnotation = localAnnotations[l];\r\n                    if (localAnnotation.requestToken &&\r\n                        localAnnotation.requestToken === savedAnnotation.requestToken) {\r\n                        localAnnotation.id = savedAnnotation.id;\r\n                        localAnnotation.serverSaveTime = savedAnnotation.serverSaveTime ? savedAnnotation.serverSaveTime : serverSaveTime;\r\n                        localAnnotation.requestToken = null; // requestToken is no longer needed.\r\n\r\n                        this.$rootScope.$broadcast('annotationSavedToServer', {annotation: localAnnotation});\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        this.updateNodeStatuses();\r\n\r\n    };\r\n\r\n    /**\r\n     * POSTs student status to server\r\n     * Returns a promise of the POST request\r\n     */\r\n    saveStudentStatus() {\r\n\r\n        if (!this.ConfigService.isPreview()) {\r\n            // we are in a run\r\n            var studentStatusURL = this.ConfigService.getStudentStatusURL();\r\n            if (studentStatusURL != null) {\r\n                var runId = this.ConfigService.getRunId();\r\n                var periodId = this.ConfigService.getPeriodId();\r\n                var workgroupId = this.ConfigService.getWorkgroupId();\r\n\r\n                // get the current node id\r\n                var currentNodeId = this.getCurrentNodeId();\r\n\r\n                // get the node statuses\r\n                var nodeStatuses = this.getNodeStatuses();\r\n\r\n                // get the project completion percentage\r\n                var projectCompletion = this.getProjectCompletion();\r\n\r\n                // create the JSON that will be saved to the database\r\n                var studentStatusJSON = {};\r\n                studentStatusJSON.runId = runId;\r\n                studentStatusJSON.periodId = periodId;\r\n                studentStatusJSON.workgroupId = workgroupId;\r\n                studentStatusJSON.currentNodeId = currentNodeId;\r\n                studentStatusJSON.nodeStatuses = nodeStatuses;\r\n                studentStatusJSON.projectCompletion = projectCompletion;\r\n\r\n                // get the student status as a string\r\n                var status = angular.toJson(studentStatusJSON);\r\n\r\n                /*\r\n                 * create the params for the message that will be sent\r\n                 * to the StudentStatusController and saved in the\r\n                 * database\r\n                 */\r\n                var studentStatusParams = {};\r\n                studentStatusParams.runId = runId;\r\n                studentStatusParams.periodId = periodId;\r\n                studentStatusParams.workgroupId = workgroupId;\r\n                studentStatusParams.status = status;\r\n\r\n                // get the url to POST the student data\r\n                var httpParams = {};\r\n                httpParams.method = 'POST';\r\n                httpParams.url = studentStatusURL;\r\n                httpParams.headers = {'Content-Type': 'application/x-www-form-urlencoded'};\r\n                httpParams.data = $.param(studentStatusParams);\r\n\r\n                // make the request to post the student status\r\n                return this.$http(httpParams).then(\r\n                    result => {\r\n                        return true;\r\n                    }, result => {\r\n                        // a server error occured\r\n                        return false;\r\n                    }\r\n                );\r\n            }\r\n        }\r\n    };\r\n\r\n    retrieveComponentStates(runId, periodId, workgroupId) {\r\n\r\n    };\r\n\r\n    getLatestComponentState() {\r\n        var latestComponentState = null;\r\n\r\n        var studentData = this.studentData;\r\n\r\n        if (studentData != null) {\r\n            var componentStates = studentData.componentStates;\r\n\r\n            if (componentStates != null) {\r\n                latestComponentState = componentStates[componentStates.length - 1];\r\n            }\r\n        }\r\n\r\n        return latestComponentState;\r\n    };\r\n\r\n    /**\r\n     * Check whether the component has unsubmitted work\r\n     * @return boolean whether or not there is unsubmitted work\r\n     */\r\n    isComponentSubmitDirty() {\r\n        let submitDirty = false;\r\n\r\n        let latestComponentState = this.getLatestComponentState();\r\n        if (latestComponentState && !latestComponentState.isSubmit) {\r\n            submitDirty = true;\r\n        }\r\n\r\n        return submitDirty;\r\n    };\r\n\r\n    /**\r\n     * Get the latest NodeState for the specified node id\r\n     * @param nodeId the node id\r\n     * @return the latest node state with the matching node id or null if none are found\r\n     */\r\n    getLatestNodeStateByNodeId(nodeId) {\r\n        let latestNodeState = null;\r\n        let allNodeStatesByNodeId = this.getNodeStatesByNodeId(nodeId);\r\n        if (allNodeStatesByNodeId != null && allNodeStatesByNodeId.length > 0) {\r\n            latestNodeState = allNodeStatesByNodeId[allNodeStatesByNodeId.length - 1];\r\n        }\r\n        return latestNodeState;\r\n    };\r\n\r\n    /**\r\n     * Get the latest component state for the given node id and component\r\n     * id.\r\n     * @param nodeId the node id\r\n     * @param componentId the component id (optional)\r\n     * @return the latest component state with the matching node id and\r\n     * component id or null if none are found\r\n     */\r\n    getLatestComponentStateByNodeIdAndComponentId(nodeId, componentId) {\r\n        var latestComponentState = null;\r\n\r\n        if (nodeId) {\r\n            var studentData = this.studentData;\r\n\r\n            if (studentData) {\r\n                // get the component states\r\n                var componentStates = studentData.componentStates;\r\n\r\n                if (componentStates) {\r\n                    // loop through all the component states from newest to oldest\r\n                    for (var c = componentStates.length - 1; c >= 0; c--) {\r\n                        var componentState = componentStates[c];\r\n\r\n                        if (componentState) {\r\n                            var componentStateNodeId = componentState.nodeId;\r\n\r\n                            // compare the node id and component id\r\n                            if (nodeId === componentStateNodeId) {\r\n                                if (componentId) {\r\n                                    var componentStateComponentId = componentState.componentId;\r\n                                    if (componentId === componentStateComponentId) {\r\n                                        latestComponentState = componentState;\r\n                                        break;\r\n                                    }\r\n                                } else {\r\n                                    latestComponentState = componentState;\r\n                                    break;\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return latestComponentState;\r\n    };\r\n\r\n    /**\r\n     * Get the student work by specified student work id, which can be a ComponentState or NodeState\r\n     * @param studentWorkId the student work id\r\n     * @return an StudentWork or null\r\n     */\r\n    getStudentWorkByStudentWorkId(studentWorkId) {\r\n        if (studentWorkId != null) {\r\n            // get the component states\r\n            var componentStates = this.studentData.componentStates;\r\n\r\n            if (componentStates != null) {\r\n\r\n                // loop through all the component states\r\n                for (var c = 0; c < componentStates.length; c++) {\r\n                    var componentState = componentStates[c];\r\n\r\n                    if (componentState != null && componentState.id === studentWorkId) {\r\n                        return componentState;\r\n                    }\r\n                }\r\n            }\r\n\r\n            // get the node states\r\n            var nodeStates = this.studentData.nodeStates;\r\n\r\n            if (nodeStates != null) {\r\n\r\n                // loop through all the node states\r\n                for (var n = 0; n < nodeStates.length; n++) {\r\n                    var nodeState = nodeStates[n];\r\n                    if (nodeState != null && nodeState.id === studentWorkId) {\r\n                        return nodeState;\r\n                    }\r\n                }\r\n            }\r\n\r\n        }\r\n        return null;\r\n    };\r\n\r\n    /**\r\n     * Returns all the component states for this workgroup\r\n     */\r\n    getComponentStates() {\r\n        return this.studentData.componentStates;\r\n    };\r\n\r\n    /**\r\n     * Get the component states for the given node id\r\n     * @param nodeId the node id\r\n     * @return an array of component states for the given node id\r\n     */\r\n    getComponentStatesByNodeId(nodeId) {\r\n        var componentStatesByNodeId = [];\r\n\r\n        if (nodeId != null) {\r\n            var studentData = this.studentData;\r\n\r\n            if (studentData != null) {\r\n\r\n                // get the component states\r\n                var componentStates = studentData.componentStates;\r\n\r\n                if (componentStates != null) {\r\n\r\n                    // loop through all the component states\r\n                    for (var c = 0; c < componentStates.length; c++) {\r\n                        var componentState = componentStates[c];\r\n\r\n                        if (componentState != null) {\r\n                            var componentStateNodeId = componentState.nodeId;\r\n\r\n                            // compare the node id\r\n                            if (nodeId == componentStateNodeId) {\r\n\r\n                                componentStatesByNodeId.push(componentState);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return componentStatesByNodeId;\r\n    };\r\n\r\n    /**\r\n     * Get the component states for the given node id and component id\r\n     * @param nodeId the node id\r\n     * @param componentId the component id\r\n     * @return an array of component states for the given node id and\r\n     * component id\r\n     */\r\n    getComponentStatesByNodeIdAndComponentId(nodeId, componentId) {\r\n        var componentStatesByNodeIdAndComponentId = [];\r\n\r\n        if (nodeId != null && componentId != null) {\r\n            var studentData = this.studentData;\r\n\r\n            if (studentData != null) {\r\n\r\n                // get the component states\r\n                var componentStates = studentData.componentStates;\r\n\r\n                if (componentStates != null) {\r\n\r\n                    // loop through all the component states\r\n                    for (var c = 0; c < componentStates.length; c++) {\r\n                        var componentState = componentStates[c];\r\n\r\n                        if (componentState != null) {\r\n                            var componentStateNodeId = componentState.nodeId;\r\n                            var componentStateComponentId = componentState.componentId;\r\n\r\n                            // compare the node id and component id\r\n                            if (nodeId == componentStateNodeId &&\r\n                                componentId == componentStateComponentId) {\r\n\r\n                                componentStatesByNodeIdAndComponentId.push(componentState);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return componentStatesByNodeIdAndComponentId;\r\n    };\r\n\r\n    /**\r\n     * Get all events\r\n     * @returns all events for the student\r\n     */\r\n    getEvents() {\r\n        if (this.studentData != null && this.studentData.events != null) {\r\n            return this.studentData.events;\r\n        } else {\r\n            return [];\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Get the events for a node id\r\n     * @param nodeId the node id\r\n     * @returns the events for the node id\r\n     */\r\n    getEventsByNodeId(nodeId) {\r\n        var eventsByNodeId = [];\r\n\r\n        if (nodeId != null) {\r\n\r\n            if (this.studentData != null && this.studentData.events != null) {\r\n\r\n                // get all the events\r\n                var events = this.studentData.events;\r\n\r\n                // loop through all the events\r\n                for (var e = 0; e < events.length; e++) {\r\n                    var event = events[e];\r\n\r\n                    if (event != null) {\r\n                        var eventNodeId = event.nodeId;\r\n\r\n                        if (nodeId === eventNodeId) {\r\n                            // this event is for the node id we are looking for\r\n                            eventsByNodeId.push(event);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return eventsByNodeId;\r\n    };\r\n\r\n\r\n    /**\r\n     * Get the events for a component id\r\n     * @param nodeId the node id\r\n     * @param componentId the component id\r\n     * @returns an array of events for the component id\r\n     */\r\n    getEventsByNodeIdAndComponentId(nodeId, componentId) {\r\n        var eventsByNodeId = [];\r\n\r\n        if (nodeId != null) {\r\n\r\n            if (this.studentData != null && this.studentData.events != null) {\r\n\r\n                // get all the events\r\n                var events = this.studentData.events;\r\n\r\n                // loop through all the events\r\n                for (var e = 0; e < events.length; e++) {\r\n                    var event = events[e];\r\n\r\n                    if (event != null) {\r\n                        var eventNodeId = event.nodeId;\r\n                        var eventComponentId = event.componentId;\r\n\r\n                        if (nodeId === eventNodeId && componentId === eventComponentId) {\r\n                            // this events is for the component id we are looking for\r\n                            eventsByNodeId.push(event);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return eventsByNodeId;\r\n    };\r\n\r\n    /**\r\n     * Get the node id of the latest node entered event for an active node that\r\n     * exists in the project. We need to check if the node exists in the project\r\n     * in case the node has been deleted from the project. We also need to check\r\n     * that the node is active in case the node has been moved to the inactive\r\n     * section of the project.\r\n     * @return the node id of the latest node entered event for an active node\r\n     * that exists in the project\r\n     */\r\n    getLatestNodeEnteredEventNodeIdWithExistingNode() {\r\n\r\n        // get all the events\r\n        var events = this.studentData.events;\r\n\r\n        // loop through all the events newest to oldest\r\n        for (var e = events.length - 1; e >= 0; e--) {\r\n\r\n            // get an event\r\n            var event = events[e];\r\n\r\n            if (event != null) {\r\n\r\n                // get the event name\r\n                var eventName = event.event;\r\n\r\n                if (eventName == 'nodeEntered') {\r\n                    // we have found a nodeEntered event\r\n\r\n                    // get the node id of the event\r\n                    var nodeId = event.nodeId;\r\n\r\n                    // check if the node exists in the project\r\n                    var node = this.ProjectService.getNodeById(nodeId);\r\n\r\n                    if (node != null) {\r\n\r\n                        // check if the node is active\r\n                        if (this.ProjectService.isActive(nodeId)) {\r\n                            // the node exists in the project and is active\r\n                            return nodeId;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Check if the student can visit the node\r\n     * @param nodeId the node id\r\n     * @returns whether the student can visit the node\r\n     */\r\n    canVisitNode(nodeId) {\r\n\r\n        var result = false;\r\n\r\n        if (nodeId != null) {\r\n\r\n            // get the node status for the node\r\n            var nodeStatus = this.getNodeStatusByNodeId(nodeId);\r\n\r\n            if (nodeStatus != null) {\r\n                if (nodeStatus.isVisitable) {\r\n                    result = true;\r\n                }\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    /**\r\n     * Get the node status by node id\r\n     * @param nodeId the node id\r\n     * @returns the node status object for a node\r\n     */\r\n    getNodeStatusByNodeId(nodeId) {\r\n        var nodeStatuses = this.nodeStatuses;\r\n        var nodeStatus = null;\r\n\r\n        if (nodeId != null) {\r\n            nodeStatus = nodeStatuses[nodeId];\r\n        }\r\n\r\n        return nodeStatus;\r\n    };\r\n\r\n    /**\r\n     * Get progress information for a given node\r\n     * @param nodeId the node id\r\n     * @returns object with number of completed items (both all and for items\r\n     * that capture student work), number of visible items (all/with work),\r\n     * completion % (for all items, items with student work)\r\n     */\r\n    getNodeProgressById(nodeId) {\r\n        let completedItems = 0;\r\n        let completedItemsWithWork = 0;\r\n        let totalItems = 0;\r\n        let totalItemsWithWork = 0;\r\n        let progress = {};\r\n\r\n        if (this.ProjectService.isGroupNode(nodeId)) {\r\n            let nodeIds = this.ProjectService.getChildNodeIdsById(nodeId);\r\n            for (let n=0; n<nodeIds.length; n++) {\r\n                let id = nodeIds[n];\r\n                let status = this.nodeStatuses[id];\r\n                if (this.ProjectService.isGroupNode(id)) {\r\n                    if (status.progress.totalItemsWithWork > -1) {\r\n                      completedItems += status.progress.completedItems;\r\n                      totalItems += status.progress.totalItems;\r\n                      completedItemsWithWork += status.progress.completedItemsWithWork;\r\n                      totalItemsWithWork += status.progress.totalItemsWithWork;\r\n                    } else {\r\n                        // we have a legacy node status so we'll need to calculate manually\r\n                        let groupProgress = this.getNodeProgressById(id);\r\n                        completedItems += groupProgress.completedItems;\r\n                        totalItems += groupProgress.totalItems;\r\n                        completedItemsWithWork += groupProgress.completedItemsWithWork;\r\n                        totalItemsWithWork += groupProgress.totalItemsWithWork;\r\n                    }\r\n                } else {\r\n                    if (status.isVisible) {\r\n                        totalItems++;\r\n\r\n                        let hasWork = this.ProjectService.nodeHasWork(id);\r\n                        if (hasWork) {\r\n                            totalItemsWithWork++;\r\n                        }\r\n\r\n                        if (status.isCompleted) {\r\n                            completedItems++;\r\n\r\n                            if (hasWork) {\r\n                              completedItemsWithWork++;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            let completionPct = totalItems ? Math.round(completedItems / totalItems * 100) : 0;\r\n            let completionPctWithWork = totalItemsWithWork ? Math.round(completedItemsWithWork / totalItemsWithWork * 100) : 0;\r\n\r\n            progress = {\r\n                \"completedItems\": completedItems,\r\n                \"completedItemsWithWork\": completedItemsWithWork,\r\n                \"totalItems\": totalItems,\r\n                \"totalItemsWithWork\": totalItemsWithWork,\r\n                \"completionPct\": completionPct,\r\n                \"completionPctWithWork\": completionPctWithWork\r\n            };\r\n        }\r\n\r\n        // TODO: implement for steps (using components instead of child nodes)?\r\n\r\n        return progress;\r\n    };\r\n\r\n    /**\r\n     * Check if the given node or component is completed\r\n     * @param nodeId the node id\r\n     * @param componentId (optional) the component id\r\n     * @returns whether the node or component is completed\r\n     */\r\n    isCompleted(nodeId, componentId) {\r\n\r\n        var result = false;\r\n\r\n        if (nodeId && componentId) {\r\n            // check that the component is completed\r\n\r\n            // get the component states for the component\r\n            var componentStates = this.getComponentStatesByNodeIdAndComponentId(nodeId, componentId);\r\n\r\n            // get the component events\r\n            var componentEvents = this.getEventsByNodeIdAndComponentId(nodeId, componentId);\r\n\r\n            // get the node events\r\n            var nodeEvents = this.getEventsByNodeId(nodeId);\r\n\r\n            // get the component object\r\n            var component = this.ProjectService.getComponentByNodeIdAndComponentId(nodeId, componentId);\r\n\r\n            var node = this.ProjectService.getNodeById(nodeId);\r\n\r\n            if (component != null) {\r\n\r\n                // get the component type\r\n                var componentType = component.type;\r\n\r\n                if (componentType != null) {\r\n\r\n                    // get the service for the component type\r\n                    var service = this.$injector.get(componentType + 'Service');\r\n\r\n                    // check if the component is completed\r\n                    if (service.isCompleted(component, componentStates, componentEvents, nodeEvents, node)) {\r\n                        result = true;\r\n                    }\r\n                }\r\n            }\r\n        } else if (nodeId) {\r\n            // check if node is a group\r\n            var isGroup = this.ProjectService.isGroupNode(nodeId);\r\n\r\n            var node = this.ProjectService.getNodeById(nodeId);\r\n\r\n            if (isGroup) {\r\n                // node is a group\r\n                var tempResult = true;\r\n\r\n                // check that all the nodes in the group are visible and completed\r\n                var nodeIds = this.ProjectService.getChildNodeIdsById(nodeId);\r\n\r\n                if (nodeIds.length) {\r\n                    for (var n=0; n<nodeIds.length; n++) {\r\n                        var id = nodeIds[n];\r\n\r\n                        if (this.nodeStatuses[id] == null || !this.nodeStatuses[id].isVisible || !this.nodeStatuses[id].isCompleted) {\r\n                            // the child is not visible or not completed so the group is not completed\r\n                            tempResult = false;\r\n                            break;\r\n                        }\r\n                    }\r\n                } else {\r\n                    // there are no nodes in the group (could be a planning activity, for example), so set isCompleted to false\r\n                    tempResult = false;\r\n                }\r\n\r\n                result = tempResult;\r\n            } else {\r\n                // check that all the components in the node are completed\r\n\r\n                // get all the components in the node\r\n                var components = this.ProjectService.getComponentsByNodeId(nodeId);\r\n\r\n                // we will default to is completed true\r\n                var tempResult = true;\r\n\r\n                /*\r\n                 * All components must be completed in order for the node to be completed\r\n                 * so we will loop through all the components and check if they are\r\n                 * completed\r\n                 */\r\n                for (var c = 0; c < components.length; c++) {\r\n                    var component = components[c];\r\n\r\n                    if (component != null) {\r\n                        var componentId = component.id;\r\n                        var componentType = component.type;\r\n                        var showPreviousWorkNodeId = component.showPreviousWorkNodeId;\r\n                        var showPreviousWorkComponentId = component.showPreviousWorkComponentId;\r\n\r\n                        var tempNodeId = nodeId;\r\n                        var tempNode = node;\r\n                        var tempComponentId = componentId;\r\n                        var tempComponent = component;\r\n\r\n                        if (showPreviousWorkNodeId != null && showPreviousWorkComponentId != null) {\r\n                            /*\r\n                             * this is a show previous work component so we will check if the\r\n                             * previous component was completed\r\n                             */\r\n                            tempNodeId = showPreviousWorkNodeId;\r\n                            tempComponentId = showPreviousWorkComponentId;\r\n                            tempNode = this.ProjectService.getNodeById(tempNodeId);\r\n                            tempComponent = this.ProjectService.getComponentByNodeIdAndComponentId(tempNodeId, tempComponentId);\r\n                        }\r\n\r\n                        if (componentType != null) {\r\n                            try {\r\n\r\n                                // get the service name\r\n                                var serviceName = componentType + 'Service';\r\n\r\n                                if (this.$injector.has(serviceName)) {\r\n\r\n                                    // get the service for the component type\r\n                                    var service = this.$injector.get(serviceName);\r\n\r\n                                    // get the component states for the component\r\n                                    var componentStates = this.getComponentStatesByNodeIdAndComponentId(tempNodeId, tempComponentId);\r\n\r\n                                    // get the component events\r\n                                    var componentEvents = this.getEventsByNodeIdAndComponentId(tempNodeId, tempComponentId);\r\n\r\n                                    // get the node events\r\n                                    var nodeEvents = this.getEventsByNodeId(tempNodeId);\r\n\r\n                                    // check if the component is completed\r\n                                    var isComponentCompleted = service.isCompleted(tempComponent, componentStates, componentEvents, nodeEvents, tempNode);\r\n\r\n                                    tempResult = tempResult && isComponentCompleted;\r\n                                }\r\n                            } catch (e) {\r\n                                console.log(this.$translate('ERROR_COULD_NOT_CALCULATE_IS_COMPLETED') + tempComponentId);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n                result = tempResult;\r\n            }\r\n        }\r\n\r\n        return result;\r\n    };\r\n\r\n    /**\r\n     * Get the current node\r\n     * @returns the current node object\r\n     */\r\n    getCurrentNode() {\r\n        return this.currentNode;\r\n    };\r\n\r\n    /**\r\n     * Get the current node id\r\n     * @returns the current node id\r\n     */\r\n    getCurrentNodeId() {\r\n        var currentNodeId = null;\r\n\r\n        if (this.currentNode != null) {\r\n            currentNodeId = this.currentNode.id;\r\n        }\r\n\r\n        return currentNodeId;\r\n    };\r\n\r\n    /**\r\n     * Set the current node\r\n     * @param nodeId the node id\r\n     */\r\n    setCurrentNodeByNodeId(nodeId) {\r\n        if (nodeId != null) {\r\n            var node = this.ProjectService.getNodeById(nodeId);\r\n\r\n            this.setCurrentNode(node);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Set the current node\r\n     * @param node the node object\r\n     */\r\n    setCurrentNode(node) {\r\n        var previousCurrentNode = this.currentNode;\r\n\r\n        if (previousCurrentNode !== node) {\r\n            // the current node is about to change\r\n\r\n            if(previousCurrentNode && !this.ProjectService.isGroupNode(previousCurrentNode.id)){\r\n                // set the previous node to the current node\r\n                this.previousStep = previousCurrentNode;\r\n            }\r\n\r\n            // set the current node to the new node\r\n            this.currentNode = node;\r\n\r\n            // broadcast the event that the current node has changed\r\n            this.$rootScope.$broadcast('currentNodeChanged', {previousNode: previousCurrentNode, currentNode: this.currentNode});\r\n        }\r\n    };\r\n\r\n    /**\r\n     * End the current node\r\n     */\r\n    endCurrentNode() {\r\n\r\n        // get the current node\r\n        var previousCurrentNode = this.currentNode;\r\n\r\n        if (previousCurrentNode != null) {\r\n\r\n            // tell the node to exit\r\n            this.$rootScope.$broadcast('exitNode', {nodeToExit: previousCurrentNode});\r\n        }\r\n    };\r\n\r\n    /**\r\n     * End the current node and set the current node\r\n     * @param nodeId the node id of the new current node\r\n     */\r\n    endCurrentNodeAndSetCurrentNodeByNodeId(nodeId) {\r\n\r\n        // check if the node is visitable\r\n        if (this.nodeStatuses[nodeId].isVisitable) {\r\n            // the node is visitable\r\n            // end the current node\r\n            this.endCurrentNode();\r\n\r\n            // set the current node\r\n            this.setCurrentNodeByNodeId(nodeId);\r\n        } else {\r\n            // the node is not visitable\r\n            this.nodeClickLocked(nodeId);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Broadcast a listenable event that a locked node has been clicked (attempted to be opened)\r\n     * @param nodeId\r\n     */\r\n    nodeClickLocked(nodeId) {\r\n        this.$rootScope.$broadcast('nodeClickLocked', {nodeId: nodeId});\r\n    };\r\n\r\n    /**\r\n     * This will parse a delimited string into an array of\r\n     * arrays. The default delimiter is the comma, but this\r\n     * can be overriden in the second argument.\r\n     * Source: http://www.bennadel.com/blog/1504-ask-ben-parsing-csv-strings-with-javascript-exec-regular-expression-command.htm\r\n     */\r\n    CSVToArray( strData, strDelimiter ) {\r\n        // Check to see if the delimiter is defined. If not,\r\n        // then default to comma.\r\n        strDelimiter = (strDelimiter || \",\");\r\n\r\n        // Create a regular expression to parse the CSV values.\r\n        var objPattern = new RegExp(\r\n            (\r\n                // Delimiters.\r\n                \"(\\\\\" + strDelimiter + \"|\\\\r?\\\\n|\\\\r|^)\" +\r\n\r\n                    // Quoted fields.\r\n                \"(?:\\\"([^\\\"]*(?:\\\"\\\"[^\\\"]*)*)\\\"|\" +\r\n\r\n                    // Standard fields.\r\n                \"([^\\\"\\\\\" + strDelimiter + \"\\\\r\\\\n]*))\"\r\n            ),\r\n            \"gi\"\r\n        );\r\n\r\n        // Create an array to hold our data. Give the array\r\n        // a default empty first row.\r\n        var arrData = [[]];\r\n\r\n        // Create an array to hold our individual pattern\r\n        // matching groups.\r\n        var arrMatches = null;\r\n\r\n\r\n        // Keep looping over the regular expression matches\r\n        // until we can no longer find a match.\r\n        while (arrMatches = objPattern.exec( strData )) {\r\n\r\n            // Get the delimiter that was found.\r\n            var strMatchedDelimiter = arrMatches[ 1 ];\r\n\r\n            // Check to see if the given delimiter has a length\r\n            // (is not the start of string) and if it matches\r\n            // field delimiter. If id does not, then we know\r\n            // that this delimiter is a row delimiter.\r\n            if (\r\n                strMatchedDelimiter.length &&\r\n                (strMatchedDelimiter != strDelimiter)\r\n            ){\r\n\r\n                // Since we have reached a new row of data,\r\n                // add an empty row to our data array.\r\n                arrData.push( [] );\r\n            }\r\n\r\n            // Now that we have our delimiter out of the way,\r\n            // let's check to see which kind of value we\r\n            // captured (quoted or unquoted).\r\n            if (arrMatches[ 2 ]){\r\n\r\n                // We found a quoted value. When we capture\r\n                // this value, unescape any double quotes.\r\n                var strMatchedValue = arrMatches[ 2 ].replace(\r\n                    new RegExp( \"\\\"\\\"\", \"g\" ),\r\n                    \"\\\"\"\r\n                );\r\n\r\n            } else {\r\n\r\n                // We found a non-quoted value.\r\n                var strMatchedValue = arrMatches[ 3 ];\r\n            }\r\n\r\n            // Now that we have our value string, let's add\r\n            // it to the data array.\r\n            var finalValue = strMatchedValue;\r\n            var floatVal = parseFloat(strMatchedValue);\r\n            if (!isNaN(floatVal)) {\r\n                finalValue = floatVal;\r\n            }\r\n            arrData[ arrData.length - 1 ].push( finalValue );\r\n        }\r\n\r\n        // Return the parsed data.\r\n        return( arrData );\r\n    };\r\n\r\n    /**\r\n     * Get the total score for the workgroup\r\n     * @returns the total score for the workgroup\r\n     */\r\n    getTotalScore() {\r\n        var annotations = this.studentData.annotations;\r\n        var workgroupId = this.ConfigService.getWorkgroupId();\r\n        return this.AnnotationService.getTotalScore(annotations, workgroupId);\r\n    }\r\n\r\n    /**\r\n     * Get the project completion for the signed in student\r\n     * @returns the project completion percentage for the signed in student\r\n     */\r\n    getProjectCompletion() {\r\n\r\n        // group0 is always the root node of the whole project\r\n        var nodeId = 'group0';\r\n\r\n        // get the progress including all of the children nodes\r\n        var progress = this.getNodeProgressById(nodeId);\r\n\r\n        return progress;\r\n    }\r\n\r\n    /**\r\n     * Get the run status\r\n     */\r\n    getRunStatus() {\r\n        return this.runStatus;\r\n    }\r\n\r\n    /**\r\n     * Get the next available planning node instance node id\r\n     * @returns the next available planning node instance node id\r\n     */\r\n    getNextAvailablePlanningNodeId() {\r\n\r\n        // used to keep track of the highest planning node number we have found, which is 1-based\r\n        let currentMaxPlanningNodeNumber = 1;\r\n\r\n        let nodeStates = this.getNodeStates();\r\n\r\n        if (nodeStates != null) {\r\n\r\n            // loop through all the NodeStates\r\n            for (var ns = 0; ns < nodeStates.length; ns++) {\r\n                let nodeState = nodeStates[ns];\r\n\r\n                if (nodeState != null) {\r\n                    let nodeStateNodeId = nodeState.nodeId;\r\n                    if (this.ProjectService.isPlanning(nodeStateNodeId) && nodeState.studentData != null) {\r\n                        let nodes = nodeState.studentData.nodes;\r\n                        for (var n = 0; n < nodes.length; n++) {\r\n                            let node = nodes[n];\r\n                            let nodeId = node.id;\r\n                            // regex to match the planning node id e.g. planningNode2\r\n                            let planningNodeIdRegEx = /planningNode(.*)/;\r\n\r\n                            // run the regex on the node id\r\n                            let result = nodeId.match(planningNodeIdRegEx);\r\n\r\n                            if (result != null) {\r\n                                // we have found a planning node instance node id\r\n\r\n                                /*\r\n                                 * get the number part of the planning node instance node id\r\n                                 * e.g. if the nodeId is planningNode2, the number part\r\n                                 * would be 2\r\n                                 */\r\n                                let planningNodeNumber = parseInt(result[1]);\r\n\r\n                                if (planningNodeNumber > currentMaxPlanningNodeNumber) {\r\n                                    /*\r\n                                     * update the max number part if we have found a new\r\n                                     * higher number\r\n                                     */\r\n                                    currentMaxPlanningNodeNumber = planningNodeNumber;\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        if (this.maxPlanningNodeNumber < currentMaxPlanningNodeNumber) {\r\n            // Update maxPlanningNodeNumber if we find a bigger number in the NodeStates\r\n            this.maxPlanningNodeNumber = currentMaxPlanningNodeNumber;\r\n        }\r\n\r\n        // Increment maxPlanningNodeNumber each time this function is called.\r\n        this.maxPlanningNodeNumber++;\r\n\r\n        // return the next available planning node instance node id\r\n        return 'planningNode' + this.maxPlanningNodeNumber;\r\n    }\r\n\r\n    /**\r\n     * Get the annotations\r\n     * @returns the annotations\r\n     */\r\n    getAnnotations() {\r\n        var annotations = null;\r\n\r\n        if (this.studentData != null && this.studentData.annotations != null) {\r\n            annotations = this.studentData.annotations;\r\n        }\r\n\r\n        return annotations;\r\n    }\r\n\r\n    /**\r\n     * Get the latest component states for a node\r\n     * @param nodeId get the component states for the node\r\n     * @return an array containing the work for the node\r\n     */\r\n    getLatestComponentStatesByNodeId(nodeId) {\r\n\r\n        var latestComponentStates = [];\r\n\r\n        if (nodeId) {\r\n            var studentData = this.studentData;\r\n\r\n            if (studentData) {\r\n\r\n                // get the node\r\n                var node = this.ProjectService.getNodeById(nodeId);\r\n\r\n                if (node != null) {\r\n\r\n                    // get the components in the node\r\n                    var components = node.components;\r\n\r\n                    if (components != null) {\r\n\r\n                        // loop through all the components\r\n                        for (var c = 0; c < components.length; c++) {\r\n                            var component = components[c];\r\n\r\n                            if (component != null) {\r\n                                var componentId = component.id;\r\n\r\n                                // get the latest component state for the component\r\n                                var componentState = this.getLatestComponentStateByNodeIdAndComponentId(nodeId, componentId);\r\n\r\n                                if (componentState == null) {\r\n                                    /*\r\n                                     * there is no component state for the component so we will\r\n                                     * create an object that just contains the node id and\r\n                                     * component id\r\n                                     */\r\n                                    componentState = {};\r\n                                    componentState.nodeId = nodeId;\r\n                                    componentState.componentId = componentId;\r\n                                }\r\n\r\n                                latestComponentStates.push(componentState);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return latestComponentStates;\r\n    }\r\n\r\n    /**\r\n     * Get the latest component state for a node\r\n     * @param nodeId get the latest component state for the node\r\n     * @return the latest component state for the node\r\n     */\r\n    getLatestComponentStateByNodeId(nodeId) {\r\n\r\n        var latestComponentState = null;\r\n\r\n        if (nodeId != null) {\r\n            var studentData = this.studentData;\r\n\r\n            if (studentData) {\r\n\r\n                // get the component states for the node\r\n                var componentStates = this.getComponentStatesByNodeId(nodeId);\r\n\r\n                // get the latest component state\r\n                latestComponentState = componentStates[componentStates.length - 1];\r\n            }\r\n        }\r\n\r\n        return latestComponentState;\r\n    }\r\n\r\n    /**\r\n     * Check if the completion criteria is satisfied\r\n     * @param completionCriteria the completion criteria\r\n     * @return whether the completion criteria was satisfied\r\n     */\r\n    isCompletionCriteriaSatisfied(completionCriteria) {\r\n\r\n        var result = true;\r\n\r\n        if (completionCriteria != null) {\r\n\r\n            if (completionCriteria.inOrder) {\r\n                // the criteria need to be satisfied in order\r\n\r\n                var tempTimestamp = 0;\r\n\r\n                // get all of the criteria\r\n                var criteria = completionCriteria.criteria;\r\n\r\n                // loop through all the criteria\r\n                for (var c = 0; c < criteria.length; c++) {\r\n                    var tempResult = true;\r\n\r\n                    // get a criterion\r\n                    var completionCriterion = criteria[c];\r\n\r\n                    if (completionCriterion != null) {\r\n\r\n                        // get the function name e.g. 'isVisited', 'isSaved', 'isSubmitted'\r\n                        var functionName = completionCriterion.name;\r\n\r\n                        if (functionName == 'isSubmitted') {\r\n                            var nodeId = completionCriterion.nodeId;\r\n                            var componentId = completionCriterion.componentId;\r\n\r\n                            // get the first submit component state after the timestamp\r\n                            var tempComponentState = this.getComponentStateSubmittedAfter(nodeId, componentId, tempTimestamp);\r\n\r\n                            if (tempComponentState == null) {\r\n                                // we did not find a component state\r\n                                result = false;\r\n                                break;\r\n                            } else {\r\n                                // we found a component state so we will update timestamp\r\n                                tempTimestamp = tempComponentState.serverSaveTime;\r\n                            }\r\n                        } else if (functionName == 'isSaved') {\r\n                            var nodeId = completionCriterion.nodeId;\r\n                            var componentId = completionCriterion.componentId;\r\n\r\n                            // get the first save component state after the timestamp\r\n                            var tempComponentState = this.getComponentStateSavedAfter(nodeId, componentId, tempTimestamp);\r\n\r\n                            if (tempComponentState == null) {\r\n                                // we did not find a component state\r\n                                result = false;\r\n                                break;\r\n                            } else {\r\n                                // we found a component state so we will update timestamp\r\n                                tempTimestamp = tempComponentState.serverSaveTime;\r\n                            }\r\n                        } else if (functionName == 'isVisited') {\r\n                            var nodeId = completionCriterion.nodeId;\r\n\r\n                            // get the first visit event after the timestamp\r\n                            var tempEvent = this.getVisitEventAfter(nodeId, tempTimestamp);\r\n\r\n                            if (tempEvent == null) {\r\n                                // we did not find a component state\r\n                                result = false;\r\n                                break;\r\n                            } else {\r\n                                // we found a component state so we will update timestamp\r\n                                tempTimestamp = tempEvent.serverSaveTime;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Get the first save component state after the given timestamp\r\n     * @param nodeId the node id of the component state\r\n     * @param componentId the component id of the component state\r\n     * @param timestamp look for a save component state after this timestamp\r\n     */\r\n    getComponentStateSavedAfter(nodeId, componentId, timestamp) {\r\n        var componentState = null;\r\n\r\n        // get all the component states\r\n        var componentStates = this.studentData.componentStates;\r\n\r\n        if (componentStates != null) {\r\n\r\n            // loop through all the component states\r\n            for (var c = 0; c < componentStates.length; c++) {\r\n\r\n                // get a component state\r\n                var tempComponentState = componentStates[c];\r\n\r\n                if (tempComponentState != null &&\r\n                    tempComponentState.serverSaveTime > timestamp &&\r\n                    tempComponentState.nodeId === nodeId &&\r\n                    tempComponentState.componentId === componentId) {\r\n\r\n                    // we have found a save component state after the timestamp\r\n                    componentState = tempComponentState;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n\r\n        return componentState;\r\n    }\r\n\r\n    /**\r\n     * Get the first submit component state after the given timestamp\r\n     * @param nodeId the node id of the component state\r\n     * @param componentId the component id of the component state\r\n     * @param timestamp look for a submit component state after this timestamp\r\n     */\r\n    getComponentStateSubmittedAfter(nodeId, componentId, timestamp) {\r\n        var componentState = null;\r\n\r\n        // get all the component states\r\n        var componentStates = this.studentData.componentStates;\r\n\r\n        if (componentStates != null) {\r\n\r\n            // loop through all the component states\r\n            for (var c = 0; c < componentStates.length; c++) {\r\n                var tempComponentState = componentStates[c];\r\n\r\n                if (tempComponentState != null &&\r\n                    tempComponentState.serverSaveTime > timestamp &&\r\n                    tempComponentState.nodeId === nodeId &&\r\n                    tempComponentState.componentId === componentId &&\r\n                    tempComponentState.isSubmit) {\r\n\r\n                    // we have found a submit component state after the timestamp\r\n                    componentState = tempComponentState;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n\r\n        return componentState;\r\n    }\r\n\r\n    /**\r\n     * Get the first visit event after the timestamp\r\n     */\r\n    getVisitEventAfter(nodeId, timestamp) {\r\n        var event = null;\r\n\r\n        // get all the events\r\n        var events = this.studentData.events;\r\n\r\n        if (events != null) {\r\n\r\n            // loop through all the events\r\n            for (var e = 0; e < events.length; e++) {\r\n                var tempEvent = events[e];\r\n\r\n                if (tempEvent != null &&\r\n                    tempEvent.serverSaveTime > timestamp &&\r\n                    tempEvent.nodeId === nodeId &&\r\n                    tempEvent.event === 'nodeEntered') {\r\n\r\n                    // we have found a visit event after the timestamp\r\n                    event = tempEvent;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n\r\n        return event;\r\n    }\r\n\r\n    /**\r\n     * Get classmate student work\r\n     * @param nodeId the node id\r\n     * @param componentId the component id\r\n     * @param showClassmateWorkSource Where to get the work from.\r\n     * 'period' will get the classmate work only from the period the student is in.\r\n     * null will get work from the whole class (all periods).\r\n     *\r\n     * @return a promise that will return the component states from classmates\r\n     */\r\n    getClassmateStudentWork(nodeId, componentId, showClassmateWorkSource) {\r\n\r\n        // get the url to get the student data\r\n        var studentDataURL = this.ConfigService.getConfigParam('studentDataURL');\r\n\r\n        var httpParams = {};\r\n        httpParams.method = 'GET';\r\n        httpParams.url = studentDataURL;\r\n\r\n        // set the workgroup id and run id\r\n        var params = {};\r\n        params.runId = this.ConfigService.getRunId();\r\n        params.nodeId = nodeId;\r\n        params.componentId = componentId;\r\n        params.getStudentWork = true;\r\n        params.getEvents = false;\r\n        params.getAnnotations = false;\r\n        params.onlyGetLatest = true;\r\n\r\n        if (showClassmateWorkSource == 'period') {\r\n            // get the period the student is in\r\n            params.periodId = this.ConfigService.getPeriodId();\r\n        }\r\n\r\n        httpParams.params = params;\r\n\r\n        // make the request for the student data\r\n        return this.$http(httpParams).then((result) => {\r\n            var componentStates = [];\r\n            var resultData = result.data;\r\n\r\n            if (resultData != null) {\r\n                componentStates = resultData.studentWorkList;\r\n            }\r\n\r\n            return componentStates;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get the max possible score for the project\r\n     * @returns the sum of the max scores for all the nodes in the project visible\r\n     * to the current workgroup or null if none of the visible components has max scores.\r\n     */\r\n    getMaxScore() {\r\n        let maxScore = null;\r\n\r\n        // loop through all the node statuses\r\n        for (var p in this.nodeStatuses) {\r\n            if (this.nodeStatuses.hasOwnProperty(p)) {\r\n                let nodeStatus = this.nodeStatuses[p];\r\n                let nodeId = nodeStatus.nodeId;\r\n\r\n                if (nodeStatus.isVisible && !this.ProjectService.isGroupNode(nodeId)) {\r\n                    // node is visible and is not a group\r\n                    // get node max score\r\n                    let nodeMaxScore = this.ProjectService.getMaxScoreForNode(nodeId);\r\n\r\n                    if (nodeMaxScore) {\r\n                        // there is a max score for the node, so add to total\r\n                        maxScore += nodeMaxScore;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return maxScore;\r\n    }\r\n}\r\n\r\nStudentDataService.$inject = [\r\n    '$filter',\r\n    '$http',\r\n    '$injector',\r\n    '$q',\r\n    '$rootScope',\r\n    'AnnotationService',\r\n    'ConfigService',\r\n    'ProjectService',\r\n    'UtilService'\r\n];\r\n\r\nexport default StudentDataService;\r\n"]}