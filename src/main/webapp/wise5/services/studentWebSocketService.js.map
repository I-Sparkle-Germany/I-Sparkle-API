{"version":3,"sources":["studentWebSocketService.es6"],"names":["StudentWebSocketService","$rootScope","$websocket","ConfigService","StudentDataService","dataStream","isPreview","runId","getRunId","periodId","getPeriodId","workgroupId","getWorkgroupId","webSocketURL","getWebSocketURL","onMessage","message","handleMessage","e","console","log","data","$broadcast","JSON","parse","messageType","annotationData","AnnotationService","addOrUpdateAnnotation","annotation","notificationData","handleWebSocketMessageReceived","currentNodeId","getCurrentNodeId","messageJSON","messageParticipants","send","$inject"],"mappings":"AAAA;;;;;;;;;;IAEMA,uB;AAEF,qCAAYC,UAAZ,EACYC,UADZ,EAEYC,aAFZ,EAGYC,kBAHZ,EAGgC;AAAA;;AAE5B,aAAKH,UAAL,GAAkBA,UAAlB;AACA,aAAKC,UAAL,GAAkBA,UAAlB;AACA,aAAKC,aAAL,GAAqBA,aAArB;AACA,aAAKC,kBAAL,GAA0BA,kBAA1B;;AAEA,aAAKC,UAAL,GAAkB,IAAlB;AACH;;AAED;;;;;;;qCAGa;AAAA;;AAET,gBAAI,KAAKF,aAAL,CAAmBG,SAAnB,EAAJ,EAAoC;AAChC;AACH,aAFD,MAEO;AACH;AACA,oBAAIC,QAAQ,KAAKJ,aAAL,CAAmBK,QAAnB,EAAZ;AACA,oBAAIC,WAAW,KAAKN,aAAL,CAAmBO,WAAnB,EAAf;AACA,oBAAIC,cAAc,KAAKR,aAAL,CAAmBS,cAAnB,EAAlB;AACA,oBAAIC,eAAe,KAAKV,aAAL,CAAmBW,eAAnB,EAAnB;AACAD,gCAAgB,YAAYN,KAAZ,GAAoB,YAApB,GAAmCE,QAAnC,GAA8C,eAA9C,GAAgEE,WAAhF;;AAEA,oBAAI;AACA;AACA,yBAAKN,UAAL,GAAkB,KAAKH,UAAL,CAAgBW,YAAhB,CAAlB;;AAEA;AACA,yBAAKR,UAAL,CAAgBU,SAAhB,CAA0B,UAACC,OAAD,EAAa;AACnC,8BAAKC,aAAL,CAAmBD,OAAnB;AACH,qBAFD;AAGH,iBARD,CAQE,OAAME,CAAN,EAAS;AACPC,4BAAQC,GAAR,CAAYF,CAAZ;AACH;AACJ;AACJ;;;;;AAED;;;;uDAI+BG,I,EAAM;;AAEjC;AACA,iBAAKpB,UAAL,CAAgBqB,UAAhB,CAA2B,0BAA3B,EAAuD,EAACD,MAAMA,IAAP,EAAvD;AACH;;;;;AAED;;;;sCAIcL,O,EAAS;AACnB,gBAAIK,OAAOE,KAAKC,KAAL,CAAWR,QAAQK,IAAnB,CAAX;AACA,gBAAII,cAAcJ,KAAKI,WAAvB;;AAEA,gBAAIA,gBAAgB,aAApB,EAAmC;AAC/B,qBAAKxB,UAAL,CAAgBqB,UAAhB,CAA2B,aAA3B,EAA0C,EAACD,MAAMA,IAAP,EAA1C;AACH,aAFD,MAEO,IAAII,gBAAgB,eAApB,EAAqC;AACxC,qBAAKxB,UAAL,CAAgBqB,UAAhB,CAA2B,eAA3B,EAA4C,EAACD,MAAMA,IAAP,EAA5C;AACH,aAFM,MAEA,IAAII,gBAAgB,cAApB,EAAoC;AACvC,qBAAKxB,UAAL,CAAgBqB,UAAhB,CAA2B,iBAA3B,EAA8CD,KAAKA,IAAnD;AACH,aAFM,MAEA,IAAII,gBAAgB,wBAApB,EAA8C;AACjD;;AAEA;AACA,oBAAIC,iBAAiBL,KAAKK,cAA1B;AACA,qBAAKtB,kBAAL,CAAwBuB,iBAAxB,CAA0CC,qBAA1C,CAAgEF,cAAhE;AACA,qBAAKzB,UAAL,CAAgBqB,UAAhB,CAA2B,uBAA3B,EAAoD,EAACO,YAAYH,cAAb,EAApD;;AAEA;AACA,oBAAII,mBAAmBT,KAAKS,gBAA5B;AACA,qBAAK7B,UAAL,CAAgBqB,UAAhB,CAA2B,iBAA3B,EAA8CQ,gBAA9C;AACH;;AAED,iBAAKC,8BAAL,CAAoCV,IAApC;AACH;;AAED;;;;;;;oDAI4BI,W,EAAaJ,I,EAAM;;AAE3C,gBAAI,CAAC,KAAKlB,aAAL,CAAmBG,SAAnB,EAAL,EAAqC;AACjC;;AAEA;AACA,oBAAI0B,gBAAgB,KAAK5B,kBAAL,CAAwB6B,gBAAxB,EAApB;;AAEA;AACA,oBAAIC,cAAc,EAAlB;AACAA,4BAAYT,WAAZ,GAA0BA,WAA1B;AACAS,4BAAYC,mBAAZ,GAAkC,mBAAlC;AACAD,4BAAYF,aAAZ,GAA4BA,aAA5B;AACAE,4BAAYb,IAAZ,GAAmBA,IAAnB;;AAEA;AACA,qBAAKhB,UAAL,CAAgB+B,IAAhB,CAAqBF,WAArB;AACH;AACJ;;;;;AAED;;;;+DAIuCT,W,EAAaJ,I,EAAM;;AAEtD,gBAAI,CAAC,KAAKlB,aAAL,CAAmBG,SAAnB,EAAL,EAAqC;AACjC;;AAEA;AACA,oBAAI0B,gBAAgB,KAAK5B,kBAAL,CAAwB6B,gBAAxB,EAApB;;AAEA;AACA,oBAAIC,cAAc,EAAlB;AACAA,4BAAYT,WAAZ,GAA0BA,WAA1B;AACAS,4BAAYC,mBAAZ,GAAkC,6BAAlC;AACAD,4BAAYF,aAAZ,GAA4BA,aAA5B;AACAE,4BAAYb,IAAZ,GAAmBA,IAAnB;;AAEA;AACA,qBAAKhB,UAAL,CAAgB+B,IAAhB,CAAqBF,WAArB;AACH;AACJ;;;;;;AAGLlC,wBAAwBqC,OAAxB,GAAkC,CAC9B,YAD8B,EAE9B,YAF8B,EAG9B,eAH8B,EAI9B,oBAJ8B,CAAlC;;kBAOerC,uB","file":"studentWebSocketService.js","sourcesContent":["'use strict';\r\n\r\nclass StudentWebSocketService {\r\n\r\n    constructor($rootScope,\r\n                $websocket,\r\n                ConfigService,\r\n                StudentDataService) {\r\n\r\n        this.$rootScope = $rootScope;\r\n        this.$websocket = $websocket;\r\n        this.ConfigService = ConfigService;\r\n        this.StudentDataService = StudentDataService;\r\n\r\n        this.dataStream = null;\r\n    }\r\n\r\n    /**\r\n     * Initialize the websocket connection\r\n     */\r\n    initialize() {\r\n\r\n        if (this.ConfigService.isPreview()) {\r\n            // We are previewing the project. Don't initialize websocket.\r\n        } else {\r\n            // We are in a run. Get the parameters for initializing the websocket connection\r\n            var runId = this.ConfigService.getRunId();\r\n            var periodId = this.ConfigService.getPeriodId();\r\n            var workgroupId = this.ConfigService.getWorkgroupId();\r\n            var webSocketURL = this.ConfigService.getWebSocketURL();\r\n            webSocketURL += \"?runId=\" + runId + \"&periodId=\" + periodId + \"&workgroupId=\" + workgroupId;\r\n\r\n            try {\r\n                // start the websocket connection\r\n                this.dataStream = this.$websocket(webSocketURL);\r\n\r\n                // this is the function that handles messages we receive from web sockets\r\n                this.dataStream.onMessage((message) => {\r\n                    this.handleMessage(message);\r\n                });\r\n            } catch(e) {\r\n                console.log(e);\r\n            }\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Handle the message we have received\r\n     * @param data the data from the message\r\n     */\r\n    handleWebSocketMessageReceived(data) {\r\n\r\n        // broadcast the data to all listeners\r\n        this.$rootScope.$broadcast('webSocketMessageRecieved', {data: data});\r\n    };\r\n\r\n    /**\r\n     * Handle receiving a websocket message\r\n     * @param message the websocket message\r\n     */\r\n    handleMessage(message) {\r\n        var data = JSON.parse(message.data);\r\n        var messageType = data.messageType;\r\n\r\n        if (messageType === 'pauseScreen') {\r\n            this.$rootScope.$broadcast('pauseScreen', {data: data});\r\n        } else if (messageType === 'unPauseScreen') {\r\n            this.$rootScope.$broadcast('unPauseScreen', {data: data});\r\n        } else if (messageType === 'notification') {\r\n            this.$rootScope.$broadcast('newNotification', data.data);\r\n        } else if (messageType === 'annotationNotification') {\r\n            // a new annotation + notification combo object was sent over websocket\r\n\r\n            // save the new annotation locally\r\n            let annotationData = data.annotationData;\r\n            this.StudentDataService.AnnotationService.addOrUpdateAnnotation(annotationData);\r\n            this.$rootScope.$broadcast('newAnnotationReceived', {annotation: annotationData});\r\n\r\n            // fire the new notification\r\n            let notificationData = data.notificationData;\r\n            this.$rootScope.$broadcast('newNotification', notificationData);\r\n        }\r\n\r\n        this.handleWebSocketMessageReceived(data);\r\n    }\r\n\r\n    /**\r\n     * Send a message to teacher\r\n     * @param data the data to send to the teacher\r\n     */\r\n    sendStudentToTeacherMessage(messageType, data) {\r\n\r\n        if (!this.ConfigService.isPreview()) {\r\n            // we are in a run\r\n\r\n            // get the current node id\r\n            var currentNodeId = this.StudentDataService.getCurrentNodeId();\r\n\r\n            // make the websocket message\r\n            var messageJSON = {};\r\n            messageJSON.messageType = messageType;\r\n            messageJSON.messageParticipants = 'studentToTeachers';\r\n            messageJSON.currentNodeId = currentNodeId;\r\n            messageJSON.data = data;\r\n\r\n            // send the websocket message\r\n            this.dataStream.send(messageJSON);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Send a message to classmates in the period\r\n     * @param data the data to send to the classmates\r\n     */\r\n    sendStudentToClassmatesInPeriodMessage(messageType, data) {\r\n\r\n        if (!this.ConfigService.isPreview()) {\r\n            // we are in a run\r\n\r\n            // get the current node id\r\n            var currentNodeId = this.StudentDataService.getCurrentNodeId();\r\n\r\n            // make the websocket message\r\n            var messageJSON = {};\r\n            messageJSON.messageType = messageType;\r\n            messageJSON.messageParticipants = 'studentToClassmatesInPeriod';\r\n            messageJSON.currentNodeId = currentNodeId;\r\n            messageJSON.data = data;\r\n\r\n            // send the websocket message\r\n            this.dataStream.send(messageJSON);\r\n        }\r\n    };\r\n}\r\n\r\nStudentWebSocketService.$inject = [\r\n    '$rootScope',\r\n    '$websocket',\r\n    'ConfigService',\r\n    'StudentDataService'\r\n];\r\n\r\nexport default StudentWebSocketService;\r\n"]}