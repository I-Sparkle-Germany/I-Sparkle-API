{"version":3,"sources":["studentWebSocketService.es6"],"names":["StudentWebSocketService","$rootScope","$stomp","$websocket","ConfigService","StudentDataService","dataStream","isPreview","runId","getRunId","periodId","getPeriodId","workgroupId","getWorkgroupId","webSocketURL","getWebSocketURL","connect","then","frame","console","log","greetingSubscription","subscribe","payload","headers","res","pauseSubscription","$broadcast","data","unPauseSubscription","studentWorkSubscription","studentWork","studentData","JSON","parse","send","stringify","e","message","messageType","annotationData","AnnotationService","addOrUpdateAnnotation","annotation","notificationData","handleWebSocketMessageReceived","currentNodeId","getCurrentNodeId","messageJSON","messageParticipants","$inject"],"mappings":"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","file":"studentWebSocketService.js","sourcesContent":["'use strict';\n\nclass StudentWebSocketService {\n  constructor(\n      $rootScope,\n      $stomp,\n      $websocket,\n      ConfigService,\n      StudentDataService) {\n    this.$rootScope = $rootScope;\n    this.$stomp = $stomp;\n    this.$websocket = $websocket;\n    this.ConfigService = ConfigService;\n    this.StudentDataService = StudentDataService;\n    this.dataStream = null;\n  }\n\n  initialize() {\n    if (!this.ConfigService.isPreview()) {\n      this.runId = this.ConfigService.getRunId();\n      this.periodId = this.ConfigService.getPeriodId();\n      const workgroupId = this.ConfigService.getWorkgroupId();\n      const webSocketURL = this.ConfigService.getWebSocketURL();\n      try {\n        this.$stomp.connect(webSocketURL).then((frame) => {\n          console.log(`connected! runId: ${this.runId}`);\n          const greetingSubscription = this.$stomp.subscribe(`/topic/greetings/${this.runId}`, (payload, headers, res) => {\n            console.log(`Greeting: ${payload}`);\n          }, {});\n\n          const pauseSubscription = this.$stomp.subscribe(`/topic/pause/${this.runId}/${this.periodId}`, (payload, headers, res) => {\n            console.log(`Pause: ${payload}`);\n            this.$rootScope.$broadcast('pauseScreen', {data: payload});\n          }, {});\n\n          const unPauseSubscription = this.$stomp.subscribe(`/topic/unpause/${this.runId}/${this.periodId}`, (payload, headers, res) => {\n            console.log(`UnPause: ${payload}`);\n            this.$rootScope.$broadcast('unPauseScreen', {data: payload});\n          }, {});\n\n          const studentWorkSubscription = this.$stomp.subscribe(`/topic/student-work/${this.runId}/${this.periodId}`, (studentWork, headers, res) => {\n            studentWork.studentData = JSON.parse(studentWork.studentData);\n            this.$rootScope.$broadcast('StudentWorkReceived', studentWork);\n          }, {});\n\n          this.$stomp.send(`/app/hello/${this.runId}`, JSON.stringify({'name': `workgroup ${workgroupId}`}), {});\n\n        });\n        //this.dataStream = this.$websocket(webSocketURL);\n        //this.dataStream.onMessage((message) => {\n        //  this.handleMessage(message);\n        //});\n      } catch(e) {\n        console.log(e);\n      }\n    }\n  }\n\n  /**\n   * Handle the message we have received\n   * @param data the data from the message\n   */\n  handleWebSocketMessageReceived(data) {\n    this.$rootScope.$broadcast('webSocketMessageReceived', {data: data});\n  }\n\n  /**\n   * Handle receiving a websocket message\n   * @param message the websocket message\n   */\n  handleMessage(message) {\n    const data = JSON.parse(message.data);\n    const messageType = data.messageType;\n    if (messageType === 'pauseScreen') {\n      this.$rootScope.$broadcast('pauseScreen', {data: data});\n    } else if (messageType === 'unPauseScreen') {\n      this.$rootScope.$broadcast('unPauseScreen', {data: data});\n    } else if (messageType === 'notification') {\n      this.$rootScope.$broadcast('newNotification', data.data);\n    } else if (messageType === 'annotationNotification') {\n      // a new annotation + notification combo object was sent over websocket\n\n      // save the new annotation locally\n      let annotationData = data.annotationData;\n      this.StudentDataService.AnnotationService.addOrUpdateAnnotation(annotationData);\n      this.$rootScope.$broadcast('newAnnotationReceived', {annotation: annotationData});\n\n      // fire the new notification\n      let notificationData = data.notificationData;\n      this.$rootScope.$broadcast('newNotification', notificationData);\n    }\n    this.handleWebSocketMessageReceived(data);\n  }\n\n  /**\n   * Send a message to teacher\n   * @param data the data to send to the teacher\n   */\n  sendStudentToTeacherMessage(messageType, data) {\n    if (!this.ConfigService.isPreview()) {\n      const currentNodeId = this.StudentDataService.getCurrentNodeId();\n      const messageJSON = {};\n      messageJSON.messageType = messageType;\n      messageJSON.messageParticipants = 'studentToTeachers';\n      messageJSON.currentNodeId = currentNodeId;\n      messageJSON.data = data;\n      this.dataStream.send(messageJSON);\n    }\n  }\n\n  sendStudentWorkToClassmatesInPeriodMessage(studentWork) {\n    if (!this.ConfigService.isPreview()) {\n      studentWork.studentData = JSON.stringify(studentWork.studentData);\n      this.$stomp.send(`/app/student-work/${this.runId}/${this.periodId}`,\n          studentWork,\n          {});\n    }\n  }\n\n  /**\n   * Send a message to classmates in the period\n   * @param data the data to send to the classmates\n   */\n  deleteMe_sendStudentToClassmatesInPeriodMessage(messageType, data) {\n    if (!this.ConfigService.isPreview()) {\n      const currentNodeId = this.StudentDataService.getCurrentNodeId();\n      const messageJSON = {};\n      messageJSON.messageType = messageType;\n      messageJSON.messageParticipants = 'studentToClassmatesInPeriod';\n      messageJSON.currentNodeId = currentNodeId;\n      messageJSON.data = data;\n      this.dataStream.send(messageJSON);\n    }\n  }\n}\n\nStudentWebSocketService.$inject = [\n  '$rootScope',\n  '$stomp',\n  '$websocket',\n  'ConfigService',\n  'StudentDataService'\n];\n\nexport default StudentWebSocketService;\n"]}