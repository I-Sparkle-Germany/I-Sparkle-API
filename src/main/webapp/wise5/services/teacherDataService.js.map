{"version":3,"sources":["teacherDataService.es6"],"names":["TeacherDataService","$http","$filter","$q","$rootScope","AnnotationService","ConfigService","NotificationService","ProjectService","TeacherWebSocketService","UtilService","$translate","studentData","componentStatesByWorkgroupId","componentStatesByNodeId","componentStatesByComponentId","currentPeriod","currentWorkgroup","currentStep","currentNode","previousStep","runStatus","periods","nodeGradingSort","studentGradingSort","studentProgressSort","$on","event","args","annotation","handleAnnotationReceived","studentWork","addOrUpdateComponentState","$broadcast","annotations","push","toWorkgroupId","annotationsToWorkgroupId","Array","nodeId","annotationsByNodeId","setAnnotations","exportType","selectedNodes","exportURL","getConfigParam","runId","getRunId","params","getStudentWork","getAnnotations","getEvents","components","retrieveStudentData","httpParams","method","url","then","result","data","window","location","href","deferred","defer","promise","resolve","context","componentId","componentType","category","projectId","newEvent","getProjectId","workgroupId","getWorkgroupId","clientSaveTime","Date","parse","type","events","angular","toJson","headers","$","param","savedEvents","nodeIdsAndComponentIds","getNodeIdsAndComponentIds","showPreviousWorkNodeIdsAndComponentIds","getShowPreviousWorkNodeIdsAndComponentIds","concat","periodId","studentDataURL","resultData","studentWorkList","componentStates","i","length","componentState","sort","sortByServerSaveTime","allEvents","eventsByWorkgroupId","eventsByNodeId","eventWorkgroupId","eventNodeId","annotationWorkgroupId","annotationNodeId","componentStateWorkgroupId","found","w","cs","id","componentStateNodeId","n","c","runStatusURL","initializePeriods","latestComponentState","getComponentStatesByWorkgroupIdAndNodeId","componentStateComponentId","componentStatesForWorkgroup","getComponentStatesByWorkgroupId","componentRevisionCounter","componentsFound","csf","key","revisionCounter","csb","reverse","getComponentStatesByNodeId","filter","indexOf","getComponentStatesByComponentId","getEventsByWorkgroupId","getEventsByNodeId","eventType","e","getAnnotationsToWorkgroupId","getAnnotationsByNodeId","getPeriods","allPeriodsOption","periodName","unshift","mergedPeriods","runStatusPeriods","p","period","runStatusPeriod","r","tempRunStatusPeriod","setCurrentPeriod","previousPeriod","setCurrentWorkgroup","workgroup","step","currentNodeId","node","getNodeById","setCurrentNode","previousCurrentNode","isGroupNode","previousNode","nodeToExit","endCurrentNode","setCurrentNodeByNodeId","totalScore","getTotalScore","isPaused","nPeriods","nPeriodsPaused","paused","updatePausedRunStatusValue","pauseScreens","unPauseScreens","sendRunStatus","saveEvent","x","value","createRunStatus","allPeriodsPaused","l","tempPeriod","tempPeriodId","customPauseMessage","pauseMessage","runStatusParams","status","$inject"],"mappings":"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","file":"teacherDataService.js","sourcesContent":["'use strict';\r\n\r\nclass TeacherDataService {\r\n\r\n    constructor($http,\r\n                $filter,\r\n                $q,\r\n                $rootScope,\r\n                AnnotationService,\r\n                ConfigService,\r\n                NotificationService,\r\n                ProjectService,\r\n                TeacherWebSocketService,\r\n                UtilService) {\r\n        this.$http = $http;\r\n        this.$filter = $filter;\r\n        this.$q = $q;\r\n        this.$rootScope = $rootScope;\r\n        this.AnnotationService = AnnotationService;\r\n        this.ConfigService = ConfigService;\r\n        this.NotificationService = NotificationService;\r\n        this.ProjectService = ProjectService;\r\n        this.TeacherWebSocketService = TeacherWebSocketService;\r\n        this.UtilService = UtilService;\r\n\r\n        this.$translate = this.$filter('translate');\r\n\r\n        this.studentData = {\r\n            componentStatesByWorkgroupId: {},\r\n            componentStatesByNodeId: {},\r\n            componentStatesByComponentId: {}\r\n        };\r\n\r\n        this.currentPeriod = null;\r\n        this.currentWorkgroup = null;\r\n        this.currentStep = null;\r\n        this.currentNode = null;\r\n        this.previousStep = null;\r\n        this.runStatus = null;\r\n        this.periods = [];\r\n        this.nodeGradingSort = 'team';\r\n        this.studentGradingSort = 'title';\r\n        this.studentProgressSort = 'team';\r\n\r\n        /**\r\n         * Listen for the 'annotationSavedToServer' event which is fired when\r\n         * we receive the response from saving an annotation to the server\r\n         */\r\n        this.$rootScope.$on('annotationSavedToServer', (event, args) => {\r\n\r\n            if (args) {\r\n                // get the annotation that was saved to the server\r\n                let annotation = args.annotation;\r\n                this.handleAnnotationReceived(annotation);\r\n            }\r\n        });\r\n\r\n        /**\r\n         * Listen for the 'newAnnotationReceived' event which is fired when\r\n         * teacher receives a new annotation (usually on a student work) from the server\r\n         */\r\n        this.$rootScope.$on('newAnnotationReceived', (event, args) => {\r\n\r\n            if (args) {\r\n                // get the annotation that was saved to the server\r\n                let annotation = args.annotation;\r\n                this.handleAnnotationReceived(annotation);\r\n            }\r\n        });\r\n\r\n        /**\r\n         * Listen for the 'newStudentWorkReceived' event which is fired when\r\n         * teacher receives a new student work from the server\r\n         */\r\n        this.$rootScope.$on('newStudentWorkReceived', (event, args) => {\r\n\r\n            if (args) {\r\n                // get the student work (component state) that was saved to the server\r\n                let studentWork = args.studentWork;\r\n                this.addOrUpdateComponentState(studentWork);\r\n                // broadcast the event that a new work has been received\r\n                this.$rootScope.$broadcast('studentWorkReceived', {studentWork: studentWork});\r\n            }\r\n        });\r\n    }\r\n\r\n    handleAnnotationReceived(annotation) {\r\n        // add the annotation to the local annotations array\r\n        this.studentData.annotations.push(annotation);\r\n\r\n        let toWorkgroupId = annotation.toWorkgroupId;\r\n        if (this.studentData.annotationsToWorkgroupId[toWorkgroupId] == null) {\r\n            this.studentData.annotationsToWorkgroupId[toWorkgroupId] = new Array();\r\n        }\r\n        this.studentData.annotationsToWorkgroupId[toWorkgroupId].push(annotation);\r\n\r\n        let nodeId = annotation.nodeId;\r\n        if (this.studentData.annotationsByNodeId[nodeId] == null) {\r\n            this.studentData.annotationsByNodeId[nodeId] = new Array();\r\n        }\r\n        this.studentData.annotationsByNodeId[nodeId].push(annotation);\r\n\r\n        this.AnnotationService.setAnnotations(this.studentData.annotations);\r\n\r\n        // broadcast the event that a new annotation has been received\r\n        this.$rootScope.$broadcast('annotationReceived', {annotation: annotation});\r\n    }\r\n\r\n    /**\r\n     * Get the data for the export and generate the csv file that will be downloaded\r\n     * @param exportType the type of export\r\n     */\r\n    getExport(exportType, selectedNodes) {\r\n        let exportURL = this.ConfigService.getConfigParam('runDataExportURL');\r\n        let runId = this.ConfigService.getRunId();\r\n        exportURL += \"/\" + runId + \"/\" + exportType;\r\n\r\n        if (exportType === \"allStudentWork\" || exportType === \"latestStudentWork\") {\r\n            let params = {};\r\n            params.runId = this.ConfigService.getRunId();\r\n            params.getStudentWork = true;\r\n            params.getAnnotations = true;\r\n            params.getEvents = false;\r\n            params.components = selectedNodes;\r\n\r\n            return this.retrieveStudentData(params);\r\n        } else if (exportType === \"events\") {\r\n            let params = {};\r\n            params.runId = this.ConfigService.getRunId();\r\n            params.getStudentWork = false;\r\n            params.getAnnotations = false;\r\n            params.getEvents = true;\r\n            params.components = selectedNodes;\r\n\r\n            return this.retrieveStudentData(params);\r\n        } else if (exportType === \"latestNotebookItems\" || exportType === \"allNotebookItems\") {\r\n            let httpParams = {\r\n                method : 'GET',\r\n                url : exportURL,\r\n                params : {}\r\n            };\r\n\r\n            return this.$http(httpParams).then((result) => {\r\n                return result.data;\r\n            });\r\n        } else if (exportType === \"notifications\") {\r\n            let httpParams = {\r\n                method : 'GET',\r\n                url : exportURL,\r\n                params : {}\r\n            };\r\n\r\n            return this.$http(httpParams).then((result) => {\r\n                return result.data;\r\n            });\r\n        } else if (exportType === \"studentAssets\") {\r\n            window.location.href = exportURL;\r\n            let deferred = this.$q.defer();\r\n            let promise = deferred.promise;\r\n            deferred.resolve([]);\r\n            return promise;\r\n        } else if (exportType === \"oneWorkgroupPerRow\") {\r\n            let params = {};\r\n            params.runId = this.ConfigService.getRunId();\r\n            params.getStudentWork = true;\r\n            params.getAnnotations = true;\r\n            params.getEvents = true;\r\n            params.components = selectedNodes;\r\n\r\n            return this.retrieveStudentData(params);\r\n        } else if (exportType === \"rawData\") {\r\n            let params = {};\r\n            params.runId = this.ConfigService.getRunId();\r\n            params.getStudentWork = true;\r\n            params.getAnnotations = true;\r\n            params.getEvents = true;\r\n            params.components = selectedNodes;\r\n\r\n            return this.retrieveStudentData(params);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Retrieves the export given the export Type\r\n     * @param exportType\r\n     */\r\n    getExport0(exportType) {\r\n        let exportURL = this.ConfigService.getConfigParam('runDataExportURL');\r\n        let runId = this.ConfigService.getRunId();\r\n        exportURL += \"/\" + runId + \"/\" + exportType;\r\n\r\n        if (exportType === \"studentAssets\") {\r\n            window.location.href = exportURL;\r\n            let deferred = this.$q.defer();\r\n            let promise = deferred.promise;\r\n            deferred.resolve([]);\r\n            return promise;\r\n        } else {\r\n            let httpParams = {\r\n                method : 'GET',\r\n                url : exportURL,\r\n                params : {}\r\n            };\r\n\r\n            return this.$http(httpParams).then((result) => {\r\n                return result.data;\r\n            });\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Save events that occur in the Classroom Monitor to the server\r\n     * @param event the event object\r\n     * @returns a promise\r\n     */\r\n    saveEvent(context, nodeId, componentId, componentType, category, event, data, projectId) {\r\n        let newEvent = {\r\n            projectId : this.ConfigService.getProjectId(),\r\n            runId : this.ConfigService.getRunId(),\r\n            workgroupId : this.ConfigService.getWorkgroupId(),\r\n            clientSaveTime : Date.parse(new Date()),\r\n            context : context,\r\n            nodeId : nodeId,\r\n            componentId : componentId,\r\n            type : componentType,\r\n            category : category,\r\n            event : event,\r\n            data : data\r\n        };\r\n\r\n        if (newEvent.projectId == null) {\r\n            newEvent.projectId = projectId;\r\n        }\r\n\r\n        let events = [newEvent];\r\n\r\n        let params = {\r\n            projectId : this.ConfigService.getProjectId(),\r\n            runId : this.ConfigService.getRunId(),\r\n            workgroupId : this.ConfigService.getWorkgroupId(),\r\n            events : angular.toJson(events)\r\n        };\r\n\r\n        if (params.projectId == null) {\r\n            params.projectId = projectId;\r\n        }\r\n\r\n        let httpParams = {};\r\n        httpParams.method = 'POST';\r\n        httpParams.url = this.ConfigService.getConfigParam('teacherDataURL');\r\n        httpParams.headers = {'Content-Type': 'application/x-www-form-urlencoded'};\r\n        httpParams.data = $.param(params);\r\n\r\n        return this.$http(httpParams).then((result) => {\r\n\r\n            let savedEvents = null;\r\n\r\n            if (result != null && result.data != null) {\r\n                let data = result.data;\r\n\r\n                if (data != null) {\r\n\r\n                    // get the saved events\r\n                    savedEvents = data.events;\r\n                }\r\n            }\r\n\r\n            return savedEvents;\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Retrieve the student data for a node id\r\n     * @param nodeId the node id\r\n     * @returns the student data for the node id\r\n     */\r\n    retrieveStudentDataByNodeId(nodeId) {\r\n\r\n        // get the node ids and component ids in the node\r\n        var nodeIdsAndComponentIds = this.ProjectService.getNodeIdsAndComponentIds(nodeId);\r\n\r\n        // get the show previous work node ids and component ids in the node\r\n        var showPreviousWorkNodeIdsAndComponentIds = this.ProjectService.getShowPreviousWorkNodeIdsAndComponentIds(nodeId);\r\n\r\n        var components = [];\r\n        components = components.concat(nodeIdsAndComponentIds);\r\n        components = components.concat(showPreviousWorkNodeIdsAndComponentIds);\r\n\r\n        var params = {};\r\n        params.runId = this.ConfigService.getRunId();\r\n        //params.periodId = periodId;\r\n        params.periodId = null;\r\n        params.workgroupId = null;\r\n        params.components = components;\r\n        params.getAnnotations = false;\r\n\r\n        return this.retrieveStudentData(params);\r\n    };\r\n\r\n    /**\r\n     * Retrieve the student data for the workgroup id\r\n     * @param workgroupId the workgroup id\r\n     * @returns the student data for the workgroup id\r\n     */\r\n    retrieveStudentDataByWorkgroupId(workgroupId) {\r\n\r\n        var params = {};\r\n        params.runId = this.ConfigService.getRunId();\r\n        params.periodId = null;\r\n        params.nodeId = null;\r\n        params.workgroupId = workgroupId;\r\n        params.toWorkgroupId = workgroupId;\r\n        params.getAnnotations = false;\r\n\r\n        return this.retrieveStudentData(params);\r\n    };\r\n\r\n    /**\r\n     * Retrieve the annotations for the run\r\n     * @returns the annotations for the run\r\n     */\r\n    retrieveAnnotations() {\r\n        var params = {};\r\n        params.runId = this.ConfigService.getRunId();\r\n        params.periodId = null;\r\n        params.nodeId = null;\r\n        params.workgroupId = null;\r\n        params.toWorkgroupId = null;\r\n        params.getStudentWork = false;\r\n        params.getEvents = false;\r\n        params.getAnnotations = true;\r\n\r\n        return this.retrieveStudentData(params);\r\n    };\r\n\r\n    /**\r\n     * Retrieve the student data\r\n     * @param params the params that specify what student data we want\r\n     * @returns a promise\r\n     */\r\n    retrieveStudentData(params) {\r\n        let studentDataURL = this.ConfigService.getConfigParam('teacherDataURL');\r\n\r\n        if (params.getStudentWork == null) {\r\n            params.getStudentWork = true;\r\n        }\r\n\r\n        if (params.getEvents == null) {\r\n            params.getEvents = false;\r\n        }\r\n\r\n        if (params.getAnnotations == null) {\r\n            params.getAnnotations = true;\r\n        }\r\n\r\n        let httpParams = {\r\n            \"method\": \"GET\",\r\n            \"url\": studentDataURL,\r\n            \"params\": params\r\n        };\r\n\r\n        return this.$http(httpParams).then((result) => {\r\n            var resultData = result.data;\r\n            if (resultData != null) {\r\n\r\n                if (resultData.studentWorkList != null) {\r\n                    var componentStates = resultData.studentWorkList;\r\n\r\n                    // populate allComponentStates, componentStatesByWorkgroupId and componentStatesByNodeId objects\r\n                    for (var i = 0; i < componentStates.length; i++) {\r\n                        var componentState = componentStates[i];\r\n                        this.addOrUpdateComponentState(componentState);\r\n                    }\r\n                }\r\n\r\n                if (resultData.events != null) {\r\n                    // populate allEvents, eventsByWorkgroupId, and eventsByNodeId arrays\r\n\r\n                    // sort the events by server save time\r\n                    resultData.events.sort(this.UtilService.sortByServerSaveTime);\r\n\r\n                    this.studentData.allEvents = resultData.events;\r\n                    this.studentData.eventsByWorkgroupId = {};\r\n                    this.studentData.eventsByNodeId = {};\r\n                    for (var i = 0; i < resultData.events.length; i++) {\r\n                        var event = resultData.events[i];\r\n                        var eventWorkgroupId = event.workgroupId;\r\n                        if (this.studentData.eventsByWorkgroupId[eventWorkgroupId] == null) {\r\n                            this.studentData.eventsByWorkgroupId[eventWorkgroupId] = new Array();\r\n                        }\r\n                        this.studentData.eventsByWorkgroupId[eventWorkgroupId].push(event);\r\n\r\n                        var eventNodeId = event.nodeId;\r\n                        if (this.studentData.eventsByNodeId[eventNodeId] == null) {\r\n                            this.studentData.eventsByNodeId[eventNodeId] = new Array();\r\n                        }\r\n                        this.studentData.eventsByNodeId[eventNodeId].push(event);\r\n                    }\r\n                }\r\n\r\n                if (resultData.annotations != null) {\r\n                    // populate annotations, annotationsByWorkgroupId, and annotationsByNodeId arrays\r\n                    this.studentData.annotations = resultData.annotations;\r\n                    this.studentData.annotationsToWorkgroupId = {};\r\n                    this.studentData.annotationsByNodeId = {};\r\n                    for (var i = 0; i < resultData.annotations.length; i++) {\r\n                        var annotation = resultData.annotations[i];\r\n                        var annotationWorkgroupId = annotation.toWorkgroupId;\r\n                        if (!this.studentData.annotationsToWorkgroupId[annotationWorkgroupId]) {\r\n                            this.studentData.annotationsToWorkgroupId[annotationWorkgroupId] = new Array();\r\n                        }\r\n                        this.studentData.annotationsToWorkgroupId[annotationWorkgroupId].push(annotation);\r\n\r\n                        var annotationNodeId = annotation.nodeId;\r\n                        if (!this.studentData.annotationsByNodeId[annotationNodeId]) {\r\n                            this.studentData.annotationsByNodeId[annotationNodeId] = new Array();\r\n                        }\r\n                        this.studentData.annotationsByNodeId[annotationNodeId].push(annotation);\r\n                    }\r\n                }\r\n\r\n                this.AnnotationService.setAnnotations(this.studentData.annotations);\r\n            }\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Add ComponentState to local bookkeeping\r\n     * @param componentState the ComponentState to add\r\n     */\r\n    addOrUpdateComponentState(componentState) {\r\n        var componentStateWorkgroupId = componentState.workgroupId;\r\n        if (this.studentData.componentStatesByWorkgroupId[componentStateWorkgroupId] == null) {\r\n            this.studentData.componentStatesByWorkgroupId[componentStateWorkgroupId] = new Array();\r\n        }\r\n        let found = false;\r\n        for (let w = 0; w < this.studentData.componentStatesByWorkgroupId[componentStateWorkgroupId].length; w++) {\r\n            let cs = this.studentData.componentStatesByWorkgroupId[componentStateWorkgroupId][w];\r\n            if (cs.id != null && cs.id === componentState.id) {\r\n                // found the same component id, so just update it in place.\r\n                this.studentData.componentStatesByWorkgroupId[componentStateWorkgroupId][w] = componentState;\r\n                found = true;  // remember this so we don't insert later.\r\n                break;\r\n            }\r\n        }\r\n        if (!found) {\r\n            this.studentData.componentStatesByWorkgroupId[componentStateWorkgroupId].push(componentState);\r\n        }\r\n\r\n        var componentStateNodeId = componentState.nodeId;\r\n        if (this.studentData.componentStatesByNodeId[componentStateNodeId] == null) {\r\n            this.studentData.componentStatesByNodeId[componentStateNodeId] = new Array();\r\n        }\r\n        found = false;  // reset\r\n        for (let n = 0; n < this.studentData.componentStatesByNodeId[componentStateNodeId].length; n++) {\r\n            let cs = this.studentData.componentStatesByNodeId[componentStateNodeId][n];\r\n            if (cs.id != null && cs.id === componentState.id) {\r\n                // found the same component id, so just update it in place.\r\n                this.studentData.componentStatesByNodeId[componentStateNodeId][n] = componentState;\r\n                found = true; // remember this so we don't insert later.\r\n                break;\r\n            }\r\n        }\r\n        if (!found) {\r\n            this.studentData.componentStatesByNodeId[componentStateNodeId].push(componentState);\r\n        }\r\n\r\n        var componentId = componentState.componentId;\r\n        if (this.studentData.componentStatesByComponentId[componentId] == null) {\r\n            this.studentData.componentStatesByComponentId[componentId] = new Array();\r\n        }\r\n        found = false;  // reset\r\n        for (let c = 0; c < this.studentData.componentStatesByComponentId[componentId].length; c++) {\r\n            let cs = this.studentData.componentStatesByComponentId[componentId][c];\r\n            if (cs.id != null && cs.id === componentState.id) {\r\n                // found the same component id, so just update it in place.\r\n                this.studentData.componentStatesByComponentId[componentId][c] = componentState\r\n                found = true; // remember this so we don't insert later.\r\n                break;\r\n            }\r\n        }\r\n        if (!found) {\r\n            this.studentData.componentStatesByComponentId[componentId].push(componentState);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Retrieve the run status from the server\r\n     */\r\n    retrieveRunStatus() {\r\n        var runStatusURL = this.ConfigService.getConfigParam('runStatusURL');\r\n        var runId = this.ConfigService.getConfigParam('runId');\r\n\r\n        //create the params for the request\r\n        var params = {\r\n            runId:runId\r\n        };\r\n\r\n        var httpParams = {};\r\n        httpParams.method = 'GET';\r\n        httpParams.url = runStatusURL;\r\n        httpParams.headers = {'Content-Type': 'application/x-www-form-urlencoded'};\r\n        httpParams.params = params;\r\n\r\n        // make the request\r\n        return this.$http(httpParams).then((result) => {\r\n            if (result != null) {\r\n                var data = result.data;\r\n                if (data != null) {\r\n                    // save the run status\r\n                    this.runStatus = data;\r\n                    this.initializePeriods();\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    getComponentStatesByWorkgroupId(workgroupId) {\r\n        if (this.studentData.componentStatesByWorkgroupId == null) {\r\n            //debugger;\r\n        }\r\n        var componentStatesByWorkgroupId = this.studentData.componentStatesByWorkgroupId[workgroupId];\r\n        if (componentStatesByWorkgroupId != null) {\r\n            return componentStatesByWorkgroupId;\r\n        } else {\r\n            return [];\r\n        }\r\n    }\r\n\r\n    getComponentStatesByNodeId(nodeId) {\r\n        var componentStatesByNodeId = this.studentData.componentStatesByNodeId[nodeId];\r\n        if (componentStatesByNodeId != null) {\r\n            return componentStatesByNodeId;\r\n        } else {\r\n            return [];\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get the component stats for a component id\r\n     * @param componentId the component id\r\n     * @returns an array containing component states for a component id\r\n     */\r\n    getComponentStatesByComponentId(componentId) {\r\n        var componentStates = [];\r\n\r\n        var componentStatesByComponentId = this.studentData.componentStatesByComponentId[componentId];\r\n\r\n        if (componentStatesByComponentId != null) {\r\n            componentStates = componentStatesByComponentId;\r\n        }\r\n\r\n        return componentStates;\r\n    }\r\n\r\n    getLatestComponentStateByWorkgroupIdNodeIdAndComponentId(workgroupId, nodeId, componentId) {\r\n        var latestComponentState = null;\r\n\r\n        var componentStates = this.getComponentStatesByWorkgroupIdAndNodeId(workgroupId, nodeId);\r\n\r\n        if (componentStates != null) {\r\n\r\n            // loop through all the component states from newest to oldest\r\n            for (var c = componentStates.length - 1; c >= 0; c--) {\r\n                var componentState = componentStates[c];\r\n\r\n                if (componentState != null) {\r\n                    var componentStateNodeId = componentState.nodeId;\r\n                    var componentStateComponentId = componentState.componentId;\r\n\r\n                    // compare the node id and component id\r\n                    if (nodeId == componentStateNodeId &&\r\n                        componentId == componentStateComponentId) {\r\n                        latestComponentState = componentState;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return latestComponentState;\r\n    }\r\n\r\n    getLatestComponentStateByWorkgroupIdNodeId(workgroupId, nodeId) {\r\n        var latestComponentState = null;\r\n\r\n        var componentStates = this.getComponentStatesByWorkgroupIdAndNodeId(workgroupId, nodeId);\r\n\r\n        if (componentStates != null) {\r\n\r\n            // loop through all the component states from newest to oldest\r\n            for (var c = componentStates.length - 1; c >= 0; c--) {\r\n                var componentState = componentStates[c];\r\n\r\n                if (componentState != null) {\r\n                    var componentStateNodeId = componentState.nodeId;\r\n\r\n                    // compare the node id and component id\r\n                    if (nodeId == componentStateNodeId) {\r\n                        latestComponentState = componentState;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return latestComponentState;\r\n    }\r\n\r\n    /**\r\n     * Get the latest component states for a workgroup. Each component state\r\n     * will be the latest component state for a component.\r\n     * @param workgroupId the workgroup id\r\n     * @return an array of latest component states\r\n     */\r\n    getLatestComponentStatesByWorkgroupId(workgroupId) {\r\n        var componentStates = [];\r\n\r\n        if (workgroupId != null) {\r\n\r\n            // get all the component states for a workgroup\r\n            var componentStatesForWorkgroup = this.getComponentStatesByWorkgroupId(workgroupId);\r\n\r\n            if (componentStatesForWorkgroup != null) {\r\n\r\n                // mapping of component to revision counter\r\n                var componentRevisionCounter = {};\r\n\r\n                /*\r\n                 * used to keep track of the components we have found component\r\n                 * states for already\r\n                 */\r\n                var componentsFound = {};\r\n\r\n                // loop through the component states forwards\r\n                for (var csf = 0; csf < componentStatesForWorkgroup.length; csf++) {\r\n\r\n                    // get a component state\r\n                    var componentState = componentStatesForWorkgroup[csf];\r\n\r\n                    if (componentState != null) {\r\n\r\n                        // get the node id and component id of the component state\r\n                        var nodeId = componentState.nodeId;\r\n                        var componentId = componentState.componentId;\r\n\r\n                        // generate the component key e.g. \"node2_bb83hs0sd8\"\r\n                        var key = nodeId + \"-\" + componentId;\r\n\r\n                        if (componentRevisionCounter[key] == null) {\r\n                            // initialize the component revision counter for this component to 1 if there is no entry\r\n                            componentRevisionCounter[key] = 1;\r\n                        }\r\n\r\n                        // get the revision counter\r\n                        var revisionCounter = componentRevisionCounter[key];\r\n\r\n                        // set the revision counter into the component state\r\n                        componentState.revisionCounter = revisionCounter;\r\n\r\n                        // increment the revision counter for the component\r\n                        componentRevisionCounter[key] = revisionCounter + 1;\r\n                    }\r\n                }\r\n\r\n                // loop through the component states backwards\r\n                for(var csb = componentStatesForWorkgroup.length - 1; csb >= 0; csb--) {\r\n\r\n                    // get a component state\r\n                    var componentState = componentStatesForWorkgroup[csb];\r\n\r\n                    if (componentState != null) {\r\n\r\n                        // get the node id and component id of the component state\r\n                        var nodeId = componentState.nodeId;\r\n                        var componentId = componentState.componentId;\r\n\r\n                        // generate the component key e.g. \"node2_bb83hs0sd8\"\r\n                        var key = nodeId + \"-\" + componentId;\r\n\r\n                        if (componentsFound[key] == null) {\r\n                            /*\r\n                             * we have not found a component state for this\r\n                             * component yet so we will add it to the array\r\n                             * of component states\r\n                             */\r\n                            componentStates.push(componentState);\r\n\r\n                            /*\r\n                             * add an entry into the components found so that\r\n                             * don't add any more component states from this\r\n                             * component\r\n                             */\r\n                            componentsFound[key] = true;\r\n                        }\r\n                    }\r\n                }\r\n\r\n                /*\r\n                 * reverse the component states array since we have been adding\r\n                 * component states from newest to oldest order but we want them\r\n                 * in oldest to newest order\r\n                 */\r\n                componentStates.reverse();\r\n            }\r\n        }\r\n\r\n        return componentStates;\r\n    }\r\n\r\n    getComponentStatesByWorkgroupIdAndNodeId(workgroupId, nodeId) {\r\n\r\n        var componentStatesByWorkgroupId = this.getComponentStatesByWorkgroupId(workgroupId);\r\n        var componentStatesByNodeId = this.getComponentStatesByNodeId(nodeId);\r\n\r\n        // find the intersect and return it\r\n        return componentStatesByWorkgroupId.filter((n) => {\r\n            return componentStatesByNodeId.indexOf(n) != -1;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get component states for a workgroup id and component id\r\n     * @param workgroupId the workgroup id\r\n     * @param componentId the component id\r\n     * @returns an array of component states\r\n     */\r\n    getComponentStatesByWorkgroupIdAndComponentId(workgroupId, componentId) {\r\n        var componentStatesByWorkgroupId = this.getComponentStatesByWorkgroupId(workgroupId);\r\n        var componentStatesByComponentId = this.getComponentStatesByComponentId(componentId);\r\n\r\n        // find the intersect and return it\r\n        return componentStatesByWorkgroupId.filter((n) => {\r\n            return componentStatesByComponentId.indexOf(n) != -1;\r\n        });\r\n    }\r\n\r\n    getEventsByWorkgroupId(workgroupId) {\r\n        var eventsByWorkgroupId = this.studentData.eventsByWorkgroupId[workgroupId];\r\n        if (eventsByWorkgroupId != null) {\r\n            return eventsByWorkgroupId;\r\n        } else {\r\n            return [];\r\n        }\r\n    };\r\n\r\n    getEventsByNodeId(nodeId) {\r\n        var eventsByNodeId = this.studentData.eventsByNodeId[nodeId];\r\n        if (eventsByNodeId != null) {\r\n            return eventsByNodeId;\r\n        } else {\r\n            return [];\r\n        }\r\n    };\r\n\r\n    getEventsByWorkgroupIdAndNodeId(workgroupId, nodeId) {\r\n        var eventsByWorkgroupId = this.getEventsByWorkgroupId(workgroupId);\r\n        var eventsByNodeId = this.getEventsByNodeId(nodeId);\r\n\r\n        // find the intersect and return it\r\n        return eventsByWorkgroupId.filter((n) => {\r\n            return eventsByNodeId.indexOf(n) != -1;\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Get the latest event by workgroup id, node id, and event type\r\n     * @param workgroupId the workgroup id\r\n     * @param nodeId the node id\r\n     * @param eventType the event type\r\n     * @return the latest event with the matching parameters or null if\r\n     * no event is found with the matching parameters\r\n     */\r\n    getLatestEventByWorkgroupIdAndNodeIdAndType(workgroupId, nodeId, eventType) {\r\n\r\n        // get all the events for a workgroup id\r\n        var eventsByWorkgroupId = this.getEventsByWorkgroupId(workgroupId);\r\n\r\n        if (eventsByWorkgroupId != null) {\r\n\r\n            /*\r\n             * loop through all the events for the workgroup from newest to\r\n             * oldest\r\n             */\r\n            for (var e = eventsByWorkgroupId.length - 1; e >= 0; e--) {\r\n\r\n                // get an event\r\n                var event = eventsByWorkgroupId[e];\r\n\r\n                if (event != null) {\r\n                    if (event.nodeId == nodeId && event.event == eventType) {\r\n                        /*\r\n                         * the event parameters match the ones we are looking\r\n                         * for\r\n                         */\r\n                        return event;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    getAnnotationsToWorkgroupId(workgroupId) {\r\n        var annotationsToWorkgroupId = this.studentData.annotationsToWorkgroupId[workgroupId];\r\n        if (annotationsToWorkgroupId != null) {\r\n            return annotationsToWorkgroupId;\r\n        } else {\r\n            return [];\r\n        }\r\n    }\r\n\r\n    getAnnotationsByNodeId(nodeId) {\r\n        var annotationsByNodeId = this.studentData.annotationsByNodeId[nodeId];\r\n        if (annotationsByNodeId != null) {\r\n            return annotationsByNodeId;\r\n        } else {\r\n            return [];\r\n        }\r\n    }\r\n\r\n    getAnnotationsToWorkgroupIdAndNodeId(workgroupId, nodeId) {\r\n        var annotationsToWorkgroupId = this.getAnnotationsToWorkgroupId(workgroupId);\r\n        var annotationsByNodeId = this.getAnnotationsByNodeId(nodeId);\r\n\r\n        // find the intersect and return it\r\n        return annotationsToWorkgroupId.filter((n) => {\r\n            return annotationsByNodeId.indexOf(n) != -1;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Initialize the periods\r\n     */\r\n    initializePeriods() {\r\n\r\n        // get the periods from the config\r\n        let periods = this.ConfigService.getPeriods();\r\n        let currentPeriod = null;\r\n\r\n        if (periods.length > 1) {\r\n            // create an option for all periods\r\n            let allPeriodsOption = {\r\n                periodId: -1,\r\n                periodName: this.$translate('allPeriods')\r\n            };\r\n\r\n            periods.unshift(allPeriodsOption);\r\n            currentPeriod = periods[0];\r\n        } else if (periods.length == 1) {\r\n            currentPeriod = periods[0];\r\n        }\r\n\r\n        // an array to gather all the periods\r\n        let mergedPeriods = [];\r\n\r\n        /*\r\n         * Get the periods from the run status. These periods may not be up to\r\n         * date so we need to compare them with the periods from the config.\r\n         */\r\n        let runStatusPeriods = this.runStatus.periods;\r\n\r\n        // loop through all the periods in the config\r\n        for (let p = 0; p < periods.length; p++) {\r\n            let period = periods[p];\r\n\r\n            if (period != null) {\r\n                // check if the period object is in the run status periods\r\n\r\n                let runStatusPeriod = null;\r\n\r\n                if (runStatusPeriods != null) {\r\n                    // loop through all the periods in the run status\r\n                    for (let r = 0; r < runStatusPeriods.length; r++) {\r\n                        let tempRunStatusPeriod = runStatusPeriods[r];\r\n\r\n                        if (tempRunStatusPeriod != null) {\r\n                            if (period.periodId == tempRunStatusPeriod.periodId) {\r\n                                /*\r\n                                 * We have found a period that is in the config and\r\n                                 * the run status.\r\n                                 */\r\n                                runStatusPeriod = tempRunStatusPeriod;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n                if (runStatusPeriod == null) {\r\n                    /*\r\n                     * we did not find the period object in the run status so\r\n                     * we will use the period object from the config\r\n                     */\r\n                    mergedPeriods.push(period);\r\n                } else {\r\n                    // we found the period object in the run status so we will use it\r\n                    mergedPeriods.push(runStatusPeriod);\r\n                }\r\n            }\r\n        }\r\n\r\n        this.periods = mergedPeriods;\r\n        this.runStatus.periods = mergedPeriods;\r\n\r\n        // set the current period\r\n        if (currentPeriod) {\r\n            this.setCurrentPeriod(currentPeriod);\r\n        }\r\n    }\r\n\r\n    setCurrentPeriod(period) {\r\n        let previousPeriod = this.currentPeriod;\r\n        this.currentPeriod = period;\r\n\r\n        // whenever the current period is set, clear the currently selected workgroup\r\n        this.setCurrentWorkgroup(null);\r\n\r\n        // broadcast the event that the current period has changed\r\n        this.$rootScope.$broadcast('currentPeriodChanged', {previousPeriod: previousPeriod, currentPeriod: this.currentPeriod});\r\n    }\r\n\r\n    getCurrentPeriod() {\r\n        return this.currentPeriod;\r\n    }\r\n\r\n    getPeriods() {\r\n        return this.periods;\r\n    }\r\n\r\n    getRunStatus() {\r\n        return this.runStatus;\r\n    }\r\n\r\n    setCurrentWorkgroup(workgroup) {\r\n        this.currentWorkgroup = workgroup;\r\n\r\n        // broadcast the event that the current workgroup has changed\r\n        this.$rootScope.$broadcast('currentWorkgroupChanged', {currentWorkgroup: this.currentWorkgroup});\r\n    }\r\n\r\n    getCurrentWorkgroup() {\r\n        return this.currentWorkgroup;\r\n    }\r\n\r\n    setCurrentStep(step) {\r\n        this.currentStep = step;\r\n\r\n        // broadcast the event that the current step has changed\r\n        this.$rootScope.$broadcast('currentStepChanged', {currentStep: this.currentStep});\r\n    }\r\n\r\n    getCurrentStep() {\r\n        return this.currentStep;\r\n    }\r\n\r\n    /**\r\n     * Get the current node\r\n     * @returns the current node object\r\n     */\r\n    getCurrentNode() {\r\n        return this.currentNode;\r\n    }\r\n\r\n    /**\r\n     * Get the current node id\r\n     * @returns the current node id\r\n     */\r\n    getCurrentNodeId() {\r\n        var currentNodeId = null;\r\n\r\n        if (this.currentNode != null) {\r\n            currentNodeId = this.currentNode.id;\r\n        }\r\n\r\n        return currentNodeId;\r\n    }\r\n\r\n    /**\r\n     * Set the current node\r\n     * @param nodeId the node id\r\n     */\r\n    setCurrentNodeByNodeId(nodeId) {\r\n        if (nodeId != null) {\r\n            let node = this.ProjectService.getNodeById(nodeId);\r\n\r\n            this.setCurrentNode(node);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Set the current node\r\n     * @param node the node object\r\n     */\r\n    setCurrentNode(node) {\r\n        let previousCurrentNode = this.currentNode;\r\n\r\n        if (previousCurrentNode !== node) {\r\n            // the current node is about to change\r\n\r\n            if (previousCurrentNode && !this.ProjectService.isGroupNode(previousCurrentNode.id)){\r\n                // set the previous node to the current node\r\n                this.previousStep = previousCurrentNode;\r\n            }\r\n\r\n            // set the current node to the new node\r\n            this.currentNode = node;\r\n\r\n            // broadcast the event that the current node has changed\r\n            this.$rootScope.$broadcast('currentNodeChanged', {previousNode: previousCurrentNode, currentNode: this.currentNode});\r\n        }\r\n    }\r\n\r\n    /**\r\n     * End the current node\r\n     */\r\n    endCurrentNode() {\r\n\r\n        // get the current node\r\n        var previousCurrentNode = this.currentNode;\r\n\r\n        if (previousCurrentNode != null) {\r\n\r\n            // tell the node to exit\r\n            this.$rootScope.$broadcast('exitNode', {nodeToExit: previousCurrentNode});\r\n        }\r\n    }\r\n\r\n    /**\r\n     * End the current node and set the current node\r\n     * @param nodeId the node id of the new current node\r\n     */\r\n    endCurrentNodeAndSetCurrentNodeByNodeId(nodeId) {\r\n        // end the current node\r\n        this.endCurrentNode();\r\n\r\n        // set the current node\r\n        this.setCurrentNodeByNodeId(nodeId);\r\n    }\r\n\r\n    /**\r\n     * Get the total score for a workgroup\r\n     * @param workgroupId the workgroup id\r\n     * @returns the total score for the workgroup\r\n     */\r\n    getTotalScoreByWorkgroupId(workgroupId) {\r\n\r\n        var totalScore = null;\r\n\r\n        if (this.studentData.annotationsToWorkgroupId != null) {\r\n\r\n            // get all the annotations for a workgroup\r\n            var annotations = this.studentData.annotationsToWorkgroupId[workgroupId];\r\n\r\n            // get the total score for the workgroup\r\n            totalScore = this.AnnotationService.getTotalScore(annotations, workgroupId);\r\n        }\r\n\r\n        return totalScore;\r\n    }\r\n\r\n    /**\r\n     * Get the run status\r\n     * @returns the run status object\r\n     */\r\n    getRunStatus() {\r\n        return this.runStatus;\r\n    }\r\n\r\n    /**\r\n     * Check if any period in the run is paused\r\n     * @returns Boolean whether any periods are paused\r\n     */\r\n    isAnyPeriodPaused(periodId) {\r\n        let isPaused = false;\r\n\r\n        // get the run status\r\n        let runStatus = this.runStatus;\r\n\r\n        if (runStatus && runStatus.periods) {\r\n            let periods = runStatus.periods;\r\n            let nPeriods = periods.length;\r\n            let nPeriodsPaused = 0;\r\n\r\n            // loop through all the periods\r\n            for (let p = 0; p < periods.length; p++) {\r\n                let period = periods[p];\r\n\r\n                if (period != null) {\r\n                    if (period.paused) {\r\n                        isPaused = true;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return isPaused;\r\n    }\r\n\r\n    /**\r\n     * Check if the given period is paused\r\n     * @param periodId the id for a period\r\n     * @returns Boolean whether the period is paused or not\r\n     */\r\n    isPeriodPaused(periodId) {\r\n\r\n        let isPaused = false;\r\n\r\n        // get the run status\r\n        let runStatus = this.runStatus;\r\n\r\n        if (runStatus && runStatus.periods) {\r\n            let periods = runStatus.periods;\r\n            let nPeriods = periods.length;\r\n            let nPeriodsPaused = 0;\r\n\r\n            // loop through all the periods\r\n            for (let p = 0; p < periods.length; p++) {\r\n                let period = periods[p];\r\n\r\n                if (period != null) {\r\n                    isPaused = period.paused;\r\n                    if (periodId == period.periodId) {\r\n                        // we have found the period we are looking for\r\n                        break;\r\n                    } else {\r\n                        if (isPaused) {\r\n                            nPeriodsPaused++;\r\n                        } else {\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (periodId === -1 && nPeriods === nPeriodsPaused) {\r\n                isPaused = true;\r\n            }\r\n        }\r\n\r\n        return isPaused;\r\n    }\r\n\r\n    /**\r\n     * The pause screen status was changed for the given periodId. Update period accordingly.\r\n     * @param periodId the id of the period to toggle\r\n     * @param isPaused Boolean whether the period should be paused or not\r\n     */\r\n    pauseScreensChanged(periodId, isPaused) {\r\n        if (periodId) {\r\n            // update the run status\r\n            this.updatePausedRunStatusValue(periodId, isPaused);\r\n\r\n            if (isPaused) {\r\n                // pause the student screens\r\n                this.TeacherWebSocketService.pauseScreens(periodId);\r\n            } else {\r\n                // unpause the student screens\r\n                this.TeacherWebSocketService.unPauseScreens(periodId);\r\n            }\r\n\r\n            // save the run status to the server\r\n            this.sendRunStatus();\r\n\r\n            // save pause/unpause screen event\r\n            let context = \"ClassroomMonitor\", nodeId = null, componentId = null, componentType = null,\r\n                category = \"TeacherAction\", data = { periodId: periodId };\r\n            let event = \"pauseScreen\";\r\n            if (!isPaused) {\r\n                event = \"unPauseScreen\";\r\n            }\r\n            this.saveEvent(context, nodeId, componentId, componentType, category, event, data);\r\n\r\n            this.$rootScope.$broadcast('pauseScreensChanged', {periods: this.runStatus.periods});\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Create a local run status object to keep track of the run status\r\n     * @returns the run status object\r\n     */\r\n    createRunStatus() {\r\n        var runStatus = {};\r\n\r\n        // get the run id\r\n        runStatus.runId = this.ConfigService.getConfigParam('runId');\r\n\r\n        // get all the periods objects\r\n        var periods = this.ConfigService.getPeriods();\r\n\r\n        //loop through all the periods\r\n        for (var x = 0; x < periods.length; x++) {\r\n            //get a period\r\n            var period = periods[x];\r\n\r\n            //set this to default to not paused\r\n            period.paused = false;\r\n        }\r\n\r\n        // set the periods into the run status\r\n        runStatus.periods = periods;\r\n\r\n        // set the run status into the view so we can access it later\r\n        this.runStatus = runStatus;\r\n\r\n        return this.runStatus;\r\n    }\r\n\r\n    /**\r\n     * Update the paused value for a period in our run status\r\n     * @param periodId the period id\r\n     * @param value whether the period is paused or not\r\n     */\r\n    updatePausedRunStatusValue(periodId, value) {\r\n        //create the local run status object if necessary\r\n        if (this.runStatus == null) {\r\n            this.createRunStatus();\r\n        }\r\n\r\n        //get the local run status object\r\n        let runStatus = this.runStatus;\r\n        let periods = runStatus.periods;\r\n\r\n        let allPeriodsPaused = true;\r\n\r\n        if (periods) {\r\n            let l = periods.length, x = l - 1;\r\n            //loop through all the periods\r\n            for (; x > -1; x--) {\r\n                //get a period\r\n                let tempPeriod = periods[x];\r\n\r\n                //get the period id\r\n                let tempPeriodId = tempPeriod.periodId;\r\n\r\n                //check if the period id matches the one we need to update or if all periods has been selected\r\n                if (periodId === tempPeriodId || periodId === -1) {\r\n                    //we have found the period we want to update\r\n                    tempPeriod.paused = value;\r\n                }\r\n\r\n                if (tempPeriodId !== -1 && !tempPeriod.paused) {\r\n                    allPeriodsPaused = false;\r\n                }\r\n\r\n                if (tempPeriodId === -1) {\r\n                    // set the paused status for the all periods option\r\n                    tempPeriod.paused = allPeriodsPaused;\r\n                }\r\n             }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Send the run status back to the server to be saved in the db\r\n     * @param customPauseMessage the custom pause message text to send to the students\r\n     */\r\n    sendRunStatus(customPauseMessage) {\r\n        //get the run status url we will use to make the request\r\n        var runStatusURL = this.ConfigService.getConfigParam('runStatusURL');\r\n\r\n        if (runStatusURL != null) {\r\n            //make the request to the server for the student statuses\r\n\r\n            //get the run id\r\n            var runId = this.ConfigService.getConfigParam('runId');\r\n\r\n            if (customPauseMessage != null) {\r\n                //set the pause message if one was provided\r\n                this.runStatus.pauseMessage = customPauseMessage;\r\n            }\r\n\r\n            //get the run status as a string\r\n            var runStatus = angular.toJson(this.runStatus);\r\n\r\n            //create the params for the request\r\n            var runStatusParams = {\r\n                runId:runId,\r\n                status:runStatus\r\n            };\r\n\r\n            var httpParams = {};\r\n            httpParams.method = 'POST';\r\n            httpParams.url = runStatusURL;\r\n            httpParams.headers = {'Content-Type': 'application/x-www-form-urlencoded'};\r\n            httpParams.data = $.param(runStatusParams);\r\n\r\n            // make the request\r\n            this.$http(httpParams);\r\n        }\r\n    };\r\n}\r\n\r\nTeacherDataService.$inject = [\r\n    '$http',\r\n    '$filter',\r\n    '$q',\r\n    '$rootScope',\r\n    'AnnotationService',\r\n    'ConfigService',\r\n    'NotificationService',\r\n    'ProjectService',\r\n    'TeacherWebSocketService',\r\n    'UtilService'\r\n];\r\n\r\nexport default TeacherDataService;\r\n"]}