{"version":3,"sources":["editNotebookItemController.es6"],"names":["EditNotebookItemController","$filter","$mdDialog","$q","$injector","$rootScope","$scope","ConfigService","NotebookService","ProjectService","StudentAssetService","StudentDataService","UtilService","$translate","showUpload","itemId","currentNodeId","getCurrentNodeId","currentNodeTitle","getNodeTitleByNodeId","item","id","localNotebookItemId","generateKey","type","nodeId","title","content","text","attachments","angular","copy","getLatestNotebookItemByLocalNotebookItemId","notebookConfig","getNotebookConfig","color","itemTypes","label","singular","isEditMode","noteLabel","saveEnabled","file","files","attachStudentAssetToNote","setShowUpload","f","attachment","studentAssetId","iconURL","push","reader","FileReader","onload","event","target","result","readAsDataURL","update","length","getNodePositionAndTitleByNodeId","getNodePositionById","getThemePath","indexOf","splice","ev","hide","uploadAssetPromises","clientSaveTime","Date","parse","i","deferred","defer","uploadAsset","then","studentAsset","copyAssetForReference","copiedAsset","newAttachment","resolve","promise","all","saveNotebookItem","isRequireTextOnEveryNote","note","requireTextOnEveryNote","enableStudentUploads","$inject"],"mappings":"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","file":"editNotebookItemController.js","sourcesContent":["'use strict';\r\n\r\nclass EditNotebookItemController {\r\n\r\n    constructor($filter,\r\n                $mdDialog,\r\n                $q,\r\n                $injector,\r\n                $rootScope,\r\n                $scope,\r\n                ConfigService,\r\n                NotebookService,\r\n                ProjectService,\r\n                StudentAssetService,\r\n                StudentDataService,\r\n                UtilService) {\r\n\r\n        this.$filter = $filter;\r\n        this.$mdDialog = $mdDialog;\r\n        this.$q = $q;\r\n        this.$injector = $injector;\r\n        this.$rootScope = $rootScope;\r\n        this.$scope = $scope;\r\n        this.ConfigService = ConfigService;\r\n        this.NotebookService = NotebookService;\r\n        this.ProjectService = ProjectService;\r\n        this.StudentAssetService = StudentAssetService;\r\n        this.StudentDataService = StudentDataService;\r\n        this.UtilService = UtilService;\r\n\r\n        this.$translate = this.$filter('translate');\r\n\r\n        this.showUpload = false;\r\n\r\n        if (this.itemId == null) {\r\n            let currentNodeId = this.StudentDataService.getCurrentNodeId();\r\n            let currentNodeTitle = this.ProjectService.getNodeTitleByNodeId(currentNodeId);\r\n\r\n            this.item = {\r\n                id: null, // null id means we're creating a new notebook item.\r\n                localNotebookItemId: this.UtilService.generateKey(10), // Id that is common across the same notebook item revisions.\r\n                type: \"note\", // the notebook item type, TODO: once questions are enabled, don't hard code\r\n                nodeId: currentNodeId, // Id of the node this note was created on\r\n                title: this.$translate('noteFrom', { currentNodeTitle: currentNodeTitle }),  // Title of the node this note was created on\r\n                content: {\r\n                    text: \"\",\r\n                    attachments: []\r\n                }\r\n            };\r\n        } else {\r\n            this.item = angular.copy(this.NotebookService.getLatestNotebookItemByLocalNotebookItemId(this.itemId));\r\n            this.item.id = null; // set to null so we're creating a new notebook item. An edit to a notebook item results in a new entry in the db.\r\n        }\r\n\r\n        this.notebookConfig = this.NotebookService.getNotebookConfig();\r\n        this.color = this.notebookConfig.itemTypes[this.item.type].label.color;\r\n\r\n        let label = this.notebookConfig.itemTypes[this.item.type].label.singular;\r\n        if (this.isEditMode) {\r\n            if (this.itemId) {\r\n                this.title = this.$translate('editNote', { noteLabel: label });\r\n            } else {\r\n                this.title = this.$translate('addNote', { noteLabel: label });\r\n            }\r\n        } else {\r\n            this.title = this.$translate('viewNote', { noteLabel: label });\r\n        }\r\n        this.saveEnabled = false;\r\n\r\n        if (this.file != null) {\r\n            // student is trying to add a file to this notebook item.\r\n            var files = [this.file];  // put the file into an array\r\n\r\n            this.attachStudentAssetToNote(files);\r\n        } else {\r\n            this.setShowUpload();\r\n        }\r\n    }\r\n\r\n    attachStudentAssetToNote(files) {\r\n        if (files != null) {\r\n            for (let f = 0; f < files.length; f++) {\r\n                let file = files[f];\r\n                // create a temporary attachment object\r\n                let attachment = {\r\n                    studentAssetId: null,\r\n                    iconURL: \"\",\r\n                    file: file  // add the file for uploading in the future\r\n                };\r\n                this.item.content.attachments.push(attachment);\r\n                // read image data as URL and set it in the temp attachment src attribute so students can preview the image\r\n                let reader = new FileReader();\r\n                reader.onload = (event) => {\r\n                    attachment.iconURL = event.target.result;\r\n                };\r\n                reader.readAsDataURL(file);\r\n                this.update();\r\n            }\r\n        }\r\n    }\r\n\r\n    getItemNodeId() {\r\n        if (this.item == null) {\r\n            return null;\r\n        } else {\r\n            return this.item.nodeId;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Returns this NotebookItem's position link\r\n     */\r\n    getItemNodeLink() {\r\n        if (this.item == null) {\r\n            return \"\";\r\n        } else {\r\n            return this.ProjectService.getNodePositionAndTitleByNodeId(this.item.nodeId);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Returns this NotebookItem's position\r\n     */\r\n    getItemNodePosition() {\r\n        if (this.item == null) {\r\n            return \"\";\r\n        } else {\r\n            return this.ProjectService.getNodePositionById(this.item.nodeId);\r\n        }\r\n    }\r\n\r\n    getTemplateUrl() {\r\n        return this.ProjectService.getThemePath() + '/notebook/editNotebookItem.html';\r\n    }\r\n\r\n    removeAttachment(attachment) {\r\n        if (this.item.content.attachments.indexOf(attachment) != -1) {\r\n            this.item.content.attachments.splice(this.item.content.attachments.indexOf(attachment), 1);\r\n            this.update();\r\n        }\r\n    }\r\n\r\n    delete(ev) {\r\n        // TODO: add archiving/deleting notebook items\r\n    }\r\n\r\n    cancel() {\r\n        this.$mdDialog.hide();\r\n    }\r\n\r\n    save() {\r\n        // go through the notebook item's attachments and look for any attachments that need to be uploaded and made into StudentAsset.\r\n        let uploadAssetPromises = [];\r\n        this.item.content.clientSaveTime = Date.parse(new Date());  // set save timestamp\r\n        if (this.item.content.attachments != null) {\r\n            for (let i = 0; i < this.item.content.attachments.length; i++) {\r\n                let attachment = this.item.content.attachments[i];\r\n                if (attachment.studentAssetId == null && attachment.file != null) {\r\n                    // this attachment hasn't been uploaded yet, so we'll do that now.\r\n                    let file = attachment.file;\r\n\r\n                    var deferred = this.$q.defer();\r\n                    this.StudentAssetService.uploadAsset(file).then((studentAsset) => {\r\n                        this.StudentAssetService.copyAssetForReference(studentAsset).then((copiedAsset) => {\r\n                            if (copiedAsset != null) {\r\n                                var newAttachment = {\r\n                                    studentAssetId: copiedAsset.id,\r\n                                    iconURL: copiedAsset.iconURL\r\n                                };\r\n                                this.item.content.attachments[i] = newAttachment;\r\n                                deferred.resolve();\r\n                            }\r\n                        });\r\n                    });\r\n                    uploadAssetPromises.push(deferred.promise);\r\n                }\r\n            }\r\n        }\r\n\r\n        // make sure all the assets are created before saving the notebook item.\r\n        this.$q.all(uploadAssetPromises).then(() => {\r\n            this.NotebookService.saveNotebookItem(this.item.id, this.item.nodeId, this.item.localNotebookItemId, this.item.type, this.item.title, this.item.content, this.item.content.clientSaveTime)\r\n                .then(() => {\r\n                    this.$mdDialog.hide();\r\n                });\r\n        });\r\n    }\r\n\r\n    update() {\r\n        // notebook item has changed\r\n        // set whether save button should be enabled\r\n        let saveEnabled = false;\r\n        if (this.item.content.text || !this.isRequireTextOnEveryNote() && this.item.content.attachments.length) {\r\n            // note has text and/or attachments when text is not required, so we can save\r\n            saveEnabled = true;\r\n        }\r\n        this.saveEnabled = saveEnabled;\r\n\r\n        this.setShowUpload();\r\n    }\r\n\r\n    isRequireTextOnEveryNote() {\r\n        return this.notebookConfig.itemTypes != null &&\r\n            this.notebookConfig.itemTypes.note != null &&\r\n            this.notebookConfig.itemTypes.note.requireTextOnEveryNote;\r\n    }\r\n\r\n    setShowUpload() {\r\n        this.showUpload = this.notebookConfig.itemTypes != null &&\r\n                    this.notebookConfig.itemTypes.note != null &&\r\n                    this.notebookConfig.itemTypes.note.enableStudentUploads &&\r\n                    this.item.content.attachments &&\r\n                    this.item.content.attachments.length < 1;\r\n    }\r\n}\r\n\r\nEditNotebookItemController.$inject = [\r\n    '$filter',\r\n    \"$mdDialog\",\r\n    \"$q\",\r\n    \"$injector\",\r\n    \"$rootScope\",\r\n    \"$scope\",\r\n    \"ConfigService\",\r\n    \"NotebookService\",\r\n    \"ProjectService\",\r\n    \"StudentAssetService\",\r\n    \"StudentDataService\",\r\n    \"UtilService\"\r\n];\r\n\r\nexport default EditNotebookItemController;\r\n"]}