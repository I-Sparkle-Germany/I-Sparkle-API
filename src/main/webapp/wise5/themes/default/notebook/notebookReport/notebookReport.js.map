{"version":3,"sources":["notebookReport.es6"],"names":["NotebookReportController","$filter","$mdSidenav","$scope","$timeout","AnnotationService","ConfigService","NotebookService","ProjectService","$translate","full","collapsed","dirty","autoSaveInterval","saveMessage","text","time","reportId","config","itemTypes","report","notes","reportItem","getLatestNotebookReportItemByReportId","workgroupId","serverSaveTime","clientSaveTime","convertToClientTimestamp","setSaveMessage","getTemplateReportItemByReportId","maxScore","localNotebookItemId","content","reportNoteContent","getReportNoteContentByReportId","id","reportItemContent","injectAssetPaths","latestAnnotations","getLatestNotebookItemAnnotations","startAutoSaveInterval","summernoteOptions","toolbar","popover","image","customButton","buttonText","note","label","singular","tooltip","buttonClass","action","$event","addNotebookItemContent","disableDragAndDrop","toolbarContainer","callbacks","onBlur","$","summernote","$onChanges","changes","insertContent","isFirstChange","currentValue","item","angular","copy","reportElement","$item","hasAttachments","attachments","length","css","a","notebookItemAttachment","iconURL","$img","addClass","append","$caption","$on","event","args","annotation","hasNewAnnotation","collapse","$notebookReportContent","animate","scrollTop","prop","onCollapse","onSetInsertMode","value","removeAbsoluteAssetPaths","stopAutoSaveInterval","autoSaveIntervalId","setInterval","saveNotebookReportItem","clearInterval","Date","parse","saveNotebookItem","nodeId","type","title","then","result","message","$inject","NotebookReport","bindings","insertMode","visible","template","controller"],"mappings":"AAAA;;;;;;;;;;IAEMA,wB;AACF,sCAAYC,OAAZ,EACYC,UADZ,EAEYC,MAFZ,EAGYC,QAHZ,EAIYC,iBAJZ,EAKYC,aALZ,EAMYC,eANZ,EAOYC,cAPZ,EAO4B;AAAA;;AAAA;;AACxB,aAAKP,OAAL,GAAeA,OAAf;AACA,aAAKC,UAAL,GAAkBA,UAAlB;AACA,aAAKC,MAAL,GAAcA,MAAd;AACA,aAAKC,QAAL,GAAgBA,QAAhB;AACA,aAAKC,iBAAL,GAAyBA,iBAAzB;AACA,aAAKC,aAAL,GAAqBA,aAArB;AACA,aAAKC,eAAL,GAAuBA,eAAvB;AACA,aAAKC,cAAL,GAAsBA,cAAtB;;AAEA,aAAKC,UAAL,GAAkB,KAAKR,OAAL,CAAa,WAAb,CAAlB;;AAEA,aAAKS,IAAL,GAAY,KAAZ;AACA,aAAKC,SAAL,GAAiB,IAAjB;;AAEA,aAAKC,KAAL,GAAa,KAAb;AACA,aAAKC,gBAAL,GAAwB,KAAxB,CAhBwB,CAgBQ;;AAEhC,aAAKC,WAAL,GAAmB;AACfC,kBAAM,EADS;AAEfC,kBAAM;AAFS,SAAnB;;AAKA;AACA,aAAKC,QAAL,GAAgB,KAAKC,MAAL,CAAYC,SAAZ,CAAsBC,MAAtB,CAA6BC,KAA7B,CAAmC,CAAnC,EAAsCJ,QAAtD;AACA,aAAKK,UAAL,GAAkB,KAAKf,eAAL,CAAqBgB,qCAArB,CAA2D,KAAKN,QAAhE,EAA0E,KAAKO,WAA/E,CAAlB;AACA,YAAI,KAAKF,UAAT,EAAqB;AACjB,gBAAIG,iBAAiB,KAAKH,UAAL,CAAgBG,cAArC;AACA,gBAAIC,iBAAiB,KAAKpB,aAAL,CAAmBqB,wBAAnB,CAA4CF,cAA5C,CAArB;AACA,iBAAKG,cAAL,CAAoB,KAAKnB,UAAL,CAAgB,OAAhB,CAApB,EAA8CiB,cAA9C;AACH,SAJD,MAIO;AACH;AACA,iBAAKJ,UAAL,GAAkB,KAAKf,eAAL,CAAqBsB,+BAArB,CAAqD,KAAKZ,QAA1D,CAAlB;AACA,gBAAI,KAAKK,UAAL,IAAmB,IAAvB,EAA6B;AACzB;AACA;AACH;AACJ;AACD;AACA,aAAKQ,QAAL,GAAgB,CAAhB;AACA,YAAIC,sBAAsB,IAA1B,CAxCwB,CAwCS;AACjC,YAAI,KAAKT,UAAL,CAAgBU,OAAhB,IAA2B,IAA3B,IAAmC,KAAKV,UAAL,CAAgBU,OAAhB,CAAwBf,QAAxB,IAAoC,IAA3E,EAAiF;AAC7Ec,kCAAsB,KAAKT,UAAL,CAAgBS,mBAAtC;AACA,gBAAIE,oBAAoB,KAAK1B,eAAL,CAAqB2B,8BAArB,CAAoD,KAAKZ,UAAL,CAAgBU,OAAhB,CAAwBf,QAA5E,CAAxB;AACA,gBAAIgB,qBAAqB,IAArB,IAA6BA,kBAAkBH,QAAlB,IAA8B,IAA/D,EAAqE;AACjE,qBAAKA,QAAL,GAAgBG,kBAAkBH,QAAlC;AACH;AACJ;AACD;AACA,aAAKR,UAAL,CAAgBa,EAAhB,GAAqB,IAArB;AACA;AACA,aAAKC,iBAAL,GAAyB,KAAK5B,cAAL,CAAoB6B,gBAApB,CAAqC,KAAKf,UAAL,CAAgBU,OAAhB,CAAwBA,OAA7D,CAAzB;AACA;AACA,aAAKM,iBAAL,GAAyB,KAAKjC,iBAAL,CAAuBkC,gCAAvB,CAAwD,KAAKf,WAA7D,EAA0E,KAAKP,QAA/E,CAAzB;;AAEA;AACA,aAAKuB,qBAAL;;AAEA;AACA,aAAKC,iBAAL,GAAyB;AACrBC,qBAAS,CACL,CAAC,MAAD,EAAS,CAAC,MAAD,EAAS,MAAT,CAAT,CADK,EAEL,CAAC,OAAD,EAAU,CAAC,MAAD,EAAS,QAAT,EAAmB,WAAnB,CAA8B,0DAA9B,CAAV,CAFK;AAGL;AACA;AACA;AACA;AACA,aAAC,MAAD,EAAS,CAAC,IAAD,EAAO,IAAP,EAAa,WAAb,CAAwB,kBAAxB,CAAT,CAPK;AAQL;AACA;AACA;AACA;AACA;AACA,aAAC,cAAD,EAAiB,CAAC,cAAD,CAAjB,CAbK,EAcL,CAAC,OAAD,EAAU,CAAC,OAAD,CAAV,CAdK,CADY;AAiBrBC,qBAAS;AACLC,uBAAO,CACH,CAAC,WAAD,EAAc,CAAC,cAAD,EAAiB,aAAjB,EAAgC,aAAhC,CAAd,CADG;AAEH;AACA,iBAAC,QAAD,EAAW,CAAC,aAAD,CAAX,CAHG;AADF,aAjBY;AAwBrBC,0BAAc;AACV;AACAC,4BAAY,YAAY,KAAK5B,MAAL,CAAYC,SAAZ,CAAsB4B,IAAtB,CAA2BC,KAA3B,CAAiCC,QAA7C,GAAwD,IAF1D;AAGVC,yBAAS,iBAAiB,KAAKhC,MAAL,CAAY8B,KAH5B;AAIVG,6BAAa,0CAJH;AAKVC,wBAAQ,gBAACC,MAAD,EAAY;AAChB,0BAAKC,sBAAL,CAA4BD,MAA5B;AACH;AAPS,aAxBO;AAiCrBE,gCAAoB,IAjCC;AAkCrBC,8BAAkB,MAAM,KAAKvC,QAAX,GAAsB,UAlCnB;AAmCrBwC,uBAAW;AACPC,wBAAQ,kBAAY;AAChBC,sBAAE,IAAF,EAAQC,UAAR,CAAmB,WAAnB;AACH;AAHM;AAnCU,SAAzB;;AA0CA,aAAKC,UAAL,GAAkB,UAACC,OAAD,EAAa;AAC3B,gBAAIA,QAAQC,aAAR,IAAyB,CAACD,QAAQC,aAAR,CAAsBC,aAAtB,EAA1B,IAAmEF,QAAQC,aAAR,CAAsBE,YAA7F,EAA2G;AACvG;AACA,oBAAIC,OAAOC,QAAQC,IAAR,CAAaN,QAAQC,aAAR,CAAsBE,YAAnC,CAAX;;AAEA;AACA,oBAAII,gBAAgBV,EAAE,MAAM,MAAK1C,QAAb,CAApB;AACAoD,8BAAcT,UAAd,CAAyB,OAAzB;AACAS,8BAAcT,UAAd,CAAyB,cAAzB;;AAEA;AACA,oBAAIU,QAAQX,EAAE,KAAF,CAAZ;AACA,oBAAIY,iBAAiB,KAArB;;AAEA,oBAAIL,KAAKlC,OAAT,EAAkB;AACd,wBAAIkC,KAAKlC,OAAL,CAAawC,WAAjB,EAA8B;AAC1B,4BAAIN,KAAKlC,OAAL,CAAawC,WAAb,CAAyBC,MAA7B,EAAqC;AACjCF,6CAAiB,IAAjB;AACA;AACAD,kCAAMI,GAAN,CAAU,YAAV,EAAwB,QAAxB;AACH;AACD,6BAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIT,KAAKlC,OAAL,CAAawC,WAAb,CAAyBC,MAA7C,EAAqDE,GAArD,EAA0D;AACtD;AACA,gCAAIC,yBAAyBV,KAAKlC,OAAL,CAAawC,WAAb,CAAyBG,CAAzB,CAA7B;AACA,gCAAIE,UAAUD,uBAAuBC,OAArC;AACA,gCAAIC,OAAOnB,EAAE,eAAekB,OAAf,GAAyB,2IAA3B,CAAX;AACAC,iCAAKC,QAAL,CAAc,iCAAd;AACAT,kCAAMU,MAAN,CAAaF,IAAb;AACH;AACJ;AACD,wBAAIZ,KAAKlC,OAAL,CAAajB,IAAjB,EAAuB;AACnB;AACA,4BAAIwD,cAAJ,EAAoB;AAChB;AACA,gCAAIU,WAAWtB,EAAE,aAAaO,KAAKlC,OAAL,CAAajB,IAA1B,GAAiC,YAAnC,EAAiD2D,GAAjD,CAAqD,EAAC,cAAc,QAAf,EAArD,CAAf;AACAJ,kCAAMU,MAAN,CAAaC,QAAb;AACAZ,0CAAcT,UAAd,CAAyB,YAAzB,EAAuCU,MAAM,CAAN,CAAvC;AACH,yBALD,MAKO;AACH;AACAD,0CAAcT,UAAd,CAAyB,YAAzB,EAAuCM,KAAKlC,OAAL,CAAajB,IAApD;AACH;AACJ,qBAXD,MAWO;AACHsD,sCAAcT,UAAd,CAAyB,YAAzB,EAAuCU,MAAM,CAAN,CAAvC;AACH;AACJ;AAEJ;AACJ,SA/CD;;AAiDA;;;;AAIA,aAAKnE,MAAL,CAAY+E,GAAZ,CAAgB,gCAAhB,EAAkD,UAACC,KAAD,EAAQC,IAAR,EAAiB;AAC/D,gBAAIC,aAAaD,KAAKC,UAAtB;AACA,gBAAIA,WAAWtD,mBAAX,KAAmC,MAAKd,QAA5C,EAAsD;AAClD;AACA,sBAAKqE,gBAAL,GAAwB,IAAxB;AACA,sBAAKhD,iBAAL,GAAyB,MAAKjC,iBAAL,CAAuBkC,gCAAvB,CAAwD,MAAKf,WAA7D,EAA0E,MAAKP,QAA/E,CAAzB;AACH;AACJ,SAPD;;AASA;;;;AAIA,aAAKd,MAAL,CAAY+E,GAAZ,CAAgB,uBAAhB,EAAyC,UAACE,IAAD,EAAU;AAC/C,gBAAI,MAAKzE,SAAT,EAAoB;AAChB;AACA,sBAAK4E,QAAL;AACH;;AAED;AACA,gBAAIC,yBAAyB7B,EAAE,2BAAF,CAA7B;AACAvD,qBAAS,YAAM;AACXoF,uCAAuBC,OAAvB,CAA+B;AAC3BC,+BAAWF,uBAAuBG,IAAvB,CAA4B,cAA5B;AADgB,iBAA/B,EAEG,GAFH;AAGH,aAJD,EAIG,GAJH;AAKH,SAbD;AAcH;;;;mCAEU;AACP,iBAAKhF,SAAL,GAAiB,CAAC,KAAKA,SAAvB;;AAEA,gBAAI,KAAKA,SAAT,EAAoB;AAChB,qBAAKiF,UAAL;AACH;AACJ;;;qCAEY;AACT,gBAAI,KAAKjF,SAAT,EAAoB;AAChB,qBAAKD,IAAL,GAAY,IAAZ;AACA,qBAAKC,SAAL,GAAiB,KAAjB;AACH,aAHD,MAGO;AACH,qBAAKD,IAAL,GAAY,CAAC,KAAKA,IAAlB;AACH;AACJ;;;+CAEsB2C,M,EAAQ;AAC3B,iBAAKwC,eAAL,CAAqB,EAACC,OAAO,IAAR,EAArB;AACH;;;gCAEOA,K,EAAO;AACX;AACA,iBAAKlF,KAAL,GAAa,IAAb;;AAEA;;;;;;;AAOA,iBAAKU,UAAL,CAAgBU,OAAhB,CAAwBA,OAAxB,GAAkC,KAAK1B,aAAL,CAAmByF,wBAAnB,CAA4CD,KAA5C,CAAlC;AACH;;AAED;;;;;;gDAGwB;AAAA;;AACpB,iBAAKE,oBAAL,GADoB,CACU;AAC9B,iBAAKC,kBAAL,GAA0BC,YAAY,YAAM;AACxC;AACA,oBAAI,OAAKtF,KAAT,EAAgB;AACZ;AACA;AACA,2BAAKuF,sBAAL;AACH;AACJ,aAPyB,EAOvB,KAAKtF,gBAPkB,CAA1B;AAQH;;AAED;;;;;;+CAGuB;AACnBuF,0BAAc,KAAKH,kBAAnB;AACH;;AAED;;;;;;iDAGyB;AAAA;;AACrB;AACA,iBAAK3E,UAAL,CAAgBU,OAAhB,CAAwBN,cAAxB,GAAyC2E,KAAKC,KAAL,CAAW,IAAID,IAAJ,EAAX,CAAzC,CAFqB,CAE6C;AAClE,iBAAK9F,eAAL,CAAqBgG,gBAArB,CAAsC,KAAKjF,UAAL,CAAgBa,EAAtD,EAA0D,KAAKb,UAAL,CAAgBkF,MAA1E,EAAkF,KAAKlF,UAAL,CAAgBS,mBAAlG,EACI,KAAKT,UAAL,CAAgBmF,IADpB,EAC0B,KAAKnF,UAAL,CAAgBoF,KAD1C,EACiD,KAAKpF,UAAL,CAAgBU,OADjE,EAC0E,KAAKV,UAAL,CAAgBU,OAAhB,CAAwBN,cADlG,EAEKiF,IAFL,CAEU,UAACC,MAAD,EAAY;AACd,oBAAIA,MAAJ,EAAY;AACR,2BAAKhG,KAAL,GAAa,KAAb;AACA,2BAAK0E,gBAAL,GAAwB,KAAxB;AACA,2BAAKhE,UAAL,CAAgBa,EAAhB,GAAqByE,OAAOzE,EAA5B,CAHQ,CAGwB;AAChC,wBAAIV,iBAAiBmF,OAAOnF,cAA5B;AACA,wBAAIC,iBAAiB,OAAKpB,aAAL,CAAmBqB,wBAAnB,CAA4CF,cAA5C,CAArB;;AAEA;AACA,2BAAKG,cAAL,CAAoB,OAAKnB,UAAL,CAAgB,OAAhB,CAApB,EAA8CiB,cAA9C;AACH;AACJ,aAbL;AAcH;;AAED;;;;;;;;uCAKemF,O,EAAS7F,I,EAAM;AAC1B,iBAAKF,WAAL,CAAiBC,IAAjB,GAAwB8F,OAAxB;AACA,iBAAK/F,WAAL,CAAiBE,IAAjB,GAAwBA,IAAxB;AACH;;;;;;AAGLhB,yBAAyB8G,OAAzB,GAAmC,CAC/B,SAD+B,EAE/B,YAF+B,EAG/B,QAH+B,EAI/B,UAJ+B,EAK/B,mBAL+B,EAM/B,eAN+B,EAO/B,iBAP+B,EAQ/B,gBAR+B,CAAnC;;AAWA,IAAMC,iBAAiB;AACnBC,cAAU;AACN9F,gBAAQ,GADF;AAEN6C,uBAAe,GAFT;AAGNkD,oBAAY,GAHN;AAINhG,kBAAU,GAJJ;AAKNiG,iBAAS,GALH;AAMN1F,qBAAa,GANP;AAONoE,oBAAY,GAPN;AAQNC,yBAAiB;AACjB;AATM,KADS;AAYnBsB,ukJAZmB;AAsEnBC,gBAAYpH;AAtEO,CAAvB;;kBAyEe+G,c","file":"notebookReport.js","sourcesContent":["\"use strict\";\n\nclass NotebookReportController {\n    constructor($filter,\n                $mdSidenav,\n                $scope,\n                $timeout,\n                AnnotationService,\n                ConfigService,\n                NotebookService,\n                ProjectService) {\n        this.$filter = $filter;\n        this.$mdSidenav = $mdSidenav;\n        this.$scope = $scope;\n        this.$timeout = $timeout;\n        this.AnnotationService = AnnotationService;\n        this.ConfigService = ConfigService;\n        this.NotebookService = NotebookService;\n        this.ProjectService = ProjectService;\n\n        this.$translate = this.$filter('translate');\n\n        this.full = false;\n        this.collapsed = true;\n\n        this.dirty = false;\n        this.autoSaveInterval = 30000;  // the auto save interval in milliseconds\n\n        this.saveMessage = {\n            text: '',\n            time: ''\n        };\n\n        // assume only one report for now\n        this.reportId = this.config.itemTypes.report.notes[0].reportId;\n        this.reportItem = this.NotebookService.getLatestNotebookReportItemByReportId(this.reportId, this.workgroupId);\n        if (this.reportItem) {\n            let serverSaveTime = this.reportItem.serverSaveTime;\n            let clientSaveTime = this.ConfigService.convertToClientTimestamp(serverSaveTime);\n            this.setSaveMessage(this.$translate('saved'), clientSaveTime);\n        } else {\n            // Student doesn't have work for this report yet, so we'll use the template.\n            this.reportItem = this.NotebookService.getTemplateReportItemByReportId(this.reportId);\n            if (this.reportItem == null) {\n                // if there is no template, don't allow student to work on the report.\n                return;\n            }\n        }\n        // get the max score\n        this.maxScore = 0;\n        let localNotebookItemId = null;  // unique id that is local to this student, that identifies a note and its revisions. e.g. \"finalReport\", \"xyzabc\"\n        if (this.reportItem.content != null && this.reportItem.content.reportId != null) {\n            localNotebookItemId = this.reportItem.localNotebookItemId;\n            let reportNoteContent = this.NotebookService.getReportNoteContentByReportId(this.reportItem.content.reportId);\n            if (reportNoteContent != null && reportNoteContent.maxScore != null) {\n                this.maxScore = reportNoteContent.maxScore;\n            }\n        }\n        // set the id to null so it can be inserted as initial version, as opposed to updated. this is true for both new and just-loaded reports.\n        this.reportItem.id = null;\n        // replace relative asset paths with absolute asset paths\n        this.reportItemContent = this.ProjectService.injectAssetPaths(this.reportItem.content.content);\n        // get the latest annotations\n        this.latestAnnotations = this.AnnotationService.getLatestNotebookItemAnnotations(this.workgroupId, this.reportId);\n\n        // start auto-saving\n        this.startAutoSaveInterval();\n\n        // summernote editor options\n        this.summernoteOptions = {\n            toolbar: [\n                ['edit', ['undo', 'redo']],\n                ['style', ['bold', 'italic', 'underline'/*, 'superscript', 'subscript', 'strikethrough', 'clear'*/]],\n                //['style', ['style']],\n                //['fontface', ['fontname']],\n                //['textsize', ['fontsize']],\n                //['fontclr', ['color']],\n                ['para', ['ul', 'ol', 'paragraph'/*, 'lineheight'*/]],\n                //['height', ['height']],\n                //['table', ['table']],\n                //['insert', ['link','picture','video','hr']],\n                //['view', ['fullscreen', 'codeview']],\n                //['help', ['help']]\n                ['customButton', ['customButton']],\n                ['print', ['print']]\n            ],\n            popover: {\n                image: [\n                    ['imagesize', ['imageSize100', 'imageSize50', 'imageSize25']],\n                    //['float', ['floatLeft', 'floatRight', 'floatNone']],\n                    ['remove', ['removeMedia']]\n                ]\n            },\n            customButton: {\n                // TODO: i18n\n                buttonText: 'Insert ' + this.config.itemTypes.note.label.singular + ' +',\n                tooltip: 'Insert from ' + this.config.label,\n                buttonClass: 'accent-1 notebook-item--report__add-note',\n                action: ($event) => {\n                    this.addNotebookItemContent($event);\n                }\n            },\n            disableDragAndDrop: true,\n            toolbarContainer: '#' + this.reportId + '-toolbar',\n            callbacks: {\n                onBlur: function () {\n                    $(this).summernote('saveRange');\n                }\n            }\n        };\n\n        this.$onChanges = (changes) => {\n            if (changes.insertContent && !changes.insertContent.isFirstChange() && changes.insertContent.currentValue) {\n                // a notebook item is being inserted into the report\n                let item = angular.copy(changes.insertContent.currentValue);\n\n                // prepare summernote editor instance\n                let reportElement = $('#' + this.reportId);\n                reportElement.summernote('focus');\n                reportElement.summernote('restoreRange');\n\n                // create a jQuery DOM element to insert into the Summernote report editor\n                let $item = $('<p>');\n                let hasAttachments = false;\n\n                if (item.content) {\n                    if (item.content.attachments) {\n                        if (item.content.attachments.length) {\n                            hasAttachments = true;\n                            // item includes attachments, so center align element\n                            $item.css('text-align', 'center');\n                        }\n                        for (let a = 0; a < item.content.attachments.length; a++) {\n                            // add each attachment to the element\n                            let notebookItemAttachment = item.content.attachments[a];\n                            let iconURL = notebookItemAttachment.iconURL;\n                            let $img = $('<img src=\"' + iconURL + '\" alt=\"notebook image\" style=\"width: 75%; max-width: 100%; height: auto; border: 1px solid #aaaaaa; padding: 8px; margin-bottom: 4px;\" />');\n                            $img.addClass('notebook-item--report__note-img');\n                            $item.append($img);\n                        }\n                    }\n                    if (item.content.text) {\n                        // item contains text, so add to element\n                        if (hasAttachments) {\n                            // item has attachments, so treat text content as a caption: center it and make it bold\n                            let $caption = $('<div><b>' + item.content.text + '</b></div>').css({'text-align': 'center'});\n                            $item.append($caption);\n                            reportElement.summernote('insertNode', $item[0]);\n                        } else {\n                            // note only contains text, so insert plain text\n                            reportElement.summernote('insertText', item.content.text);\n                        }\n                    } else {\n                        reportElement.summernote('insertNode', $item[0]);\n                    }\n                }\n\n            }\n        }\n\n        /**\n         * Captures the annotation received event, checks whether the given\n         * annotation id matches this report id, updates UI accordingly\n         */\n        this.$scope.$on('notebookItemAnnotationReceived', (event, args) => {\n            let annotation = args.annotation;\n            if (annotation.localNotebookItemId === this.reportId) {\n                // there is a new annotation for this report\n                this.hasNewAnnotation = true;\n                this.latestAnnotations = this.AnnotationService.getLatestNotebookItemAnnotations(this.workgroupId, this.reportId);\n            }\n        });\n\n        /**\n         * Captures the show report annotations event, opens report (if collapsed)\n         * and scrolls to the report annotations display\n         */\n        this.$scope.$on('showReportAnnotations', (args) => {\n            if (this.collapsed) {\n                // open the report\n                this.collapse();\n            }\n\n            // scroll to report annotations (bottom)\n            let $notebookReportContent = $('.notebook-report__content');\n            $timeout(() => {\n                $notebookReportContent.animate({\n                    scrollTop: $notebookReportContent.prop('scrollHeight')\n                }, 500);\n            }, 500);\n        });\n    }\n\n    collapse() {\n        this.collapsed = !this.collapsed;\n\n        if (this.collapsed) {\n            this.onCollapse();\n        }\n    }\n\n    fullscreen() {\n        if (this.collapsed) {\n            this.full = true;\n            this.collapsed = false;\n        } else {\n            this.full = !this.full;\n        }\n    }\n\n    addNotebookItemContent($event) {\n        this.onSetInsertMode({value: true});\n    }\n\n    changed(value) {\n        // report content had changed\n        this.dirty = true;\n\n        /*\n         * remove the absolute asset paths\n         * e.g.\n         * <img src='https://wise.berkeley.edu/curriculum/3/assets/sun.png'/>\n         * will be changed to\n         * <img src='sun.png'/>\n         */\n        this.reportItem.content.content = this.ConfigService.removeAbsoluteAssetPaths(value);\n    }\n\n    /**\n     * Start the auto save interval for this report\n     */\n    startAutoSaveInterval() {\n        this.stopAutoSaveInterval();  // stop any existing interval\n        this.autoSaveIntervalId = setInterval(() => {\n            // check if the student work is dirty\n            if (this.dirty) {\n                // the student work is dirty so we will save.\n                // obtain the component states from the children and save them to the server\n                this.saveNotebookReportItem();\n            }\n        }, this.autoSaveInterval);\n    }\n\n    /**\n     * Stop the auto save interval for this report\n     */\n    stopAutoSaveInterval() {\n        clearInterval(this.autoSaveIntervalId);\n    }\n\n    /**\n     * Save the notebook report item to server\n     */\n    saveNotebookReportItem() {\n        // save new report notebook item\n        this.reportItem.content.clientSaveTime = Date.parse(new Date());  // set save timestamp\n        this.NotebookService.saveNotebookItem(this.reportItem.id, this.reportItem.nodeId, this.reportItem.localNotebookItemId,\n            this.reportItem.type, this.reportItem.title, this.reportItem.content, this.reportItem.content.clientSaveTime)\n            .then((result) => {\n                if (result) {\n                    this.dirty = false;\n                    this.hasNewAnnotation = false;\n                    this.reportItem.id = result.id; // set the reportNotebookItemId to the newly-incremented id so that future saves during this visit will be an update instead of an insert.\n                    let serverSaveTime = result.serverSaveTime;\n                    let clientSaveTime = this.ConfigService.convertToClientTimestamp(serverSaveTime);\n\n                    // set save message\n                    this.setSaveMessage(this.$translate('saved'), clientSaveTime);\n                }\n            });\n    }\n\n    /**\n     * Set the message next to the save button\n     * @param message the message to display\n     * @param time the time to display\n     */\n    setSaveMessage(message, time) {\n        this.saveMessage.text = message;\n        this.saveMessage.time = time;\n    }\n}\n\nNotebookReportController.$inject = [\n    '$filter',\n    '$mdSidenav',\n    '$scope',\n    '$timeout',\n    'AnnotationService',\n    'ConfigService',\n    'NotebookService',\n    'ProjectService'\n];\n\nconst NotebookReport = {\n    bindings: {\n        config: '<',\n        insertContent: '<',\n        insertMode: '<',\n        reportId: '<',\n        visible: '<',\n        workgroupId: '<',\n        onCollapse: '&',\n        onSetInsertMode: '&'\n        //onClose: '&'\n    },\n    template:\n        `<div ng-if=\"($ctrl.visible && $ctrl.full && !$ctrl.collapsed) || $ctrl.insertMode\" class=\"notebook-report-backdrop\"></div>\n        <div ng-if=\"$ctrl.visible\" class=\"notebook-report-container\"\n              ng-class=\"{'notebook-report-container__collapsed': $ctrl.collapsed, 'notebook-report-container__full': $ctrl.full && !$ctrl.collapsed}\">\n            <md-card class=\"notebook-report md-whiteframe-3dp l-constrained\">\n                <md-toolbar ng-click=\"$ctrl.collapsed ? $ctrl.collapse() : return\" class=\"md-toolbar--wise md-toolbar--wise--sm notebook-report__toolbar\">\n                    <md-toolbar-tools class=\"md-toolbar-tools\">\n                        <md-icon>assignment</md-icon>&nbsp;\n                        <span ng-if=\"$ctrl.collapsed\" class=\"overflow--ellipsis notebook-report__toolbar__title\">{{$ctrl.reportItem.content.title}}</span>\n                        <span flex></span>\n                        <md-button aria-label=\"{{'toggleFullScreen' | translate}}\" title=\"{{'toggleFullScreen' | translate}}\" class=\"md-icon-button notebook-tools--full\"\n                                   ng-click=\"$ctrl.fullscreen()\">\n                            <md-icon ng-if=\"!$ctrl.full || $ctrl.collapsed\"> fullscreen </md-icon>\n                            <md-icon ng-if=\"$ctrl.full && !$ctrl.collapsed\"> fullscreen_exit </md-icon>\n                        </md-button>\n                        <md-button aria-label=\"{{'collapse' | translate}}\" title=\"{{'collapse' | translate}}\" class=\"md-icon-button\"\n                                   ng-if=\"!$ctrl.collapsed\" ng-click=\"$event.stopPropagation(); $ctrl.collapse()\">\n                            <md-icon> arrow_drop_down </md-icon>\n                        </md-button>\n                        <md-button aria-label=\"{{'restore' | translate}}\" title=\"{{'restore' | translate}}\" class=\"md-icon-button\"\n                                   ng-if=\"$ctrl.collapsed\" ng-click=\"$event.stopPropagation(); $ctrl.collapse()\">\n                            <md-icon> arrow_drop_up </md-icon>\n                        </md-button>\n                    </md-toolbar-tools>\n                    <div class=\"notebook-report__content__header md-whiteframe-1dp\" layout=\"row\" layout-align=\"start center\">\n                        <span style=\"color: {{$ctrl.config.itemTypes.report.label.color}};\">{{$ctrl.reportItem.content.title}}</span>\n                        <span flex></span>\n                        <md-icon aria-label=\"{{$ctrl.reportItem.content.title}} info\" style=\"color: {{$ctrl.config.itemTypes.report.label.color}};\">\n                            info\n                            <md-tooltip md-direction=\"left\">{{$ctrl.reportItem.content.prompt}}</md-tooltip>\n                        </md-icon>\n                    </div>\n                </md-toolbar>\n                <md-content class=\"notebook-report__content\" flex>\n                    <summernote id=\"{{$ctrl.reportId}}\"\n                                class=\"notebook-item--report__content\"\n                                ng-model=\"$ctrl.reportItemContent\"\n                                ng-change=\"$ctrl.changed($ctrl.reportItemContent)\"\n                                config=\"$ctrl.summernoteOptions\"></summernote>\n                    <notebook-report-annotations annotations=\"$ctrl.latestAnnotations\"\n                                                 has-new=\"$ctrl.hasNewAnnotation\"\n                                                 max-score=\"$ctrl.maxScore\"></notebook-report-annotations>\n                </md-content>\n                <md-card-actions class=\"notebook-report__actions\">\n                    <div id=\"{{$ctrl.reportId}}-toolbar\"></div>\n                    <div layout=\"row\" layout-align=\"start center\">\n                        <md-button class=\"md-primary md-raised button--small\"\n                                   aria-label=\"{{ 'save' | translate }}\"\n                                   ng-disabled=\"!$ctrl.dirty\"\n                                   ng-click=\"$ctrl.saveNotebookReportItem()\">{{ 'save' | translate }}</md-button>\n                        <span ng-show=\"$ctrl.saveMessage.text\"\n                              class=\"component__actions__info md-caption\">\n                              {{$ctrl.saveMessage.text}} <span class=\"component__actions__more\"><md-tooltip md-direction=\"top\">{{ $ctrl.saveMessage.time | amDateFormat:'ddd, MMM D YYYY, h:mm a' }}</md-tooltip><span am-time-ago=\"$ctrl.saveMessage.time\"></span></span>\n                        </span>\n                    </div>\n                </md-card-actions>\n            </md-card>\n        </div>`,\n    controller: NotebookReportController\n};\n\nexport default NotebookReport;\n"]}