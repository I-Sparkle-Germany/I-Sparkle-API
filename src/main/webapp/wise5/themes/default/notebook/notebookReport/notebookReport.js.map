{"version":3,"sources":["notebookReport.es6"],"names":["NotebookReportController","$filter","$mdSidenav","$scope","$timeout","AnnotationService","ConfigService","NotebookService","ProjectService","$translate","full","collapsed","dirty","autoSaveInterval","saveMessage","text","time","reportId","config","itemTypes","report","notes","reportItem","getLatestNotebookReportItemByReportId","workgroupId","serverSaveTime","clientSaveTime","convertToClientTimestamp","setSaveMessage","getTemplateReportItemByReportId","maxScore","localNotebookItemId","content","reportNoteContent","getReportNoteContentByReportId","id","reportItemContent","injectAssetPaths","latestAnnotations","getLatestNotebookItemAnnotations","startAutoSaveInterval","summernoteOptions","toolbar","popover","image","customButton","buttonText","note","label","singular","tooltip","buttonClass","action","$event","addNotebookItemContent","disableDragAndDrop","toolbarContainer","callbacks","onBlur","$","summernote","$onChanges","changes","insertContent","isFirstChange","currentValue","item","angular","copy","reportElement","$item","hasAttachments","attachments","length","css","a","notebookItemAttachment","iconURL","$img","addClass","append","$caption","$on","event","args","annotation","hasNewAnnotation","collapse","$notebookReportContent","animate","scrollTop","prop","onCollapse","onSetInsertMode","value","removeAbsoluteAssetPaths","stopAutoSaveInterval","autoSaveIntervalId","setInterval","saveNotebookReportItem","clearInterval","Date","parse","saveNotebookItem","nodeId","type","title","then","result","message","$inject","NotebookReport","bindings","insertMode","visible","template","controller"],"mappings":"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","file":"notebookReport.js","sourcesContent":["\"use strict\";\r\n\r\nclass NotebookReportController {\r\n    constructor($filter,\r\n                $mdSidenav,\r\n                $scope,\r\n                $timeout,\r\n                AnnotationService,\r\n                ConfigService,\r\n                NotebookService,\r\n                ProjectService) {\r\n        this.$filter = $filter;\r\n        this.$mdSidenav = $mdSidenav;\r\n        this.$scope = $scope;\r\n        this.$timeout = $timeout;\r\n        this.AnnotationService = AnnotationService;\r\n        this.ConfigService = ConfigService;\r\n        this.NotebookService = NotebookService;\r\n        this.ProjectService = ProjectService;\r\n\r\n        this.$translate = this.$filter('translate');\r\n\r\n        this.full = false;\r\n        this.collapsed = true;\r\n\r\n        this.dirty = false;\r\n        this.autoSaveInterval = 30000;  // the auto save interval in milliseconds\r\n\r\n        this.saveMessage = {\r\n            text: '',\r\n            time: ''\r\n        };\r\n\r\n        // assume only one report for now\r\n        this.reportId = this.config.itemTypes.report.notes[0].reportId;\r\n        this.reportItem = this.NotebookService.getLatestNotebookReportItemByReportId(this.reportId, this.workgroupId);\r\n        if (this.reportItem) {\r\n            let serverSaveTime = this.reportItem.serverSaveTime;\r\n            let clientSaveTime = this.ConfigService.convertToClientTimestamp(serverSaveTime);\r\n            this.setSaveMessage(this.$translate('saved'), clientSaveTime);\r\n        } else {\r\n            // Student doesn't have work for this report yet, so we'll use the template.\r\n            this.reportItem = this.NotebookService.getTemplateReportItemByReportId(this.reportId);\r\n            if (this.reportItem == null) {\r\n                // if there is no template, don't allow student to work on the report.\r\n                return;\r\n            }\r\n        }\r\n        // get the max score\r\n        this.maxScore = 0;\r\n        let localNotebookItemId = null;  // unique id that is local to this student, that identifies a note and its revisions. e.g. \"finalReport\", \"xyzabc\"\r\n        if (this.reportItem.content != null && this.reportItem.content.reportId != null) {\r\n            localNotebookItemId = this.reportItem.localNotebookItemId;\r\n            let reportNoteContent = this.NotebookService.getReportNoteContentByReportId(this.reportItem.content.reportId);\r\n            if (reportNoteContent != null && reportNoteContent.maxScore != null) {\r\n                this.maxScore = reportNoteContent.maxScore;\r\n            }\r\n        }\r\n        // set the id to null so it can be inserted as initial version, as opposed to updated. this is true for both new and just-loaded reports.\r\n        this.reportItem.id = null;\r\n        // replace relative asset paths with absolute asset paths\r\n        this.reportItemContent = this.ProjectService.injectAssetPaths(this.reportItem.content.content);\r\n        // get the latest annotations\r\n        this.latestAnnotations = this.AnnotationService.getLatestNotebookItemAnnotations(this.workgroupId, this.reportId);\r\n\r\n        // start auto-saving\r\n        this.startAutoSaveInterval();\r\n\r\n        // summernote editor options\r\n        this.summernoteOptions = {\r\n            toolbar: [\r\n                ['edit', ['undo', 'redo']],\r\n                ['style', ['bold', 'italic', 'underline'/*, 'superscript', 'subscript', 'strikethrough', 'clear'*/]],\r\n                //['style', ['style']],\r\n                //['fontface', ['fontname']],\r\n                //['textsize', ['fontsize']],\r\n                //['fontclr', ['color']],\r\n                ['para', ['ul', 'ol', 'paragraph'/*, 'lineheight'*/]],\r\n                //['height', ['height']],\r\n                //['table', ['table']],\r\n                //['insert', ['link','picture','video','hr']],\r\n                //['view', ['fullscreen', 'codeview']],\r\n                //['help', ['help']]\r\n                ['customButton', ['customButton']]\r\n                //['print', ['print']]\r\n            ],\r\n            popover: {\r\n                image: [\r\n                    ['imagesize', ['imageSize100', 'imageSize50', 'imageSize25']],\r\n                    //['float', ['floatLeft', 'floatRight', 'floatNone']],\r\n                    ['remove', ['removeMedia']]\r\n                ]\r\n            },\r\n            customButton: {\r\n                // TODO: i18n\r\n                buttonText: 'Insert ' + this.config.itemTypes.note.label.singular + ' +',\r\n                tooltip: 'Insert from ' + this.config.label,\r\n                buttonClass: 'accent-1 notebook-item--report__add-note',\r\n                action: ($event) => {\r\n                    this.addNotebookItemContent($event);\r\n                }\r\n            },\r\n            disableDragAndDrop: true,\r\n            toolbarContainer: '#' + this.reportId + '-toolbar',\r\n            callbacks: {\r\n                onBlur: function () {\r\n                    $(this).summernote('saveRange');\r\n                }\r\n            }\r\n        };\r\n\r\n        this.$onChanges = (changes) => {\r\n            if (changes.insertContent && !changes.insertContent.isFirstChange() && changes.insertContent.currentValue) {\r\n                // a notebook item is being inserted into the report\r\n                let item = angular.copy(changes.insertContent.currentValue);\r\n\r\n                // prepare summernote editor instance\r\n                let reportElement = $('#' + this.reportId);\r\n                reportElement.summernote('focus');\r\n                reportElement.summernote('restoreRange');\r\n\r\n                // create a jQuery DOM element to insert into the Summernote report editor\r\n                let $item = $('<p>');\r\n                let hasAttachments = false;\r\n\r\n                if (item.content) {\r\n                    if (item.content.attachments) {\r\n                        if (item.content.attachments.length) {\r\n                            hasAttachments = true;\r\n                            // item includes attachments, so center align element\r\n                            $item.css('text-align', 'center');\r\n                        }\r\n                        for (let a = 0; a < item.content.attachments.length; a++) {\r\n                            // add each attachment to the element\r\n                            let notebookItemAttachment = item.content.attachments[a];\r\n                            let iconURL = notebookItemAttachment.iconURL;\r\n                            let $img = $('<img src=\"' + iconURL + '\" alt=\"notebook image\" style=\"width: 75%; max-width: 100%; height: auto; border: 1px solid #aaaaaa; padding: 8px; margin-bottom: 4px;\" />');\r\n                            $img.addClass('notebook-item--report__note-img');\r\n                            $item.append($img);\r\n                        }\r\n                    }\r\n                    if (item.content.text) {\r\n                        // item contains text, so add to element\r\n                        if (hasAttachments) {\r\n                            // item has attachments, so treat text content as a caption: center it and make it bold\r\n                            let $caption = $('<div><b>' + item.content.text + '</b></div>').css({'text-align': 'center'});\r\n                            $item.append($caption);\r\n                            reportElement.summernote('insertNode', $item[0]);\r\n                        } else {\r\n                            // note only contains text, so insert plain text\r\n                            reportElement.summernote('insertText', item.content.text);\r\n                        }\r\n                    } else {\r\n                        reportElement.summernote('insertNode', $item[0]);\r\n                    }\r\n                }\r\n\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Captures the annotation received event, checks whether the given\r\n         * annotation id matches this report id, updates UI accordingly\r\n         */\r\n        this.$scope.$on('notebookItemAnnotationReceived', (event, args) => {\r\n            let annotation = args.annotation;\r\n            if (annotation.localNotebookItemId === this.reportId) {\r\n                // there is a new annotation for this report\r\n                this.hasNewAnnotation = true;\r\n                this.latestAnnotations = this.AnnotationService.getLatestNotebookItemAnnotations(this.workgroupId, this.reportId);\r\n            }\r\n        });\r\n\r\n        /**\r\n         * Captures the show report annotations event, opens report (if collapsed)\r\n         * and scrolls to the report annotations display\r\n         */\r\n        this.$scope.$on('showReportAnnotations', (args) => {\r\n            if (this.collapsed) {\r\n                // open the report\r\n                this.collapse();\r\n            }\r\n\r\n            // scroll to report annotations (bottom)\r\n            let $notebookReportContent = $('.notebook-report__content');\r\n            $timeout(() => {\r\n                $notebookReportContent.animate({\r\n                    scrollTop: $notebookReportContent.prop('scrollHeight')\r\n                }, 500);\r\n            }, 500);\r\n        });\r\n    }\r\n\r\n    collapse() {\r\n        this.collapsed = !this.collapsed;\r\n\r\n        if (this.collapsed) {\r\n            this.onCollapse();\r\n        }\r\n    }\r\n\r\n    fullscreen() {\r\n        if (this.collapsed) {\r\n            this.full = true;\r\n            this.collapsed = false;\r\n        } else {\r\n            this.full = !this.full;\r\n        }\r\n    }\r\n\r\n    addNotebookItemContent($event) {\r\n        this.onSetInsertMode({value: true});\r\n    }\r\n\r\n    changed(value) {\r\n        // report content had changed\r\n        this.dirty = true;\r\n\r\n        /*\r\n         * remove the absolute asset paths\r\n         * e.g.\r\n         * <img src='https://wise.berkeley.edu/curriculum/3/assets/sun.png'/>\r\n         * will be changed to\r\n         * <img src='sun.png'/>\r\n         */\r\n        this.reportItem.content.content = this.ConfigService.removeAbsoluteAssetPaths(value);\r\n    }\r\n\r\n    /**\r\n     * Start the auto save interval for this report\r\n     */\r\n    startAutoSaveInterval() {\r\n        this.stopAutoSaveInterval();  // stop any existing interval\r\n        this.autoSaveIntervalId = setInterval(() => {\r\n            // check if the student work is dirty\r\n            if (this.dirty) {\r\n                // the student work is dirty so we will save.\r\n                // obtain the component states from the children and save them to the server\r\n                this.saveNotebookReportItem();\r\n            }\r\n        }, this.autoSaveInterval);\r\n    }\r\n\r\n    /**\r\n     * Stop the auto save interval for this report\r\n     */\r\n    stopAutoSaveInterval() {\r\n        clearInterval(this.autoSaveIntervalId);\r\n    }\r\n\r\n    /**\r\n     * Save the notebook report item to server\r\n     */\r\n    saveNotebookReportItem() {\r\n        // save new report notebook item\r\n        this.reportItem.content.clientSaveTime = Date.parse(new Date());  // set save timestamp\r\n        this.NotebookService.saveNotebookItem(this.reportItem.id, this.reportItem.nodeId, this.reportItem.localNotebookItemId,\r\n            this.reportItem.type, this.reportItem.title, this.reportItem.content, this.reportItem.content.clientSaveTime)\r\n            .then((result) => {\r\n                if (result) {\r\n                    this.dirty = false;\r\n                    this.hasNewAnnotation = false;\r\n                    this.reportItem.id = result.id; // set the reportNotebookItemId to the newly-incremented id so that future saves during this visit will be an update instead of an insert.\r\n                    let serverSaveTime = result.serverSaveTime;\r\n                    let clientSaveTime = this.ConfigService.convertToClientTimestamp(serverSaveTime);\r\n\r\n                    // set save message\r\n                    this.setSaveMessage(this.$translate('saved'), clientSaveTime);\r\n                }\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Set the message next to the save button\r\n     * @param message the message to display\r\n     * @param time the time to display\r\n     */\r\n    setSaveMessage(message, time) {\r\n        this.saveMessage.text = message;\r\n        this.saveMessage.time = time;\r\n    }\r\n}\r\n\r\nNotebookReportController.$inject = [\r\n    '$filter',\r\n    '$mdSidenav',\r\n    '$scope',\r\n    '$timeout',\r\n    'AnnotationService',\r\n    'ConfigService',\r\n    'NotebookService',\r\n    'ProjectService'\r\n];\r\n\r\nconst NotebookReport = {\r\n    bindings: {\r\n        config: '<',\r\n        insertContent: '<',\r\n        insertMode: '<',\r\n        reportId: '<',\r\n        visible: '<',\r\n        workgroupId: '<',\r\n        onCollapse: '&',\r\n        onSetInsertMode: '&'\r\n        //onClose: '&'\r\n    },\r\n    template:\r\n        `<div ng-if=\"($ctrl.visible && $ctrl.full && !$ctrl.collapsed) || $ctrl.insertMode\" class=\"notebook-report-backdrop\"></div>\r\n        <div ng-if=\"$ctrl.visible\" class=\"notebook-report-container\"\r\n              ng-class=\"{'notebook-report-container__collapsed': $ctrl.collapsed, 'notebook-report-container__full': $ctrl.full && !$ctrl.collapsed}\">\r\n            <md-card class=\"notebook-report md-whiteframe-3dp l-constrained\">\r\n                <md-toolbar ng-click=\"$ctrl.collapsed ? $ctrl.collapse() : return\" class=\"md-toolbar--wise md-toolbar--wise--sm notebook-report__toolbar\">\r\n                    <md-toolbar-tools class=\"md-toolbar-tools\">\r\n                        <md-icon>assignment</md-icon>&nbsp;\r\n                        <span ng-if=\"$ctrl.collapsed\" class=\"overflow--ellipsis notebook-report__toolbar__title\">{{$ctrl.reportItem.content.title}}</span>\r\n                        <span flex></span>\r\n                        <md-button aria-label=\"{{'toggleFullScreen' | translate}}\" title=\"{{'toggleFullScreen' | translate}}\" class=\"md-icon-button notebook-tools--full\"\r\n                                   ng-click=\"$ctrl.fullscreen()\">\r\n                            <md-icon> zoom_out_map </md-icon>\r\n                        </md-button>\r\n                        <md-button aria-label=\"{{'collapse' | translate}}\" title=\"{{'collapse' | translate}}\" class=\"md-icon-button\"\r\n                                   ng-if=\"!$ctrl.collapsed\" ng-click=\"$event.stopPropagation(); $ctrl.collapse()\">\r\n                            <md-icon> arrow_drop_down </md-icon>\r\n                        </md-button>\r\n                        <md-button aria-label=\"{{'restore' | translate}}\" title=\"{{'restore' | translate}}\" class=\"md-icon-button\"\r\n                                   ng-if=\"$ctrl.collapsed\" ng-click=\"$event.stopPropagation(); $ctrl.collapse()\">\r\n                            <md-icon> arrow_drop_up </md-icon>\r\n                        </md-button>\r\n                    </md-toolbar-tools>\r\n                    <div class=\"notebook-report__content__header md-whiteframe-1dp\" layout=\"row\" layout-align=\"start center\">\r\n                        <span style=\"color: {{$ctrl.config.itemTypes.report.label.color}};\">{{$ctrl.reportItem.content.title}}</span>\r\n                        <span flex></span>\r\n                        <md-icon aria-label=\"{{$ctrl.reportItem.content.title}} info\" style=\"color: {{$ctrl.config.itemTypes.report.label.color}};\">\r\n                            info\r\n                            <md-tooltip md-direction=\"left\">{{$ctrl.reportItem.content.prompt}}</md-tooltip>\r\n                        </md-icon>\r\n                    </div>\r\n                </md-toolbar>\r\n                <md-content class=\"notebook-report__content\" flex>\r\n                    <summernote id=\"{{$ctrl.reportId}}\"\r\n                                class=\"notebook-item--report__content\"\r\n                                ng-model=\"$ctrl.reportItemContent\"\r\n                                ng-change=\"$ctrl.changed($ctrl.reportItemContent)\"\r\n                                config=\"$ctrl.summernoteOptions\"></summernote>\r\n                    <notebook-report-annotations annotations=\"$ctrl.latestAnnotations\"\r\n                                                 has-new=\"$ctrl.hasNewAnnotation\"\r\n                                                 max-score=\"$ctrl.maxScore\"></notebook-report-annotations>\r\n                </md-content>\r\n                <md-card-actions class=\"notebook-report__actions\">\r\n                    <div id=\"{{$ctrl.reportId}}-toolbar\"></div>\r\n                    <div layout=\"row\" layout-align=\"start center\">\r\n                        <md-button class=\"md-primary md-raised button--small\"\r\n                                   aria-label=\"{{ 'save' | translate }}\"\r\n                                   ng-disabled=\"!$ctrl.dirty\"\r\n                                   ng-click=\"$ctrl.saveNotebookReportItem()\">{{ 'save' | translate }}</md-button>\r\n                        <span ng-show=\"$ctrl.saveMessage.text\"\r\n                              class=\"component__actions__info md-caption\">\r\n                              {{$ctrl.saveMessage.text}} <span class=\"component__actions__more\"><md-tooltip md-direction=\"top\">{{ $ctrl.saveMessage.time | amDateFormat:'ddd, MMM D YYYY, h:mm a' }}</md-tooltip><span am-time-ago=\"$ctrl.saveMessage.time\"></span></span>\r\n                        </span>\r\n                    </div>\r\n                </md-card-actions>\r\n            </md-card>\r\n        </div>`,\r\n    controller: NotebookReportController\r\n};\r\n\r\nexport default NotebookReport;\r\n"]}